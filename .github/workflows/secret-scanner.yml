name: Secret Scanner

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  scan-secrets:
    runs-on: ubuntu-latest
    name: Scan for exposed secrets
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Scan for API keys and secrets
        run: |
          echo "üîí Scanning for exposed secrets..."
          FOUND=0

          # Google API keys (AIza...)
          if grep -rE 'AIza[0-9A-Za-z_-]{35}' --include='*.html' --include='*.js' --include='*.json' --include='*.py' --include='*.yml' . 2>/dev/null; then
            echo "‚ùå FOUND: Google API key (AIza...)"
            FOUND=1
          fi

          # OpenWeatherMap-style 32-char hex keys in data attributes
          if grep -riE 'data-[a-z-]*key="[a-f0-9]{32}"' --include='*.html' . 2>/dev/null; then
            echo "‚ùå FOUND: Hex API key in data attribute"
            FOUND=1
          fi

          # AWS keys
          if grep -rE 'AKIA[0-9A-Z]{16}' --include='*.html' --include='*.js' --include='*.json' --include='*.py' . 2>/dev/null; then
            echo "‚ùå FOUND: AWS Access Key"
            FOUND=1
          fi

          # OpenAI / Stripe secret keys
          if grep -rE 'sk-[a-zA-Z0-9]{20,}' --include='*.html' --include='*.js' --include='*.json' --include='*.py' . 2>/dev/null; then
            echo "‚ùå FOUND: OpenAI/Stripe secret key"
            FOUND=1
          fi

          # Generic secret/password/token with real values (not placeholders)
          if grep -riE '(api_secret|private_key|secret_key)\s*[:=]\s*['"'"'"][A-Za-z0-9_/+=.-]{15,}['"'"'"]' --include='*.html' --include='*.js' --include='*.json' --include='*.py' . 2>/dev/null; then
            echo "‚ùå FOUND: Possible secret/private key value"
            FOUND=1
          fi

          # .env files that shouldn't exist in repo
          if find . -name '*.env' -o -name '.env.*' -o -name '*.env.local' | grep -q .; then
            echo "‚ùå FOUND: .env file in repository"
            FOUND=1
          fi

          if [ "$FOUND" -eq 1 ]; then
            echo ""
            echo "========================================"
            echo "  ‚ùå BUILD FAILED ‚Äî SECRETS DETECTED"
            echo "========================================"
            echo "Remove all API keys before pushing."
            exit 1
          fi

          echo "‚úÖ No secrets found. Build allowed."
