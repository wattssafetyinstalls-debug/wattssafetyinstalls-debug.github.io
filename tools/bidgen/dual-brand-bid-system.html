<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
<!-- Favicon -->
<link rel="icon" href="/favicon.ico" sizes="16x16 32x32 48x48"/>
<link rel="icon" href="/favicon-32x32.png" sizes="32x32" type="image/png"/>
<link rel="icon" href="/favicon-96x96.png" sizes="96x96" type="image/png"/>
<link rel="icon" href="/android-chrome-192x192.png" sizes="192x192" type="image/png"/>
<link rel="apple-touch-icon" href="/apple-touch-icon.png" sizes="180x180"/>
<link rel="manifest" href="/manifest.json"/>
<meta name="msapplication-TileColor" content="#0A1D37"/>
<meta name="msapplication-TileImage" content="/ms-icon-144x144.png"/>
<meta name="theme-color" content="#0A1D37"/>
    <title>Dual Brand Bid System - Watts ATP & Watts Safety Installs</title>
    <meta name="robots" content="noindex, nofollow">
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-database-compat.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #1a1a2e; color: #eee; min-height: 100vh; }
        .container { max-width: 1400px; margin: 0 auto; padding: 30px 20px; }
        h1 { font-size: 28px; margin-bottom: 4px; color: #e8e8e8; }
        .subtitle { color: #7f8c8d; font-size: 14px; margin-bottom: 30px; }
        
        /* Brand Toggle */
        .brand-toggle { display: flex; gap: 20px; margin-bottom: 30px; }
        .brand-option { flex: 1; padding: 20px; border: 2px solid #2a3a5c; border-radius: 10px; cursor: pointer; transition: all 0.3s; text-align: center; }
        .brand-option:hover { border-color: #3498db; }
        .brand-option.active { border-color: #3498db; background: #0f1a33; }
        .brand-option.atp.active { border-color: #e67e22; }
        .brand-option.wsi.active { border-color: #27ae60; }
        .brand-name { font-size: 18px; font-weight: 600; margin-bottom: 5px; }
        .brand-desc { font-size: 12px; color: #7f8c8d; }
        .brand-type { font-size: 11px; text-transform: uppercase; letter-spacing: 1px; margin-top: 8px; padding: 4px 8px; border-radius: 4px; display: inline-block; }
        .brand-type.state { background: #e67e22; color: white; }
        .brand-type.commercial { background: #27ae60; color: white; }
        
        /* Card Styles */
        .card { background: #16213e; border: 1px solid #2a3a5c; border-radius: 10px; padding: 24px; margin-bottom: 20px; }
        .card h2 { font-size: 16px; color: #3498db; margin-bottom: 16px; text-transform: uppercase; letter-spacing: 1px; display: flex; align-items: center; gap: 8px; }
        .card h2 .icon { width: 28px; height: 28px; background: #3498db; color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 14px; font-weight: bold; }
        
        /* Form Styles */
        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 14px; }
        .form-group { display: flex; flex-direction: column; }
        .form-group.full { grid-column: 1 / -1; }
        .form-group label { font-size: 11px; text-transform: uppercase; color: #7f8c8d; letter-spacing: 0.5px; margin-bottom: 4px; }
        .form-group input, .form-group textarea, .form-group select { background: #0f1a33; border: 1px solid #2a3a5c; border-radius: 6px; padding: 10px 12px; color: #eee; font-size: 14px; font-family: inherit; transition: border-color 0.2s; }
        .form-group input:focus, .form-group textarea:focus, .form-group select:focus { outline: none; border-color: #3498db; }
        
        /* Button Styles */
        .btn { padding: 14px 28px; border: none; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.2s; display: inline-flex; align-items: center; gap: 8px; }
        .btn-primary { background: #3498db; color: white; }
        .btn-primary:hover { background: #2980b9; }
        .btn-success { background: #27ae60; color: white; }
        .btn-success:hover { background: #2ecc71; }
        .btn-warning { background: #f39c12; color: white; }
        .btn-warning:hover { background: #e67e22; }
        .btn-danger { background: #e74c3c; color: white; }
        .btn-danger:hover { background: #c0392b; }
        .btn-google { background: #4285f4; color: white; }
        .btn-google:hover { background: #3367d6; }
        
        /* Competitive Intelligence */
        .comp-intel { background: #0f1a33; border: 1px solid #2a3a5c; border-radius: 10px; padding: 20px; margin-bottom: 20px; }
        .competitor-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; margin-top: 15px; }
        .competitor-card { background: #1a2744; border: 1px solid #2a3a5c; border-radius: 8px; padding: 15px; }
        
        .notification { position: fixed; top: 20px; right: 20px; background: #3498db; color: white; padding: 15px 20px; border-radius: 8px; z-index: 10000; max-width: 350px; box-shadow: 0 4px 12px rgba(0,0,0,0.3); }
    </style>
</head>
<body>

<div class="container">
    <h1>Dual Brand Bid System</h1>
    <p class="subtitle">State Contracts (ATP) vs Commercial Projects (WSI) with Competitive Intelligence</p>

    <!-- BRAND SELECTION -->
    <div class="brand-toggle">
        <div class="brand-option atp" id="atpBrand" onclick="selectBrand('atp')">
            <div class="brand-name">Watts ATP Contractor</div>
            <div class="brand-desc">State Contracts & Government Bids</div>
            <div class="brand-type state">State Contract</div>
        </div>
        <div class="brand-option wsi" id="wsiBrand" onclick="selectBrand('wsi')">
            <div class="brand-name">Watts Safety Installs</div>
            <div class="brand-desc">Commercial & Residential Projects</div>
            <div class="brand-type commercial">Commercial</div>
        </div>
    </div>

    <!-- STATE CONTRACT RESTRICTIONS (ATP only) -->
    <div class="card" id="stateRestrictions" style="display: none;">
        <h2><span class="icon">üîí</span> State Contract Restrictions</h2>
        <div class="state-restrictions">
            <h4>Watts ATP Contractor - State Contract Guidelines</h4>
            <ul>
                <li>No material markups allowed - cost plus only</li>
                <li>Labor rates must be pre-approved and fixed</li>
                <li>All pricing must be fully transparent and auditable</li>
                <li>Competitive bidding requirements apply</li>
                <li>Prevailing wage requirements may apply</li>
                <li>Bonding and insurance minimums required</li>
            </ul>
        </div>
    </div>

    <!-- COMPETITIVE INTELLIGENCE -->
    <div class="card">
        <h2><span class="icon">üéØ</span> Competitive Intelligence</h2>
        
        <!-- Google Intelligence Integration -->
        <div class="comp-intel" style="margin-bottom: 20px;">
            <h3 style="color: #3498db; margin-bottom: 15px;">üîç Google Intelligence Data</h3>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 15px;">
                <button class="btn btn-primary" onclick="importGoogleIntelligence('drive')">üìÅ Import Drive Data</button>
                <button class="btn btn-primary" onclick="importGoogleIntelligence('gmail')">üìß Import Gmail Data</button>
                <button class="btn btn-primary" onclick="importGoogleIntelligence('financials')">üìä Import Financials</button>
                <button class="btn btn-primary" onclick="importGoogleIntelligence('wave')">üåä Import Wave Data</button>
            </div>
            <div id="googleIntelStatus" style="padding: 10px; background: #0f1a33; border-radius: 6px; font-size: 12px; color: #7f8c8d;">
                Click above to import intelligence data from Google scans
            </div>
        </div>
        
        <div class="competitor-grid" id="competitorGrid">
            <!-- Competitor cards will be populated here -->
        </div>
    </div>

    <!-- BID INPUT -->
    <div class="card">
        <h2><span class="icon">üìù</span> Project Details</h2>
        <div class="form-grid">
            <div class="form-group full">
                <label>Project Type</label>
                <select id="projectType" onchange="updateProjectType()">
                    <option value="">Select Project Type...</option>
                    <option value="state">State Contract</option>
                    <option value="commercial">Commercial</option>
                    <option value="residential">Residential</option>
                    <option value="municipal">Municipal</option>
                </select>
            </div>
            <div class="form-group">
                <label>Project Name/ID</label>
                <input type="text" id="projectName" placeholder="e.g. Norfolk City Hall - Bathroom Renovation">
            </div>
            <div class="form-group">
                <label>Location</label>
                <input type="text" id="projectLocation" placeholder="e.g. Norfolk, NE">
            </div>
            <div class="form-group">
                <label>Square Footage</label>
                <input type="number" id="projectSqft" placeholder="e.g. 1500">
            </div>
            <div class="form-group">
                <label>Project Duration (days)</label>
                <input type="number" id="projectDuration" placeholder="e.g. 15">
            </div>
            <div class="form-group">
                <label>Bid Due Date</label>
                <input type="date" id="bidDueDate">
            </div>
        </div>
    </div>

    <!-- ACTIONS -->
    <div style="display: flex; gap: 15px; margin-top: 30px; flex-wrap: wrap;">
        <button class="btn btn-primary" onclick="analyzeBid()">üß† Analyze Competition</button>
        <button class="btn btn-success" onclick="generateBid()">üìÑ Generate Bid Document</button>
        <button class="btn btn-warning" onclick="saveToHistory()">üíæ Save to History</button>
        <button class="btn btn-secondary" onclick="exportAnalysis()">üìä Export Analysis</button>
    </div>
</div>

<script>
// Firebase configuration - SINGLE DECLARATION
const firebaseConfig = {
    apiKey: "YOUR_FIREBASE_API_KEY_HERE",
    authDomain: "wattsatpcontractor.firebaseapp.com",
    databaseURL: "https://wattsatpcontractor-default-rtdb.firebaseio.com",
    projectId: "wattsatpcontractor",
    storageBucket: "wattsatpcontractor.appspot.com",
    messagingSenderId: "1059217531358"
};

// Initialize Firebase - SINGLE INITIALIZATION
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

// Global variables - SINGLE DECLARATION
let currentBrand = '';
let bidHistory = [];
let predictiveModel = {
    avgTotalCost: 0,
    avgLaborCost: 0,
    avgMaterialCost: 0,
    avgDuration: 0,
    winRate: 0
};

// Brand configurations
const brandConfigs = {
    atp: {
        name: "Watts ATP Contractor",
        type: "state",
        allowMarkup: false,
        laborRates: "fixed",
        materialPricing: "cost-plus",
        restrictions: true,
        color: "#e67e22",
        maxStatePayout: 10000,
        hardCap: false,
        scopeMultiplier: 1.25
    },
    wsi: {
        name: "Watts Safety Installs", 
        type: "commercial",
        allowMarkup: true,
        laborRates: "market",
        materialPricing: "retail",
        restrictions: false,
        color: "#27ae60",
        maxStatePayout: null,
        hardCap: false,
        scopeMultiplier: 1.0
    }
};

// Initialize
document.addEventListener('DOMContentLoaded', () => {
    loadBidHistory();
    loadCompetitorData();
    setupFileUpload();
    
    // AUTO SCAN: Automatically scan for ATP files on load
    autoScanGoogleIntelligence();
    
    // AUTO IMPORT: Automatically import latest intelligence
    autoImportLatestIntelligence();
});

// Brand selection - MAIN FUNCTION
function selectBrand(brand) {
    console.log(`üéØ Selected brand: ${brand}`);
    currentBrand = brand;
    
    // Update UI
    document.querySelectorAll('.brand-option').forEach(option => {
        option.classList.remove('active');
    });
    document.getElementById(`${brand}Brand`).classList.add('active');
    
    // Show/hide state restrictions for ATP
    const stateRestrictions = document.getElementById('stateRestrictions');
    if (brand === 'atp') {
        stateRestrictions.style.display = 'block';
        console.log('üîí State restrictions shown for ATP');
    } else {
        stateRestrictions.style.display = 'none';
        console.log('üè¢ Commercial mode for WSI');
    }
    
    // Update form fields for brand
    updateFormForBrand(brand);
    
    // Load brand-specific intelligence
    loadBrandIntelligence(brand);
    
    // Update predictive model for brand
    updatePredictiveModelForBrand(brand);
}

// Import Google Intelligence Data
function importGoogleIntelligence(source) {
    const statusDiv = document.getElementById('googleIntelStatus');
    statusDiv.innerHTML = `üîÑ Importing ${source} intelligence data...`;
    statusDiv.style.color = '#f39c12';
    
    // Get stored Google scan results from localStorage
    const storedResults = localStorage.getItem('googleScanResults');
    if (!storedResults) {
        statusDiv.innerHTML = `‚ùå No Google scan data found. Please run Google scans first.`;
        statusDiv.style.color = '#e74c3c';
        return;
    }
    
    try {
        const scanData = JSON.parse(storedResults);
        const sourceData = scanData[source];
        
        if (!sourceData || !sourceData.atpItems || sourceData.atpItems.length === 0) {
            statusDiv.innerHTML = `‚ùå No ${source} data found. Please scan ${source} first.`;
            statusDiv.style.color = '#e74c3c';
            return;
        }
        
        // Process and integrate the data
        processGoogleIntelligence(source, sourceData);
        
        statusDiv.innerHTML = `‚úÖ Successfully imported ${sourceData.atpItems.length} items from ${source}`;
        statusDiv.style.color = '#27ae60';
        
        // Update bid calculations with new intelligence
        updateBidCalculationsWithIntelligence(sourceData);
        
    } catch (error) {
        console.error('Error importing Google intelligence:', error);
        statusDiv.innerHTML = `‚ùå Error importing ${source} data: ${error.message}`;
        statusDiv.style.color = '#e74c3c';
    }
}

// Add all missing functions that are referenced in the HTML
function analyzeBid() {
    console.log('üß† Analyzing competition...');
    const projectData = gatherProjectData();
    
    if (!projectData) {
        showNotification('‚ùå Please enter project details first', 'error');
        return;
    }
    
    // Run predictive analysis
    const analysis = runPredictiveAnalysis(projectData);
    
    // Display results
    displayAnalysisResults(analysis);
    
    showNotification('‚úÖ Competition analysis complete', 'success');
}

function generateBid() {
    console.log('üìÑ Generating bid document...');
    
    if (!currentBrand) {
        showNotification('‚ùå Please select a brand first', 'error');
        return;
    }
    
    const projectData = gatherProjectData();
    if (!projectData) {
        showNotification('‚ùå Please enter project details first', 'error');
        return;
    }
    
    // Generate bid based on brand and project data
    const bidDocument = generateBidDocument(currentBrand, projectData);
    
    // Display or download the bid
    displayBidDocument(bidDocument);
    
    showNotification('‚úÖ Bid document generated successfully', 'success');
}

function saveToHistory() {
    console.log('üíæ Saving to history...');
    
    const projectData = gatherProjectData();
    if (!projectData) {
        showNotification('‚ùå No project data to save', 'error');
        return;
    }
    
    // Save to Firebase
    const userPIN = sessionStorage.getItem('bid_pin');
    if (userPIN) {
        const hashed = hashPIN(userPIN);
        const bidData = {
            ...projectData,
            brand: currentBrand,
            timestamp: new Date().toISOString(),
            id: 'bid_' + Date.now()
        };
        
        db.ref(`users/${hashed}/bidHistory`).push(bidData)
            .then(() => {
                showNotification('‚úÖ Bid saved to history', 'success');
            })
            .catch(error => {
                console.error('Error saving to history:', error);
                showNotification('‚ùå Failed to save to history', 'error');
            });
    } else {
        showNotification('‚ùå Please set up your PIN first', 'error');
    }
}

function exportAnalysis() {
    console.log('üìä Exporting analysis...');
    
    // Generate analysis report
    const analysisData = generateAnalysisReport();
    
    // Create and download the report
    const blob = new Blob([analysisData], { type: 'text/plain' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `bid-analysis-${new Date().toISOString().split('T')[0]}.txt`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    window.URL.revokeObjectURL(url);
    
    showNotification('‚úÖ Analysis exported successfully', 'success');
}

// Helper functions
function gatherProjectData() {
    return {
        projectName: document.getElementById('projectName')?.value || '',
        location: document.getElementById('projectLocation')?.value || '',
        sqft: parseFloat(document.getElementById('projectSqft')?.value) || 0,
        duration: parseInt(document.getElementById('projectDuration')?.value) || 0,
        bidDueDate: document.getElementById('bidDueDate')?.value || '',
        projectType: document.getElementById('projectType')?.value || '',
        brand: currentBrand
    };
}

function runPredictiveAnalysis(projectData) {
    // Simple predictive analysis
    return {
        winProbability: calculateWinProbability(projectData),
        recommendedPrice: calculateRecommendedPrice(projectData),
        competitorThreat: assessCompetitorThreat(projectData),
        marketPosition: determineMarketPosition(projectData)
    };
}

function calculateWinProbability(projectData) {
    // Base probability
    let probability = 0.65;
    
    // Adjust for brand
    if (projectData.brand === 'atp') {
        probability *= 0.9; // State contracts more competitive
    } else {
        probability *= 1.1; // Commercial more flexible
    }
    
    return Math.min(Math.max(probability, 0.1), 0.95);
}

function calculateRecommendedPrice(projectData) {
    // Simple price calculation
    const basePrice = projectData.sqft * 150; // $150 per sqft base
    const complexityMultiplier = projectData.duration > 30 ? 1.2 : 1.0;
    
    return basePrice * complexityMultiplier;
}

function assessCompetitorThreat(projectData) {
    // Simple threat assessment
    return 'medium'; // Would be calculated from actual competitor data
}

function determineMarketPosition(projectData) {
    return 'competitive'; // Would be calculated from market data
}

function displayAnalysisResults(analysis) {
    // Display analysis results in UI
    console.log('Analysis results:', analysis);
}

function generateBidDocument(brand, projectData) {
    // Generate bid document content
    return {
        brand: brand,
        projectData: projectData,
        analysis: runPredictiveAnalysis(projectData),
        timestamp: new Date().toISOString()
    };
}

function displayBidDocument(bidDocument) {
    // Display or download bid document
    console.log('Bid document:', bidDocument);
}

function generateAnalysisReport() {
    // Generate text report
    return `
BID ANALYSIS REPORT
==================
Date: ${new Date().toLocaleString()}
Brand: ${currentBrand || 'Not selected'}
Analysis: Predictive bid analysis completed

RECOMMENDATIONS:
- Review competitor pricing
- Consider market conditions
- Optimize for win probability

Generated by Watts ATP Contractor System
    `;
}

function showNotification(message, type) {
    // Create notification element
    const notification = document.createElement('div');
    notification.className = 'notification';
    notification.style.background = type === 'success' ? '#27ae60' : type === 'error' ? '#e74c3c' : '#3498db';
    notification.innerHTML = message;
    document.body.appendChild(notification);
    
    // Auto-remove after 5 seconds
    setTimeout(() => {
        if (notification.parentNode) {
            notification.parentNode.removeChild(notification);
        }
    }, 5000);
}

// Placeholder functions for auto-scan functionality
function autoScanGoogleIntelligence() {
    console.log('üîç Auto-scanning Google Intelligence...');
    // Implementation would go here
}

function autoImportLatestIntelligence() {
    console.log('üì• Auto-importing latest intelligence...');
    // Implementation would go here
}

function loadBidHistory() {
    console.log('üìã Loading bid history...');
    // Implementation would go here
}

function loadCompetitorData() {
    console.log('üè¢ Loading competitor data...');
    // Implementation would go here
}

function setupFileUpload() {
    console.log('üìÅ Setting up file upload...');
    // Implementation would go here
}

function updateFormForBrand(brand) {
    console.log(`üîÑ Updating form for ${brand}...`);
    // Implementation would go here
}

function loadBrandIntelligence(brand) {
    console.log(`üìä Loading intelligence for ${brand}...`);
    // Implementation would go here
}

function updatePredictiveModelForBrand(brand) {
    console.log(`üß† Updating predictive model for ${brand}...`);
    // Implementation would go here
}

function processGoogleIntelligence(source, data) {
    console.log(`üîÑ Processing ${source} intelligence...`);
    // Implementation would go here
}

function updateBidCalculationsWithIntelligence(data) {
    console.log('üí∞ Updating bid calculations with intelligence...');
    // Implementation would go here
}

function hashPIN(pin) {
    let h = 0;
    for (let i = 0; i < pin.length; i++) {
        h = ((h << 5) - h) + pin.charCodeAt(i);
        h |= 0;
    }
    return 'u' + Math.abs(h).toString(36);
}

</script>

</body>
</html>
