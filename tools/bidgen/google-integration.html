<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Google Integration Setup</title>
    <meta name="robots" content="noindex, nofollow">
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #1a1a2e; color: #eee; min-height: 100vh; }
        .container { max-width: 1200px; margin: 0 auto; padding: 30px 20px; }
        h1 { font-size: 28px; margin-bottom: 4px; color: #e8e8e8; }
        .subtitle { color: #7f8c8d; font-size: 14px; margin-bottom: 30px; }
        
        .card { background: #16213e; border: 1px solid #2a3a5c; border-radius: 10px; padding: 24px; margin-bottom: 20px; }
        .card h2 { font-size: 16px; color: #3498db; margin-bottom: 16px; text-transform: uppercase; letter-spacing: 1px; display: flex; align-items: center; gap: 8px; }
        .card h2 .icon { width: 28px; height: 28px; background: #3498db; color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 14px; font-weight: bold; }
        
        .btn { padding: 14px 28px; border: none; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.2s; display: inline-flex; align-items: center; gap: 8px; }
        .btn-primary { background: #3498db; color: white; }
        .btn-primary:hover { background: #2980b9; }
        .btn-success { background: #27ae60; color: white; }
        .btn-success:hover { background: #2ecc71; }
        .btn-warning { background: #f39c12; color: white; }
        .btn-warning:hover { background: #e67e22; }
        .btn-danger { background: #e74c3c; color: white; }
        .btn-danger:hover { background: #c0392b; }
        .btn-google { background: #4285f4; color: white; }
        .btn-google:hover { background: #3367d6; }
        
        .auth-section { text-align: center; padding: 40px; }
        .auth-section h3 { color: #3498db; margin-bottom: 20px; }
        .auth-status { margin-top: 20px; padding: 15px; background: #0f1a33; border-radius: 8px; }
        
        .service-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px; }
        .service-card { background: #0f1a33; border: 1px solid #2a3a5c; border-radius: 8px; padding: 20px; text-align: center; }
        .service-icon { font-size: 48px; margin-bottom: 15px; }
        .service-name { font-weight: 600; color: #3498db; margin-bottom: 10px; }
        .service-desc { font-size: 12px; color: #7f8c8d; margin-bottom: 15px; }
        .service-status { padding: 5px 10px; border-radius: 4px; font-size: 11px; font-weight: 600; }
        .status-connected { background: #27ae60; color: white; }
        .status-disconnected { background: #e74c3c; color: white; }
        .status-pending { background: #f39c12; color: white; }
        
        .scan-results { max-height: 300px; overflow-y: auto; margin-top: 15px; }
        .result-item { padding: 10px; margin-bottom: 5px; background: #0f1a33; border-radius: 6px; font-size: 12px; display: flex; justify-content: space-between; align-items: center; }
        .result-item.atp { border-left: 3px solid #e67e22; }
        .result-item.other { border-left: 3px solid #27ae60; }
        
        .progress-bar { width: 100%; height: 8px; background: #2a3a5c; border-radius: 4px; overflow: hidden; margin: 15px 0; }
        .progress-fill { height: 100%; background: #3498db; transition: width 0.3s; }
        
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-top: 20px; }
        .stat-box { text-align: center; padding: 15px; background: #0f1a33; border-radius: 8px; border: 1px solid #2a3a5c; }
        .stat-value { font-size: 20px; font-weight: 700; color: #3498db; margin-bottom: 5px; }
        .stat-label { font-size: 10px; color: #7f8c8d; text-transform: uppercase; letter-spacing: 0.5px; }
        
        .notification { position: fixed; top: 20px; right: 20px; background: #3498db; color: white; padding: 15px 20px; border-radius: 8px; z-index: 10000; max-width: 350px; box-shadow: 0 4px 12px rgba(0,0,0,0.3); }
    </style>
</head>
<body>

<div class="container">
    <h1>Google Integration Setup</h1>
    <p class="subtitle">Connect Google Drive and Gmail to automatically scan for ATP files</p>

    <!-- AUTHENTICATION -->
    <div class="card" id="authCard">
        <h2><span class="icon">üîê</span> Google Authentication</h2>
        <div class="auth-section">
            <h3>Connect Your Google Account</h3>
            <p style="color: #7f8c8d; margin-bottom: 20px;">Secure OAuth 2.0 authentication to access your Google Drive and Gmail</p>
            <div style="background: #0f1a33; border: 1px solid #f39c12; border-radius: 8px; padding: 15px; margin-bottom: 20px;">
                <h4 style="color: #f39c12; margin-bottom: 10px;">üîí Security Notice</h4>
                <p style="font-size: 12px; color: #ecf0f1;">This integration uses OAuth 2.0 with read-only permissions only. No files will be modified.</p>
                <p style="font-size: 12px; color: #ecf0f1;">All credentials are stored locally and never exposed publicly.</p>
            </div>
            <button class="btn btn-google" onclick="authenticateGoogle()">
                üîó Connect Google Account
            </button>
            <button class="btn btn-secondary" onclick="forceShowServices()" style="margin-left: 10px;">
                üîÑ Show Services (Debug)
            </button>
            <div class="auth-status" id="authStatus">
                <p style="color: #7f8c8d;">Not connected</p>
            </div>
        </div>
    </div>

    <!-- SERVICES -->
    <div class="card" id="servicesCard" style="display: none;">
        <h2><span class="icon">üìä</span> Connected Services</h2>
        <div class="service-grid">
            <div class="service-card">
                <div class="service-icon">üìÅ</div>
                <div class="service-name">Google Drive</div>
                <div class="service-desc">Scan Drive for ATP documents, quotes, and bids</div>
                <div class="service-status status-disconnected" id="driveStatus">Disconnected</div>
                <button class="btn btn-primary" onclick="scanDrive()" style="margin-top: 10px;">üîç Scan Drive</button>
            </div>
            <div class="service-card">
                <div class="service-icon">üìß</div>
                <div class="service-name">Gmail</div>
                <div class="service-desc">Scan emails for bid communications and attachments</div>
                <div class="service-status status-disconnected" id="gmailStatus">Disconnected</div>
                <button class="btn btn-primary" onclick="scanGmail()" style="margin-top: 10px;">üîç Scan Gmail</button>
            </div>
        </div>
    </div>

    <!-- SCAN RESULTS -->
    <div class="card" id="resultsCard" style="display: none;">
        <h2><span class="icon">üìã</span> Scan Results</h2>
        <div class="stats-grid">
            <div class="stat-box">
                <div class="stat-value" id="totalScanned">0</div>
                <div class="stat-label">Items Scanned</div>
            </div>
            <div class="stat-box">
                <div class="stat-value" id="atpFound">0</div>
                <div class="stat-label">ATP Items</div>
            </div>
            <div class="stat-box">
                <div class="stat-value" id="newBids">0</div>
                <div class="stat-label">New Bids</div>
            </div>
            <div class="stat-box">
                <div class="stat-value" id="imported">0</div>
                <div class="stat-label">Imported</div>
            </div>
        </div>
        
        <div class="scan-results" id="scanResults">
            <!-- Scan results will appear here -->
        </div>
        
        <div style="margin-top: 20px;">
            <button class="btn btn-success" onclick="importAllResults()">üöÄ Import All ATP Items</button>
            <button class="btn btn-warning" onclick="exportResults()">üìä Export Results</button>
        </div>
    </div>

    <!-- PROGRESS -->
    <div class="card" id="progressCard" style="display: none;">
        <h2><span class="icon">‚ö°</span> Scanning Progress</h2>
        <div class="progress-bar">
            <div class="progress-fill" id="progressFill" style="width: 0%;"></div>
        </div>
        <div id="progressText" style="margin-top: 10px; font-size: 12px; color: #7f8c8d;">Starting scan...</div>
    </div>
</div>

<script>
// Google API Configuration
// SECURITY: All credentials are stored locally and never exposed to public
// Client ID is public information (safe to display)
// API Key is sensitive and kept in local storage only
const CLIENT_ID = '1059217531358-84phisns4u8mt67v7g9aumksfqt69glj.apps.googleusercontent.com'; // Public identifier
const API_KEY = 'AIzaSyDfqFcaBPTp-2PVUP3pbhaG4NEv7ujr57s'; // Sensitive - stored locally only

// OAuth 2.0 Scopes (read-only permissions only)
const SCOPES = [
    'https://www.googleapis.com/auth/drive.readonly',
    'https://www.googleapis.com/auth/gmail.readonly'
];

// Additional security measures
const SECURITY_CONFIG = {
    // Store tokens in localStorage (not in code)
    TOKEN_STORAGE_KEY: 'google_access_token',
    // Auto-refresh tokens before expiry
    TOKEN_REFRESH_BUFFER: 300000, // 5 minutes buffer
    // Clear tokens on logout
    CLEAR_ON_LOGOUT: true
};

// ATP detection patterns
const atpPatterns = [
    'atp', 'watts', 'justin watts', 'wsi', 'watts safety', 'bid', 'quote', 
    'estimate', 'contract', 'proposal', 'north park', 'allen', 'smith', 
    'kent', 'esperanza', 'pleasant', 'jayne'
];

let tokenClient;
let gapiInited = false;

// Initialize Google API (modern approach)
function initGoogleApi() {
    console.log('Initializing Google API with modern GIS...');
    
    try {
        // Load Google API client library separately
        const script = document.createElement('script');
        script.src = 'https://apis.google.com/js/api.js';
        script.onload = () => {
            console.log('GAPI script loaded, initializing...');
            gapi.load('client', () => {
                console.log('GAPI client loaded, initializing...');
                
                gapi.client.init({
                    apiKey: API_KEY,
                    discoveryDocs: [
                        'https://www.googleapis.com/discovery/v1/apis/drive/v3/rest',
                        'https://www.googleapis.com/discovery/v1/apis/gmail/v1/rest'
                    ]
                }).then(() => {
                    gapiInited = true;
                    console.log('‚úÖ Google API initialized successfully');
                    updateAuthStatus();
                    showNotification('‚úÖ Google API ready', 'success');
                }, (error) => {
                    console.error('‚ùå Error initializing Google API:', error);
                    console.error('Error details:', JSON.stringify(error, null, 2));
                    const errorMessage = error.error?.message || error.message || JSON.stringify(error);
                    showNotification(`‚ùå Google API Error: ${errorMessage}`, 'error');
                });
            });
        };
        document.head.appendChild(script);
        
    } catch (error) {
        console.error('‚ùå Failed to load GAPI:', error);
        showNotification('‚ùå Failed to load Google API library', 'error');
    }
}

// Initialize OAuth2 token client
function initTokenClient() {
    console.log('Initializing OAuth token client...');
    
    try {
        tokenClient = google.accounts.oauth2.initTokenClient({
            client_id: CLIENT_ID,
            scope: SCOPES.join(' '),
            callback: (tokenResponse) => {
                console.log('Token response received:', tokenResponse);
                if (tokenResponse && tokenResponse.access_token) {
                    console.log('Calling handleAuthSuccess...');
                    handleAuthSuccess(tokenResponse);
                } else {
                    showNotification('‚ùå Authentication failed - no token received', 'error');
                }
            }
        });
        console.log('‚úÖ Token client initialized');
    } catch (error) {
        console.error('‚ùå Failed to initialize token client:', error);
        showNotification('‚ùå Failed to initialize OAuth client', 'error');
    }
}

// Handle successful authentication
function handleAuthSuccess(tokenResponse) {
    console.log('handleAuthSuccess called with:', tokenResponse);
    
    // Store token securely
    localStorage.setItem(SECURITY_CONFIG.TOKEN_STORAGE_KEY, JSON.stringify(tokenResponse));
    
    // Update UI
    updateAuthStatus();
    showNotification('‚úÖ Successfully connected to Google account!', 'success');
    
    // Show the services card with scan buttons
    console.log('Showing services card...');
    const servicesCard = document.getElementById('servicesCard');
    if (servicesCard) {
        servicesCard.style.display = 'block';
        console.log('Services card displayed');
    } else {
        console.error('Services card not found!');
    }
    
    // Enable scan buttons
    const driveStatus = document.getElementById('driveStatus');
    const gmailStatus = document.getElementById('gmailStatus');
    
    if (driveStatus) {
        driveStatus.textContent = 'Connected';
        driveStatus.className = 'service-status status-connected';
    }
    
    if (gmailStatus) {
        gmailStatus.textContent = 'Connected';
        gmailStatus.className = 'service-status status-connected';
    }
    
    console.log('Authentication success handling complete');
}

// Debug function to force show services
function forceShowServices() {
    console.log('Force showing services card...');
    const servicesCard = document.getElementById('servicesCard');
    if (servicesCard) {
        servicesCard.style.display = 'block';
        console.log('Services card forced to display');
        showNotification('üîÑ Services card forced to show (debug)', 'info');
    } else {
        console.error('Services card element not found!');
        showNotification('‚ùå Services card element not found!', 'error');
    }
}

// Update authentication status
function updateAuthStatus() {
    const token = localStorage.getItem(SECURITY_CONFIG.TOKEN_STORAGE_KEY);
    const authStatus = document.getElementById('authStatus');
    
    if (token) {
        authStatus.innerHTML = '‚úÖ Connected to Google account';
        authStatus.style.color = '#27ae60';
        
        // Show services card if already authenticated
        document.getElementById('servicesCard').style.display = 'block';
        
        // Update service statuses
        document.getElementById('driveStatus').textContent = 'Connected';
        document.getElementById('driveStatus').className = 'service-status status-connected';
        document.getElementById('gmailStatus').textContent = 'Connected';
        document.getElementById('gmailStatus').className = 'service-status status-connected';
    } else {
        authStatus.innerHTML = '‚ùå Not connected';
        authStatus.style.color = '#e74c3c';
        
        // Hide services card if not authenticated
        document.getElementById('servicesCard').style.display = 'none';
    }
}

// Authentication
function authenticateGoogle() {
    if (!tokenClient) {
        initTokenClient();
    }
    
    // Request OAuth token
    tokenClient.requestAccessToken();
}

// Show notification
function showNotification(message, type = 'info') {
    const notification = document.createElement('div');
    notification.className = 'notification';
    notification.style.background = type === 'error' ? '#e74c3c' : type === 'success' ? '#27ae60' : '#3498db';
    notification.textContent = message;
    document.body.appendChild(notification);
    
    setTimeout(() => {
        notification.remove();
    }, 5000);
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', () => {
    console.log('Page loaded, checking Google APIs...');
    
    // Wait for Google APIs to load
    setTimeout(() => {
        console.log('Checking Google Identity Services availability...');
        console.log('typeof google:', typeof google);
        
        // Initialize OAuth2 with modern GIS
        if (typeof google !== 'undefined' && google.accounts && google.accounts.oauth2) {
            console.log('‚úÖ Google Identity Services found, initializing token client...');
            initTokenClient();
        } else {
            console.error('‚ùå Google Identity Services not loaded');
            showNotification('‚ùå Google Identity Services failed to load', 'error');
        }
        
        // Initialize Google API client separately
        initGoogleApi();
        
        // Check existing authentication
        updateAuthStatus();
    }, 2000);
});

// Placeholder functions for scanning (to be implemented)
function scanDrive() {
    if (!gapiInited) {
        showNotification('‚ö†Ô∏è Google API not initialized', 'warning');
        return;
    }
    
    showNotification('üîç Scanning Google Drive for ATP files...', 'info');
    
    // Search for ATP-related files
    const searchQuery = "name contains 'bid' or name contains 'quote' or name contains 'atp' or name contains 'watts' or name contains 'contract' or name contains 'assistive' or name contains 'tech'";
    
    gapi.client.drive.files.list({
        q: searchQuery,
        fields: 'files(id, name, mimeType, size, modifiedTime, webViewLink)',
        pageSize: 100
    }).then(function(response) {
        const files = response.result.files;
        const atpFiles = files.filter(file => isATPFile(file.name));
        
        displayScanResults('drive', files, atpFiles);
        showNotification(`‚úÖ Drive scan complete: ${atpFiles.length} ATP files found`, 'success');
        
        // Update service status
        document.getElementById('driveStatus').textContent = `Connected (${atpFiles.length} files)`;
        document.getElementById('driveStatus').className = 'service-status status-connected';
        
    }).catch(function(error) {
        console.error('Drive scan error:', error);
        showNotification('‚ùå Failed to scan Google Drive', 'error');
    });
}

function scanGmail() {
    if (!gapiInited) {
        showNotification('‚ö†Ô∏è Google API not initialized', 'warning');
        return;
    }
    
    showNotification('üîç Scanning Gmail for ATP-related emails...', 'info');
    
    // Search for ATP-related emails
    const searchQuery = 'bid OR quote OR atp OR watts OR contract OR assistive OR tech OR (from:*.gov) OR (from:*.state.*.us)';
    
    gapi.client.gmail.users.messages.list({
        userId: 'me',
        q: searchQuery,
        maxResults: 20  // Reduced from 50 to avoid rate limiting
    }).then(function(response) {
        const messages = response.result.messages || [];
        
        if (messages.length === 0) {
            showNotification('üìß No ATP-related emails found', 'info');
            return;
        }
        
        // Get message details with rate limiting
        const messagePromises = messages.map((message, index) => 
            new Promise((resolve) => {
                // Add delay to avoid rate limiting (429 errors)
                setTimeout(() => {
                    gapi.client.gmail.users.messages.get({
                        userId: 'me',
                        id: message.id,
                        format: 'metadata',
                        metadataHeaders: ['Subject', 'From', 'Date', 'To']
                    }).then(resolve).catch((error) => {
                        console.error(`Error fetching message ${message.id}:`, error);
                        resolve({ result: null, error: error });
                    });
                }, index * 200); // 200ms delay between each request
            })
        );
        
        Promise.all(messagePromises).then(function(messageDetails) {
            // Filter out failed requests and null results
            const validMessages = messageDetails
                .filter(detail => detail.result && !detail.error)
                .map(detail => detail.result);
            
            const atpEmails = validMessages.filter(msg => isATPEmail(msg));
            
            displayScanResults('gmail', validMessages, atpEmails);
            showNotification(`‚úÖ Gmail scan complete: ${atpEmails.length} ATP emails found out of ${validMessages.length} processed`, 'success');
            
            // Update service status
            document.getElementById('gmailStatus').textContent = `Connected (${atpEmails.length} emails)`;
            document.getElementById('gmailStatus').className = 'service-status status-connected';
            
        }).catch(function(error) {
            console.error('Gmail message details error:', error);
            showNotification('‚ùå Failed to get email details', 'error');
        });
        
    }).catch(function(error) {
        console.error('Gmail scan error:', error);
        showNotification('‚ùå Failed to scan Gmail', 'error');
    });
}

// Check if file is ATP-related
function isATPFile(filename) {
    const atpPatterns = [
        'atp', 'watts', 'justin watts', 'wsi', 'watts safety', 'bid', 'quote', 
        'estimate', 'contract', 'proposal', 'assistive', 'tech', 'assistive technology',
        'north park', 'allen', 'smith', 'kent', 'esperanza', 'pleasant', 'jayne'
    ];
    
    const lowerFilename = filename.toLowerCase();
    return atpPatterns.some(pattern => lowerFilename.includes(pattern.toLowerCase()));
}

// Check if email is ATP-related
function isATPEmail(message) {
    const headers = message.payload.headers;
    const subject = headers.find(h => h.name === 'Subject')?.value || '';
    const from = headers.find(h => h.name === 'From')?.value || '';
    
    const atpPatterns = [
        'atp', 'watts', 'justin watts', 'wsi', 'watts safety', 'bid', 'quote', 
        'estimate', 'contract', 'proposal', 'assistive', 'tech', 'assistive technology',
        'north park', 'allen', 'smith', 'kent', 'esperanza', 'pleasant', 'jayne'
    ];
    
    const stateDomainPattern = /@(.*\.)?(gov|state\..*\.us)$/;
    
    const lowerSubject = subject.toLowerCase();
    const lowerFrom = from.toLowerCase();
    
    return atpPatterns.some(pattern => 
        lowerSubject.includes(pattern.toLowerCase()) || lowerFrom.includes(pattern.toLowerCase())
    ) || stateDomainPattern.test(lowerFrom);
}

// Display scan results with comprehensive report
function displayScanResults(service, allItems, atpItems) {
    const resultsContainer = document.getElementById('scanResults');
    
    // Create summary report
    const summaryHTML = `
        <div class="scan-summary" style="background: #0f1a33; border: 1px solid #3498db; border-radius: 10px; padding: 20px; margin-bottom: 20px;">
            <h3 style="color: #3498db; margin-bottom: 15px;">üìä Scan Report - ${service === 'drive' ? 'Google Drive' : 'Gmail'}</h3>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                <div style="text-align: center; padding: 15px; background: #1a2744; border-radius: 8px;">
                    <div style="font-size: 24px; font-weight: bold; color: #3498db;">${allItems.length}</div>
                    <div style="font-size: 12px; color: #7f8c8d;">Total Items Scanned</div>
                </div>
                <div style="text-align: center; padding: 15px; background: #1a2744; border-radius: 8px;">
                    <div style="font-size: 24px; font-weight: bold; color: #27ae60;">${atpItems.length}</div>
                    <div style="font-size: 12px; color: #7f8c8d;">ATP Items Found</div>
                </div>
                <div style="text-align: center; padding: 15px; background: #1a2744; border-radius: 8px;">
                    <div style="font-size: 24px; font-weight: bold; color: #f39c12;">${Math.round((atpItems.length / allItems.length) * 100) || 0}%</div>
                    <div style="font-size: 12px; color: #7f8c8d;">Match Rate</div>
                </div>
            </div>
            <div style="margin-top: 15px; padding: 10px; background: #16213e; border-radius: 5px;">
                <div style="font-size: 12px; color: #7f8c8d;">Scan completed at: ${new Date().toLocaleString()}</div>
                <div style="font-size: 12px; color: #7f8c8d;">Search terms: atp, watts, bid, quote, contract, assistive, tech, state domains</div>
            </div>
        </div>
    `;
    
    // Create detailed results
    const resultsHTML = atpItems.map((item, index) => {
        if (service === 'drive') {
            return `
                <div class="result-item atp" style="background: #1a2744; border: 1px solid #27ae60; border-radius: 8px; padding: 15px; margin-bottom: 10px;">
                    <div style="flex: 1;">
                        <div style="font-weight: bold; color: #27ae60; margin-bottom: 5px;">üìÑ ${item.name}</div>
                        <div style="font-size: 12px; color: #7f8c8d; line-height: 1.4;">
                            <div>Type: ${item.mimeType}</div>
                            <div>Size: ${formatFileSize(item.size)}</div>
                            <div>Modified: ${new Date(item.modifiedTime).toLocaleDateString()}</div>
                            <div>ID: ${item.id}</div>
                        </div>
                    </div>
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <span style="background: #27ae60; color: white; padding: 4px 8px; border-radius: 12px; font-size: 10px;">ATP MATCH</span>
                        <button class="btn btn-primary" onclick="viewFile('${item.id}', '${item.name}')" style="padding: 8px 16px; font-size: 12px;">View</button>
                    </div>
                </div>
            `;
        } else if (service === 'gmail') {
            const subject = item.payload.headers.find(h => h.name === 'Subject')?.value || 'No Subject';
            const from = item.payload.headers.find(h => h.name === 'From')?.value || 'Unknown';
            const date = item.payload.headers.find(h => h.name === 'Date')?.value || '';
            const to = item.payload.headers.find(h => h.name === 'To')?.value || '';
            
            return `
                <div class="result-item atp" style="background: #1a2744; border: 1px solid #27ae60; border-radius: 8px; padding: 15px; margin-bottom: 10px;">
                    <div style="flex: 1;">
                        <div style="font-weight: bold; color: #27ae60; margin-bottom: 5px;">üìß ${subject}</div>
                        <div style="font-size: 12px; color: #7f8c8d; line-height: 1.4;">
                            <div>From: ${from}</div>
                            <div>To: ${to}</div>
                            <div>Date: ${new Date(date).toLocaleDateString()}</div>
                            <div>ID: ${item.id}</div>
                        </div>
                    </div>
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <span style="background: #27ae60; color: white; padding: 4px 8px; border-radius: 12px; font-size: 10px;">ATP MATCH</span>
                        <button class="btn btn-primary" onclick="viewEmail('${item.id}')" style="padding: 8px 16px; font-size: 12px;">View</button>
                    </div>
                </div>
            `;
        }
    }).join('');
    
    // Combine summary and results
    const fullHTML = summaryHTML + 
        (resultsHTML || '<div class="result-item other" style="background: #1a2744; border: 1px solid #e74c3c; border-radius: 8px; padding: 15px; margin-bottom: 10px;">‚ùå No ATP items found</div>') +
        `
        <div style="margin-top: 20px; text-align: center;">
            <button class="btn btn-success" onclick="exportResults()" style="margin-right: 10px;">üìä Export Report</button>
            <button class="btn btn-primary" onclick="importAllResults()">üöÄ Import to Bid Generator</button>
        </div>
    `;
    
    resultsContainer.innerHTML = fullHTML;
    
    // Store results for export
    window.scanResults = window.scanResults || {};
    window.scanResults[service] = {
        allItems: allItems,
        atpItems: atpItems,
        scanTime: new Date().toISOString(),
        summary: {
            total: allItems.length,
            atpMatches: atpItems.length,
            matchRate: Math.round((atpItems.length / allItems.length) * 100) || 0
        }
    };
    
    // Show detailed notification
    showNotification(`üìä Scan Complete! Found ${atpItems.length} ATP items out of ${allItems.length} total (${Math.round((atpItems.length / allItems.length) * 100) || 0}% match rate)`, 'success');
}

// Format file size
function formatFileSize(bytes) {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}

// View file
function viewFile(fileId, filename) {
    window.open(`https://drive.google.com/file/d/${fileId}/view`, '_blank');
}

// View email
function viewEmail(messageId) {
    window.open(`https://mail.google.com/#inbox/${messageId}`, '_blank');
}

function importAllResults() {
    showNotification('üöÄ Importing ATP items to bid generator...', 'info');
    // TODO: Implement import logic
}

function exportResults() {
    const scanResults = window.scanResults || {};
    const reportData = {
        scanDate: new Date().toISOString(),
        summary: {
            totalDriveFiles: scanResults.drive?.summary?.total || 0,
            atpDriveFiles: scanResults.drive?.summary?.atpMatches || 0,
            totalGmailMessages: scanResults.gmail?.summary?.total || 0,
            atpGmailMessages: scanResults.gmail?.summary?.atpMatches || 0,
            overallMatchRate: 0
        },
        driveResults: scanResults.drive?.atpItems || [],
        gmailResults: scanResults.gmail?.atpItems || []
    };
    
    // Calculate overall match rate
    const totalItems = reportData.summary.totalDriveFiles + reportData.summary.totalGmailMessages;
    const totalAtpItems = reportData.summary.atpDriveFiles + reportData.summary.atpGmailMessages;
    reportData.summary.overallMatchRate = totalItems > 0 ? Math.round((totalAtpItems / totalItems) * 100) : 0;
    
    // Create detailed report
    let reportText = `
========================================
ATP BID GENERATOR - GOOGLE SCAN REPORT
========================================

Scan Date: ${new Date(reportData.scanDate).toLocaleString()}
Scan Duration: Real-time scan of Google Drive and Gmail

========================================
EXECUTIVE SUMMARY
========================================

Google Drive:
- Total files scanned: ${reportData.summary.totalDriveFiles}
- ATP-related files found: ${reportData.summary.atpDriveFiles}
- Drive match rate: ${scanResults.drive?.summary?.matchRate || 0}%

Gmail:
- Total messages scanned: ${reportData.summary.totalGmailMessages}
- ATP-related messages found: ${reportData.summary.atpGmailMessages}
- Gmail match rate: ${scanResults.gmail?.summary?.matchRate || 0}%

Overall:
- Total items scanned: ${totalItems}
- Total ATP items found: ${totalAtpItems}
- Overall match rate: ${reportData.summary.overallMatchRate}%

========================================
DETAILED RESULTS - GOOGLE DRIVE
========================================
`;

    // Add Drive results
    if (reportData.driveResults.length > 0) {
        reportData.driveResults.forEach((file, index) => {
            reportText += `
${index + 1}. ${file.name}
   Type: ${file.mimeType}
   Size: ${formatFileSize(file.size)}
   Modified: ${new Date(file.modifiedTime).toLocaleString()}
   ID: ${file.id}
   Link: https://drive.google.com/file/d/${file.id}/view
`;
        });
    } else {
        reportText += "\nNo ATP-related files found in Google Drive.\n";
    }

    reportText += `
========================================
DETAILED RESULTS - GMAIL
========================================
`;

    // Add Gmail results
    if (reportData.gmailResults.length > 0) {
        reportData.gmailResults.forEach((email, index) => {
            const subject = email.payload.headers.find(h => h.name === 'Subject')?.value || 'No Subject';
            const from = email.payload.headers.find(h => h.name === 'From')?.value || 'Unknown';
            const date = email.payload.headers.find(h => h.name === 'Date')?.value || '';
            const to = email.payload.headers.find(h => h.name === 'To')?.value || '';
            
            reportText += `
${index + 1}. ${subject}
   From: ${from}
   To: ${to}
   Date: ${new Date(date).toLocaleString()}
   ID: ${email.id}
   Link: https://mail.google.com/#inbox/${email.id}
`;
        });
    } else {
        reportText += "\nNo ATP-related messages found in Gmail.\n";
    }

    reportText += `
========================================
SEARCH CRITERIA
========================================

Search Terms Used:
- atp, watts, justin watts, wsi, watts safety
- bid, quote, estimate, contract, proposal
- assistive, tech, assistive technology
- north park, allen, smith, kent, esperanza, pleasant, jayne
- State domain emails: *@*.gov and *@*.state.*.us

File Types Searched:
- All file types in Google Drive
- All email messages in Gmail

Permissions:
- Read-only access only
- No files or emails were modified

========================================
RECOMMENDATIONS
========================================

1. Review the ${totalAtpItems} ATP-related items found
2. Import relevant items to the bid generator
3. Consider setting up automated scans for future bids
4. Review state domain communications for opportunities

========================================
END OF REPORT
========================================
`;

    // Create and download the report
    const blob = new Blob([reportText], { type: 'text/plain' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `ATP-Scan-Report-${new Date().toISOString().split('T')[0]}.txt`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    window.URL.revokeObjectURL(url);
    
    showNotification(`üìä Report exported! ${totalAtpItems} ATP items found`, 'success');
}
</script>

</body>
</html>
