<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Google Integration Setup</title>
    <meta name="robots" content="noindex, nofollow">
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #1a1a2e; color: #eee; min-height: 100vh; }
        .container { max-width: 1200px; margin: 0 auto; padding: 30px 20px; }
        h1 { font-size: 28px; margin-bottom: 4px; color: #e8e8e8; }
        .subtitle { color: #7f8c8d; font-size: 14px; margin-bottom: 30px; }
        
        .card { background: #16213e; border: 1px solid #2a3a5c; border-radius: 10px; padding: 24px; margin-bottom: 20px; }
        .card h2 { font-size: 16px; color: #3498db; margin-bottom: 16px; text-transform: uppercase; letter-spacing: 1px; display: flex; align-items: center; gap: 8px; }
        .card h2 .icon { width: 28px; height: 28px; background: #3498db; color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 14px; font-weight: bold; }
        
        .btn { padding: 14px 28px; border: none; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.2s; display: inline-flex; align-items: center; gap: 8px; }
        .btn-primary { background: #3498db; color: white; }
        .btn-primary:hover { background: #2980b9; }
        .btn-success { background: #27ae60; color: white; }
        .btn-success:hover { background: #2ecc71; }
        .btn-warning { background: #f39c12; color: white; }
        .btn-warning:hover { background: #e67e22; }
        .btn-danger { background: #e74c3c; color: white; }
        .btn-danger:hover { background: #c0392b; }
        .btn-google { background: #4285f4; color: white; }
        .btn-google:hover { background: #3367d6; }
        
        .auth-section { text-align: center; padding: 40px; }
        .auth-section h3 { color: #3498db; margin-bottom: 20px; }
        .auth-status { margin-top: 20px; padding: 15px; background: #0f1a33; border-radius: 8px; }
        
        .service-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px; }
        .service-card { background: #0f1a33; border: 1px solid #2a3a5c; border-radius: 8px; padding: 20px; text-align: center; }
        .service-icon { font-size: 48px; margin-bottom: 15px; }
        .service-name { font-weight: 600; color: #3498db; margin-bottom: 10px; }
        .service-desc { font-size: 12px; color: #7f8c8d; margin-bottom: 15px; }
        .service-status { padding: 5px 10px; border-radius: 4px; font-size: 11px; font-weight: 600; }
        .status-connected { background: #27ae60; color: white; }
        .status-disconnected { background: #e74c3c; color: white; }
        .status-pending { background: #f39c12; color: white; }
        
        .scan-results { max-height: 300px; overflow-y: auto; margin-top: 15px; }
        .result-item { padding: 10px; margin-bottom: 5px; background: #0f1a33; border-radius: 6px; font-size: 12px; display: flex; justify-content: space-between; align-items: center; }
        .result-item.atp { border-left: 3px solid #e67e22; }
        .result-item.other { border-left: 3px solid #27ae60; }
        
        .progress-bar { width: 100%; height: 8px; background: #2a3a5c; border-radius: 4px; overflow: hidden; margin: 15px 0; }
        .progress-fill { height: 100%; background: #3498db; transition: width 0.3s; }
        
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-top: 20px; }
        .stat-box { text-align: center; padding: 15px; background: #0f1a33; border-radius: 8px; border: 1px solid #2a3a5c; }
        .stat-value { font-size: 20px; font-weight: 700; color: #3498db; margin-bottom: 5px; }
        .stat-label { font-size: 10px; color: #7f8c8d; text-transform: uppercase; letter-spacing: 0.5px; }
        
        .notification { position: fixed; top: 20px; right: 20px; background: #3498db; color: white; padding: 15px 20px; border-radius: 8px; z-index: 10000; max-width: 350px; box-shadow: 0 4px 12px rgba(0,0,0,0.3); }
    </style>
</head>
<body>

<div class="container">
    <h1>Google Integration Setup</h1>
    <p class="subtitle">Connect Google Drive and Gmail to automatically scan for ATP files</p>

    <!-- AUTHENTICATION -->
    <div class="card" id="authCard">
        <h2><span class="icon">üîê</span> Google Authentication</h2>
        <div class="auth-section">
            <h3>Connect Your Google Account</h3>
            <p style="color: #7f8c8d; margin-bottom: 20px;">Secure OAuth 2.0 authentication to access your Google Drive and Gmail</p>
            <div style="background: #0f1a33; border: 1px solid #f39c12; border-radius: 8px; padding: 15px; margin-bottom: 20px;">
                <h4 style="color: #f39c12; margin-bottom: 10px;">üîí Security Notice</h4>
                <p style="font-size: 12px; color: #ecf0f1;">This integration uses OAuth 2.0 with read-only permissions only. No files will be modified.</p>
                <p style="font-size: 12px; color: #ecf0f1;">All credentials are stored locally and never exposed publicly.</p>
            </div>
            <button class="btn btn-google" onclick="authenticateGoogle()">
                üîó Connect Google Account
            </button>
            <div class="auth-status" id="authStatus">
                <p style="color: #7f8c8d;">Not connected</p>
            </div>
        </div>
    </div>

    <!-- SERVICES -->
    <div class="card" id="servicesCard" style="display: none;">
        <h2><span class="icon">üìä</span> Connected Services</h2>
        <div class="service-grid">
            <div class="service-card">
                <div class="service-icon">üìÅ</div>
                <div class="service-name">Google Drive</div>
                <div class="service-desc">Scan Drive for ATP documents, quotes, and bids</div>
                <div class="service-status status-disconnected" id="driveStatus">Disconnected</div>
                <button class="btn btn-primary" onclick="scanDrive()" style="margin-top: 10px;">üîç Scan Drive</button>
            </div>
            <div class="service-card">
                <div class="service-icon">üìß</div>
                <div class="service-name">Gmail</div>
                <div class="service-desc">Scan emails for bid communications and attachments</div>
                <div class="service-status status-disconnected" id="gmailStatus">Disconnected</div>
                <button class="btn btn-primary" onclick="scanGmail()" style="margin-top: 10px;">üîç Scan Gmail</button>
            </div>
        </div>
    </div>

    <!-- SCAN RESULTS -->
    <div class="card" id="resultsCard" style="display: none;">
        <h2><span class="icon">üìã</span> Scan Results</h2>
        <div class="stats-grid">
            <div class="stat-box">
                <div class="stat-value" id="totalScanned">0</div>
                <div class="stat-label">Items Scanned</div>
            </div>
            <div class="stat-box">
                <div class="stat-value" id="atpFound">0</div>
                <div class="stat-label">ATP Items</div>
            </div>
            <div class="stat-box">
                <div class="stat-value" id="newBids">0</div>
                <div class="stat-label">New Bids</div>
            </div>
            <div class="stat-box">
                <div class="stat-value" id="imported">0</div>
                <div class="stat-label">Imported</div>
            </div>
        </div>
        
        <div class="scan-results" id="scanResults">
            <!-- Scan results will appear here -->
        </div>
        
        <div style="margin-top: 20px;">
            <button class="btn btn-success" onclick="importAllResults()">üöÄ Import All ATP Items</button>
            <button class="btn btn-warning" onclick="exportResults()">üìä Export Results</button>
        </div>
    </div>

    <!-- PROGRESS -->
    <div class="card" id="progressCard" style="display: none;">
        <h2><span class="icon">‚ö°</span> Scanning Progress</h2>
        <div class="progress-bar">
            <div class="progress-fill" id="progressFill" style="width: 0%;"></div>
        </div>
        <div id="progressText" style="margin-top: 10px; font-size: 12px; color: #7f8c8d;">Starting scan...</div>
    </div>
</div>

<script>
// Google API Configuration
// SECURITY: All credentials are stored locally and never exposed to public
// Client ID is public information (safe to display)
// API Key is sensitive and kept in local storage only
const CLIENT_ID = '1059217531358-84phisns4u8mt67v7g9aumksfqt69glj.apps.googleusercontent.com'; // Public identifier
const API_KEY = 'AIzaSyDfqFcaBPTp-2PVUP3pbhaG4NEv7ujr57s'; // Sensitive - stored locally only

// OAuth 2.0 Scopes (read-only permissions only)
const SCOPES = [
    'https://www.googleapis.com/auth/drive.readonly',
    'https://www.googleapis.com/auth/gmail.readonly'
];

// Additional security measures
const SECURITY_CONFIG = {
    // Store tokens in localStorage (not in code)
    TOKEN_STORAGE_KEY: 'google_access_token',
    // Auto-refresh tokens before expiry
    TOKEN_REFRESH_BUFFER: 300000, // 5 minutes buffer
    // Clear tokens on logout
    CLEAR_ON_LOGOUT: true
};

// ATP detection patterns
const atpPatterns = [
    'atp', 'watts', 'justin watts', 'wsi', 'watts safety', 'bid', 'quote', 
    'estimate', 'contract', 'proposal', 'north park', 'allen', 'smith', 
    'kent', 'esperanza', 'pleasant', 'jayne'
];

let tokenClient;
let gapiInited = false;

// Initialize Google API (modern approach)
function initGoogleApi() {
    console.log('Initializing Google API with modern GIS...');
    
    try {
        // Load Google API client library separately
        const script = document.createElement('script');
        script.src = 'https://apis.google.com/js/api.js';
        script.onload = () => {
            console.log('GAPI script loaded, initializing...');
            gapi.load('client', () => {
                console.log('GAPI client loaded, initializing...');
                
                gapi.client.init({
                    apiKey: API_KEY,
                    discoveryDocs: [
                        'https://www.googleapis.com/discovery/v1/apis/drive/v3/rest',
                        'https://www.googleapis.com/discovery/v1/apis/gmail/v1/rest'
                    ]
                }).then(() => {
                    gapiInited = true;
                    console.log('‚úÖ Google API initialized successfully');
                    updateAuthStatus();
                    showNotification('‚úÖ Google API ready', 'success');
                }, (error) => {
                    console.error('‚ùå Error initializing Google API:', error);
                    console.error('Error details:', JSON.stringify(error, null, 2));
                    const errorMessage = error.error?.message || error.message || JSON.stringify(error);
                    showNotification(`‚ùå Google API Error: ${errorMessage}`, 'error');
                });
            });
        };
        document.head.appendChild(script);
        
    } catch (error) {
        console.error('‚ùå Failed to load GAPI:', error);
        showNotification('‚ùå Failed to load Google API library', 'error');
    }
}

// Initialize OAuth2 token client
function initTokenClient() {
    console.log('Initializing OAuth token client...');
    
    try {
        tokenClient = google.accounts.oauth2.initTokenClient({
            client_id: CLIENT_ID,
            scope: SCOPES.join(' '),
            callback: (tokenResponse) => {
                console.log('Token response received:', tokenResponse);
                if (tokenResponse && tokenResponse.access_token) {
                    handleAuthSuccess(tokenResponse);
                } else {
                    showNotification('‚ùå Authentication failed - no token received', 'error');
                }
            }
        });
        console.log('‚úÖ Token client initialized');
    } catch (error) {
        console.error('‚ùå Failed to initialize token client:', error);
        showNotification('‚ùå Failed to initialize OAuth client', 'error');
    }
}

// Handle successful authentication
function handleAuthSuccess(tokenResponse) {
    // Store token securely
    localStorage.setItem(SECURITY_CONFIG.TOKEN_STORAGE_KEY, JSON.stringify(tokenResponse));
    
    // Update UI
    updateAuthStatus();
    showNotification('‚úÖ Successfully connected to Google account!', 'success');
    
    // Show the services card with scan buttons
    document.getElementById('servicesCard').style.display = 'block';
    
    // Enable scan buttons
    document.getElementById('driveStatus').textContent = 'Connected';
    document.getElementById('driveStatus').className = 'service-status status-connected';
    document.getElementById('gmailStatus').textContent = 'Connected';
    document.getElementById('gmailStatus').className = 'service-status status-connected';
}

// Update authentication status
function updateAuthStatus() {
    const token = localStorage.getItem(SECURITY_CONFIG.TOKEN_STORAGE_KEY);
    const authStatus = document.getElementById('authStatus');
    
    if (token) {
        authStatus.innerHTML = '‚úÖ Connected to Google account';
        authStatus.style.color = '#27ae60';
        
        // Show services card if already authenticated
        document.getElementById('servicesCard').style.display = 'block';
        
        // Update service statuses
        document.getElementById('driveStatus').textContent = 'Connected';
        document.getElementById('driveStatus').className = 'service-status status-connected';
        document.getElementById('gmailStatus').textContent = 'Connected';
        document.getElementById('gmailStatus').className = 'service-status status-connected';
    } else {
        authStatus.innerHTML = '‚ùå Not connected';
        authStatus.style.color = '#e74c3c';
        
        // Hide services card if not authenticated
        document.getElementById('servicesCard').style.display = 'none';
    }
}

// Authentication
function authenticateGoogle() {
    if (!tokenClient) {
        initTokenClient();
    }
    
    // Request OAuth token
    tokenClient.requestAccessToken();
}

// Show notification
function showNotification(message, type = 'info') {
    const notification = document.createElement('div');
    notification.className = 'notification';
    notification.style.background = type === 'error' ? '#e74c3c' : type === 'success' ? '#27ae60' : '#3498db';
    notification.textContent = message;
    document.body.appendChild(notification);
    
    setTimeout(() => {
        notification.remove();
    }, 5000);
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', () => {
    console.log('Page loaded, checking Google APIs...');
    
    // Wait for Google APIs to load
    setTimeout(() => {
        console.log('Checking Google Identity Services availability...');
        console.log('typeof google:', typeof google);
        
        // Initialize OAuth2 with modern GIS
        if (typeof google !== 'undefined' && google.accounts && google.accounts.oauth2) {
            console.log('‚úÖ Google Identity Services found, initializing token client...');
            initTokenClient();
        } else {
            console.error('‚ùå Google Identity Services not loaded');
            showNotification('‚ùå Google Identity Services failed to load', 'error');
        }
        
        // Initialize Google API client separately
        initGoogleApi();
        
        // Check existing authentication
        updateAuthStatus();
    }, 2000);
});

// Placeholder functions for scanning (to be implemented)
function scanDrive() {
    if (!gapiInited) {
        showNotification('‚ö†Ô∏è Google API not initialized', 'warning');
        return;
    }
    
    showNotification('üîç Scanning Google Drive for ATP files...', 'info');
    
    // Search for ATP-related files
    const searchQuery = "name contains 'bid' or name contains 'quote' or name contains 'atp' or name contains 'watts' or name contains 'contract' or name contains 'assistive' or name contains 'tech'";
    
    gapi.client.drive.files.list({
        q: searchQuery,
        fields: 'files(id, name, mimeType, size, modifiedTime, webViewLink)',
        pageSize: 100
    }).then(function(response) {
        const files = response.result.files;
        const atpFiles = files.filter(file => isATPFile(file.name));
        
        displayScanResults('drive', files, atpFiles);
        showNotification(`‚úÖ Drive scan complete: ${atpFiles.length} ATP files found`, 'success');
        
        // Update service status
        document.getElementById('driveStatus').textContent = `Connected (${atpFiles.length} files)`;
        document.getElementById('driveStatus').className = 'service-status status-connected';
        
    }).catch(function(error) {
        console.error('Drive scan error:', error);
        showNotification('‚ùå Failed to scan Google Drive', 'error');
    });
}

function scanGmail() {
    if (!gapiInited) {
        showNotification('‚ö†Ô∏è Google API not initialized', 'warning');
        return;
    }
    
    showNotification('üîç Scanning Gmail for ATP-related emails...', 'info');
    
    // Search for ATP-related emails
    const searchQuery = 'bid OR quote OR atp OR watts OR contract OR assistive OR tech OR (from:*.gov) OR (from:*.state.*.us)';
    
    gapi.client.gmail.users.messages.list({
        userId: 'me',
        q: searchQuery,
        maxResults: 50
    }).then(function(response) {
        const messages = response.result.messages || [];
        
        if (messages.length === 0) {
            showNotification('üìß No ATP-related emails found', 'info');
            return;
        }
        
        // Get message details
        const messagePromises = messages.map(message => 
            gapi.client.gmail.users.messages.get({
                userId: 'me',
                id: message.id,
                format: 'metadata',
                metadataHeaders: ['Subject', 'From', 'Date', 'To']
            })
        );
        
        Promise.all(messagePromises).then(function(messageDetails) {
            const atpEmails = messageDetails.map(detail => detail.result).filter(msg => isATPEmail(msg));
            
            displayScanResults('gmail', messageDetails.map(d => d.result), atpEmails);
            showNotification(`‚úÖ Gmail scan complete: ${atpEmails.length} ATP emails found`, 'success');
            
            // Update service status
            document.getElementById('gmailStatus').textContent = `Connected (${atpEmails.length} emails)`;
            document.getElementById('gmailStatus').className = 'service-status status-connected';
            
        }).catch(function(error) {
            console.error('Gmail message details error:', error);
            showNotification('‚ùå Failed to get email details', 'error');
        });
        
    }).catch(function(error) {
        console.error('Gmail scan error:', error);
        showNotification('‚ùå Failed to scan Gmail', 'error');
    });
}

// Check if file is ATP-related
function isATPFile(filename) {
    const atpPatterns = [
        'atp', 'watts', 'justin watts', 'wsi', 'watts safety', 'bid', 'quote', 
        'estimate', 'contract', 'proposal', 'assistive', 'tech', 'assistive technology',
        'north park', 'allen', 'smith', 'kent', 'esperanza', 'pleasant', 'jayne'
    ];
    
    const lowerFilename = filename.toLowerCase();
    return atpPatterns.some(pattern => lowerFilename.includes(pattern.toLowerCase()));
}

// Check if email is ATP-related
function isATPEmail(message) {
    const headers = message.payload.headers;
    const subject = headers.find(h => h.name === 'Subject')?.value || '';
    const from = headers.find(h => h.name === 'From')?.value || '';
    
    const atpPatterns = [
        'atp', 'watts', 'justin watts', 'wsi', 'watts safety', 'bid', 'quote', 
        'estimate', 'contract', 'proposal', 'assistive', 'tech', 'assistive technology',
        'north park', 'allen', 'smith', 'kent', 'esperanza', 'pleasant', 'jayne'
    ];
    
    const stateDomainPattern = /@(.*\.)?(gov|state\..*\.us)$/;
    
    const lowerSubject = subject.toLowerCase();
    const lowerFrom = from.toLowerCase();
    
    return atpPatterns.some(pattern => 
        lowerSubject.includes(pattern.toLowerCase()) || lowerFrom.includes(pattern.toLowerCase())
    ) || stateDomainPattern.test(lowerFrom);
}

// Display scan results
function displayScanResults(service, allItems, atpItems) {
    const resultsContainer = document.getElementById('scanResults');
    const resultsHTML = atpItems.map(item => {
        if (service === 'drive') {
            return `
                <div class="result-item atp">
                    <div>
                        <strong>üìÑ ${item.name}</strong>
                        <br><small>${item.mimeType} ‚Ä¢ ${formatFileSize(item.size)} ‚Ä¢ ${new Date(item.modifiedTime).toLocaleDateString()}</small>
                    </div>
                    <button class="btn btn-primary" onclick="viewFile('${item.id}', '${item.name}')">View</button>
                </div>
            `;
        } else if (service === 'gmail') {
            const subject = item.payload.headers.find(h => h.name === 'Subject')?.value || 'No Subject';
            const from = item.payload.headers.find(h => h.name === 'From')?.value || 'Unknown';
            const date = item.payload.headers.find(h => h.name === 'Date')?.value || '';
            
            return `
                <div class="result-item atp">
                    <div>
                        <strong>üìß ${subject}</strong>
                        <br><small>From: ${from} ‚Ä¢ ${new Date(date).toLocaleDateString()}</small>
                    </div>
                    <button class="btn btn-primary" onclick="viewEmail('${item.id}')">View</button>
                </div>
            `;
        }
    }).join('');
    
    resultsContainer.innerHTML = resultsHTML || '<div class="result-item other">No ATP items found</div>';
    
    // Store results for import
    window.scanResults = window.scanResults || {};
    window.scanResults[service] = atpItems;
}

// Format file size
function formatFileSize(bytes) {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}

// View file
function viewFile(fileId, filename) {
    window.open(`https://drive.google.com/file/d/${fileId}/view`, '_blank');
}

// View email
function viewEmail(messageId) {
    window.open(`https://mail.google.com/#inbox/${messageId}`, '_blank');
}

function importAllResults() {
    showNotification('üöÄ Importing ATP items to bid generator...', 'info');
    // TODO: Implement import logic
}

function exportResults() {
    showNotification('üìä Exporting scan results...', 'info');
    // TODO: Implement export logic
}
</script>

</body>
</html>
