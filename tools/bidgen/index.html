<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bid Document Generator</title>
    <meta name="robots" content="noindex, nofollow">
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-database-compat.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #1a1a2e; color: #eee; min-height: 100vh; }
        .container { max-width: 900px; margin: 0 auto; padding: 30px 20px; }
        h1 { font-size: 28px; margin-bottom: 4px; color: #e8e8e8; }
        .subtitle { color: #7f8c8d; font-size: 14px; margin-bottom: 30px; }
        .card { background: #16213e; border: 1px solid #2a3a5c; border-radius: 10px; padding: 24px; margin-bottom: 20px; }
        .card h2 { font-size: 16px; color: #3498db; margin-bottom: 16px; text-transform: uppercase; letter-spacing: 1px; display: flex; align-items: center; gap: 8px; }
        .card h2 .icon { width: 28px; height: 28px; background: #3498db; color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 14px; font-weight: bold; }
        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 14px; }
        .form-group { display: flex; flex-direction: column; }
        .form-group.full { grid-column: 1 / -1; }
        .form-group label { font-size: 11px; text-transform: uppercase; color: #7f8c8d; letter-spacing: 0.5px; margin-bottom: 4px; }
        .form-group input, .form-group textarea, .form-group select { background: #0f1a33; border: 1px solid #2a3a5c; border-radius: 6px; padding: 10px 12px; color: #eee; font-size: 14px; font-family: inherit; transition: border-color 0.2s; min-width: 0; }
        .card { overflow: hidden; }
        .form-group input:focus, .form-group textarea:focus, .form-group select:focus { outline: none; border-color: #3498db; }
        .form-group input::placeholder, .form-group textarea::placeholder { color: #4a5568; }
        .form-group select option { background: #0f1a33; color: #eee; }
        .saved-indicator { color: #27ae60; font-size: 12px; margin-left: 8px; opacity: 0; transition: opacity 0.3s; }
        .saved-indicator.show { opacity: 1; }
        .btn-row { display: flex; gap: 12px; margin-top: 24px; flex-wrap: wrap; }
        .btn { padding: 14px 28px; border: none; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; gap: 8px; }
        .btn-labor { background: #2c3e50; color: white; }
        .btn-labor:hover { background: #34495e; }
        .btn-materials { background: #27ae60; color: white; }
        .btn-materials:hover { background: #2ecc71; }
        .btn-change { background: #c0392b; color: white; }
        .btn-change:hover { background: #e74c3c; }
        .btn-save { background: #2a3a5c; color: #bbb; border: 1px solid #3a4a6c; }
        .btn-save:hover { background: #3a4a6c; color: white; }
        .btn-clear { background: transparent; color: #7f8c8d; border: 1px solid #2a3a5c; }
        .btn-clear:hover { background: #2a3a5c; color: #bbb; }
        .instructions { background: #0f1a33; border: 1px solid #2a3a5c; border-radius: 10px; padding: 20px 24px; margin-bottom: 20px; }
        .instructions h3 { color: #f39c12; font-size: 14px; margin-bottom: 10px; }
        .instructions ol { padding-left: 20px; color: #95a5a6; font-size: 13px; }
        .instructions ol li { margin-bottom: 6px; }
        .instructions ol li strong { color: #bdc3c7; }
        .price-section { margin-top: 14px; padding-top: 14px; border-top: 1px solid #2a3a5c; }
        .price-section h3 { font-size: 13px; color: #7f8c8d; margin-bottom: 10px; text-transform: uppercase; letter-spacing: 0.5px; }
        .price-note { font-size: 11px; color: #555; margin-top: 6px; }
        .saved-jobs { margin-top: 10px; }
        .saved-jobs select { background: #0f1a33; border: 1px solid #2a3a5c; border-radius: 6px; padding: 8px 12px; color: #eee; font-size: 13px; width: 100%; margin-bottom: 10px; }
        .saved-jobs select:focus { outline: none; border-color: #3498db; }
        .job-actions { display: flex; gap: 8px; flex-wrap: wrap; }
        .job-actions .btn { padding: 8px 16px; font-size: 12px; }
        .trade-badge { display: inline-block; padding: 3px 10px; border-radius: 12px; font-size: 11px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; margin-left: 8px; }
        .trade-badge.flooring { background: #27ae60; color: white; }
        .trade-badge.painting { background: #8e44ad; color: white; }
        .trade-badge.general { background: #e67e22; color: white; }
        .trade-badge.plumbing { background: #2980b9; color: white; }
        .trade-badge.electrical { background: #f39c12; color: #1a1a1a; }
        .trade-badge.custom { background: #7f8c8d; color: white; }
        #laborItemsContainer .li-row { display: grid; grid-template-columns: 1fr 100px 110px; gap: 8px; margin-bottom: 8px; align-items: center; }
        #laborItemsContainer .li-row input { font-size: 12px; padding: 7px 8px; min-width: 0; }
        #matItemsContainer .mi-row { display: grid; grid-template-columns: 1fr 70px 110px; gap: 8px; margin-bottom: 8px; align-items: center; }
        #matItemsContainer .mi-row input { font-size: 12px; padding: 7px 8px; min-width: 0; }
        .item-header { display: grid; gap: 8px; margin-bottom: 6px; font-size: 10px; color: #7f8c8d; text-transform: uppercase; letter-spacing: 0.5px; }
        .item-header.labor { grid-template-columns: 1fr 100px 110px; }
        .item-header.mat { grid-template-columns: 1fr 70px 110px; }
        .add-row-btn { background: none; border: 1px dashed #3a4a6c; color: #7f8c8d; padding: 6px 14px; border-radius: 6px; cursor: pointer; font-size: 12px; margin-top: 4px; }
        .add-row-btn:hover { border-color: #3498db; color: #3498db; }
        .remove-row { background: none; border: none; color: #c0392b; cursor: pointer; font-size: 16px; padding: 0 4px; }
        /* Autocomplete dropdown */
        .ac-wrap { position: relative; }
        .ac-drop { position: absolute; top: 100%; left: 0; right: 0; background: #0f1a33; border: 1px solid #3498db; border-top: none; border-radius: 0 0 6px 6px; max-height: 220px; overflow-y: auto; z-index: 1000; display: none; }
        .ac-drop.show { display: block; }
        .ac-item { padding: 8px 10px; cursor: pointer; border-bottom: 1px solid #1a2744; font-size: 12px; }
        .ac-item:hover, .ac-item.ac-active { background: #1a2744; }
        .ac-item .ac-desc { color: #eee; font-weight: 600; }
        .ac-item .ac-meta { color: #7f8c8d; font-size: 10px; margin-top: 2px; display: flex; gap: 8px; align-items: center; }
        .ac-item .ac-price { color: #27ae60; font-weight: 600; }
        .ac-item .ac-adj { color: #f39c12; font-size: 9px; }
        .ac-item .ac-date { color: #555; }
        .ac-item .ac-count { background: #2a3a5c; color: #7f8c8d; padding: 1px 5px; border-radius: 8px; font-size: 9px; }
        /* Catalog stats bar */
        .catalog-bar { background: #0f1a33; border: 1px solid #2a3a5c; border-radius: 8px; padding: 8px 14px; margin-bottom: 20px; display: flex; align-items: center; gap: 16px; font-size: 11px; color: #7f8c8d; flex-wrap: wrap; }
        .catalog-bar .cb-stat { display: flex; align-items: center; gap: 4px; }
        .catalog-bar .cb-num { color: #3498db; font-weight: 700; }
        .catalog-bar .cb-inflation { margin-left: auto; display: flex; align-items: center; gap: 6px; }
        .catalog-bar .cb-inflation input { background: #0f1a33; border: 1px solid #2a3a5c; border-radius: 4px; padding: 2px 6px; color: #f39c12; font-size: 11px; width: 48px; text-align: center; }
        .catalog-bar .cb-inflation input:focus { outline: none; border-color: #f39c12; }
        .predict-btn { background: linear-gradient(135deg, #8e44ad, #3498db); color: white; border: none; padding: 6px 14px; border-radius: 6px; font-size: 11px; cursor: pointer; font-weight: 600; letter-spacing: 0.3px; }
        .predict-btn:hover { filter: brightness(1.15); }
        /* Price Lookup Panel */
        .price-lookup { background: #0f1a33; border: 1px solid #2a3a5c; border-radius: 10px; padding: 16px; margin-bottom: 20px; }
        .price-lookup h3 { color: #3498db; font-size: 14px; margin: 0 0 12px 0; display: flex; align-items: center; gap: 8px; }
        .price-lookup h3 .pl-dot { width: 8px; height: 8px; border-radius: 50%; background: #e74c3c; display: inline-block; }
        .price-lookup h3 .pl-dot.online { background: #27ae60; }
        .pl-search-row { display: flex; gap: 8px; margin-bottom: 10px; }
        .pl-search-row input { flex: 1; background: #1a2744; border: 1px solid #2a3a5c; border-radius: 6px; padding: 10px 14px; color: #eee; font-size: 13px; }
        .pl-search-row input:focus { outline: none; border-color: #3498db; }
        .pl-search-row select { background: #1a2744; border: 1px solid #2a3a5c; border-radius: 6px; padding: 10px; color: #eee; font-size: 12px; }
        .pl-search-row button { background: linear-gradient(135deg, #e67e22, #e74c3c); color: white; border: none; padding: 10px 20px; border-radius: 6px; font-size: 13px; font-weight: 600; cursor: pointer; white-space: nowrap; }
        .pl-search-row button:hover { filter: brightness(1.15); }
        .pl-search-row button:disabled { opacity: 0.5; cursor: not-allowed; }
        .pl-status { font-size: 11px; color: #7f8c8d; margin-bottom: 8px; min-height: 16px; }
        .pl-results { max-height: 300px; overflow-y: auto; }
        .pl-item { display: flex; align-items: center; justify-content: space-between; padding: 8px 10px; border-bottom: 1px solid #1a2744; font-size: 12px; gap: 8px; }
        .pl-item:hover { background: #1a2744; }
        .pl-item .pl-name { color: #eee; flex: 1; font-weight: 500; }
        .pl-item .pl-price { color: #27ae60; font-weight: 700; font-size: 13px; min-width: 70px; text-align: right; }
        .pl-item .pl-src { color: #7f8c8d; font-size: 10px; background: #2a3a5c; padding: 2px 6px; border-radius: 4px; }
        .pl-item .pl-add { background: #27ae60; color: white; border: none; padding: 4px 10px; border-radius: 4px; font-size: 10px; cursor: pointer; font-weight: 600; white-space: nowrap; }
        .pl-item .pl-add:hover { background: #2ecc71; }
        .pl-empty { color: #555; font-size: 12px; text-align: center; padding: 20px; }
        .pl-spinner { display: inline-block; width: 14px; height: 14px; border: 2px solid #2a3a5c; border-top-color: #3498db; border-radius: 50%; animation: plspin 0.6s linear infinite; margin-right: 6px; vertical-align: middle; }
        @keyframes plspin { to { transform: rotate(360deg); } }
        .cat-tabs { display: flex; gap: 4px; margin-bottom: 12px; }
        .cat-tab { background: #1a2744; border: 1px solid #2a3a5c; color: #7f8c8d; padding: 7px 16px; border-radius: 6px 6px 0 0; font-size: 12px; cursor: pointer; font-weight: 600; border-bottom: none; }
        .cat-tab.active { background: #0f1a33; color: #3498db; border-color: #3498db; border-bottom: 1px solid #0f1a33; }
        .cat-tab:hover:not(.active) { color: #eee; }
        .cat-form { display: flex; flex-direction: column; gap: 8px; }
        .cat-form-row { display: flex; gap: 8px; flex-wrap: wrap; }
        .cat-input-full { background: #1a2744; border: 1px solid #2a3a5c; border-radius: 6px; padding: 10px 14px; color: #eee; font-size: 13px; width: 100%; box-sizing: border-box; }
        .cat-input-full:focus, .cat-input-sm:focus, .cat-textarea:focus { outline: none; border-color: #3498db; }
        .cat-input-sm { background: #1a2744; border: 1px solid #2a3a5c; border-radius: 6px; padding: 10px; color: #eee; font-size: 12px; min-width: 80px; flex: 1; }
        .cat-add-btn { background: linear-gradient(135deg, #27ae60, #2ecc71); color: white; border: none; padding: 10px 20px; border-radius: 6px; font-size: 13px; font-weight: 600; cursor: pointer; white-space: nowrap; }
        .cat-add-btn:hover { filter: brightness(1.15); }
        .cat-textarea { background: #1a2744; border: 1px solid #2a3a5c; border-radius: 6px; padding: 12px 14px; color: #eee; font-size: 12px; font-family: monospace; width: 100%; box-sizing: border-box; min-height: 120px; resize: vertical; line-height: 1.5; }
        .pl-item .pl-actions { display: flex; gap: 4px; }
        .pl-item .pl-edit, .pl-item .pl-del { background: none; border: 1px solid #2a3a5c; color: #7f8c8d; padding: 3px 8px; border-radius: 4px; font-size: 10px; cursor: pointer; }
        .pl-item .pl-edit:hover { border-color: #3498db; color: #3498db; }
        .pl-item .pl-del:hover { border-color: #e74c3c; color: #e74c3c; }
        .pl-item .pl-hist { font-size: 9px; color: #555; margin-top: 2px; }
        .cat-panel { min-height: 60px; }
        /* PIN login overlay */
        #loginOverlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: #1a1a2e; z-index: 99999; display: flex; align-items: center; justify-content: center; }
        .login-box { background: #16213e; border: 1px solid #2a3a5c; border-radius: 12px; padding: 40px; text-align: center; max-width: 400px; width: 90%; }
        .login-box h2 { color: #3498db; font-size: 22px; margin-bottom: 8px; }
        .login-box p { color: #7f8c8d; font-size: 13px; margin-bottom: 24px; }
        .login-box input { background: #0f1a33; border: 2px solid #2a3a5c; border-radius: 8px; padding: 14px 18px; color: #eee; font-size: 24px; text-align: center; letter-spacing: 8px; width: 200px; font-family: monospace; }
        .login-box input:focus { outline: none; border-color: #3498db; }
        .login-box .login-btn { display: block; width: 100%; margin-top: 16px; padding: 14px; background: #3498db; color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; }
        .login-box .login-btn:hover { background: #2980b9; }
        .login-box .login-error { color: #e74c3c; font-size: 13px; margin-top: 12px; min-height: 20px; }
        .login-box .login-hint { color: #555; font-size: 11px; margin-top: 16px; }
        /* Sync status bar */
        .sync-bar { background: #0f1a33; border: 1px solid #2a3a5c; border-radius: 8px; padding: 10px 16px; margin-bottom: 20px; display: flex; align-items: center; justify-content: space-between; font-size: 12px; }
        .sync-bar .sync-status { display: flex; align-items: center; gap: 8px; }
        .sync-dot { width: 8px; height: 8px; border-radius: 50%; }
        .sync-dot.online { background: #27ae60; }
        .sync-dot.offline { background: #e74c3c; }
        .sync-dot.syncing { background: #f39c12; animation: pulse 1s infinite; }
        @keyframes pulse { 0%,100% { opacity: 1; } 50% { opacity: 0.3; } }
        .sync-bar .sync-label { color: #7f8c8d; }
        .sync-bar .sync-device { color: #555; font-size: 11px; }
        .sync-bar .logout-btn { background: none; border: 1px solid #2a3a5c; color: #7f8c8d; padding: 4px 12px; border-radius: 4px; cursor: pointer; font-size: 11px; }
        .sync-bar .logout-btn:hover { border-color: #e74c3c; color: #e74c3c; }
    </style>
</head>
<body>

<!-- PIN LOGIN OVERLAY -->
<div id="loginOverlay">
    <div class="login-box">
        <h2>Bid Generator</h2>
        <p>Enter your PIN to access your synced workspace</p>
        <input type="password" id="pinInput" maxlength="6" placeholder="----" autofocus>
        <button class="login-btn" id="loginBtn" onclick="attemptLogin()">Unlock</button>
        <div class="login-error" id="loginError"></div>
        <div class="login-hint" id="loginHint">First time? Enter a new 4-6 digit PIN to create your workspace.</div>
    </div>
</div>

<!-- MAIN APP (hidden until login) -->
<div class="container" id="mainApp" style="display:none;">
    <h1>Bid Document Generator</h1>
    <p class="subtitle">Fill in the details below, then generate your Labor Estimate, Materials Estimate, or Change Order. All generated docs are editable with e-signature pads.</p>

    <!-- SYNC STATUS BAR -->
    <div class="sync-bar">
        <div class="sync-status"><span class="sync-dot online" id="syncDot"></span><span class="sync-label" id="syncLabel">Connected to cloud</span></div>
        <span class="sync-device" id="syncDevice"></span>
        <button class="logout-btn" onclick="logout()">Lock</button>
    </div>

    <div class="catalog-bar" id="catalogBar" style="display:none;">
        <span class="cb-stat">Catalog: <span class="cb-num" id="cbLaborCount">0</span> labor</span>
        <span class="cb-stat"><span class="cb-num" id="cbMatCount">0</span> materials</span>
        <span class="cb-stat"><span class="cb-num" id="cbJobCount">0</span> past jobs</span>
        <span class="cb-inflation">Inflation %/yr <input type="number" id="inflationRate" value="3.2" step="0.1" min="0" max="20" onchange="saveInflationRate()"></span>
        <button class="predict-btn" onclick="predictiveFill()">&#9889; Smart Fill from History</button>
    </div>

    <div class="price-lookup" id="priceLookup">
        <h3>Material Catalog</h3>
        <div class="cat-tabs">
            <button class="cat-tab active" onclick="catSwitchTab('browse')">Browse</button>
            <button class="cat-tab" onclick="catSwitchTab('add')">+ Add Item</button>
            <button class="cat-tab" onclick="catSwitchTab('import')">Paste Import</button>
        </div>
        <!-- Browse Tab -->
        <div class="cat-panel" id="catBrowse">
            <div class="pl-search-row">
                <input type="text" id="catFilter" placeholder="Filter catalog... (type to search your saved items)" oninput="catRenderList()">
                <select id="catSort" onchange="catRenderList()">
                    <option value="recent">Recent</option>
                    <option value="alpha">A-Z</option>
                    <option value="price-low">Price: Low</option>
                    <option value="price-high">Price: High</option>
                    <option value="most-used">Most Used</option>
                </select>
            </div>
            <div class="pl-status" id="catStatus">Your saved materials &mdash; synced to cloud via Firebase</div>
            <div class="pl-results" id="catList">
                <div class="pl-empty">No items in catalog yet. Add items using the tabs above.</div>
            </div>
        </div>
        <!-- Add Item Tab -->
        <div class="cat-panel" id="catAdd" style="display:none">
            <div class="cat-form">
                <input type="text" id="catNewDesc" placeholder="Item description (e.g. 1/2 in. x 10 ft. PEX Pipe)" class="cat-input-full">
                <div class="cat-form-row">
                    <input type="text" id="catNewPrice" placeholder="Price ($)" class="cat-input-sm" onkeydown="if(event.key==='Enter')catAddItem()">
                    <input type="text" id="catNewQty" placeholder="Qty (1)" class="cat-input-sm" value="1">
                    <select id="catNewStore" class="cat-input-sm">
                        <option value="Manual">Store...</option>
                        <option value="Menards">Menards</option>
                        <option value="Home Depot">Home Depot</option>
                        <option value="Lowes">Lowes</option>
                        <option value="Amazon">Amazon</option>
                        <option value="Walmart">Walmart</option>
                        <option value="Other">Other</option>
                    </select>
                    <button class="cat-add-btn" onclick="catAddItem()">+ Add to Catalog</button>
                </div>
            </div>
            <div class="pl-status" id="catAddStatus">Add materials you use regularly. Prices are tracked over time.</div>
        </div>
        <!-- Paste Import Tab -->
        <div class="cat-panel" id="catImport" style="display:none">
            <div class="cat-form">
                <textarea id="catPasteArea" class="cat-textarea" placeholder="Paste items here — one per line. Formats accepted:&#10;&#10;  Wax Ring  $4.99&#10;  12/2 Romex 250ft | 89.99 | Menards&#10;  PEX Pipe, 0.50, Home Depot&#10;&#10;Tip: Copy a list from any store website or receipt and paste it here."></textarea>
                <div class="cat-form-row">
                    <select id="catImportStore" class="cat-input-sm">
                        <option value="">Store (optional)</option>
                        <option value="Menards">Menards</option>
                        <option value="Home Depot">Home Depot</option>
                        <option value="Lowes">Lowes</option>
                        <option value="Amazon">Amazon</option>
                    </select>
                    <button class="cat-add-btn" onclick="catImportPaste()">Import Pasted Items</button>
                </div>
                <div style="display:flex;align-items:center;gap:10px;margin-top:6px;padding-top:10px;border-top:1px solid #2a3a5c">
                    <label class="cat-add-btn" style="background:linear-gradient(135deg,#3498db,#2980b9);cursor:pointer;display:inline-flex;align-items:center;gap:6px">
                        <span>Upload CSV File</span>
                        <input type="file" id="catCsvFile" accept=".csv,.txt,.tsv" style="display:none" onchange="catImportCSV(this)">
                    </label>
                    <span style="font-size:11px;color:#7f8c8d">Accepts .csv files (description, price, store)</span>
                </div>
            </div>
            <div class="pl-status" id="catImportStatus">Paste product lists, upload CSV files, or use the AI prompt below.</div>
            <div style="margin-top:12px;background:#1a2744;border:1px solid #2a3a5c;border-radius:8px;padding:12px">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
                    <span style="color:#f39c12;font-size:12px;font-weight:600">AI Prompt Template — Copy &amp; paste to DeepSeek / ChatGPT</span>
                    <button onclick="catCopyPrompt()" style="background:#2a3a5c;color:#eee;border:none;padding:4px 12px;border-radius:4px;font-size:11px;cursor:pointer">Copy Prompt</button>
                </div>
                <div id="catAiPrompt" style="font-size:11px;color:#aaa;font-family:monospace;white-space:pre-wrap;line-height:1.5;max-height:120px;overflow-y:auto;background:#0f1a33;padding:10px;border-radius:6px">I need a list of common materials and current retail prices for a TRADE_TYPE project. Format each item on its own line like this:

Item Description | $Price | Store Name

For example:
1/2 in. x 10 ft. PEX-A Pipe | $3.98 | Home Depot
Wax Ring for Toilet | $4.27 | Menards
12/2 NM-B Romex Wire 250ft | $89.97 | Lowes

Please give me 20-30 items commonly used in TRADE_TYPE work, with realistic current US retail prices. Include items from Menards, Home Depot, Lowes, and Amazon. Focus on: FOCUS_AREA</div>
                <div class="cat-form-row" style="margin-top:8px">
                    <select id="catPromptTrade" class="cat-input-sm" onchange="catUpdatePrompt()">
                        <option value="plumbing">Plumbing</option>
                        <option value="electrical">Electrical</option>
                        <option value="HVAC">HVAC</option>
                        <option value="general handyman">General Handyman</option>
                        <option value="flooring">Flooring</option>
                        <option value="drywall">Drywall</option>
                        <option value="painting">Painting</option>
                        <option value="roofing">Roofing</option>
                    </select>
                    <input type="text" id="catPromptFocus" class="cat-input-sm" placeholder="Focus area (e.g. bathroom rough-in, panel upgrade...)" value="common repairs and installs" oninput="catUpdatePrompt()">
                </div>
            </div>
        </div>
    </div>

    <div class="instructions">
        <h3>How to Use</h3>
        <ol>
            <li><strong>Select your trade type</strong> (Section 2) &mdash; scope, materials, and disclaimers auto-populate.</li>
            <li><strong>Fill in your company info</strong> (Section 1) &mdash; saves automatically to cloud.</li>
            <li><strong>Fill in the job details</strong> (Section 2) &mdash; client name, address, unit, date.</li>
            <li><strong>Adjust labor line items &amp; materials</strong> (Section 3) &mdash; add, remove, or edit rows.</li>
            <li><strong>Click a button</strong> to open the document in a new tab.</li>
            <li>In the generated doc: click <strong>"Edit Values"</strong> to adjust any number or text. Totals auto-recalculate.</li>
            <li><strong>Sign</strong> with mouse or finger on the signature pads. Date auto-stamps.</li>
            <li><strong>Ctrl+P</strong> &rarr; <strong>"Save as PDF"</strong> to save the final version.</li>
        </ol>
    </div>

    <!-- SECTION 1 -->
    <div class="card">
        <h2><span class="icon">1</span> Your Company Info <span class="saved-indicator" id="companySaved">Synced</span></h2>
        <div class="form-grid">
            <div class="form-group full">
                <label>Invoice Brand</label>
                <select id="brandSelect" onchange="onBrandChange()">
                    <option value="wsi">Watts Safety Installs</option>
                    <option value="atp">Watts ATP Contractor</option>
                </select>
            </div>
            <div class="form-group full"><label>Company Name</label><input type="text" id="companyName" placeholder="e.g. Smith General Contracting LLC"></div>
            <div class="form-group"><label>License Number</label><input type="text" id="licenseNum" placeholder="NE License #"></div>
            <div class="form-group"><label>Phone</label><input type="text" id="phone" placeholder="(402) 555-1234"></div>
            <div class="form-group"><label>Email</label><input type="text" id="email" placeholder="you@company.com"></div>
            <div class="form-group"><label>City / Address (optional)</label><input type="text" id="companyAddress" placeholder="Norfolk, NE"></div>
        </div>
    </div>

    <!-- SECTION 2 -->
    <div class="card">
        <h2><span class="icon">2</span> Job Details <span class="trade-badge flooring" id="tradeBadge">Flooring</span></h2>
        <div class="form-grid">
            <div class="form-group full">
                <label>Trade Type</label>
                <select id="tradeType" onchange="onTradeChange()">
                    <option value="flooring">Flooring</option>
                    <option value="painting">Painting</option>
                    <option value="general">General / Remodel</option>
                    <option value="plumbing">Plumbing</option>
                    <option value="electrical">Electrical</option>
                    <option value="custom">Custom (blank template)</option>
                </select>
            </div>
            <div class="form-group"><label>Client / Property Management Co.</label><input type="text" id="clientName" placeholder="e.g. ABC Property Management"></div>
            <div class="form-group"><label>Estimate Date</label><input type="date" id="estimateDate"></div>
            <div class="form-group"><label>Property / Complex Name</label><input type="text" id="complexName" placeholder="e.g. Oakwood Apartments"></div>
            <div class="form-group"><label>Unit / Address</label><input type="text" id="unitNum" placeholder="e.g. Unit 204"></div>
            <div class="form-group"><label>City, State</label><input type="text" id="jobCity" placeholder="e.g. Norfolk, NE"></div>
            <div class="form-group"><label>Area Size (sq ft)</label><input type="number" id="sqft" value="48" min="1"></div>
            <div class="form-group full"><label>Area Description (e.g. "Bathroom, Second Floor" or "Living Room &amp; Hallway")</label><input type="text" id="areaDesc" placeholder="e.g. Bathroom, Second Floor"></div>
        </div>
        <div class="saved-jobs" style="margin-top:16px;">
            <label style="font-size:11px; text-transform:uppercase; color:#7f8c8d; letter-spacing:0.5px;">Saved Jobs (synced across devices)</label>
            <select id="savedJobsSelect"><option value="">-- Select a saved job --</option></select>
            <div class="job-actions">
                <button class="btn btn-save" onclick="saveJob()">Save Current Job</button>
                <button class="btn btn-save" onclick="loadJob()">Load Selected</button>
                <button class="btn btn-clear" onclick="deleteJob()">Delete Selected</button>
                <button class="btn btn-clear" onclick="clearForm()">Clear Form</button>
            </div>
        </div>
    </div>

    <!-- SECTION 3 -->
    <div class="card">
        <h2><span class="icon">3</span> Labor Line Items</h2>
        <div class="item-header labor"><span>Description</span><span>Basis</span><span>Price</span></div>
        <div id="laborItemsContainer"></div>
        <button class="add-row-btn" onclick="addLaborRow('','','')">+ Add Labor Item</button>
    </div>

    <div class="card">
        <h2><span class="icon">4</span> Material Line Items</h2>
        <div class="form-grid" style="margin-bottom:14px;">
            <div class="form-group"><label>Materials Markup %</label><input type="number" id="materialsMarkup" value="15" step="1"></div>
            <div class="form-group"><label>Third-Party Supplier Note (optional)</label><input type="text" id="supplierNote" placeholder="e.g. Scranton Flooring supplies vinyl — PM pays directly"></div>
        </div>
        <div class="item-header mat"><span>Material</span><span>Qty</span><span>Price</span></div>
        <div id="matItemsContainer"></div>
        <button class="add-row-btn" onclick="addMatRow('','','')">+ Add Material Item</button>
    </div>

    <!-- SECTION 5 -->
    <div class="card">
        <h2><span class="icon">5</span> Disclaimer &amp; Unforeseen Conditions</h2>
        <div class="form-group full">
            <label>Unforeseen Conditions Clause (auto-filled by trade, editable)</label>
            <textarea id="disclaimer" rows="4" style="resize:vertical;"></textarea>
        </div>
    </div>

    <div class="btn-row">
        <button class="btn btn-labor" onclick="generateLabor()">Open Labor Estimate (A)</button>
        <button class="btn btn-materials" onclick="generateMaterials()">Open Materials Estimate (B)</button>
        <button class="btn btn-change" onclick="generateChangeOrder()">Open Change Order</button>
    </div>
</div>

<script>
// =====================================================================
// FIREBASE CONFIG & INIT
// =====================================================================
const firebaseConfig = {
    apiKey: "AIzaSyBPcOw7Qjw6ePeHSmGBTSIRKwrqhIZMB0Q",
    authDomain: "wsi---bid-generator.firebaseapp.com",
    databaseURL: "https://wsi---bid-generator-default-rtdb.firebaseio.com",
    projectId: "wsi---bid-generator",
    storageBucket: "wsi---bid-generator.firebasestorage.app",
    messagingSenderId: "613129301141",
    appId: "1:613129301141:web:92405028eca5aae354bf9c",
    measurementId: "G-011LE4CZEF"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

let userPIN = null;
let dbRef = null; // will be db.ref('users/<hashed_pin>')
let companyRef = null;
let jobsRef = null;
let catalogRef = null;
let settingsRef = null;
let _suppressSync = false; // prevent loops when loading from cloud
let _catalog = { labor: {}, materials: {} };
let _inflationRate = 3.2;

// =====================================================================
// SIMPLE PIN HASHING (not crypto-grade, just obfuscation for DB path)
// =====================================================================
function hashPIN(pin) {
    let h = 0;
    for (let i = 0; i < pin.length; i++) {
        h = ((h << 5) - h) + pin.charCodeAt(i);
        h |= 0;
    }
    return 'u' + Math.abs(h).toString(36);
}

// =====================================================================
// LOGIN / AUTH
// =====================================================================
document.getElementById('pinInput').addEventListener('keydown', function(e) {
    if (e.key === 'Enter') attemptLogin();
});

function attemptLogin() {
    const pin = document.getElementById('pinInput').value.trim();
    if (pin.length < 4) {
        document.getElementById('loginError').textContent = 'PIN must be at least 4 digits.';
        return;
    }
    const hashed = hashPIN(pin);
    dbRef = db.ref('users/' + hashed);
    companyRef = dbRef.child('company');
    jobsRef = dbRef.child('jobs');
    catalogRef = dbRef.child('catalog');
    settingsRef = dbRef.child('settings');

    // Check if this PIN/workspace exists
    dbRef.child('created').once('value').then(snap => {
        if (snap.exists()) {
            // Existing workspace — load it
            userPIN = pin;
            sessionStorage.setItem('bid_pin', pin);
            showApp();
        } else {
            // New workspace — create it
            if (!confirm('This PIN has no saved data yet. Create a new workspace with PIN "' + pin + '"?')) return;
            dbRef.child('created').set(Date.now()).then(() => {
                userPIN = pin;
                sessionStorage.setItem('bid_pin', pin);
                showApp();
            });
        }
    }).catch(err => {
        document.getElementById('loginError').textContent = 'Connection error. Check your internet.';
        console.error(err);
    });
}

function logout() {
    sessionStorage.removeItem('bid_pin');
    location.reload();
}

function showApp() {
    document.getElementById('loginOverlay').style.display = 'none';
    document.getElementById('mainApp').style.display = 'block';
    document.getElementById('syncDevice').textContent = 'PIN: ' + userPIN.charAt(0) + '***';
    initApp();
}

// Auto-login if session still active
window.addEventListener('DOMContentLoaded', () => {
    const savedPin = sessionStorage.getItem('bid_pin');
    if (savedPin) {
        document.getElementById('pinInput').value = savedPin;
        attemptLogin();
    }
});

// =====================================================================
// SYNC STATUS HELPERS
// =====================================================================
function setSyncStatus(state, label) {
    const dot = document.getElementById('syncDot');
    const lbl = document.getElementById('syncLabel');
    dot.className = 'sync-dot ' + state;
    lbl.textContent = label;
}

let _syncTimer = null;
function flashSync() {
    setSyncStatus('syncing', 'Syncing...');
    clearTimeout(_syncTimer);
    _syncTimer = setTimeout(() => setSyncStatus('online', 'Connected to cloud'), 1200);
}

// =====================================================================
// TRADE PRESETS
// =====================================================================
const TRADES = {
    flooring: {
        label: 'Flooring',
        areaDesc: 'Bathroom, Second Floor',
        scope: [
            'Disconnect, remove, store, and reinstall toilet',
            'Demolition and removal of existing flooring layers',
            'Subfloor inspection and repair as needed',
            'Concrete/cement patch layer repair using professional-grade compounds',
            'Self-leveling underlayment — prime and pour',
            'Installation of new flooring material',
            'Debris removal, hauling, and disposal'
        ],
        labor: [
            { desc: 'Toilet Removal & Reinstallation', basis: '1 fixture', price: 140 },
            { desc: 'Demolition — Existing Flooring Layers', basis: 'per sq ft', price: 4.50 },
            { desc: 'Subfloor Repair', basis: 'fixed', price: 250 },
            { desc: 'Concrete/Cement Patch Repair', basis: 'per sq ft', price: 1.50 },
            { desc: 'Self-Leveling Underlayment — Prime & Pour', basis: 'per sq ft', price: 3.00 },
            { desc: 'Flooring Installation', basis: 'per sq ft', price: 2.75 },
            { desc: 'Debris Hauling & Disposal', basis: '1 lot', price: 60 },
            { desc: 'Material Procurement & Coordination', basis: '1 lot', price: 60 }
        ],
        materials: [
            { desc: 'Wax Ring with Plastic Sleeve', qty: '1 ea', price: 8 },
            { desc: 'Toilet Mounting Bolts', qty: '1 set', price: 5 },
            { desc: '3/4" OSB Sheet (4\' x 8\')', qty: '1 sheet', price: 45 },
            { desc: '2x4 Lumber — Blocking', qty: '8 lin ft', price: 10 },
            { desc: 'Construction Adhesive', qty: '1 tube', price: 6 },
            { desc: 'Deck Screws / Ring-Shank Nails', qty: '1 box', price: 8 },
            { desc: 'ARDEX FEATHER FINISH (10 lb)', qty: '1 bag', price: 30 },
            { desc: 'ARDEX GPS Patch & Skimcoat (10 lb)', qty: '1 bag', price: 25 },
            { desc: 'ARDEX K 15 Self-Leveling (50 lb)', qty: '1 bag', price: 45 },
            { desc: 'ARDEX P 51 Primer (1 qt)', qty: '1 qt', price: 15 },
            { desc: 'Mixing Paddle / Trowels / Spreaders', qty: '1 lot', price: 10 },
            { desc: 'Scraper Blades / Utility Blades', qty: '1 pack', price: 8 },
            { desc: 'Containment / Damming Material', qty: '1 lot', price: 5 },
            { desc: 'Plastic Sheeting / Drop Cloths', qty: '1 roll', price: 6 },
            { desc: 'Contractor Trash Bags (Heavy Duty)', qty: '1 box', price: 8 }
        ],
        supplierNote: 'Sheet vinyl and adhesive supplied by Scranton Flooring — PM pays Scranton directly. This estimate covers subfloor repair materials, underlayment, and consumables only.',
        disclaimer: 'Due to existing flooring layers, the condition of the underlying subfloor, patch layers, and structural members cannot be fully ascertained prior to demolition. Contractor shall provide immediate written notice upon discovery of any concealed damage, rot, mold, structural deficiency, or non-compliant prior repairs. Work in the affected area shall cease until a written Change Order authorizing additional scope and compensation is executed by both parties.',
        notes: [
            'Flooring material may be supplied separately by a third-party vendor as noted above.',
            'Markup covers procurement time, vehicle/fuel, handling, and warranty administration.',
            'All work performed per manufacturer specifications and Nebraska building code.'
        ]
    },
    painting: {
        label: 'Painting',
        areaDesc: 'Interior Unit',
        scope: [
            'Surface preparation — patching, sanding, caulking',
            'Primer application on all prepared surfaces',
            'Two coats of finish paint on walls',
            'Ceiling painting (one coat primer + one coat finish)',
            'Trim, door, and window frame painting',
            'Hardware removal and reinstallation as needed',
            'Drop cloths, masking, and protection of fixtures/flooring',
            'Cleanup and debris removal'
        ],
        labor: [
            { desc: 'Surface Prep — Patch, Sand, Caulk', basis: 'per sq ft', price: 0.75 },
            { desc: 'Primer Application — Walls', basis: 'per sq ft', price: 0.50 },
            { desc: 'Finish Paint — Walls (2 coats)', basis: 'per sq ft', price: 1.25 },
            { desc: 'Ceiling — Prime & Paint', basis: 'per sq ft', price: 1.00 },
            { desc: 'Trim / Doors / Window Frames', basis: 'per unit', price: 35 },
            { desc: 'Hardware Removal & Reinstall', basis: '1 lot', price: 40 },
            { desc: 'Masking, Protection & Cleanup', basis: '1 lot', price: 50 }
        ],
        materials: [
            { desc: 'Interior Latex Paint — Walls (5 gal)', qty: '1 bucket', price: 145 },
            { desc: 'Interior Latex Paint — Ceiling (5 gal)', qty: '1 bucket', price: 125 },
            { desc: 'Primer — Multi-Surface (5 gal)', qty: '1 bucket', price: 95 },
            { desc: 'Trim Paint — Semi-Gloss (1 gal)', qty: '1 gal', price: 45 },
            { desc: 'Caulk — Paintable Latex', qty: '4 tubes', price: 16 },
            { desc: 'Spackle / Joint Compound', qty: '1 qt', price: 8 },
            { desc: 'Sandpaper Assortment', qty: '1 pack', price: 12 },
            { desc: 'Painter\'s Tape (Blue)', qty: '4 rolls', price: 24 },
            { desc: 'Roller Covers / Brushes / Trays', qty: '1 lot', price: 30 },
            { desc: 'Drop Cloths / Plastic Sheeting', qty: '1 lot', price: 15 },
            { desc: 'Contractor Trash Bags', qty: '1 box', price: 8 }
        ],
        supplierNote: '',
        disclaimer: 'Existing wall and ceiling conditions may include concealed damage such as water stains, mold, lead-based paint (pre-1978 structures), crumbling plaster, or drywall deterioration not visible until surface preparation begins. Contractor shall provide immediate written notice upon discovery. Work shall cease in the affected area until a written Change Order is executed by both parties. Lead paint testing is the responsibility of the property owner per EPA RRP Rule.',
        notes: [
            'Paint colors to be selected and approved by client prior to purchase.',
            'Markup covers procurement time, vehicle/fuel, handling, and warranty administration.',
            'Walls with extensive damage may require skim-coating at additional cost (Change Order).'
        ]
    },
    general: {
        label: 'General / Remodel',
        areaDesc: 'Unit Interior',
        scope: ['Demolition and removal of existing materials','Structural inspection and repair as needed','Rough carpentry and framing','Finish carpentry and trim installation','Material procurement and coordination','Debris removal, hauling, and disposal','Final cleanup and punch list'],
        labor: [
            { desc: 'Demolition & Removal', basis: 'per sq ft', price: 3.00 },
            { desc: 'Framing / Structural Repair', basis: 'fixed', price: 300 },
            { desc: 'Rough Carpentry', basis: 'per hour', price: 65 },
            { desc: 'Finish Carpentry / Trim', basis: 'per hour', price: 65 },
            { desc: 'Material Procurement & Coordination', basis: '1 lot', price: 75 },
            { desc: 'Debris Hauling & Disposal', basis: '1 lot', price: 75 },
            { desc: 'Final Cleanup & Punch List', basis: '1 lot', price: 50 }
        ],
        materials: [
            { desc: 'Framing Lumber', qty: '1 lot', price: 80 },
            { desc: 'Plywood / OSB Sheathing', qty: '1 lot', price: 60 },
            { desc: 'Fasteners / Screws / Nails', qty: '1 lot', price: 25 },
            { desc: 'Construction Adhesive', qty: '2 tubes', price: 12 },
            { desc: 'Trim / Molding', qty: '1 lot', price: 45 },
            { desc: 'Caulk / Sealant', qty: '1 lot', price: 15 },
            { desc: 'Plastic Sheeting / Drop Cloths', qty: '1 lot', price: 10 },
            { desc: 'Contractor Trash Bags', qty: '1 box', price: 8 }
        ],
        supplierNote: '',
        disclaimer: 'Concealed conditions behind walls, above ceilings, or beneath floors cannot be fully assessed until demolition is underway. This includes but is not limited to: structural damage, mold, pest damage, non-code-compliant wiring or plumbing, and asbestos-containing materials. Contractor shall provide immediate written notice upon discovery. Work shall cease until a written Change Order is executed by both parties.',
        notes: ['Specialty subcontractors (plumbing, electrical, HVAC) quoted separately if needed.','Markup covers procurement time, vehicle/fuel, handling, and warranty administration.','All work performed per Nebraska building code and manufacturer specifications.']
    },
    plumbing: {
        label: 'Plumbing',
        areaDesc: 'Bathroom / Kitchen',
        scope: ['Shut off water supply and drain lines','Removal of existing fixtures as needed','Pipe repair, replacement, or rerouting','Installation of new fixtures and trim','Pressure testing and leak check','Drywall / access panel patching (if applicable)','Cleanup and debris removal'],
        labor: [
            { desc: 'Fixture Removal & Disposal', basis: 'per fixture', price: 75 },
            { desc: 'Pipe Repair / Replacement', basis: 'per hour', price: 85 },
            { desc: 'New Fixture Installation', basis: 'per fixture', price: 120 },
            { desc: 'Pressure Test & Leak Check', basis: '1 lot', price: 50 },
            { desc: 'Access Panel / Drywall Patch', basis: '1 lot', price: 60 },
            { desc: 'Cleanup & Debris Removal', basis: '1 lot', price: 40 }
        ],
        materials: [
            { desc: 'PEX / Copper Pipe & Fittings', qty: '1 lot', price: 65 },
            { desc: 'Shut-Off Valves', qty: '2 ea', price: 24 },
            { desc: 'Supply Lines (braided)', qty: '2 ea', price: 16 },
            { desc: 'Wax Ring / Gaskets / Seals', qty: '1 lot', price: 12 },
            { desc: 'Pipe Sealant / Teflon Tape', qty: '1 lot', price: 8 },
            { desc: 'Drywall Patch Kit', qty: '1 ea', price: 15 },
            { desc: 'Contractor Trash Bags', qty: '1 box', price: 8 }
        ],
        supplierNote: '',
        disclaimer: 'Plumbing systems concealed within walls, floors, and ceilings cannot be fully assessed until access is gained. Conditions including corroded pipes, non-code-compliant connections, galvanic corrosion, root intrusion, or deteriorated drain lines may be discovered during work. Contractor shall provide immediate written notice. Work shall cease until a written Change Order is executed by both parties.',
        notes: ['Fixtures to be selected and approved by client prior to purchase unless specified.','Markup covers procurement time, vehicle/fuel, handling, and warranty administration.','Permits pulled if required by local jurisdiction.']
    },
    electrical: {
        label: 'Electrical',
        areaDesc: 'Unit Interior',
        scope: ['Circuit identification and testing','Removal of existing fixtures / devices as needed','Wire repair, replacement, or new runs','Installation of new fixtures, outlets, and switches','Panel inspection and breaker work (if applicable)','Testing and verification of all circuits','Patching of access points and cleanup'],
        labor: [
            { desc: 'Circuit Testing & Identification', basis: '1 lot', price: 60 },
            { desc: 'Fixture / Device Removal', basis: 'per unit', price: 25 },
            { desc: 'Wire Run — New or Replacement', basis: 'per run', price: 120 },
            { desc: 'Fixture / Outlet / Switch Install', basis: 'per unit', price: 45 },
            { desc: 'Panel / Breaker Work', basis: 'per hour', price: 95 },
            { desc: 'Final Testing & Verification', basis: '1 lot', price: 50 },
            { desc: 'Patching & Cleanup', basis: '1 lot', price: 40 }
        ],
        materials: [
            { desc: 'Romex / Wire (various gauge)', qty: '1 lot', price: 55 },
            { desc: 'Outlets / Switches / Cover Plates', qty: '1 lot', price: 30 },
            { desc: 'Junction Boxes / Connectors', qty: '1 lot', price: 20 },
            { desc: 'Wire Nuts / Electrical Tape', qty: '1 lot', price: 10 },
            { desc: 'Breakers (if needed)', qty: '1 lot', price: 25 },
            { desc: 'Drywall Patch Kit', qty: '1 ea', price: 15 },
            { desc: 'Contractor Trash Bags', qty: '1 box', price: 8 }
        ],
        supplierNote: '',
        disclaimer: 'Electrical systems concealed within walls, ceilings, and floors cannot be fully assessed until access is gained. Conditions including aluminum wiring, knob-and-tube wiring, non-code-compliant connections, overloaded circuits, or deteriorated insulation may be discovered. Contractor shall provide immediate written notice. Work shall cease until a written Change Order is executed by both parties. All electrical work performed per NEC and local code.',
        notes: ['Light fixtures and specialty devices to be selected by client unless specified.','Markup covers procurement time, vehicle/fuel, handling, and warranty administration.','Permits pulled if required by local jurisdiction.']
    },
    custom: {
        label: 'Custom',
        areaDesc: '',
        scope: ['[Describe scope item]'],
        labor: [
            { desc: '[Labor description]', basis: '1 lot', price: 0 },
            { desc: '[Labor description]', basis: '1 lot', price: 0 },
            { desc: '[Labor description]', basis: '1 lot', price: 0 }
        ],
        materials: [
            { desc: '[Material description]', qty: '1 lot', price: 0 },
            { desc: '[Material description]', qty: '1 lot', price: 0 },
            { desc: '[Material description]', qty: '1 lot', price: 0 }
        ],
        supplierNote: '',
        disclaimer: 'Concealed conditions not visible prior to commencement of work may require additional scope. Contractor shall provide immediate written notice upon discovery. Work shall cease until a written Change Order is executed by both parties.',
        notes: ['Markup covers procurement time, vehicle/fuel, handling, and warranty administration.','All work performed per applicable building codes.']
    }
};

// =====================================================================
// APP INIT — load from Firebase
// =====================================================================
function initApp() {
    if (!document.getElementById('estimateDate').value) {
        document.getElementById('estimateDate').value = new Date().toISOString().split('T')[0];
    }

    // Load company info from Firebase
    companyRef.once('value').then(snap => {
        const data = snap.val();
        if (data) {
            _suppressSync = true;
            companyFields.forEach(id => {
                if (data[id]) document.getElementById(id).value = data[id];
            });
            _suppressSync = false;
        }
    });

    // Load saved jobs from Firebase and listen for changes
    jobsRef.on('value', snap => {
        const data = snap.val() || {};
        _cloudJobs = data;
        loadSavedJobsList();
        updateCatalogBar();
    });

    // Load price catalog and settings from Firebase
    loadCatalog();

    // Price lookup is now fully client-side — no proxy needed

    // Set up company field auto-save to Firebase
    companyFields.forEach(id => {
        document.getElementById(id).addEventListener('input', () => {
            if (_suppressSync) return;
            const obj = {};
            companyFields.forEach(fid => { obj[fid] = document.getElementById(fid).value; });
            companyRef.set(obj);
            flashSync();
            const ind = document.getElementById('companySaved');
            ind.classList.add('show');
            setTimeout(() => ind.classList.remove('show'), 2000);
        });
    });

    // Default trade
    onTradeChange();

    // Monitor connection
    db.ref('.info/connected').on('value', snap => {
        if (snap.val() === true) {
            setSyncStatus('online', 'Connected to cloud');
        } else {
            setSyncStatus('offline', 'Offline — changes will sync when reconnected');
        }
    });
}

const companyFields = ['companyName', 'licenseNum', 'phone', 'email', 'companyAddress', 'brandSelect'];
let _cloudJobs = {};

// ========== PRICE CATALOG SYSTEM ==========
function sanitizeKey(s) { return String(s||'').toLowerCase().trim().replace(/[.#$\[\]\/]/g,'_').replace(/\s+/g,'_').substring(0,80) || '_empty'; }

function loadCatalog() {
    if (!catalogRef) return;
    catalogRef.on('value', snap => {
        const d = snap.val() || {};
        _catalog.labor = d.labor || {};
        _catalog.materials = d.materials || {};
        updateCatalogBar();
        if (document.getElementById('catList')) catRenderList();
    });
    if (settingsRef) {
        settingsRef.once('value').then(snap => {
            const s = snap.val() || {};
            if (s.inflationRate !== undefined) {
                _inflationRate = s.inflationRate;
                const el = document.getElementById('inflationRate');
                if (el) el.value = _inflationRate;
            }
        });
    }
}

function updateCatalogBar() {
    const lc = Object.keys(_catalog.labor).length;
    const mc = Object.keys(_catalog.materials).length;
    const jc = Object.keys(_cloudJobs).length;
    document.getElementById('cbLaborCount').textContent = lc;
    document.getElementById('cbMatCount').textContent = mc;
    document.getElementById('cbJobCount').textContent = jc;
    document.getElementById('catalogBar').style.display = (lc + mc + jc > 0) ? 'flex' : 'none';
}

function saveInflationRate() {
    _inflationRate = parseFloat(document.getElementById('inflationRate').value) || 3.2;
    if (settingsRef) settingsRef.update({ inflationRate: _inflationRate });
}

function saveToCatalog(type, items, jobName) {
    if (!catalogRef) return;
    const now = Date.now();
    const updates = {};
    items.forEach(item => {
        const key = sanitizeKey(item.desc);
        if (key === '_empty') return;
        const existing = (_catalog[type] && _catalog[type][key]) || {};
        const history = existing.history || {};
        const pushKey = 't' + now + '_' + Math.random().toString(36).substr(2, 4);
        const entry = { price: item.price, date: now, jobName: jobName || '' };
        if (type === 'labor') entry.basis = item.basis || '';
        if (type === 'materials') entry.qty = item.qty || '';
        history[pushKey] = entry;
        updates[type + '/' + key] = {
            desc: item.desc,
            price: item.price,
            basis: item.basis || '',
            qty: item.qty || '',
            lastUsed: now,
            firstSeen: existing.firstSeen || now,
            useCount: (existing.useCount || 0) + 1,
            history: history
        };
    });
    catalogRef.update(updates);
}

function inflationAdjust(price, dateMs) {
    if (!dateMs || !price) return price;
    const years = (Date.now() - dateMs) / (365.25 * 24 * 60 * 60 * 1000);
    if (years < 0.05) return price; // less than ~18 days, no adjustment
    return price * Math.pow(1 + (_inflationRate / 100), years);
}

function relativeDate(ms) {
    if (!ms) return '';
    const days = Math.floor((Date.now() - ms) / 86400000);
    if (days === 0) return 'today';
    if (days === 1) return 'yesterday';
    if (days < 30) return days + 'd ago';
    if (days < 365) return Math.floor(days / 30) + 'mo ago';
    return (days / 365).toFixed(1) + 'yr ago';
}

// ========== AUTOCOMPLETE ENGINE ==========
let _acActiveInput = null;
let _acActiveDrop = null;
let _acActiveIdx = -1;

function acSearch(query, type) {
    const catalog = _catalog[type] || {};
    const q = query.toLowerCase().trim();
    if (!q) return Object.values(catalog).sort((a, b) => (b.useCount || 0) - (a.useCount || 0)).slice(0, 12);
    return Object.values(catalog).filter(item => {
        return item.desc && item.desc.toLowerCase().includes(q);
    }).sort((a, b) => {
        const aStarts = a.desc.toLowerCase().startsWith(q) ? 1 : 0;
        const bStarts = b.desc.toLowerCase().startsWith(q) ? 1 : 0;
        if (aStarts !== bStarts) return bStarts - aStarts;
        return (b.useCount || 0) - (a.useCount || 0);
    }).slice(0, 10);
}

function acRender(results, dropEl, type) {
    dropEl.innerHTML = '';
    if (results.length === 0) { dropEl.classList.remove('show'); return; }
    results.forEach((item, idx) => {
        const div = document.createElement('div');
        div.className = 'ac-item';
        const adj = inflationAdjust(item.price, item.lastUsed);
        const showAdj = Math.abs(adj - item.price) > 0.005;
        let metaHtml = '<span class="ac-price">$' + item.price.toFixed(2) + '</span>';
        if (showAdj) metaHtml += '<span class="ac-adj">&rarr; $' + adj.toFixed(2) + ' adj.</span>';
        if (type === 'labor' && item.basis) metaHtml += '<span>' + item.basis + '</span>';
        if (type === 'materials' && item.qty) metaHtml += '<span>' + item.qty + '</span>';
        metaHtml += '<span class="ac-date">' + relativeDate(item.lastUsed) + '</span>';
        metaHtml += '<span class="ac-count">&times;' + (item.useCount || 1) + '</span>';
        div.innerHTML = '<div class="ac-desc">' + item.desc + '</div><div class="ac-meta">' + metaHtml + '</div>';
        div.addEventListener('mousedown', function(e) {
            e.preventDefault();
            acSelect(item, type);
        });
        dropEl.appendChild(div);
    });
    dropEl.classList.add('show');
    _acActiveIdx = -1;
}

function acSelect(item, type) {
    if (!_acActiveInput) return;
    const row = _acActiveInput.closest('.li-row, .mi-row');
    if (!row) return;
    const inputs = row.querySelectorAll('input');
    const adj = inflationAdjust(item.price, item.lastUsed);
    const useAdj = Math.abs(adj - item.price) > 0.005;
    inputs[0].value = item.desc;
    if (type === 'labor') {
        inputs[1].value = item.basis || '';
        inputs[2].value = (useAdj ? adj : item.price).toFixed(2);
    } else {
        inputs[1].value = item.qty || '';
        inputs[2].value = (useAdj ? adj : item.price).toFixed(2);
    }
    acClose();
}

function acClose() {
    if (_acActiveDrop) _acActiveDrop.classList.remove('show');
    _acActiveInput = null;
    _acActiveDrop = null;
    _acActiveIdx = -1;
}

function acKeydown(e, dropEl) {
    const items = dropEl.querySelectorAll('.ac-item');
    if (!items.length || !dropEl.classList.contains('show')) return;
    if (e.key === 'ArrowDown') {
        e.preventDefault();
        _acActiveIdx = Math.min(_acActiveIdx + 1, items.length - 1);
        items.forEach((it, i) => it.classList.toggle('ac-active', i === _acActiveIdx));
        items[_acActiveIdx].scrollIntoView({ block: 'nearest' });
    } else if (e.key === 'ArrowUp') {
        e.preventDefault();
        _acActiveIdx = Math.max(_acActiveIdx - 1, 0);
        items.forEach((it, i) => it.classList.toggle('ac-active', i === _acActiveIdx));
        items[_acActiveIdx].scrollIntoView({ block: 'nearest' });
    } else if (e.key === 'Enter' && _acActiveIdx >= 0) {
        e.preventDefault();
        items[_acActiveIdx].dispatchEvent(new MouseEvent('mousedown'));
    } else if (e.key === 'Escape') {
        acClose();
    }
}

function attachAutocomplete(input, type) {
    const wrap = document.createElement('div');
    wrap.className = 'ac-wrap';
    input.parentNode.insertBefore(wrap, input);
    wrap.appendChild(input);
    const drop = document.createElement('div');
    drop.className = 'ac-drop';
    wrap.appendChild(drop);

    input.addEventListener('focus', function() {
        _acActiveInput = input;
        _acActiveDrop = drop;
        const results = acSearch(input.value, type);
        if (results.length) acRender(results, drop, type);
    });
    input.addEventListener('input', function() {
        _acActiveInput = input;
        _acActiveDrop = drop;
        acRender(acSearch(input.value, type), drop, type);
    });
    input.addEventListener('blur', function() {
        setTimeout(acClose, 150);
    });
    input.addEventListener('keydown', function(e) {
        acKeydown(e, drop);
    });
}

// ========== PREDICTIVE FILL ==========
function predictiveFill() {
    const trade = document.getElementById('tradeType').value;
    const jobs = Object.values(_cloudJobs).filter(j => j.tradeType === trade);
    if (jobs.length === 0) { alert('No past jobs found for this trade type. Save some jobs first to build your history.'); return; }

    // Tally frequency of each labor item across past jobs of same trade
    const laborFreq = {}, matFreq = {};
    jobs.forEach(j => {
        (j.laborItems || []).forEach(li => {
            const k = sanitizeKey(li.desc);
            if (!laborFreq[k]) laborFreq[k] = { desc: li.desc, basis: li.basis, prices: [], count: 0 };
            laborFreq[k].prices.push({ price: li.price, date: j.savedAt || Date.now() });
            laborFreq[k].count++;
        });
        (j.matItems || []).forEach(mi => {
            const k = sanitizeKey(mi.desc);
            if (!matFreq[k]) matFreq[k] = { desc: mi.desc, qty: mi.qty, prices: [], count: 0 };
            matFreq[k].prices.push({ price: mi.price, date: j.savedAt || Date.now() });
            matFreq[k].count++;
        });
    });

    // Sort by frequency, take top items
    const topLabor = Object.values(laborFreq).sort((a, b) => b.count - a.count).slice(0, 10);
    const topMat = Object.values(matFreq).sort((a, b) => b.count - a.count).slice(0, 15);

    if (topLabor.length === 0 && topMat.length === 0) { alert('Not enough history to predict items.'); return; }

    const msg = 'Smart Fill found ' + topLabor.length + ' labor items and ' + topMat.length + ' materials from ' + jobs.length + ' past ' + trade + ' jobs.\n\nPrices will be inflation-adjusted (' + _inflationRate + '%/yr).\n\nReplace current line items?';
    if (!confirm(msg)) return;

    // Fill labor
    document.getElementById('laborItemsContainer').innerHTML = '';
    topLabor.forEach(item => {
        const latest = item.prices.sort((a, b) => b.date - a.date)[0];
        const adjPrice = inflationAdjust(latest.price, latest.date);
        addLaborRow(item.desc, item.basis, adjPrice.toFixed(2));
    });

    // Fill materials
    document.getElementById('matItemsContainer').innerHTML = '';
    topMat.forEach(item => {
        const latest = item.prices.sort((a, b) => b.date - a.date)[0];
        const adjPrice = inflationAdjust(latest.price, latest.date);
        addMatRow(item.desc, item.qty, adjPrice.toFixed(2));
    });
}

// ========== MATERIAL CATALOG MANAGER ==========
// A clean, reliable inventory catalog. No flaky web scraping.
// Add items manually, paste from store websites, browse & manage your catalog.

function catSwitchTab(tab) {
    const tabs = document.querySelectorAll('.cat-tab');
    const panels = document.querySelectorAll('.cat-panel');
    const tabMap = { browse: 0, add: 1, import: 2 };
    const panelMap = { browse: 'catBrowse', add: 'catAdd', import: 'catImport' };
    tabs.forEach(t => t.classList.remove('active'));
    panels.forEach(p => p.style.display = 'none');
    if (tabs[tabMap[tab]]) tabs[tabMap[tab]].classList.add('active');
    document.getElementById(panelMap[tab]).style.display = '';
    if (tab === 'browse') catRenderList();
}

function catGetMaterials() {
    if (!_catalog || !_catalog.materials) return [];
    const items = [];
    Object.keys(_catalog.materials).forEach(k => {
        const v = _catalog.materials[k];
        if (!v || !v.desc) return;
        items.push({ key: 'materials/' + k, ...v });
    });
    return items;
}

function catRenderList() {
    const listEl = document.getElementById('catList');
    const statusEl = document.getElementById('catStatus');
    const filter = (document.getElementById('catFilter').value || '').toLowerCase().trim();
    const sort = document.getElementById('catSort').value;

    let items = catGetMaterials();

    // Filter
    if (filter) {
        items = items.filter(i => (i.desc || '').toLowerCase().includes(filter) || (i.source || '').toLowerCase().includes(filter));
    }

    // Sort
    if (sort === 'alpha') items.sort((a, b) => (a.desc || '').localeCompare(b.desc || ''));
    else if (sort === 'price-low') items.sort((a, b) => (a.price || 0) - (b.price || 0));
    else if (sort === 'price-high') items.sort((a, b) => (b.price || 0) - (a.price || 0));
    else if (sort === 'most-used') items.sort((a, b) => (b.useCount || 0) - (a.useCount || 0));
    else items.sort((a, b) => (b.lastUsed || 0) - (a.lastUsed || 0));

    statusEl.innerHTML = '<strong>' + items.length + '</strong> items' + (filter ? ' matching "' + escHtml(filter) + '"' : '') + ' &mdash; synced to Firebase';

    if (items.length === 0) {
        listEl.innerHTML = '<div class="pl-empty">' + (filter ? 'No items match your filter.' : 'No items in catalog yet. Use the "+ Add Item" or "Paste Import" tabs above.') + '</div>';
        return;
    }

    listEl.innerHTML = '';
    items.slice(0, 50).forEach(item => {
        const div = document.createElement('div');
        div.className = 'pl-item';
        const priceStr = '$' + (item.price || 0).toFixed(2);
        const ago = item.lastUsed ? catTimeAgo(item.lastUsed) : '';
        const histLen = (item.history || []).length;
        div.innerHTML = '<div style="flex:1;min-width:0">'
            + '<span class="pl-name">' + escHtml(item.desc) + '</span>'
            + (ago ? '<div class="pl-hist">' + escHtml(ago) + (histLen > 1 ? ' &middot; ' + histLen + ' price updates' : '') + '</div>' : '')
            + '</div>'
            + '<span class="pl-price">' + priceStr + '</span>'
            + (item.source ? '<span class="pl-src">' + escHtml(item.source) + '</span>' : '')
            + '<div class="pl-actions">'
            + '<button class="pl-add" title="Add to current bid">+ Bid</button>'
            + '<button class="pl-edit" title="Edit price">Edit</button>'
            + '<button class="pl-del" title="Delete item">X</button>'
            + '</div>';
        div.querySelector('.pl-add').addEventListener('click', function() {
            addMatRow(item.desc, item.qty || '1', (item.price || 0).toFixed(2));
            this.textContent = 'Added!';
            this.style.background = '#2a3a5c';
            setTimeout(() => { this.textContent = '+ Bid'; this.style.background = ''; }, 1500);
        });
        div.querySelector('.pl-edit').addEventListener('click', function() {
            const newPrice = prompt('New price for "' + item.desc + '":', (item.price || 0).toFixed(2));
            if (!newPrice) return;
            const p = parseFloat(newPrice.replace(/[^0-9.]/g, ''));
            if (isNaN(p) || p <= 0) { alert('Invalid price'); return; }
            catSaveItem({ desc: item.desc, price: p, source: item.source || 'Manual', qty: item.qty || '1' });
            catRenderList();
        });
        div.querySelector('.pl-del').addEventListener('click', function() {
            if (!confirm('Delete "' + item.desc + '" from catalog?')) return;
            if (catalogRef) catalogRef.child(item.key).remove();
            catRenderList();
        });
        listEl.appendChild(div);
    });
    if (items.length > 50) {
        listEl.innerHTML += '<div class="pl-empty">Showing first 50 of ' + items.length + ' items. Use the filter to narrow down.</div>';
    }
}

function catTimeAgo(ts) {
    const diff = Date.now() - ts;
    const mins = Math.floor(diff / 60000);
    if (mins < 1) return 'just now';
    if (mins < 60) return mins + 'm ago';
    const hrs = Math.floor(mins / 60);
    if (hrs < 24) return hrs + 'h ago';
    const days = Math.floor(hrs / 24);
    if (days < 30) return days + 'd ago';
    const months = Math.floor(days / 30);
    return months + 'mo ago';
}

function catAddItem() {
    const desc = document.getElementById('catNewDesc').value.trim();
    const priceStr = document.getElementById('catNewPrice').value.trim();
    const qty = document.getElementById('catNewQty').value.trim() || '1';
    const store = document.getElementById('catNewStore').value;

    if (!desc) { document.getElementById('catNewDesc').focus(); return; }
    if (!priceStr) { document.getElementById('catNewPrice').focus(); return; }
    const price = parseFloat(priceStr.replace(/[^0-9.]/g, ''));
    if (isNaN(price) || price <= 0) { alert('Enter a valid price'); document.getElementById('catNewPrice').focus(); return; }

    catSaveItem({ desc, price, source: store, qty });

    document.getElementById('catAddStatus').innerHTML = 'Added <strong>' + escHtml(desc) + '</strong> at $' + price.toFixed(2) + ' to catalog!';
    document.getElementById('catNewDesc').value = '';
    document.getElementById('catNewPrice').value = '';
    document.getElementById('catNewDesc').focus();
    updateCatalogBar();
}

function catImportPaste() {
    const raw = document.getElementById('catPasteArea').value.trim();
    if (!raw) { document.getElementById('catPasteArea').focus(); return; }
    const store = document.getElementById('catImportStore').value || 'Import';
    const statusEl = document.getElementById('catImportStatus');

    const lines = raw.split('\n').map(l => l.trim()).filter(l => l.length > 2);
    let imported = 0;

    lines.forEach(line => {
        // Try to parse: "description  $price" or "description | price | store" or "description, price, store"
        let desc = '', price = 0, lineStore = store;

        // Pattern 1: pipe-separated (desc | price | store)
        if (line.includes('|')) {
            const parts = line.split('|').map(p => p.trim());
            desc = parts[0] || '';
            const priceMatch = (parts[1] || '').match(/([\d,]+\.?\d{0,2})/);
            if (priceMatch) price = parseFloat(priceMatch[1].replace(/,/g, ''));
            if (parts[2]) lineStore = parts[2];
        }
        // Pattern 2: comma-separated (desc, price, store)
        else if ((line.match(/,/g) || []).length >= 1) {
            const parts = line.split(',').map(p => p.trim());
            // Find which part has the price
            let priceIdx = -1;
            parts.forEach((p, i) => {
                if (i > 0 && /^\$?[\d,]+\.?\d{0,2}$/.test(p.replace(/\$/g, ''))) priceIdx = i;
            });
            if (priceIdx > 0) {
                desc = parts.slice(0, priceIdx).join(', ');
                price = parseFloat(parts[priceIdx].replace(/[^0-9.]/g, ''));
                if (parts[priceIdx + 1]) lineStore = parts[priceIdx + 1];
            }
        }
        // Pattern 3: description followed by $price somewhere in the line
        if (!desc || !price) {
            const m = line.match(/^(.+?)\s+\$?([\d,]+\.\d{2})\s*(.*)$/);
            if (m) {
                desc = m[1].replace(/[\|,\-]+$/, '').trim();
                price = parseFloat(m[2].replace(/,/g, ''));
                if (m[3] && m[3].length > 1) lineStore = m[3].trim();
            }
        }
        // Pattern 4: just a dollar amount anywhere
        if (!desc || !price) {
            const pm = line.match(/\$([\d,]+\.?\d{0,2})/);
            if (pm) {
                price = parseFloat(pm[1].replace(/,/g, ''));
                desc = line.replace(/\$[\d,]+\.?\d{0,2}/, '').replace(/[\|,]+/g, ' ').trim();
            }
        }

        if (desc && price > 0 && desc.length >= 2) {
            catSaveItem({ desc, price, source: lineStore, qty: '1' });
            imported++;
        }
    });

    if (imported > 0) {
        statusEl.innerHTML = 'Imported <strong>' + imported + '</strong> items to catalog!';
        document.getElementById('catPasteArea').value = '';
        updateCatalogBar();
    } else {
        statusEl.innerHTML = 'Could not parse any items. Make sure each line has a description and a price (e.g. "Wax Ring $4.99").';
    }
}

function catImportCSV(input) {
    const file = input.files && input.files[0];
    if (!file) return;
    const statusEl = document.getElementById('catImportStatus');
    statusEl.innerHTML = '<span class="pl-spinner"></span> Reading ' + escHtml(file.name) + '...';
    const reader = new FileReader();
    reader.onload = function(e) {
        const text = e.target.result || '';
        // Put CSV content into the paste area and trigger import
        document.getElementById('catPasteArea').value = text;
        catImportPaste();
        input.value = ''; // reset file input
    };
    reader.onerror = function() {
        statusEl.innerHTML = 'Error reading file. Try again.';
    };
    reader.readAsText(file);
}

function catUpdatePrompt() {
    const trade = document.getElementById('catPromptTrade').value;
    const focus = document.getElementById('catPromptFocus').value || 'common repairs and installs';
    const template = 'I need a list of common materials and current retail prices for a ' + trade + ' project. Format each item on its own line like this:\n\nItem Description | $Price | Store Name\n\nFor example:\n1/2 in. x 10 ft. PEX-A Pipe | $3.98 | Home Depot\nWax Ring for Toilet | $4.27 | Menards\n12/2 NM-B Romex Wire 250ft | $89.97 | Lowes\n\nPlease give me 20-30 items commonly used in ' + trade + ' work, with realistic current US retail prices. Include items from Menards, Home Depot, Lowes, and Amazon. Focus on: ' + focus;
    document.getElementById('catAiPrompt').textContent = template;
}

function catCopyPrompt() {
    const text = document.getElementById('catAiPrompt').textContent;
    navigator.clipboard.writeText(text).then(() => {
        const btn = event.target;
        btn.textContent = 'Copied!';
        btn.style.background = '#27ae60';
        setTimeout(() => { btn.textContent = 'Copy Prompt'; btn.style.background = '#2a3a5c'; }, 2000);
    }).catch(() => {
        // Fallback for older browsers
        const ta = document.createElement('textarea');
        ta.value = text;
        document.body.appendChild(ta);
        ta.select();
        document.execCommand('copy');
        document.body.removeChild(ta);
        const btn = event.target;
        btn.textContent = 'Copied!';
        btn.style.background = '#27ae60';
        setTimeout(() => { btn.textContent = 'Copy Prompt'; btn.style.background = '#2a3a5c'; }, 2000);
    });
}

function catSaveItem(item) {
    if (!catalogRef || !item.desc || !item.price) return;
    const sKey = sanitizeKey(item.desc);
    const fbPath = 'materials/' + sKey;
    const now = Date.now();
    const existing = (_catalog && _catalog.materials && _catalog.materials[sKey]) || {};
    const history = existing.history || [];
    history.push({ price: parseFloat(item.price), date: now, job: (item.source || 'manual') });
    if (history.length > 20) history.splice(0, history.length - 20);
    catalogRef.child(fbPath).set({
        desc: item.desc,
        price: parseFloat(item.price),
        qty: item.qty || '1',
        lastUsed: now,
        firstSeen: existing.firstSeen || now,
        useCount: (existing.useCount || 0) + 1,
        history: history,
        source: item.source || 'Manual',
        model: item.model || ''
    });
    updateCatalogBar();
}

function escHtml(s) { return String(s || '').replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;'); }

// ========== BRAND PRESETS ==========
const BRANDS = {
    wsi: {
        name: 'Watts Safety Installs',
        accent: '#C0392B',
        dark: '#1A1A1A',
        headerBg: '#1A1A1A',
        headerText: '#C0392B',
        badgeText: '#FFF5E6',
        scopeCheck: '#C0392B',
        combinedBg: '#FFF5E6',
        combinedBorder: '#1A1A1A',
        combinedGrand: '#1A1A1A',
        combinedRule: '#e8c9a0',
        toolbarBg: '#1A1A1A',
        authBg: '#FFF5E6'
    },
    atp: {
        name: 'Watts ATP Contractor',
        accent: '#00C4B4',
        dark: '#0A1D37',
        headerBg: '#0A1D37',
        headerText: '#00C4B4',
        badgeText: 'white',
        scopeCheck: '#00C4B4',
        combinedBg: '#e6faf8',
        combinedBorder: '#0A1D37',
        combinedGrand: '#0A1D37',
        combinedRule: '#8dd8cf',
        toolbarBg: '#0A1D37',
        authBg: '#e6faf8'
    }
};

function getBrand() { return BRANDS[document.getElementById('brandSelect').value] || BRANDS.wsi; }

function onBrandChange() {
    // Trigger auto-save of company fields
    const evt = new Event('input', { bubbles: true });
    document.getElementById('brandSelect').dispatchEvent(evt);
}

// ========== TRADE CHANGE ==========
function onTradeChange() {
    const t = document.getElementById('tradeType').value;
    const preset = TRADES[t];
    const badge = document.getElementById('tradeBadge');
    badge.textContent = preset.label;
    badge.className = 'trade-badge ' + t;
    const adEl = document.getElementById('areaDesc');
    const knownDefaults = Object.values(TRADES).map(p => p.areaDesc);
    if (!adEl.value || knownDefaults.includes(adEl.value)) adEl.value = preset.areaDesc;
    document.getElementById('laborItemsContainer').innerHTML = '';
    preset.labor.forEach(li => addLaborRow(li.desc, li.basis, li.price));
    document.getElementById('matItemsContainer').innerHTML = '';
    preset.materials.forEach(mi => addMatRow(mi.desc, mi.qty, mi.price));
    document.getElementById('supplierNote').value = preset.supplierNote;
    document.getElementById('disclaimer').value = preset.disclaimer;
}

function addLaborRow(desc, basis, price) {
    const c = document.getElementById('laborItemsContainer');
    const row = document.createElement('div');
    row.className = 'li-row';
    row.innerHTML = '<input type="text" placeholder="Description" value="'+esc(desc)+'">'
        + '<input type="text" placeholder="Basis" value="'+esc(basis)+'">'
        + '<div style="display:flex;gap:4px;align-items:center;"><input type="number" step="0.25" placeholder="$" value="'+(price||'')+'" style="flex:1;"><button class="remove-row" onclick="this.closest(\'.li-row\').remove()">&times;</button></div>';
    c.appendChild(row);
    attachAutocomplete(row.querySelector('input'), 'labor');
}
function addMatRow(desc, qty, price) {
    const c = document.getElementById('matItemsContainer');
    const row = document.createElement('div');
    row.className = 'mi-row';
    row.innerHTML = '<input type="text" placeholder="Material" value="'+esc(desc)+'">'
        + '<input type="text" placeholder="Qty" value="'+esc(qty)+'">'
        + '<div style="display:flex;gap:4px;align-items:center;"><input type="number" step="0.01" placeholder="$" value="'+(price||'')+'" style="flex:1;"><button class="remove-row" onclick="this.closest(\'.mi-row\').remove()">&times;</button></div>';
    c.appendChild(row);
    attachAutocomplete(row.querySelector('input'), 'materials');
}
function esc(s) { return String(s||'').replace(/"/g, '&quot;'); }

// ========== GATHER DATA ==========
function getLaborItems() {
    const rows = document.querySelectorAll('#laborItemsContainer .li-row');
    return Array.from(rows).map(r => {
        const inputs = r.querySelectorAll('input');
        return { desc: inputs[0].value, basis: inputs[1].value, price: parseFloat(inputs[2].value) || 0 };
    }).filter(i => i.desc);
}
function getMatItems() {
    const rows = document.querySelectorAll('#matItemsContainer .mi-row');
    return Array.from(rows).map(r => {
        const inputs = r.querySelectorAll('input');
        return { desc: inputs[0].value, qty: inputs[1].value, price: parseFloat(inputs[2].value) || 0 };
    }).filter(i => i.desc);
}
function getScope() { return TRADES[document.getElementById('tradeType').value].scope; }
function getNotes() { return TRADES[document.getElementById('tradeType').value].notes; }

// ========== SAVED JOBS (FIREBASE) ==========
function loadSavedJobsList() {
    const sel = document.getElementById('savedJobsSelect');
    sel.innerHTML = '<option value="">-- Select a saved job --</option>';
    Object.keys(_cloudJobs).sort().forEach(n => {
        const o = document.createElement('option');
        o.value = n; o.textContent = n; sel.appendChild(o);
    });
}
function saveJob() {
    const c = gv('clientName'), x = gv('complexName'), u = gv('unitNum');
    const name = prompt('Save job as:', (c+' - '+x+' '+u).trim() || 'New Job');
    if (!name) return;
    const jobData = {
        tradeType: gv('tradeType'), clientName: c, complexName: x, unitNum: u,
        jobCity: gv('jobCity'), sqft: gv('sqft'), areaDesc: gv('areaDesc'),
        estimateDate: gv('estimateDate'), materialsMarkup: gv('materialsMarkup'),
        supplierNote: gv('supplierNote'), disclaimer: gv('disclaimer'),
        laborItems: getLaborItems(), matItems: getMatItems(),
        savedAt: Date.now()
    };
    jobsRef.child(name).set(jobData).then(() => {
        saveToCatalog('labor', jobData.laborItems, name);
        saveToCatalog('materials', jobData.matItems, name);
        flashSync();
        updateCatalogBar();
        document.getElementById('savedJobsSelect').value = name;
        alert('Job saved & synced: ' + name);
    });
}
function loadJob() {
    const n = document.getElementById('savedJobsSelect').value;
    if (!n) { alert('Select a job first.'); return; }
    const j = _cloudJobs[n]; if (!j) return;
    ['tradeType','clientName','complexName','unitNum','jobCity','sqft','areaDesc','estimateDate','materialsMarkup','supplierNote','disclaimer'].forEach(k => {
        const e = document.getElementById(k); if (e && j[k] !== undefined) e.value = j[k];
    });
    const badge = document.getElementById('tradeBadge');
    const preset = TRADES[j.tradeType] || TRADES.custom;
    badge.textContent = preset.label; badge.className = 'trade-badge ' + (j.tradeType || 'custom');
    if (j.laborItems) {
        document.getElementById('laborItemsContainer').innerHTML = '';
        j.laborItems.forEach(li => addLaborRow(li.desc, li.basis, li.price));
    }
    if (j.matItems) {
        document.getElementById('matItemsContainer').innerHTML = '';
        j.matItems.forEach(mi => addMatRow(mi.desc, mi.qty, mi.price));
    }
}
function deleteJob() {
    const n = document.getElementById('savedJobsSelect').value;
    if (!n) { alert('Select a job first.'); return; }
    if (!confirm('Delete "'+n+'"?')) return;
    jobsRef.child(n).remove().then(() => { flashSync(); });
}
function clearForm() {
    ['clientName','complexName','unitNum','jobCity','areaDesc','supplierNote'].forEach(id => { document.getElementById(id).value = ''; });
    document.getElementById('sqft').value = 48;
    document.getElementById('estimateDate').value = new Date().toISOString().split('T')[0];
    onTradeChange();
}

// ========== HELPERS ==========
function gv(id) { return document.getElementById(id).value; }
function gn(id) { return parseFloat(document.getElementById(id).value) || 0; }
function f(n) { return n.toFixed(2); }
function fd(s) { if (!s) return '[Date]'; const d = new Date(s+'T12:00:00'); return d.toLocaleDateString('en-US',{year:'numeric',month:'long',day:'numeric'}); }
function loc() { return [gv('complexName'),gv('unitNum'),gv('jobCity')].filter(Boolean).join(', ') || '[Location]'; }
function co(brand) { var b = brand || getBrand(); return '<div class="company-info"><h1>'+(gv('companyName')||b.name)+'</h1><p>Licensed General Contractor &mdash; State of Nebraska</p><p>License #: '+(gv('licenseNum')||'[LICENSE #]')+' &nbsp;|&nbsp; Phone: '+(gv('phone')||'[PHONE]')+' &nbsp;|&nbsp; Email: '+(gv('email')||'[EMAIL]')+'</p></div>'; }
function E(v, extra) { return '<span data-editable '+(extra||'')+'>'+v+'</span>'; }
function P(v, extra) { return '<span data-editable class="editable-price" '+(extra||'')+'>'+v+'</span>'; }

// ========== SHARED DOC CSS ==========
function docCSS(brand) {
    var a = brand.accent, d = brand.dark;
    return '@media print { body { margin:0; padding:0.3in; } .no-print { display:none !important; } .sig-canvas { border:none !important; } }'
    +'* { margin:0; padding:0; box-sizing:border-box; }'
    +'body { font-family:"Segoe UI",Tahoma,Geneva,Verdana,sans-serif; color:#1a1a1a; line-height:1.5; padding:0.5in; padding-top:60px; max-width:8.5in; margin:0 auto; font-size:11pt; }'
    +'.toolbar { position:fixed; top:0; left:0; right:0; background:'+brand.toolbarBg+'; color:#eee; padding:8px 20px; display:flex; align-items:center; gap:12px; z-index:9999; box-shadow:0 2px 12px rgba(0,0,0,0.3); font-size:13px; }'
    +'.toolbar .tbt { font-weight:700; font-size:14px; margin-right:auto; } .toolbar button { padding:8px 18px; border:none; border-radius:5px; font-size:13px; font-weight:600; cursor:pointer; }'
    +'.toolbar .tbp { background:'+a+'; color:'+brand.badgeText+'; } .toolbar .tbe { background:#2a3a5c; color:#bbb; border:1px solid #3a4a6c; } .toolbar .tbe.active { background:#f39c12; color:#1a1a1a; border-color:#f39c12; } .toolbar .tbs { font-size:11px; color:#7f8c8d; }'
    +'.header { display:flex; justify-content:space-between; align-items:flex-start; border-bottom:3px solid '+d+'; padding-bottom:15px; margin-bottom:20px; }'
    +'.company-info h1 { font-size:22pt; color:'+d+'; margin-bottom:2px; } .company-info p { font-size:9pt; color:#555; }'
    +'.badge { background:'+a+'; color:'+brand.badgeText+'; padding:8px 20px; font-size:12pt; font-weight:bold; text-align:center; border-radius:4px; } .badge small { display:block; font-size:8pt; font-weight:normal; opacity:0.8; }'
    +'.info-grid { display:grid; grid-template-columns:1fr 1fr; gap:15px; margin-bottom:20px; } .info-grid-3 { display:grid; grid-template-columns:1fr 1fr 1fr; gap:12px; margin-bottom:20px; }'
    +'.info-box { background:#f8f9fa; border:1px solid #dee2e6; border-radius:4px; padding:10px 14px; } .info-box label { font-size:8pt; text-transform:uppercase; color:#6c757d; letter-spacing:0.5px; display:block; margin-bottom:2px; } .info-box .value { font-size:11pt; font-weight:600; color:'+d+'; } .info-box.hl { background:#fff3cd; border-color:#ffc107; }'
    +'.scope { background:#eef2f7; border-left:4px solid '+a+'; padding:12px 16px; margin-bottom:20px; font-size:10pt; } .scope h3 { font-size:10pt; color:'+d+'; margin-bottom:6px; text-transform:uppercase; letter-spacing:0.5px; } .scope ul { list-style:none; padding:0; } .scope ul li { padding:2px 0 2px 16px; position:relative; } .scope ul li::before { content:"\\2713"; position:absolute; left:0; color:'+brand.scopeCheck+'; font-weight:bold; }'
    +'table { width:100%; border-collapse:collapse; margin-bottom:20px; } table thead th { background:'+d+'; color:'+a+'; padding:8px 10px; text-align:left; font-size:9pt; text-transform:uppercase; letter-spacing:0.5px; }'
    +'table thead th:last-child, table thead th:nth-child(3), table thead th:nth-child(4), table thead th:nth-child(5) { text-align:right; }'
    +'table tbody td { padding:8px 10px; border-bottom:1px solid #e9ecef; font-size:10pt; vertical-align:top; } table tbody td:last-child, table tbody td:nth-child(3), table tbody td:nth-child(4), table tbody td:nth-child(5) { text-align:right; white-space:nowrap; } table tbody tr:nth-child(even) { background:#f8f9fa; }'
    +'.item-num { font-weight:700; color:'+a+'; width:30px; } .item-desc strong { display:block; font-size:10pt; } .item-desc small { color:#6c757d; font-size:8.5pt; }'
    +'.subtotal-row td { border-top:2px solid '+a+'; font-weight:700; font-size:11pt; padding-top:10px; background:transparent !important; }'
    +'.total-row td { border-top:3px double '+d+'; font-weight:700; font-size:13pt; color:'+d+'; padding-top:12px; padding-bottom:12px; background:#f5f5f5 !important; }'
    +'.markup-row td { font-weight:600; color:#6c757d; font-size:10pt; }'
    +'.combined { background:'+brand.combinedBg+'; border:2px solid '+brand.combinedBorder+'; border-radius:6px; padding:16px 20px; margin-top:24px; } .combined h3 { font-size:12pt; color:'+brand.combinedGrand+'; margin-bottom:10px; text-transform:uppercase; letter-spacing:0.5px; } .combined table { width:100%; border-collapse:collapse; } .combined table td { padding:6px 10px; font-size:11pt; border-bottom:1px solid '+brand.combinedRule+'; } .combined table td:last-child { text-align:right; font-weight:600; } .combined .grand td { border-top:3px double '+brand.combinedGrand+'; font-size:14pt; font-weight:700; color:'+brand.combinedGrand+'; padding-top:10px; } .combined .psf td { font-size:10pt; color:#6c757d; border-bottom:none; }'
    +'.supplier-note { background:#d4edda; border:1px solid #28a745; border-radius:4px; padding:12px 16px; margin-bottom:20px; font-size:9.5pt; } .supplier-note h4 { color:#155724; font-size:10pt; margin-bottom:4px; } .supplier-note p { color:#155724; }'
    +'.notes-section { margin-top:20px; } .notes-section h3 { font-size:11pt; color:'+a+'; border-bottom:2px solid '+a+'; padding-bottom:4px; margin-bottom:10px; text-transform:uppercase; letter-spacing:0.5px; } .notes-section .note { font-size:9pt; color:#495057; margin-bottom:8px; padding-left:14px; position:relative; } .notes-section .note::before { content:"\\25CF"; position:absolute; left:0; color:'+a+'; font-size:7pt; top:2px; }'
    +'.unforeseen-box { background:#fff3cd; border:1px solid #ffc107; border-radius:4px; padding:12px 16px; margin-top:20px; font-size:9pt; } .unforeseen-box h4 { color:#856404; font-size:10pt; margin-bottom:6px; } .unforeseen-box p { color:#664d03; line-height:1.5; }'
    +'.ref { background:#f0f0f0; border:1px solid #ccc; border-radius:4px; padding:12px 16px; margin-bottom:20px; font-size:9.5pt; } .ref h4 { font-size:10pt; color:'+d+'; margin-bottom:6px; text-transform:uppercase; } .ref p { color:#495057; margin-bottom:4px; }'
    +'.stitle { font-size:11pt; color:'+a+'; border-bottom:2px solid '+a+'; padding-bottom:4px; margin-bottom:12px; margin-top:24px; text-transform:uppercase; letter-spacing:0.5px; }'
    +'.dbox { border:1px solid #dee2e6; border-radius:4px; padding:16px; margin-bottom:20px; } .dbox label { font-size:9pt; color:#6c757d; text-transform:uppercase; display:block; margin-bottom:8px; } .dbox .wl { border-bottom:1px solid #dee2e6; min-height:22px; margin-bottom:6px; }'
    +'.pbox { background:#f8f9fa; border:2px dashed #adb5bd; border-radius:4px; padding:20px; text-align:center; margin-bottom:20px; } .pbox p { color:#6c757d; font-size:9pt; }'
    +'.impact { display:grid; grid-template-columns:1fr 1fr 1fr; gap:12px; margin-bottom:20px; } .impact-box { border:1px solid #dee2e6; border-radius:4px; padding:12px; text-align:center; } .impact-box label { font-size:8pt; text-transform:uppercase; color:#6c757d; display:block; margin-bottom:4px; } .impact-box .val { font-size:14pt; font-weight:700; color:'+a+'; } .impact-box .val.grn { color:#27ae60; }'
    +'.legal { background:#f8f9fa; border:1px solid #dee2e6; border-radius:4px; padding:16px; margin-top:20px; font-size:9pt; color:#495057; line-height:1.6; } .legal h4 { font-size:10pt; color:'+d+'; margin-bottom:8px; } .legal p { margin-bottom:8px; }'
    +'.auth { margin-top:30px; border:2px solid '+a+'; border-radius:6px; padding:20px; background:'+brand.authBg+'; } .auth h3 { font-size:12pt; color:'+a+'; margin-bottom:12px; text-transform:uppercase; }'
    +'.auth-opt { display:flex; align-items:flex-start; margin-bottom:12px; padding:10px; background:white; border:1px solid #dee2e6; border-radius:4px; cursor:pointer; } .auth-opt.selected { border-color:'+a+'; background:'+brand.authBg+'; }'
    +'.auth-cb { width:18px; height:18px; border:2px solid '+d+'; border-radius:3px; margin-right:12px; flex-shrink:0; margin-top:2px; display:flex; align-items:center; justify-content:center; font-size:14px; } .auth-cb.checked { background:'+a+'; border-color:'+a+'; color:'+brand.badgeText+'; }'
    +'.auth-txt { font-size:10pt; } .auth-txt strong { display:block; margin-bottom:2px; } .auth-txt small { color:#6c757d; font-size:8.5pt; }'
    +'[contenteditable="true"] { outline:none; } body.edit-mode [data-editable] { background:#fffde7; border-bottom:2px dashed #f39c12; cursor:text; padding:1px 4px; border-radius:2px; } body.edit-mode [data-editable]:focus { background:#fff9c4; border-bottom-color:#e67e22; } body.edit-mode .editable-price { background:#e3f2fd !important; border-bottom:2px dashed #2196f3 !important; } body.edit-mode .editable-price:focus { background:#bbdefb !important; }'
    +'.sig-section { margin-top:30px; } .sig-section h3 { font-size:11pt; color:'+d+'; border-bottom:2px solid '+d+'; padding-bottom:4px; margin-bottom:16px; text-transform:uppercase; letter-spacing:0.5px; } .sig-grid { display:grid; grid-template-columns:1fr 1fr; gap:30px; } .sig-pad { text-align:center; } .sig-pad label { font-size:9pt; color:#6c757d; display:block; margin-bottom:4px; text-transform:uppercase; letter-spacing:0.5px; } .sig-canvas { border:1px solid #ccc; border-radius:4px; background:white; cursor:crosshair; width:100%; height:100px; display:block; touch-action:none; } .sig-pad .sig-date { font-size:9pt; color:#495057; margin-top:4px; min-height:18px; } .sig-pad .sig-clear { font-size:11px; color:#c0392b; cursor:pointer; background:none; border:none; text-decoration:underline; margin-top:2px; }'
    +'@media print { .sig-pad .sig-clear { display:none; } .toolbar { display:none !important; } body { padding-top:0 !important; } }'
    +'.footer { margin-top:30px; text-align:center; font-size:8pt; color:#adb5bd; border-top:1px solid #dee2e6; padding-top:10px; }';
}

// ========== SHARED DOC JS ==========
function docJS() {
    return '<'+'script>'
    +'let editMode=false;'
    +'function toggleEdit(){editMode=!editMode;document.body.classList.toggle("edit-mode",editMode);var b=document.getElementById("editBtn");b.textContent=editMode?"EDITING (click to lock)":"Edit Values";b.classList.toggle("active",editMode);document.getElementById("editStatus").textContent=editMode?"Click any highlighted value to change it":"Document locked";document.querySelectorAll("[data-editable]").forEach(function(el){el.contentEditable=editMode?"true":"false";});}'
    +'function recalc(){var sqEl=document.querySelector("[data-sqft]"),sq=sqEl?(parseFloat(sqEl.textContent)||1):1;document.querySelectorAll("tbody tr").forEach(function(row){var lt=row.querySelector("[data-line-total]");if(!lt)return;var rateEl=row.querySelector("[data-rate]");var basisEl=row.querySelector("[data-basis]");var qtyEl=row.querySelector("[data-qty]");var upEl=row.querySelector("[data-unit-price]");if(rateEl&&basisEl){var rate=parseFloat(rateEl.textContent.replace(/[^0-9.\\-]/g,""))||0;if(basisEl.textContent.toLowerCase().indexOf("sq ft")!==-1){lt.textContent="$"+(rate*sq).toFixed(2);}else{lt.textContent="$"+rate.toFixed(2);}}if(qtyEl&&upEl){var q=parseFloat(qtyEl.textContent)||1;var up=parseFloat(upEl.textContent.replace(/[^0-9.\\-]/g,""))||0;lt.textContent="$"+(q*up).toFixed(2);}});var sub=0;document.querySelectorAll("[data-line-total]").forEach(function(el){sub+=parseFloat(el.textContent.replace(/[^0-9.\\-]/g,""))||0;});document.querySelectorAll("[data-subtotal]").forEach(function(el){el.textContent="$"+sub.toFixed(2);});document.querySelectorAll("[data-total]").forEach(function(el){el.textContent="$"+sub.toFixed(2);});var me=document.querySelector("[data-markup-pct]");if(me){var p=parseFloat(me.textContent)||0,ma=sub*(p/100),mt=sub+ma;document.querySelectorAll("[data-markup-amt]").forEach(function(e){e.textContent="$"+ma.toFixed(2);});document.querySelectorAll("[data-mat-total]").forEach(function(e){e.textContent="$"+mt.toFixed(2);});var le=document.querySelector("[data-combined-labor]");if(le){var la=parseFloat(le.textContent.replace(/[^0-9.\\-]/g,""))||0,g=la+mt;document.querySelectorAll("[data-combined-mat]").forEach(function(e){e.textContent="$"+mt.toFixed(2);});document.querySelectorAll("[data-grand-total]").forEach(function(e){e.textContent="$"+g.toFixed(2);});document.querySelectorAll("[data-per-sqft]").forEach(function(e){e.textContent="$"+(g/sq).toFixed(2)+" /sq ft";});}}}'
    +'document.addEventListener("input",function(e){if(e.target.hasAttribute("data-line-total")||e.target.hasAttribute("data-markup-pct")||e.target.hasAttribute("data-rate")||e.target.hasAttribute("data-basis")||e.target.hasAttribute("data-qty")||e.target.hasAttribute("data-unit-price")||e.target.hasAttribute("data-sqft")||e.target.hasAttribute("data-combined-labor"))recalc();});'
    +'function initSig(cid,did){var c=document.getElementById(cid);if(!c)return;var x=c.getContext("2d");var d=false,h=false;function rs(){var r=c.getBoundingClientRect();c.width=r.width*2;c.height=r.height*2;x.scale(2,2);x.strokeStyle="#1a1a1a";x.lineWidth=2;x.lineCap="round";x.lineJoin="round";}rs();function gp(e){var r=c.getBoundingClientRect(),t=e.touches?e.touches[0]:e;return{x:t.clientX-r.left,y:t.clientY-r.top};}c.addEventListener("mousedown",function(e){d=true;x.beginPath();var p=gp(e);x.moveTo(p.x,p.y);});c.addEventListener("mousemove",function(e){if(!d)return;var p=gp(e);x.lineTo(p.x,p.y);x.stroke();});c.addEventListener("mouseup",function(){d=false;if(!h){h=true;sd(did);}});c.addEventListener("mouseleave",function(){d=false;});c.addEventListener("touchstart",function(e){e.preventDefault();d=true;x.beginPath();var p=gp(e);x.moveTo(p.x,p.y);},{passive:false});c.addEventListener("touchmove",function(e){e.preventDefault();if(!d)return;var p=gp(e);x.lineTo(p.x,p.y);x.stroke();},{passive:false});c.addEventListener("touchend",function(e){e.preventDefault();d=false;if(!h){h=true;sd(did);}},{passive:false});window["clear_"+cid]=function(){x.clearRect(0,0,c.width,c.height);h=false;document.getElementById(did).textContent="";};}'
    +'function sd(did){var e=document.getElementById(did);if(e){var n=new Date();e.textContent="Signed: "+n.toLocaleDateString("en-US",{year:"numeric",month:"long",day:"numeric"})+" at "+n.toLocaleTimeString("en-US",{hour:"2-digit",minute:"2-digit"});}}'
    +'document.querySelectorAll(".auth-opt").forEach(function(opt){opt.addEventListener("click",function(){document.querySelectorAll(".auth-opt").forEach(function(o){o.classList.remove("selected");o.querySelector(".auth-cb").classList.remove("checked");o.querySelector(".auth-cb").textContent="";});this.classList.add("selected");var cb=this.querySelector(".auth-cb");cb.classList.add("checked");cb.textContent="\\u2713";});});'
    +'document.addEventListener("DOMContentLoaded",function(){initSig("sigContractor","sigDateContractor");initSig("sigClient","sigDateClient");});'
    +'</'+'script>';
}
function toolbar(title) { return '<div class="toolbar no-print"><span class="tbt">'+title+'</span><span class="tbs" id="editStatus">Document locked</span><button class="tbe" id="editBtn" onclick="toggleEdit()">Edit Values</button><button class="tbp" onclick="window.print()">Print / Save as PDF</button></div>'; }
function sigHTML() { return '<div class="sig-section"><h3>Signatures</h3><div class="sig-grid"><div class="sig-pad"><label>Contractor Signature</label><canvas id="sigContractor" class="sig-canvas"></canvas><div class="sig-date" id="sigDateContractor"></div><button class="sig-clear no-print" onclick="clear_sigContractor()">Clear</button></div><div class="sig-pad"><label>Client / Property Manager Signature</label><canvas id="sigClient" class="sig-canvas"></canvas><div class="sig-date" id="sigDateClient"></div><button class="sig-clear no-print" onclick="clear_sigClient()">Clear</button></div></div></div>'; }
function openDoc(html) { var w = window.open('','_blank'); w.document.write(html); w.document.close(); }

// ========== LABOR ESTIMATE ==========
function generateLabor() {
    var brand = getBrand();
    var sq = gn('sqft'), items = getLaborItems(), scope = getScope(), notes = getNotes();
    var tot = 0; items.forEach(function(i){ tot += (i.basis.toLowerCase().indexOf('sq ft') !== -1) ? i.price * sq : i.price; });
    var ad = gv('areaDesc') || '[Area]';
    var disc = gv('disclaimer');
    var h = '<!DOCTYPE html><html><head><meta charset="UTF-8"><title>Labor Estimate - '+(gv('clientName')||'Client')+'</title><style>'+docCSS(brand)+'</style></head><body>';
    h += toolbar('ESTIMATE A &mdash; LABOR');
    h += '<div class="header">'+co(brand)+'<div class="badge">ESTIMATE A<br><small>LABOR COSTS</small></div></div>';
    h += '<div class="info-grid"><div class="info-box"><label>Prepared For</label><div class="value">'+E(gv('clientName')||'[Client]')+'</div></div><div class="info-box"><label>Estimate Date</label><div class="value">'+E(fd(gv('estimateDate')))+'</div></div><div class="info-box"><label>Project Location</label><div class="value">'+E(loc())+'</div></div><div class="info-box"><label>Estimate Valid For</label><div class="value">'+E('30 Days from Date Above')+'</div></div></div>';
    h += '<div class="scope"><h3>Scope of Work &mdash; <span data-editable data-sqft>'+sq+'</span> sq ft '+E(ad)+'</h3><ul>';
    scope.forEach(function(s){ h += '<li>'+E(s)+'</li>'; });
    h += '</ul></div>';
    h += '<table><thead><tr><th style="width:30px">#</th><th>Description of Work</th><th>Basis</th><th>Rate</th><th>Total</th></tr></thead><tbody>';
    items.forEach(function(item, i){
        var isSqFt = item.basis.toLowerCase().indexOf('sq ft') !== -1;
        var lineTotal = isSqFt ? item.price * sq : item.price;
        h += '<tr><td class="item-num">'+(i+1)+'</td><td class="item-desc"><strong>'+E(item.desc)+'</strong></td><td>'+E(item.basis,'data-basis')+'</td><td>'+P('$'+f(item.price),'data-rate')+'</td><td><strong>'+P('$'+f(lineTotal),'data-line-total')+'</strong></td></tr>';
    });
    h += '<tr class="subtotal-row"><td></td><td colspan="3">LABOR SUBTOTAL</td><td><span data-subtotal>$'+f(tot)+'</span></td></tr>';
    h += '<tr class="total-row"><td></td><td colspan="3">TOTAL LABOR &mdash; ESTIMATE A</td><td><span data-total>$'+f(tot)+'</span></td></tr>';
    h += '</tbody></table>';
    h += '<div class="notes-section"><h3>Labor Estimate Notes</h3>';
    notes.forEach(function(n){ h += '<div class="note">'+E(n)+'</div>'; });
    h += '</div>';
    if (disc) { h += '<div class="unforeseen-box"><h4>UNFORESEEN CONDITIONS CLAUSE</h4><p>'+E(disc)+'</p></div>'; }
    h += sigHTML();
    h += '<div class="footer"><p>'+brand.name+' &nbsp;|&nbsp; Valid for 30 days. &nbsp;|&nbsp; Licensed General Contractor &mdash; State of Nebraska</p></div>';
    h += docJS() + '</body></html>';
    openDoc(h);
}

// ========== MATERIALS ESTIMATE ==========
function generateMaterials() {
    var brand = getBrand();
    var sq = gn('sqft'), mk = gn('materialsMarkup'), items = getMatItems(), notes = getNotes();
    var sub = 0; items.forEach(function(i){ sub += (parseFloat(i.qty) || 1) * i.price; });
    var ma = sub * (mk/100), mt = sub + ma;
    var litems = getLaborItems(), labTot = 0; litems.forEach(function(i){ labTot += (i.basis.toLowerCase().indexOf('sq ft') !== -1) ? i.price * sq : i.price; });
    var grand = labTot + mt;
    var ad = gv('areaDesc') || '[Area]';
    var sn = gv('supplierNote');
    var h = '<!DOCTYPE html><html><head><meta charset="UTF-8"><title>Materials Estimate - '+(gv('clientName')||'Client')+'</title><style>'+docCSS(brand)+'</style></head><body>';
    h += toolbar('ESTIMATE B &mdash; MATERIALS');
    h += '<div class="header">'+co(brand)+'<div class="badge">ESTIMATE B<br><small>MATERIAL COSTS</small></div></div>';
    h += '<div class="info-grid"><div class="info-box"><label>Prepared For</label><div class="value">'+E(gv('clientName')||'[Client]')+'</div></div><div class="info-box"><label>Estimate Date</label><div class="value">'+E(fd(gv('estimateDate')))+'</div></div><div class="info-box"><label>Project Location</label><div class="value">'+E(loc())+'</div></div><div class="info-box"><label>Estimate Valid For</label><div class="value">'+E('30 Days from Date Above')+'</div></div></div>';
    if (sn) { h += '<div class="supplier-note"><h4>MATERIAL SUPPLIER NOTE</h4><p>'+E(sn)+'</p></div>'; }
    h += '<table><thead><tr><th style="width:30px">#</th><th>Material</th><th>Qty</th><th>Unit Price</th><th>Total</th></tr></thead><tbody>';
    items.forEach(function(item, i){
        var qtyNum = parseFloat(item.qty) || 1;
        var lineTotal = qtyNum * item.price;
        h += '<tr><td class="item-num">'+(i+1)+'</td><td class="item-desc"><strong>'+E(item.desc)+'</strong></td><td>'+E(item.qty,'data-qty')+'</td><td>'+P('$'+f(item.price),'data-unit-price')+'</td><td><strong>'+P('$'+f(lineTotal),'data-line-total')+'</strong></td></tr>';
    });
    h += '<tr class="subtotal-row"><td></td><td colspan="3">MATERIALS SUBTOTAL</td><td><span data-subtotal>$'+f(sub)+'</span></td></tr>';
    h += '<tr class="markup-row"><td></td><td colspan="3"><strong>Contractor Markup (<span data-editable data-markup-pct>'+mk+'</span>%)</strong></td><td><span data-markup-amt>$'+f(ma)+'</span></td></tr>';
    h += '<tr class="total-row"><td></td><td colspan="3">TOTAL MATERIALS &mdash; ESTIMATE B</td><td><span data-mat-total>$'+f(mt)+'</span></td></tr>';
    h += '</tbody></table>';
    h += '<div class="combined"><h3>Combined Project Total</h3><table>';
    h += '<tr><td>Estimate A &mdash; Labor</td><td><span data-combined-labor>$'+f(labTot)+'</span></td></tr>';
    h += '<tr><td>Estimate B &mdash; Materials</td><td><span data-combined-mat>$'+f(mt)+'</span></td></tr>';
    if (sn) h += '<tr><td style="color:#6c757d;font-style:italic;">Third-Party Supplied Materials (paid separately)</td><td style="color:#6c757d;font-style:italic;">Not Included</td></tr>';
    h += '<tr class="grand"><td>TOTAL PROJECT PRICE</td><td><span data-grand-total>$'+f(grand)+'</span></td></tr>';
    h += '<tr class="psf"><td>Per Square Foot (<span data-sqft>'+sq+'</span> sq ft)</td><td><span data-per-sqft>$'+f(grand/sq)+' /sq ft</span></td></tr>';
    h += '</table></div>';
    h += '<div class="notes-section"><h3>Materials Notes</h3>';
    notes.forEach(function(n){ h += '<div class="note">'+E(n)+'</div>'; });
    h += '</div>';
    h += sigHTML();
    h += '<div class="footer"><p>'+brand.name+' &nbsp;|&nbsp; Valid for 30 days. &nbsp;|&nbsp; Licensed General Contractor &mdash; State of Nebraska</p></div>';
    h += docJS() + '</body></html>';
    openDoc(h);
}

// ========== CHANGE ORDER ==========
function generateChangeOrder() {
    var sq = gn('sqft'), mk = gn('materialsMarkup')/100;
    var litems = getLaborItems(), labTot = 0; litems.forEach(function(i){ labTot += (i.basis.toLowerCase().indexOf('sq ft') !== -1) ? i.price * sq : i.price; });
    var mitems = getMatItems(), matSub = 0; mitems.forEach(function(i){ matSub += (parseFloat(i.qty) || 1) * i.price; });
    var matTot = matSub + (matSub * mk), orig = labTot + matTot;
    var disc = gv('disclaimer');
    var brand = getBrand();
    var h = '<!DOCTYPE html><html><head><meta charset="UTF-8"><title>Change Order - '+(gv('clientName')||'Client')+'</title><style>'+docCSS(brand)+'</style></head><body>';
    h += toolbar('CHANGE ORDER');
    h += '<div class="header">'+co(brand)+'<div class="badge">CHANGE ORDER<br><small>SCOPE AMENDMENT</small></div></div>';
    h += '<div class="info-grid-3"><div class="info-box hl"><label>Change Order #</label><div class="value">'+E('CO-001')+'</div></div><div class="info-box"><label>Date Issued</label><div class="value">'+E(fd(new Date().toISOString().split('T')[0]))+'</div></div><div class="info-box"><label>Response Required By</label><div class="value">'+E('3 Business Days')+'</div></div></div>';
    h += '<div class="info-grid"><div class="info-box"><label>Prepared For</label><div class="value">'+E(gv('clientName')||'[Client]')+'</div></div><div class="info-box"><label>Project Location</label><div class="value">'+E(loc())+'</div></div></div>';
    h += '<div class="ref"><h4>Reference &mdash; Original Estimate</h4><p><strong>Original Date:</strong> '+fd(gv('estimateDate'))+'</p><p><strong>Original Amount:</strong> Labor $'+f(labTot)+' + Materials $'+f(matTot)+' = <strong>$'+f(orig)+'</strong></p><p><strong>Clause:</strong> '+E(disc || 'Unforeseen Conditions')+'</p></div>';
    h += '<h3 class="stitle">Section 1 &mdash; Discovered Conditions</h3>';
    h += '<div class="dbox"><label>Describe the concealed condition(s):</label><div class="wl" data-editable contenteditable="false">&nbsp;</div><div class="wl" data-editable contenteditable="false">&nbsp;</div><div class="wl" data-editable contenteditable="false">&nbsp;</div><div class="wl" data-editable contenteditable="false">&nbsp;</div></div>';
    h += '<div class="dbox"><label>Location within the unit:</label><div class="wl" data-editable contenteditable="false">&nbsp;</div><div class="wl" data-editable contenteditable="false">&nbsp;</div></div>';
    h += '<div class="pbox"><p><strong>PHOTO DOCUMENTATION</strong> &mdash; Attach dated photos. Count: '+E('______')+'</p></div>';
    h += '<h3 class="stitle">Section 2 &mdash; Additional Work</h3>';
    h += '<table><thead><tr><th style="width:30px">#</th><th>Description</th><th>Qty</th><th>Rate</th><th>Total</th></tr></thead><tbody>';
    var letters = 'ABCDEFGHIJ';
    for (var i = 0; i < 5; i++) {
        h += '<tr><td class="item-num">'+letters[i]+'</td><td class="item-desc"><strong>'+E('[Description]')+'</strong></td><td>'+E('______')+'</td><td>'+P('$______')+'</td><td><strong>'+P('$______','data-line-total')+'</strong></td></tr>';
    }
    h += '<tr class="subtotal-row"><td></td><td colspan="3">CHANGE ORDER SUBTOTAL</td><td><span data-subtotal>$0.00</span></td></tr>';
    h += '<tr class="total-row"><td></td><td colspan="3">CHANGE ORDER TOTAL</td><td><span data-total>$0.00</span></td></tr>';
    h += '</tbody></table>';
    h += '<h3 class="stitle">Section 3 &mdash; Project Impact</h3>';
    h += '<div class="impact"><div class="impact-box"><label>Original Contract</label><div class="val grn">$'+f(orig)+'</div></div><div class="impact-box"><label>This Change Order</label><div class="val">'+E('$______')+'</div></div><div class="impact-box"><label>Revised Total</label><div class="val">'+E('$______')+'</div></div></div>';
    h += '<div class="info-grid"><div class="info-box"><label>Schedule Impact</label><div class="value">'+E('Additional ___ day(s)')+'</div></div><div class="info-box"><label>Revised Completion</label><div class="value">'+E('______')+'</div></div></div>';
    h += '<div class="legal"><h4>Terms &amp; Conditions</h4><p>1. This Change Order amends the original estimate upon execution by both parties.</p><p>2. Work shall not commence until written authorization is received.</p><p>3. Additional compensation reflects actual cost plus applicable overhead.</p><p>4. If declined, Contractor restores area to safe condition. Not responsible for unaddressed damage.</p><p>5. Payment due upon completion of additional scope.</p><p>6. Consistent with Nebraska Revised Statute &sect;73-1117.</p></div>';
    h += '<div class="auth"><h3>Client Authorization</h3>';
    h += '<div class="auth-opt"><div class="auth-cb"></div><div class="auth-txt"><strong>APPROVED</strong><small>I authorize the Contractor to proceed at the stated price.</small></div></div>';
    h += '<div class="auth-opt"><div class="auth-cb"></div><div class="auth-txt"><strong>APPROVED WITH MODIFICATIONS</strong><small>Proceed with modifications: '+E('______________________________')+'</small></div></div>';
    h += '<div class="auth-opt"><div class="auth-cb"></div><div class="auth-txt"><strong>DECLINED</strong><small>I decline. Contractor will restore area to safe condition.</small></div></div></div>';
    h += sigHTML();
    h += '<div class="footer"><p>Change Order &mdash; '+brand.name+' &nbsp;|&nbsp; Licensed GC &mdash; Nebraska &nbsp;|&nbsp; Retain copies for all parties.</p></div>';
    h += docJS() + '</body></html>';
    openDoc(h);
}
</script>
</body>
</html>
