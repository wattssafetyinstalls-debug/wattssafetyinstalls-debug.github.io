<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bid Document Generator</title>
    <meta name="robots" content="noindex, nofollow">
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-database-compat.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #1a1a2e; color: #eee; min-height: 100vh; }
        .container { max-width: 900px; margin: 0 auto; padding: 30px 20px; }
        h1 { font-size: 28px; margin-bottom: 4px; color: #e8e8e8; }
        .subtitle { color: #7f8c8d; font-size: 14px; margin-bottom: 30px; }
        .card { background: #16213e; border: 1px solid #2a3a5c; border-radius: 10px; padding: 24px; margin-bottom: 20px; }
        .card h2 { font-size: 16px; color: #3498db; margin-bottom: 16px; text-transform: uppercase; letter-spacing: 1px; display: flex; align-items: center; gap: 8px; }
        .card h2 .icon { width: 28px; height: 28px; background: #3498db; color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 14px; font-weight: bold; }
        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 14px; }
        .form-group { display: flex; flex-direction: column; }
        .form-group.full { grid-column: 1 / -1; }
        .form-group label { font-size: 11px; text-transform: uppercase; color: #7f8c8d; letter-spacing: 0.5px; margin-bottom: 4px; }
        .form-group input, .form-group textarea, .form-group select { background: #0f1a33; border: 1px solid #2a3a5c; border-radius: 6px; padding: 10px 12px; color: #eee; font-size: 14px; font-family: inherit; transition: border-color 0.2s; min-width: 0; }
        .card { overflow: hidden; }
        .form-group input:focus, .form-group textarea:focus, .form-group select:focus { outline: none; border-color: #3498db; }
        .form-group input::placeholder, .form-group textarea::placeholder { color: #4a5568; }
        .form-group select option { background: #0f1a33; color: #eee; }
        .saved-indicator { color: #27ae60; font-size: 12px; margin-left: 8px; opacity: 0; transition: opacity 0.3s; }
        .saved-indicator.show { opacity: 1; }
        .btn-row { display: flex; gap: 12px; margin-top: 24px; flex-wrap: wrap; }
        .btn { padding: 14px 28px; border: none; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; gap: 8px; }
        .btn-labor { background: #2c3e50; color: white; }
        .btn-labor:hover { background: #34495e; }
        .btn-materials { background: #27ae60; color: white; }
        .btn-materials:hover { background: #2ecc71; }
        .btn-change { background: #c0392b; color: white; }
        .btn-change:hover { background: #e74c3c; }
        .btn-save { background: #2a3a5c; color: #bbb; border: 1px solid #3a4a6c; }
        .btn-save:hover { background: #3a4a6c; color: white; }
        .btn-clear { background: transparent; color: #7f8c8d; border: 1px solid #2a3a5c; }
        .btn-clear:hover { background: #2a3a5c; color: #bbb; }
        .instructions { background: #0f1a33; border: 1px solid #2a3a5c; border-radius: 10px; padding: 20px 24px; margin-bottom: 20px; }
        .instructions h3 { color: #f39c12; font-size: 14px; margin-bottom: 10px; }
        .instructions ol { padding-left: 20px; color: #95a5a6; font-size: 13px; }
        .instructions ol li { margin-bottom: 6px; }
        .instructions ol li strong { color: #bdc3c7; }
        .price-section { margin-top: 14px; padding-top: 14px; border-top: 1px solid #2a3a5c; }
        .price-section h3 { font-size: 13px; color: #7f8c8d; margin-bottom: 10px; text-transform: uppercase; letter-spacing: 0.5px; }
        .price-note { font-size: 11px; color: #555; margin-top: 6px; }
        .saved-jobs { margin-top: 10px; }
        .saved-jobs select { background: #0f1a33; border: 1px solid #2a3a5c; border-radius: 6px; padding: 8px 12px; color: #eee; font-size: 13px; width: 100%; margin-bottom: 10px; }
        .saved-jobs select:focus { outline: none; border-color: #3498db; }
        .job-actions { display: flex; gap: 8px; flex-wrap: wrap; }
        .job-actions .btn { padding: 8px 16px; font-size: 12px; }
        .trade-badge { display: inline-block; padding: 3px 10px; border-radius: 12px; font-size: 11px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; margin-left: 8px; }
        .trade-badge.flooring { background: #27ae60; color: white; }
        .trade-badge.painting { background: #8e44ad; color: white; }
        .trade-badge.general { background: #e67e22; color: white; }
        .trade-badge.plumbing { background: #2980b9; color: white; }
        .trade-badge.electrical { background: #f39c12; color: #1a1a1a; }
        .trade-badge.custom { background: #7f8c8d; color: white; }
        #laborItemsContainer .li-row { display: grid; grid-template-columns: 1fr 100px 110px; gap: 8px; margin-bottom: 8px; align-items: center; }
        #laborItemsContainer .li-row input { font-size: 12px; padding: 7px 8px; min-width: 0; }
        #matItemsContainer .mi-row { display: grid; grid-template-columns: 1fr 70px 110px; gap: 8px; margin-bottom: 8px; align-items: center; }
        #matItemsContainer .mi-row input { font-size: 12px; padding: 7px 8px; min-width: 0; }
        .item-header { display: grid; gap: 8px; margin-bottom: 6px; font-size: 10px; color: #7f8c8d; text-transform: uppercase; letter-spacing: 0.5px; }
        .item-header.labor { grid-template-columns: 1fr 100px 110px; }
        .item-header.mat { grid-template-columns: 1fr 70px 110px; }
        .add-row-btn { background: none; border: 1px dashed #3a4a6c; color: #7f8c8d; padding: 6px 14px; border-radius: 6px; cursor: pointer; font-size: 12px; margin-top: 4px; }
        .add-row-btn:hover { border-color: #3498db; color: #3498db; }
        .remove-row { background: none; border: none; color: #c0392b; cursor: pointer; font-size: 16px; padding: 0 4px; }
        /* Autocomplete dropdown */
        .ac-wrap { position: relative; }
        .ac-drop { position: absolute; top: 100%; left: 0; right: 0; background: #0f1a33; border: 1px solid #3498db; border-top: none; border-radius: 0 0 6px 6px; max-height: 220px; overflow-y: auto; z-index: 1000; display: none; }
        .ac-drop.show { display: block; }
        .ac-item { padding: 8px 10px; cursor: pointer; border-bottom: 1px solid #1a2744; font-size: 12px; }
        .ac-item:hover, .ac-item.ac-active { background: #1a2744; }
        .ac-item .ac-desc { color: #eee; font-weight: 600; }
        .ac-item .ac-meta { color: #7f8c8d; font-size: 10px; margin-top: 2px; display: flex; gap: 8px; align-items: center; }
        .ac-item .ac-price { color: #27ae60; font-weight: 600; }
        .ac-item .ac-adj { color: #f39c12; font-size: 9px; }
        .ac-item .ac-date { color: #555; }
        .ac-item .ac-count { background: #2a3a5c; color: #7f8c8d; padding: 1px 5px; border-radius: 8px; font-size: 9px; }
        /* Catalog stats bar */
        .catalog-bar { background: #0f1a33; border: 1px solid #2a3a5c; border-radius: 8px; padding: 8px 14px; margin-bottom: 20px; display: flex; align-items: center; gap: 16px; font-size: 11px; color: #7f8c8d; flex-wrap: wrap; }
        .catalog-bar .cb-stat { display: flex; align-items: center; gap: 4px; }
        .catalog-bar .cb-num { color: #3498db; font-weight: 700; }
        .catalog-bar .cb-inflation { margin-left: auto; display: flex; align-items: center; gap: 6px; }
        .catalog-bar .cb-inflation input { background: #0f1a33; border: 1px solid #2a3a5c; border-radius: 4px; padding: 2px 6px; color: #f39c12; font-size: 11px; width: 48px; text-align: center; }
        .catalog-bar .cb-inflation input:focus { outline: none; border-color: #f39c12; }
        .predict-btn { background: linear-gradient(135deg, #8e44ad, #3498db); color: white; border: none; padding: 6px 14px; border-radius: 6px; font-size: 11px; cursor: pointer; font-weight: 600; letter-spacing: 0.3px; }
        .predict-btn:hover { filter: brightness(1.15); }
        /* Invoice Widget Styles */
        .invoice-widget { position: fixed; top: 20px; right: 20px; width: 320px; background: #16213e; border: 1px solid #2a3a5c; border-radius: 10px; box-shadow: 0 4px 12px rgba(0,0,0,0.3); z-index: 9999; max-height: calc(100vh - 40px); display: flex; flex-direction: column; }
        .invoice-widget-header { padding: 12px 16px; border-bottom: 1px solid #2a3a5c; display: flex; justify-content: space-between; align-items: center; cursor: pointer; }
        .invoice-widget-header:hover { background: #1a2744; }
        .invoice-widget-title { font-size: 14px; font-weight: 600; color: #3498db; display: flex; align-items: center; gap: 8px; }
        .invoice-widget-toggle { background: none; border: none; color: #7f8c8d; cursor: pointer; font-size: 18px; padding: 0; }
        .invoice-widget-toggle:hover { color: #3498db; }
        .invoice-widget-stats { padding: 10px 16px; background: #0f1a33; border-bottom: 1px solid #2a3a5c; display: grid; grid-template-columns: 1fr 1fr; gap: 8px; font-size: 11px; }
        .invoice-widget-stat { text-align: center; }
        .invoice-widget-stat-value { font-size: 16px; font-weight: 700; color: #3498db; }
        .invoice-widget-stat-label { color: #7f8c8d; margin-top: 2px; }
        .invoice-widget-body { overflow-y: auto; max-height: 400px; }
        .invoice-widget-body.collapsed { display: none; }
        .invoice-banner-item { padding: 10px 16px; border-bottom: 1px solid #2a3a5c; transition: background 0.2s; }
        .invoice-banner-item:hover { background: #1a2744; }
        .invoice-banner-item.urgent { background: rgba(231, 76, 60, 0.1); border-left: 3px solid #e74c3c; }
        .invoice-banner-item.warning { background: rgba(243, 156, 18, 0.1); border-left: 3px solid #f39c12; }
        .invoice-banner-client { font-size: 13px; font-weight: 600; color: #ecf0f1; margin-bottom: 4px; }
        .invoice-banner-meta { font-size: 11px; color: #7f8c8d; display: flex; justify-content: space-between; align-items: center; }
        .invoice-banner-date { display: flex; align-items: center; gap: 4px; }
        .invoice-banner-timer { font-weight: 600; }
        .invoice-banner-timer.urgent { color: #e74c3c; }
        .invoice-banner-timer.warning { color: #f39c12; }
        .invoice-banner-timer.safe { color: #27ae60; }
        .invoice-widget-actions { padding: 10px 16px; border-top: 1px solid #2a3a5c; display: flex; gap: 6px; }
        .invoice-widget-btn { flex: 1; padding: 6px 10px; border: none; border-radius: 6px; font-size: 11px; cursor: pointer; font-weight: 600; transition: all 0.2s; }
        .invoice-widget-btn.primary { background: #3498db; color: white; }
        .invoice-widget-btn.primary:hover { background: #2980b9; }
        .invoice-widget-btn.secondary { background: #2a3a5c; color: #bdc3c7; }
        .invoice-widget-btn.secondary:hover { background: #3a4a6c; }
        .invoice-widget-empty { padding: 30px 20px; text-align: center; color: #7f8c8d; font-size: 12px; }
        .invoice-modal { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); z-index: 10000; display: none; align-items: center; justify-content: center; }
        .invoice-modal.show { display: flex; }
        .invoice-modal-content { background: #16213e; border: 1px solid #2a3a5c; border-radius: 10px; width: 90%; max-width: 800px; max-height: 90vh; overflow-y: auto; }
        .invoice-modal-header { padding: 16px 20px; border-bottom: 1px solid #2a3a5c; display: flex; justify-content: space-between; align-items: center; }
        .invoice-modal-title { font-size: 16px; font-weight: 600; color: #3498db; }
        .invoice-modal-close { background: none; border: none; color: #7f8c8d; cursor: pointer; font-size: 24px; }
        .invoice-modal-close:hover { color: #e74c3c; }
        .invoice-modal-body { padding: 20px; }
        .invoice-tabs { display: flex; gap: 8px; margin-bottom: 16px; border-bottom: 1px solid #2a3a5c; padding-bottom: 8px; }
        .invoice-tab { background: transparent; border: none; color: #7f8c8d; padding: 8px 16px; cursor: pointer; font-size: 13px; font-weight: 600; border-radius: 6px 6px 0 0; transition: all 0.2s; }
        .invoice-tab:hover { background: #1a2744; color: #bdc3c7; }
        .invoice-tab.active { background: #1a2744; color: #3498db; border-bottom: 2px solid #3498db; }
        .invoice-filters { display: flex; gap: 10px; margin-bottom: 16px; flex-wrap: wrap; }
        .invoice-filters select, .invoice-filters input { background: #0f1a33; border: 1px solid #2a3a5c; border-radius: 6px; padding: 8px 12px; color: #eee; font-size: 13px; }
        .invoice-filters select:focus, .invoice-filters input:focus { outline: none; border-color: #3498db; }
        .invoice-list { max-height: 500px; overflow-y: auto; }
        .invoice-item { background: #0f1a33; border: 1px solid #2a3a5c; border-radius: 8px; padding: 14px; margin-bottom: 10px; transition: all 0.2s; }
        .invoice-item:hover { border-color: #3498db; background: #1a2744; }
        .invoice-item.temporary { border-left: 3px solid #f39c12; }
        .invoice-item.permanent { border-left: 3px solid #27ae60; }
        .invoice-item.expired { opacity: 0.6; border-left: 3px solid #e74c3c; }
        .invoice-header { display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px; }
        .invoice-client { font-size: 15px; font-weight: 600; color: #ecf0f1; }
        .invoice-status { font-size: 11px; padding: 3px 8px; border-radius: 12px; font-weight: 600; text-transform: uppercase; }
        .invoice-status.temp { background: #f39c12; color: #1a1a1a; }
        .invoice-status.perm { background: #27ae60; color: white; }
        .invoice-status.lost { background: #e74c3c; color: white; }
        .invoice-details { font-size: 12px; color: #7f8c8d; margin-bottom: 10px; display: flex; gap: 16px; flex-wrap: wrap; }
        .invoice-details span { display: flex; align-items: center; gap: 4px; }
        .invoice-timer { font-size: 11px; color: #f39c12; font-weight: 600; }
        .invoice-timer.urgent { color: #e74c3c; }
        .invoice-actions { display: flex; gap: 6px; flex-wrap: wrap; }
        .invoice-btn { padding: 6px 12px; border: none; border-radius: 6px; font-size: 11px; cursor: pointer; font-weight: 600; transition: all 0.2s; }
        .invoice-btn.award { background: #27ae60; color: white; }
        .invoice-btn.award:hover { background: #2ecc71; }
        .invoice-btn.lost { background: #e74c3c; color: white; }
        .invoice-btn.lost:hover { background: #c0392b; }
        .invoice-btn.view { background: #3498db; color: white; }
        .invoice-btn.view:hover { background: #2980b9; }
        .invoice-btn.delete { background: #7f8c8d; color: white; }
        .invoice-btn.delete:hover { background: #95a5a6; }
        .invoice-empty { text-align: center; padding: 40px 20px; color: #7f8c8d; font-size: 14px; }
        /* Price Lookup Panel */
        .price-lookup { background: #0f1a33; border: 1px solid #2a3a5c; border-radius: 10px; padding: 16px; margin-bottom: 20px; }
        .price-lookup h3 { color: #3498db; font-size: 14px; margin: 0 0 12px 0; display: flex; align-items: center; gap: 8px; }
        .price-lookup h3 .pl-dot { width: 8px; height: 8px; border-radius: 50%; background: #e74c3c; display: inline-block; }
        .price-lookup h3 .pl-dot.online { background: #27ae60; }
        .pl-search-row { display: flex; gap: 8px; margin-bottom: 10px; }
        .pl-search-row input { flex: 1; background: #1a2744; border: 1px solid #2a3a5c; border-radius: 6px; padding: 10px 14px; color: #eee; font-size: 13px; }
        .pl-search-row input:focus { outline: none; border-color: #3498db; }
        .pl-search-row select { background: #1a2744; border: 1px solid #2a3a5c; border-radius: 6px; padding: 10px; color: #eee; font-size: 12px; }
        .pl-search-row button { background: linear-gradient(135deg, #e67e22, #e74c3c); color: white; border: none; padding: 10px 20px; border-radius: 6px; font-size: 13px; font-weight: 600; cursor: pointer; white-space: nowrap; }
        .pl-search-row button:hover { filter: brightness(1.15); }
        .pl-search-row button:disabled { opacity: 0.5; cursor: not-allowed; }
        .pl-status { font-size: 11px; color: #7f8c8d; margin-bottom: 8px; min-height: 16px; }
        .pl-results { max-height: 300px; overflow-y: auto; }
        .pl-item { display: flex; align-items: center; justify-content: space-between; padding: 8px 10px; border-bottom: 1px solid #1a2744; font-size: 12px; gap: 8px; }
        .pl-item:hover { background: #1a2744; }
        .pl-item .pl-name { color: #eee; flex: 1; font-weight: 500; }
        .pl-item .pl-price { color: #27ae60; font-weight: 700; font-size: 13px; min-width: 70px; text-align: right; }
        .pl-item .pl-src { color: #7f8c8d; font-size: 10px; background: #2a3a5c; padding: 2px 6px; border-radius: 4px; }
        .pl-item .pl-add { background: #27ae60; color: white; border: none; padding: 4px 10px; border-radius: 4px; font-size: 10px; cursor: pointer; font-weight: 600; white-space: nowrap; }
        .pl-item .pl-add:hover { background: #2ecc71; }
        .pl-empty { color: #555; font-size: 12px; text-align: center; padding: 20px; }
        .pl-spinner { display: inline-block; width: 14px; height: 14px; border: 2px solid #2a3a5c; border-top-color: #3498db; border-radius: 50%; animation: plspin 0.6s linear infinite; margin-right: 6px; vertical-align: middle; }
        @keyframes plspin { to { transform: rotate(360deg); } }
        .cat-tabs { display: flex; gap: 4px; margin-bottom: 12px; }
        .cat-tab { background: #1a2744; border: 1px solid #2a3a5c; color: #7f8c8d; padding: 7px 16px; border-radius: 6px 6px 0 0; font-size: 12px; cursor: pointer; font-weight: 600; border-bottom: none; }
        .cat-tab.active { background: #0f1a33; color: #3498db; border-color: #3498db; border-bottom: 1px solid #0f1a33; }
        .cat-tab:hover:not(.active) { color: #eee; }
        .cat-form { display: flex; flex-direction: column; gap: 8px; }
        .cat-form-row { display: flex; gap: 8px; flex-wrap: wrap; }
        .cat-input-full { background: #1a2744; border: 1px solid #2a3a5c; border-radius: 6px; padding: 10px 14px; color: #eee; font-size: 13px; width: 100%; box-sizing: border-box; }
        .cat-input-full:focus, .cat-input-sm:focus, .cat-textarea:focus { outline: none; border-color: #3498db; }
        .cat-input-sm { background: #1a2744; border: 1px solid #2a3a5c; border-radius: 6px; padding: 10px; color: #eee; font-size: 12px; min-width: 80px; flex: 1; }
        .cat-add-btn { background: linear-gradient(135deg, #27ae60, #2ecc71); color: white; border: none; padding: 10px 20px; border-radius: 6px; font-size: 13px; font-weight: 600; cursor: pointer; white-space: nowrap; }
        .cat-add-btn:hover { filter: brightness(1.15); }
        .cat-textarea { background: #1a2744; border: 1px solid #2a3a5c; border-radius: 6px; padding: 12px 14px; color: #eee; font-size: 12px; font-family: monospace; width: 100%; box-sizing: border-box; min-height: 120px; resize: vertical; line-height: 1.5; }
        .pl-item .pl-actions { display: flex; gap: 4px; }
        .pl-item .pl-edit, .pl-item .pl-del { background: none; border: 1px solid #2a3a5c; color: #7f8c8d; padding: 3px 8px; border-radius: 4px; font-size: 10px; cursor: pointer; }
        .pl-item .pl-edit:hover { border-color: #3498db; color: #3498db; }
        .pl-item .pl-del:hover { border-color: #e74c3c; color: #e74c3c; }
        .pl-item .pl-hist { font-size: 9px; color: #555; margin-top: 2px; }
        .cat-panel { min-height: 60px; }
        /* PIN login overlay */
        #loginOverlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: #1a1a2e; z-index: 99999; display: flex; align-items: center; justify-content: center; }
        .login-box { background: #16213e; border: 1px solid #2a3a5c; border-radius: 12px; padding: 40px; text-align: center; max-width: 400px; width: 90%; }
        .login-box h2 { color: #3498db; font-size: 22px; margin-bottom: 8px; }
        .login-box p { color: #7f8c8d; font-size: 13px; margin-bottom: 24px; }
        .login-box input { background: #0f1a33; border: 2px solid #2a3a5c; border-radius: 8px; padding: 14px 18px; color: #eee; font-size: 24px; text-align: center; letter-spacing: 8px; width: 200px; font-family: monospace; }
        .login-box input:focus { outline: none; border-color: #3498db; }
        .login-box .login-btn { display: block; width: 100%; margin-top: 16px; padding: 14px; background: #3498db; color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; }
        .login-box .login-btn:hover { background: #2980b9; }
        .login-box .login-error { color: #e74c3c; font-size: 13px; margin-top: 12px; min-height: 20px; }
        .login-box .login-hint { color: #555; font-size: 11px; margin-top: 16px; }
        /* Sync status bar */
        .sync-bar { background: #0f1a33; border: 1px solid #2a3a5c; border-radius: 8px; padding: 10px 16px; margin-bottom: 20px; display: flex; align-items: center; justify-content: space-between; font-size: 12px; }
        .sync-bar .sync-status { display: flex; align-items: center; gap: 8px; }
        .sync-dot { width: 8px; height: 8px; border-radius: 50%; }
        .sync-dot.online { background: #27ae60; }
        .sync-dot.offline { background: #e74c3c; }
        .sync-dot.syncing { background: #f39c12; animation: pulse 1s infinite; }
        @keyframes pulse { 0%,100% { opacity: 1; } 50% { opacity: 0.3; } }
        .sync-bar .sync-label { color: #7f8c8d; }
        .sync-bar .sync-device { color: #555; font-size: 11px; }
        .sync-bar .logout-btn { background: none; border: 1px solid #2a3a5c; color: #7f8c8d; padding: 4px 12px; border-radius: 4px; cursor: pointer; font-size: 11px; }
        .sync-bar .logout-btn:hover { border-color: #e74c3c; color: #e74c3c; }
        
        /* Client Autocomplete */
        .client-ac-wrap { position: relative; }
        .client-ac-drop { position: absolute; top: 100%; left: 0; right: 0; background: #0f1a33; border: 1px solid #3498db; border-top: none; border-radius: 0 0 6px 6px; max-height: 200px; overflow-y: auto; z-index: 1001; display: none; }
        .client-ac-drop.show { display: block; }
        .client-ac-item { padding: 10px 12px; cursor: pointer; border-bottom: 1px solid #1a2744; font-size: 13px; }
        .client-ac-item:hover, .client-ac-item.active { background: #1a2744; }
        .client-ac-item .ca-name { color: #ecf0f1; font-weight: 600; }
        .client-ac-item .ca-meta { color: #7f8c8d; font-size: 11px; margin-top: 2px; }
        .client-ac-item .ca-new { color: #3498db; font-style: italic; }
        /* Quick Templates */
        .template-bar { background: #0f1a33; border: 1px solid #2a3a5c; border-radius: 8px; padding: 10px 14px; margin-bottom: 12px; display: flex; align-items: center; gap: 10px; flex-wrap: wrap; }
        .template-bar label { font-size: 11px; color: #7f8c8d; text-transform: uppercase; white-space: nowrap; }
        .template-bar select { background: #1a2744; border: 1px solid #2a3a5c; border-radius: 6px; padding: 8px 12px; color: #eee; font-size: 13px; flex: 1; min-width: 200px; }
        .template-bar select:focus { outline: none; border-color: #3498db; }
        .template-bar button { background: linear-gradient(135deg, #27ae60, #2ecc71); color: white; border: none; padding: 8px 16px; border-radius: 6px; font-size: 12px; font-weight: 600; cursor: pointer; white-space: nowrap; }
        .template-bar button:hover { filter: brightness(1.15); }
        /* Analytics Modal */
        .analytics-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin-bottom: 20px; }
        .analytics-card { background: #0f1a33; border: 1px solid #2a3a5c; border-radius: 8px; padding: 14px; text-align: center; }
        .analytics-card .a-value { font-size: 24px; font-weight: 700; }
        .analytics-card .a-label { font-size: 10px; color: #7f8c8d; text-transform: uppercase; margin-top: 4px; }
        .analytics-chart { background: #0f1a33; border: 1px solid #2a3a5c; border-radius: 8px; padding: 16px; margin-bottom: 16px; }
        .analytics-chart h4 { font-size: 12px; color: #7f8c8d; text-transform: uppercase; margin-bottom: 12px; }
        .analytics-bar-row { display: flex; align-items: center; gap: 10px; margin-bottom: 8px; font-size: 12px; }
        .analytics-bar-label { width: 100px; color: #bdc3c7; text-align: right; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .analytics-bar { flex: 1; height: 20px; background: #1a2744; border-radius: 4px; overflow: hidden; }
        .analytics-bar-fill { height: 100%; border-radius: 4px; transition: width 0.5s; }
        .analytics-bar-val { width: 60px; color: #7f8c8d; font-size: 11px; }
        /* PDF Template System */
        .tpl-modal-overlay { position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.85);z-index:3000;display:none;overflow-y:auto;padding:20px; }
        .tpl-modal-overlay.show { display:flex;align-items:flex-start;justify-content:center; }
        .tpl-modal { background:#0d1b2a;border:1px solid #2a3a5c;border-radius:12px;width:100%;max-width:900px;margin:20px auto;padding:24px;color:#ecf0f1; }
        .tpl-modal h2 { font-size:18px;margin-bottom:16px;color:#ecf0f1; }
        .tpl-modal h3 { font-size:14px;margin:16px 0 8px;color:#bdc3c7; }
        .tpl-tabs { display:flex;gap:8px;margin-bottom:16px;border-bottom:1px solid #2a3a5c;padding-bottom:8px; }
        .tpl-tab { background:#1a2744;border:1px solid #2a3a5c;color:#bdc3c7;padding:8px 16px;border-radius:6px 6px 0 0;cursor:pointer;font-size:12px;font-weight:600; }
        .tpl-tab.active { background:#3498db;color:white;border-color:#3498db; }
        .tpl-upload-zone { border:2px dashed #2a3a5c;border-radius:10px;padding:40px 20px;text-align:center;cursor:pointer;transition:all 0.2s;margin-bottom:16px; }
        .tpl-upload-zone:hover,.tpl-upload-zone.dragover { border-color:#3498db;background:rgba(52,152,219,0.1); }
        .tpl-upload-zone p { color:#7f8c8d;font-size:13px;margin-top:8px; }
        .tpl-list { display:grid;gap:10px;margin-bottom:16px; }
        .tpl-card { background:#16213e;border:1px solid #2a3a5c;border-radius:8px;padding:14px;display:flex;align-items:center;gap:14px;cursor:pointer;transition:all 0.2s; }
        .tpl-card:hover { border-color:#3498db;background:#1a2744; }
        .tpl-card.selected { border-color:#27ae60;background:rgba(39,174,96,0.1); }
        .tpl-card-icon { width:48px;height:48px;background:#0f1a33;border-radius:6px;display:flex;align-items:center;justify-content:center;font-size:24px;flex-shrink:0; }
        .tpl-card-info { flex:1;min-width:0; }
        .tpl-card-info .tpl-name { font-size:14px;font-weight:600;color:#ecf0f1;white-space:nowrap;overflow:hidden;text-overflow:ellipsis; }
        .tpl-card-info .tpl-meta { font-size:11px;color:#7f8c8d;margin-top:2px; }
        .tpl-card-actions { display:flex;gap:6px; }
        .tpl-card-actions button { background:#2a3a5c;border:none;color:#bdc3c7;padding:6px 10px;border-radius:4px;font-size:11px;cursor:pointer; }
        .tpl-card-actions button:hover { background:#3498db;color:white; }
        .tpl-card-actions button.del:hover { background:#e74c3c; }
        .tpl-preview-wrap { position:relative;background:#fff;border-radius:8px;overflow:hidden;margin-bottom:16px; }
        .tpl-preview-wrap canvas { width:100%;display:block; }
        .tpl-field-marker { position:absolute;border:2px dashed #3498db;background:rgba(52,152,219,0.15);cursor:move;font-size:10px;color:#3498db;padding:2px 4px;border-radius:3px;min-width:60px;min-height:18px;display:flex;align-items:center; }
        .tpl-field-marker.active { border-color:#e74c3c;background:rgba(231,76,60,0.15);color:#e74c3c; }
        .tpl-field-bar { display:flex;flex-wrap:wrap;gap:6px;margin-bottom:12px; }
        .tpl-field-btn { background:#1a2744;border:1px solid #2a3a5c;color:#bdc3c7;padding:6px 12px;border-radius:6px;font-size:11px;cursor:pointer; }
        .tpl-field-btn:hover { border-color:#3498db;color:#3498db; }
        .tpl-field-btn.placed { background:#27ae60;border-color:#27ae60;color:white; }
        .tpl-gen-bar { display:flex;gap:8px;margin-top:16px; }
        .tpl-gen-bar button { padding:10px 20px;border:none;border-radius:8px;font-size:13px;font-weight:600;cursor:pointer; }
        .tpl-gen-bar .tpl-fill-btn { background:linear-gradient(135deg,#3498db,#2980b9);color:white; }
        .tpl-gen-bar .tpl-fill-btn:hover { filter:brightness(1.15); }
        .tpl-gen-bar .tpl-cancel-btn { background:#2a3a5c;color:#bdc3c7; }
        /* CTA Buttons */
        .cta-buttons { display: flex; flex-direction: column; gap: 8px; }
        .cta-btn { padding: 10px 16px; border: none; border-radius: 8px; font-size: 13px; font-weight: 600; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; gap: 6px; min-width: 140px; }
        .cta-btn.enhanced-atp { background: #e67e22; color: white; }
        .cta-btn.enhanced-atp:hover { background: #d35400; transform: translateY(-1px); }
        .cta-btn.google-scan { background: #4285f4; color: white; }
        .cta-btn.google-scan:hover { background: #3367d6; transform: translateY(-1px); }
    </style>
</head>
<body>

<!-- PIN LOGIN OVERLAY -->
<div id="loginOverlay">
    <div class="login-box">
        <h2>Bid Generator</h2>
        <p>Enter your PIN to access your synced workspace</p>
        <input type="password" id="pinInput" maxlength="6" placeholder="----" autofocus>
        <button class="login-btn" id="loginBtn" onclick="attemptLogin()">Unlock</button>
        <div class="login-error" id="loginError"></div>
        <div class="login-hint" id="loginHint">First time? Enter a new 4-6 digit PIN to create your workspace.</div>
    </div>
</div>

<!-- MAIN APP (hidden until login) -->
<div class="container" id="mainApp" style="display:none;">
    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 20px;">
        <div>
            <h1>Bid Document Generator</h1>
            <p class="subtitle">Fill in the details below, then generate your Labor Estimate, Materials Estimate, or Change Order. All generated docs are editable with e-signature pads.</p>
        </div>
        <div class="cta-buttons">
            <button class="cta-btn enhanced-atp" onclick="window.open('/tools/bidgen/dual-brand-bid-system.html', '_blank')">
                üè¢ Enhanced ATP
            </button>
            <button class="cta-btn google-scan" onclick="window.open('/tools/bidgen/google-integration.html', '_blank')">
                ‚òÅÔ∏è Google Scan
            </button>
        </div>
    </div>

    <!-- SYNC STATUS BAR -->
    <div class="sync-bar">
        <div class="sync-status"><span class="sync-dot online" id="syncDot"></span><span class="sync-label" id="syncLabel">Connected to cloud</span></div>
        <span class="sync-device" id="syncDevice"></span>
        <button class="logout-btn" onclick="logout()">Lock</button>
    </div>

    <div class="catalog-bar" id="catalogBar">
        <div class="catalog-item">
            <div class="catalog-icon">&#x1F4C9;</div>
            <div class="catalog-label">Market Rate Analysis</div>
            <input type="number" id="marketRate" placeholder="25.00" step="0.01" onchange="updateMarketRates()">
        </div>
        <div class="catalog-item">
            <div class="catalog-icon">&#x1F4C8;</div>
            <div class="catalog-label">Inflation %/yr</div>
            <input type="number" id="inflationRate" placeholder="3.2" step="0.1" onchange="saveInflationRate()">
        </div>
        <div class="catalog-item">
            <div class="catalog-icon">&#x1F50D;</div>
            <div class="catalog-label">Smart Fill from History</div>
            <button class="predict-btn" onclick="predictiveFill()">&#9889; Smart Fill from History</button>
        </div>
    </div>

    <!-- INVOICE WIDGET (Top-Right Corner) -->
    <div class="invoice-widget" id="invoiceWidget">
        <div class="invoice-widget-header" onclick="toggleInvoiceWidget()">
            <div class="invoice-widget-title">üìö Quotes</div>
            <button class="invoice-widget-toggle" id="widgetToggle">‚àí</button>
        </div>
        <div class="invoice-widget-stats">
            <div class="invoice-widget-stat">
                <div class="invoice-widget-stat-value" id="statPending">0</div>
                <div class="invoice-widget-stat-label">Pending</div>
            </div>
            <div class="invoice-widget-stat">
                <div class="invoice-widget-stat-value" id="statExpiring" style="color: #e74c3c;">0</div>
                <div class="invoice-widget-stat-label">Expiring</div>
            </div>
        </div>
        <div class="invoice-widget-body" id="widgetBody">
            <!-- Auto-populated with urgent invoices -->
        </div>
        <div class="invoice-widget-actions">
            <button class="invoice-widget-btn primary" onclick="openInvoiceModal()">üìö Open Library</button>
        </div>
    </div>

    <!-- QUOTE LIBRARY MODAL -->
    <div class="invoice-modal" id="invoiceModal" onclick="if(event.target===this)closeInvoiceModal()">
        <div class="invoice-modal-content">
            <div class="invoice-modal-header">
                <div class="invoice-modal-title">üìö Quote Library</div>
                <button class="invoice-modal-close" onclick="closeInvoiceModal()">√ó</button>
            </div>
            <div class="invoice-modal-body">
                <!-- Stats Bar -->
                <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin-bottom:16px">
                    <div style="background:#0f1a33;border:1px solid #2a3a5c;border-radius:8px;padding:10px;text-align:center">
                        <div style="font-size:20px;font-weight:700;color:#3498db" id="statPendingLib">0</div>
                        <div style="font-size:10px;color:#7f8c8d;text-transform:uppercase">Pending</div>
                    </div>
                    <div style="background:#0f1a33;border:1px solid #2a3a5c;border-radius:8px;padding:10px;text-align:center">
                        <div style="font-size:20px;font-weight:700;color:#27ae60" id="statAwarded">0</div>
                        <div style="font-size:10px;color:#7f8c8d;text-transform:uppercase">Awarded</div>
                    </div>
                    <div style="background:#0f1a33;border:1px solid #2a3a5c;border-radius:8px;padding:10px;text-align:center">
                        <div style="font-size:20px;font-weight:700;color:#f39c12" id="statTotal">$0</div>
                        <div style="font-size:10px;color:#7f8c8d;text-transform:uppercase">Total Value</div>
                    </div>
                    <div style="background:#0f1a33;border:1px solid #2a3a5c;border-radius:8px;padding:10px;text-align:center">
                        <div style="font-size:20px;font-weight:700;color:#e74c3c" id="statExpiringLib">0</div>
                        <div style="font-size:10px;color:#7f8c8d;text-transform:uppercase">Expiring</div>
                    </div>
                </div>
                <!-- Tabs -->
                <div class="invoice-tabs">
                    <button class="invoice-tab active" onclick="invSwitchTab('all')">All Quotes</button>
                    <button class="invoice-tab" onclick="invSwitchTab('temporary')">Pending</button>
                    <button class="invoice-tab" onclick="invSwitchTab('permanent')">Awarded</button>
                    <button class="invoice-tab" onclick="invSwitchTab('lost')">Lost</button>
                    <button class="invoice-tab" onclick="openAnalytics()" style="margin-left:auto;background:#0f1a33;border:1px solid #2a3a5c;border-radius:6px">üìä Analytics</button>
                </div>
                <!-- Filters -->
                <div class="invoice-filters">
                    <input type="text" id="invSearchClient" placeholder="Search by client or location..." oninput="invRenderList()" style="flex:1">
                    <select id="invSortBy" onchange="invRenderList()">
                        <option value="expires-asc">Expiring Soonest</option>
                        <option value="date-desc">Date: Newest</option>
                        <option value="date-asc">Date: Oldest</option>
                        <option value="client-asc">Client: A-Z</option>
                        <option value="client-desc">Client: Z-A</option>
                        <option value="amount-desc">Amount: High-Low</option>
                        <option value="amount-asc">Amount: Low-High</option>
                    </select>
                    <select id="invFilterClient" onchange="invRenderList()">
                        <option value="">All Clients</option>
                    </select>
                </div>
                <!-- Quote Index List -->
                <div class="invoice-list" id="invoiceList">
                    <div class="invoice-empty">No quotes yet. Generate a bid to get started.</div>
                </div>
                <!-- Detail Panel (shown when clicking a quote) -->
                <div id="quoteDetailPanel" style="display:none"></div>
            </div>
        </div>
    </div>

    <div class="price-lookup" id="priceLookup">
        <h3>Material Catalog</h3>
        <div class="cat-tabs">
            <button class="cat-tab active" onclick="catSwitchTab('browse')">Browse</button>
            <button class="cat-tab" onclick="catSwitchTab('add')">+ Add Item</button>
            <button class="cat-tab" onclick="catSwitchTab('import')">Paste Import</button>
        </div>
        <!-- Browse Tab -->
        <div class="cat-panel" id="catBrowse">
            <div class="pl-search-row">
                <input type="text" id="catFilter" placeholder="Filter catalog... (type to search your saved items)" oninput="catRenderList()">
                <select id="catSort" onchange="catRenderList()">
                    <option value="recent">Recent</option>
                    <option value="alpha">A-Z</option>
                    <option value="price-low">Price: Low</option>
                    <option value="price-high">Price: High</option>
                    <option value="most-used">Most Used</option>
                </select>
            </div>
            <div class="pl-status" id="catStatus">Your saved materials &mdash; synced to cloud via Firebase</div>
            <div class="pl-results" id="catList">
                <div class="pl-empty">No items in catalog yet. Add items using the tabs above.</div>
            </div>
        </div>
        <!-- Add Item Tab -->
        <div class="cat-panel" id="catAdd" style="display:none">
            <div class="cat-form">
                <input type="text" id="catNewDesc" placeholder="Item description (e.g. 1/2 in. x 10 ft. PEX Pipe)" class="cat-input-full">
                <div class="cat-form-row">
                    <input type="text" id="catNewPrice" placeholder="Price ($)" class="cat-input-sm" onkeydown="if(event.key==='Enter')catAddItem()">
                    <input type="text" id="catNewQty" placeholder="Qty (1)" class="cat-input-sm" value="1">
                    <select id="catNewStore" class="cat-input-sm">
                        <option value="Manual">Store...</option>
                        <option value="Menards">Menards</option>
                        <option value="Home Depot">Home Depot</option>
                        <option value="Lowes">Lowes</option>
                        <option value="Amazon">Amazon</option>
                        <option value="Walmart">Walmart</option>
                        <option value="Other">Other</option>
                    </select>
                    <button class="cat-add-btn" onclick="catAddItem()">+ Add to Catalog</button>
                </div>
            </div>
            <div class="pl-status" id="catAddStatus">Add materials you use regularly. Prices are tracked over time.</div>
        </div>
        <!-- Paste Import Tab -->
        <div class="cat-panel" id="catImport" style="display:none">
            <div class="cat-form">
                <textarea id="catPasteArea" class="cat-textarea" placeholder="Paste items here ‚Äî one per line. Formats accepted:&#10;&#10;  Wax Ring  $4.99&#10;  12/2 Romex 250ft | 89.99 | Menards&#10;  PEX Pipe, 0.50, Home Depot&#10;&#10;Tip: Copy a list from any store website or receipt and paste it here."></textarea>
                <div class="cat-form-row">
                    <select id="catImportStore" class="cat-input-sm">
                        <option value="">Store (optional)</option>
                        <option value="Menards">Menards</option>
                        <option value="Home Depot">Home Depot</option>
                        <option value="Lowes">Lowes</option>
                        <option value="Amazon">Amazon</option>
                    </select>
                    <button class="cat-add-btn" onclick="catImportPaste()">Import Pasted Items</button>
                </div>
                <div style="display:flex;align-items:center;gap:10px;margin-top:6px;padding-top:10px;border-top:1px solid #2a3a5c">
                    <label class="cat-add-btn" style="background:linear-gradient(135deg,#3498db,#2980b9);cursor:pointer;display:inline-flex;align-items:center;gap:6px">
                        <span>Upload CSV File</span>
                        <input type="file" id="catCsvFile" accept=".csv,.txt,.tsv" style="display:none" onchange="catImportCSV(this)">
                    </label>
                    <button class="cat-add-btn" onclick="catImportFromScan()" style="background:linear-gradient(135deg,#e67e22,#d35400)">
                        üì• Import from Scan
                    </button>
                    <span style="font-size:11px;color:#7f8c8d">Import from Google Integration scans</span>
                </div>
            </div>
            <div class="pl-status" id="catImportStatus">Paste product lists, upload CSV files, or use the AI prompt below.</div>
            <div style="margin-top:12px;background:#1a2744;border:1px solid #2a3a5c;border-radius:8px;padding:12px">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
                    <span style="color:#f39c12;font-size:12px;font-weight:600">AI Prompt Template ‚Äî Copy &amp; paste to DeepSeek / ChatGPT</span>
                    <button onclick="catCopyPrompt()" style="background:#2a3a5c;color:#eee;border:none;padding:4px 12px;border-radius:4px;font-size:11px;cursor:pointer">Copy Prompt</button>
                </div>
                <div id="catAiPrompt" style="font-size:11px;color:#aaa;font-family:monospace;white-space:pre-wrap;line-height:1.5;max-height:120px;overflow-y:auto;background:#0f1a33;padding:10px;border-radius:6px">I need a list of common materials and current retail prices for a TRADE_TYPE project. Format each item on its own line like this:

Item Description | $Price | Store Name

For example:
1/2 in. x 10 ft. PEX-A Pipe | $3.98 | Home Depot
Wax Ring for Toilet | $4.27 | Menards
12/2 NM-B Romex Wire 250ft | $89.97 | Lowes

Please give me 20-30 items commonly used in TRADE_TYPE work, with realistic current US retail prices. Include items from Menards, Home Depot, Lowes, and Amazon. Focus on: FOCUS_AREA</div>
                <div class="cat-form-row" style="margin-top:8px">
                    <select id="catPromptTrade" class="cat-input-sm" onchange="catUpdatePrompt()">
                        <option value="plumbing">Plumbing</option>
                        <option value="electrical">Electrical</option>
                        <option value="HVAC">HVAC</option>
                        <option value="general handyman">General Handyman</option>
                        <option value="flooring">Flooring</option>
                        <option value="drywall">Drywall</option>
                        <option value="painting">Painting</option>
                        <option value="roofing">Roofing</option>
                    </select>
                    <input type="text" id="catPromptFocus" class="cat-input-sm" placeholder="Focus area (e.g. bathroom rough-in, panel upgrade...)" value="common repairs and installs" oninput="catUpdatePrompt()">
                </div>
            </div>
        </div>
    </div>

    <div class="instructions">
        <h3>How to Use</h3>
        <ol>
            <li><strong>Select your trade type</strong> (Section 2) &mdash; scope, materials, and disclaimers auto-populate.</li>
            <li><strong>Fill in your company info</strong> (Section 1) &mdash; saves automatically to cloud.</li>
            <li><strong>Fill in the job details</strong> (Section 2) &mdash; client name, address, unit, date.</li>
            <li><strong>Adjust labor line items &amp; materials</strong> (Section 3) &mdash; add, remove, or edit rows.</li>
            <li><strong>Click a button</strong> to open the document in a new tab.</li>
            <li>In the generated doc: click <strong>"Edit Values"</strong> to adjust any number or text. Totals auto-recalculate.</li>
            <li><strong>Sign</strong> with mouse or finger on the signature pads. Date auto-stamps.</li>
            <li><strong>Ctrl+P</strong> &rarr; <strong>"Save as PDF"</strong> to save the final version.</li>
        </ol>
    </div>

    <!-- SECTION 1 -->
    <div class="card">
        <h2><span class="icon">1</span> Your Company Info <span class="saved-indicator" id="companySaved">Synced</span></h2>
        <div class="form-grid">
            <div class="form-group full">
                <label>Invoice Brand</label>
                <select id="brandSelect" onchange="onBrandChange()">
                    <option value="wsi">Watts Safety Installs</option>
                    <option value="atp">Watts ATP Contractor</option>
                </select>
            </div>
            <div class="form-group full"><label>Company Name</label><input type="text" id="companyName" placeholder="e.g. Smith General Contracting LLC"></div>
            <div class="form-group"><label>License Number</label><input type="text" id="licenseNum" placeholder="NE License #"></div>
            <div class="form-group"><label>Phone</label><input type="text" id="phone" placeholder="(402) 555-1234"></div>
            <div class="form-group"><label>Email</label><input type="text" id="email" placeholder="you@company.com"></div>
            <div class="form-group"><label>City / Address (optional)</label><input type="text" id="companyAddress" placeholder="Norfolk, NE"></div>
        </div>
    </div>

    <!-- QUICK TEMPLATES -->
    <div class="template-bar" id="templateBar">
        <label>‚ö° Quick Template</label>
        <select id="templateSelect">
            <option value="">-- Select a preset job template --</option>
            <optgroup label="Accessibility / ATP">
                <option value="grab_bar_install">Grab Bar Installation (Standard)</option>
                <option value="ada_ramp">ADA Ramp Build &amp; Install</option>
                <option value="walk_in_shower">Walk-In Shower Conversion</option>
                <option value="stair_rail">Stair Rail / Handrail Install</option>
            </optgroup>
            <optgroup label="Plumbing">
                <option value="toilet_replace">Toilet Replacement</option>
                <option value="faucet_replace">Faucet Replacement</option>
                <option value="water_heater">Water Heater Install</option>
                <option value="drain_repair">Drain Repair / Clearing</option>
            </optgroup>
            <optgroup label="Electrical">
                <option value="outlet_install">Outlet / Switch Install</option>
                <option value="light_fixture">Light Fixture Install</option>
                <option value="ceiling_fan">Ceiling Fan Install</option>
                <option value="gfci_upgrade">GFCI Outlet Upgrade</option>
            </optgroup>
            <optgroup label="General / Remodel">
                <option value="drywall_patch">Drywall Patch &amp; Repair</option>
                <option value="door_install">Interior Door Install</option>
                <option value="flooring_vinyl">Vinyl Flooring Install</option>
                <option value="paint_room">Room Paint (Interior)</option>
            </optgroup>
        </select>
        <button onclick="applyTemplate()">Apply</button>
    </div>

    <!-- SECTION 2 -->
    <div class="card">
        <h2><span class="icon">2</span> Job Details <span class="trade-badge flooring" id="tradeBadge">Flooring</span></h2>
        <div class="form-grid">
            <div class="form-group full">
                <label>Trade Type</label>
                <select id="tradeType" onchange="onTradeChange()">
                    <option value="flooring">Flooring</option>
                    <option value="painting">Painting</option>
                    <option value="general">General / Remodel</option>
                    <option value="plumbing">Plumbing</option>
                    <option value="electrical">Electrical</option>
                    <option value="custom">Custom (blank template)</option>
                </select>
            </div>
            <div class="form-group"><label>Client / Property Management Co.</label><div class="client-ac-wrap"><input type="text" id="clientName" placeholder="e.g. ABC Property Management" oninput="clientAcSearch()" onfocus="clientAcSearch()" autocomplete="off"><div class="client-ac-drop" id="clientAcDrop"></div></div></div>
            <div class="form-group"><label>Estimate Date</label><input type="date" id="estimateDate"></div>
            <div class="form-group"><label>Property / Complex Name</label><input type="text" id="complexName" placeholder="e.g. Oakwood Apartments"></div>
            <div class="form-group"><label>Unit / Address</label><input type="text" id="unitNum" placeholder="e.g. Unit 204"></div>
            <div class="form-group"><label>City, State</label><input type="text" id="jobCity" placeholder="e.g. Norfolk, NE"></div>
            <div class="form-group"><label>Area Size (sq ft)</label><input type="number" id="sqft" value="48" min="1"></div>
            <div class="form-group full"><label>Area Description (e.g. "Bathroom, Second Floor" or "Living Room &amp; Hallway")</label><input type="text" id="areaDesc" placeholder="e.g. Bathroom, Second Floor"></div>
        </div>
        <div class="saved-jobs" style="margin-top:16px;">
            <label style="font-size:11px; text-transform:uppercase; color:#7f8c8d; letter-spacing:0.5px;">Saved Jobs (synced across devices)</label>
            <select id="savedJobsSelect"><option value="">-- Select a saved job --</option></select>
            <div class="job-actions">
                <button class="btn btn-save" onclick="saveJob()">Save Current Job</button>
                <button class="btn btn-save" onclick="loadJob()">Load Selected</button>
                <button class="btn btn-clear" onclick="deleteJob()">Delete Selected</button>
                <button class="btn btn-clear" onclick="clearForm()">Clear Form</button>
            </div>
        </div>
    </div>

    <!-- SECTION 3 -->
    <div class="card">
        <h2><span class="icon">3</span> Labor Line Items</h2>
        <div class="item-header labor"><span>Description</span><span>Basis</span><span>Price</span></div>
        <div id="laborItemsContainer"></div>
        <button class="add-row-btn" onclick="addLaborRow('','','')">+ Add Labor Item</button>
    </div>

    <div class="card">
        <h2><span class="icon">4</span> Material Line Items</h2>
        <div class="form-grid" style="margin-bottom:14px;">
            <div class="form-group"><label>Materials Markup %</label><input type="number" id="materialsMarkup" value="15" step="1"></div>
            <div class="form-group"><label>Third-Party Supplier Note (optional)</label><input type="text" id="supplierNote" placeholder="e.g. Scranton Flooring supplies vinyl ‚Äî PM pays directly"></div>
        </div>
        <div class="item-header mat"><span>Material</span><span>Qty</span><span>Price</span></div>
        <div id="matItemsContainer"></div>
        <button class="add-row-btn" onclick="addMatRow('','','')">+ Add Material Item</button>
    </div>

    <!-- SECTION 5 -->
    <div class="card">
        <h2><span class="icon">5</span> Disclaimer &amp; Unforeseen Conditions</h2>
        <div class="form-group full">
            <label>Unforeseen Conditions Clause (auto-filled by trade, editable)</label>
            <textarea id="disclaimer" rows="4" style="resize:vertical;"></textarea>
        </div>
    </div>

    <div class="btn-row">
        <button class="btn btn-labor" onclick="generateLabor()">Open Labor Estimate (A)</button>
        <button class="btn btn-materials" onclick="generateMaterials()">Open Materials Estimate (B)</button>
        <button class="btn btn-change" onclick="generateChangeOrder()">Open Change Order</button>
        <button class="btn" style="background:linear-gradient(135deg,#8e44ad,#9b59b6);color:white" onclick="openTemplateManager()">Use My Template</button>
    </div>
</div>

<!-- PDF TEMPLATE MANAGER MODAL -->
<div class="tpl-modal-overlay" id="tplOverlay">
    <div class="tpl-modal">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px">
            <h2 style="margin:0">PDF Template Manager</h2>
            <button onclick="closeTplManager()" style="background:none;border:none;color:#7f8c8d;font-size:20px;cursor:pointer">&times;</button>
        </div>
        <div class="tpl-tabs">
            <div class="tpl-tab active" onclick="tplSwitchTab('library',this)">My Templates</div>
            <div class="tpl-tab" onclick="tplSwitchTab('mapper',this)">Field Mapper</div>
        </div>
        <!-- LIBRARY TAB -->
        <div id="tplTabLibrary">
            <div class="tpl-upload-zone" id="tplDropZone">
                <div style="font-size:36px;margin-bottom:8px">üìÑ</div>
                <strong style="color:#ecf0f1;font-size:14px">Upload a PDF Template</strong>
                <p>Drag &amp; drop a PDF here, or click to browse.<br>Works with fillable forms and static layouts.</p>
                <input type="file" id="tplFileInput" accept=".pdf" style="display:none">
            </div>
            <div class="tpl-list" id="tplList">
                <div style="text-align:center;color:#7f8c8d;padding:20px;font-size:13px">No templates uploaded yet. Upload a PDF to get started.</div>
            </div>
        </div>
        <!-- MAPPER TAB -->
        <div id="tplTabMapper" style="display:none">
            <div id="tplMapperEmpty" style="text-align:center;color:#7f8c8d;padding:40px;font-size:13px">
                Select a template from the Library tab first, then click "Map Fields" to set up field positions.
            </div>
            <div id="tplMapperContent" style="display:none">
                <h3>Click a field button, then click on the PDF where it should go:</h3>
                <div class="tpl-field-bar" id="tplFieldBar"></div>
                <div class="tpl-preview-wrap" id="tplPreviewWrap">
                    <canvas id="tplCanvas"></canvas>
                </div>
                <div class="tpl-gen-bar">
                    <button class="tpl-fill-btn" onclick="tplSaveMappings()">Save Field Mappings</button>
                    <button class="tpl-cancel-btn" onclick="tplClearMappings()">Clear All</button>
                </div>
            </div>
        </div>
        <!-- GENERATE FROM TEMPLATE -->
        <div style="border-top:1px solid #2a3a5c;padding-top:16px;margin-top:16px">
            <h3 style="margin-top:0">Generate from Template</h3>
            <p style="font-size:12px;color:#7f8c8d;margin-bottom:12px">Select a template above, then click generate. Your current bid data will be filled into the template.</p>
            <div class="tpl-gen-bar">
                <button class="tpl-fill-btn" onclick="tplGenerateFilled()">Fill &amp; Download PDF</button>
                <button class="tpl-cancel-btn" onclick="closeTplManager()">Close</button>
            </div>
        </div>
    </div>
</div>

<script>
// =====================================================================
// FIREBASE CONFIG & INIT
// =====================================================================
const firebaseConfig = {
    apiKey: "AIzaSyBPcOw7Qjw6ePeHSmGBTSIRKwrqhIZMB0Q",
    authDomain: "wsi---bid-generator.firebaseapp.com",
    databaseURL: "https://wsi---bid-generator-default-rtdb.firebaseio.com",
    projectId: "wsi---bid-generator",
    storageBucket: "wsi---bid-generator.firebasestorage.app",
    messagingSenderId: "613129301141",
    appId: "1:613129301141:web:92405028eca5aae354bf9c",
    measurementId: "G-011LE4CZEF"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

let userPIN = null;
let dbRef = null; // will be db.ref('users/<hashed_pin>')
let companyRef = null;
let jobsRef = null;
let catalogRef = null;
let settingsRef = null;
let _suppressSync = false; // prevent loops when loading from cloud
let _catalog = { labor: {}, materials: {} };
let _inflationRate = 3.2;

// =====================================================================
// SIMPLE PIN HASHING (not crypto-grade, just obfuscation for DB path)
// =====================================================================
function hashPIN(pin) {
    let h = 0;
    for (let i = 0; i < pin.length; i++) {
        h = ((h << 5) - h) + pin.charCodeAt(i);
        h |= 0;
    }
    return 'u' + Math.abs(h).toString(36);
}

// =====================================================================
// LOGIN / AUTH
// =====================================================================
document.getElementById('pinInput').addEventListener('keydown', function(e) {
    if (e.key === 'Enter') attemptLogin();
});

function attemptLogin() {
    const pin = document.getElementById('pinInput').value.trim();
    if (pin.length < 4) {
        document.getElementById('loginError').textContent = 'PIN must be at least 4 digits.';
        return;
    }
    const hashed = hashPIN(pin);
    dbRef = db.ref('users/' + hashed);
    companyRef = dbRef.child('company');
    jobsRef = dbRef.child('jobs');
    catalogRef = dbRef.child('catalog');
    settingsRef = dbRef.child('settings');

    // Check if this PIN/workspace exists
    dbRef.child('created').once('value').then(snap => {
        if (snap.exists()) {
            // Existing workspace ‚Äî load it
            userPIN = pin;
            sessionStorage.setItem('bid_pin', pin);
            showApp();
        } else {
            // New workspace ‚Äî create it
            if (!confirm('This PIN has no saved data yet. Create a new workspace with PIN "' + pin + '"?')) return;
            dbRef.child('created').set(Date.now()).then(() => {
                userPIN = pin;
                sessionStorage.setItem('bid_pin', pin);
                showApp();
            });
        }
    }).catch(err => {
        document.getElementById('loginError').textContent = 'Connection error. Check your internet.';
        console.error(err);
    });
}

function logout() {
    sessionStorage.removeItem('bid_pin');
    location.reload();
}

function showApp() {
    document.getElementById('loginOverlay').style.display = 'none';
    document.getElementById('mainApp').style.display = 'block';
    document.getElementById('syncDevice').textContent = 'PIN: ' + userPIN.charAt(0) + '***';
    initApp();
    setTimeout(function() {
        initInvoiceSystem();
        initClientDB();
        initPushNotifications();
        tplLoadFromFirebase();
    }, 500);
}

function showNotification(msg, type) {
    const el = document.createElement('div');
    el.style.cssText = 'position:fixed;top:20px;left:50%;transform:translateX(-50%);padding:12px 24px;border-radius:8px;font-size:13px;font-weight:600;z-index:99999;box-shadow:0 4px 12px rgba(0,0,0,0.3);transition:opacity 0.3s;';
    el.style.background = type === 'success' ? '#27ae60' : type === 'error' ? '#e74c3c' : '#3498db';
    el.style.color = 'white';
    el.textContent = msg;
    document.body.appendChild(el);
    setTimeout(() => { el.style.opacity = '0'; setTimeout(() => el.remove(), 300); }, 3000);
}

// Auto-login if session still active
window.addEventListener('DOMContentLoaded', () => {
    const savedPin = sessionStorage.getItem('bid_pin');
    if (savedPin) {
        document.getElementById('pinInput').value = savedPin;
        attemptLogin();
    }
});

// =====================================================================
// SYNC STATUS HELPERS
// =====================================================================
function setSyncStatus(state, label) {
    const dot = document.getElementById('syncDot');
    const lbl = document.getElementById('syncLabel');
    dot.className = 'sync-dot ' + state;
    lbl.textContent = label;
}

let _syncTimer = null;
function flashSync() {
    setSyncStatus('syncing', 'Syncing...');
    clearTimeout(_syncTimer);
    _syncTimer = setTimeout(() => setSyncStatus('online', 'Connected to cloud'), 1200);
}

// =====================================================================
// TRADE PRESETS
// =====================================================================
const TRADES = {
    flooring: {
        label: 'Flooring',
        areaDesc: 'Bathroom, Second Floor',
        scope: [
            'Disconnect, remove, store, and reinstall toilet',
            'Demolition and removal of existing flooring layers',
            'Subfloor inspection and repair as needed',
            'Concrete/cement patch layer repair using professional-grade compounds',
            'Self-leveling underlayment ‚Äî prime and pour',
            'Installation of new flooring material',
            'Debris removal, hauling, and disposal'
        ],
        labor: [
            { desc: 'Toilet Removal & Reinstallation', basis: '1 fixture', price: 140 },
            { desc: 'Demolition ‚Äî Existing Flooring Layers', basis: 'per sq ft', price: 4.50 },
            { desc: 'Subfloor Repair', basis: 'fixed', price: 250 },
            { desc: 'Concrete/Cement Patch Repair', basis: 'per sq ft', price: 1.50 },
            { desc: 'Self-Leveling Underlayment ‚Äî Prime & Pour', basis: 'per sq ft', price: 3.00 },
            { desc: 'Flooring Installation', basis: 'per sq ft', price: 2.75 },
            { desc: 'Debris Hauling & Disposal', basis: '1 lot', price: 60 },
            { desc: 'Material Procurement & Coordination', basis: '1 lot', price: 60 }
        ],
        materials: [
            { desc: 'Wax Ring with Plastic Sleeve', qty: '1 ea', price: 8 },
            { desc: 'Toilet Mounting Bolts', qty: '1 set', price: 5 },
            { desc: '3/4" OSB Sheet (4\' x 8\')', qty: '1 sheet', price: 45 },
            { desc: '2x4 Lumber ‚Äî Blocking', qty: '8 lin ft', price: 10 },
            { desc: 'Construction Adhesive', qty: '1 tube', price: 6 },
            { desc: 'Deck Screws / Ring-Shank Nails', qty: '1 box', price: 8 },
            { desc: 'ARDEX FEATHER FINISH (10 lb)', qty: '1 bag', price: 30 },
            { desc: 'ARDEX GPS Patch & Skimcoat (10 lb)', qty: '1 bag', price: 25 },
            { desc: 'ARDEX K 15 Self-Leveling (50 lb)', qty: '1 bag', price: 45 },
            { desc: 'ARDEX P 51 Primer (1 qt)', qty: '1 qt', price: 15 },
            { desc: 'Mixing Paddle / Trowels / Spreaders', qty: '1 lot', price: 10 },
            { desc: 'Scraper Blades / Utility Blades', qty: '1 pack', price: 8 },
            { desc: 'Containment / Damming Material', qty: '1 lot', price: 5 },
            { desc: 'Plastic Sheeting / Drop Cloths', qty: '1 roll', price: 6 },
            { desc: 'Contractor Trash Bags (Heavy Duty)', qty: '1 box', price: 8 }
        ],
        supplierNote: 'Sheet vinyl and adhesive supplied by Scranton Flooring ‚Äî PM pays Scranton directly. This estimate covers subfloor repair materials, underlayment, and consumables only.',
        disclaimer: 'Due to existing flooring layers, the condition of the underlying subfloor, patch layers, and structural members cannot be fully ascertained prior to demolition. Contractor shall provide immediate written notice upon discovery of any concealed damage, rot, mold, structural deficiency, or non-compliant prior repairs. Work in the affected area shall cease until a written Change Order authorizing additional scope and compensation is executed by both parties.',
        notes: [
            'Flooring material may be supplied separately by a third-party vendor as noted above.',
            'Markup covers procurement time, vehicle/fuel, handling, and warranty administration.',
            'All work performed per manufacturer specifications and Nebraska building code.'
        ]
    },
    painting: {
        label: 'Painting',
        areaDesc: 'Interior Unit',
        scope: [
            'Surface preparation ‚Äî patching, sanding, caulking',
            'Primer application on all prepared surfaces',
            'Two coats of finish paint on walls',
            'Ceiling painting (one coat primer + one coat finish)',
            'Trim, door, and window frame painting',
            'Hardware removal and reinstallation as needed',
            'Drop cloths, masking, and protection of fixtures/flooring',
            'Cleanup and debris removal'
        ],
        labor: [
            { desc: 'Surface Prep ‚Äî Patch, Sand, Caulk', basis: 'per sq ft', price: 0.75 },
            { desc: 'Primer Application ‚Äî Walls', basis: 'per sq ft', price: 0.50 },
            { desc: 'Finish Paint ‚Äî Walls (2 coats)', basis: 'per sq ft', price: 1.25 },
            { desc: 'Ceiling ‚Äî Prime & Paint', basis: 'per sq ft', price: 1.00 },
            { desc: 'Trim / Doors / Window Frames', basis: 'per unit', price: 35 },
            { desc: 'Hardware Removal & Reinstall', basis: '1 lot', price: 40 },
            { desc: 'Masking, Protection & Cleanup', basis: '1 lot', price: 50 }
        ],
        materials: [
            { desc: 'Interior Latex Paint ‚Äî Walls (5 gal)', qty: '1 bucket', price: 145 },
            { desc: 'Interior Latex Paint ‚Äî Ceiling (5 gal)', qty: '1 bucket', price: 125 },
            { desc: 'Primer ‚Äî Multi-Surface (5 gal)', qty: '1 bucket', price: 95 },
            { desc: 'Trim Paint ‚Äî Semi-Gloss (1 gal)', qty: '1 gal', price: 45 },
            { desc: 'Caulk ‚Äî Paintable Latex', qty: '4 tubes', price: 16 },
            { desc: 'Spackle / Joint Compound', qty: '1 qt', price: 8 },
            { desc: 'Sandpaper Assortment', qty: '1 pack', price: 12 },
            { desc: 'Painter\'s Tape (Blue)', qty: '4 rolls', price: 24 },
            { desc: 'Roller Covers / Brushes / Trays', qty: '1 lot', price: 30 },
            { desc: 'Drop Cloths / Plastic Sheeting', qty: '1 lot', price: 15 },
            { desc: 'Contractor Trash Bags', qty: '1 box', price: 8 }
        ],
        supplierNote: '',
        disclaimer: 'Existing wall and ceiling conditions may include concealed damage such as water stains, mold, lead-based paint (pre-1978 structures), crumbling plaster, or drywall deterioration not visible until surface preparation begins. Contractor shall provide immediate written notice upon discovery. Work shall cease in the affected area until a written Change Order is executed by both parties. Lead paint testing is the responsibility of the property owner per EPA RRP Rule.',
        notes: [
            'Paint colors to be selected and approved by client prior to purchase.',
            'Markup covers procurement time, vehicle/fuel, handling, and warranty administration.',
            'Walls with extensive damage may require skim-coating at additional cost (Change Order).'
        ]
    },
    general: {
        label: 'General / Remodel',
        areaDesc: 'Unit Interior',
        scope: ['Demolition and removal of existing materials','Structural inspection and repair as needed','Rough carpentry and framing','Finish carpentry and trim installation','Material procurement and coordination','Debris removal, hauling, and disposal','Final cleanup and punch list'],
        labor: [
            { desc: 'Demolition & Removal', basis: 'per sq ft', price: 3.00 },
            { desc: 'Framing / Structural Repair', basis: 'fixed', price: 300 },
            { desc: 'Rough Carpentry', basis: 'per hour', price: 65 },
            { desc: 'Finish Carpentry / Trim', basis: 'per hour', price: 65 },
            { desc: 'Material Procurement & Coordination', basis: '1 lot', price: 75 },
            { desc: 'Debris Hauling & Disposal', basis: '1 lot', price: 75 },
            { desc: 'Final Cleanup & Punch List', basis: '1 lot', price: 50 }
        ],
        materials: [
            { desc: 'Framing Lumber', qty: '1 lot', price: 80 },
            { desc: 'Plywood / OSB Sheathing', qty: '1 lot', price: 60 },
            { desc: 'Fasteners / Screws / Nails', qty: '1 lot', price: 25 },
            { desc: 'Construction Adhesive', qty: '2 tubes', price: 12 },
            { desc: 'Trim / Molding', qty: '1 lot', price: 45 },
            { desc: 'Caulk / Sealant', qty: '1 lot', price: 15 },
            { desc: 'Plastic Sheeting / Drop Cloths', qty: '1 lot', price: 10 },
            { desc: 'Contractor Trash Bags', qty: '1 box', price: 8 }
        ],
        supplierNote: '',
        disclaimer: 'Concealed conditions behind walls, above ceilings, or beneath floors cannot be fully assessed until demolition is underway. This includes but is not limited to: structural damage, mold, pest damage, non-code-compliant wiring or plumbing, and asbestos-containing materials. Contractor shall provide immediate written notice upon discovery. Work shall cease until a written Change Order is executed by both parties.',
        notes: ['Specialty subcontractors (plumbing, electrical, HVAC) quoted separately if needed.','Markup covers procurement time, vehicle/fuel, handling, and warranty administration.','All work performed per Nebraska building code and manufacturer specifications.']
    },
    plumbing: {
        label: 'Plumbing',
        areaDesc: 'Bathroom / Kitchen',
        scope: ['Shut off water supply and drain lines','Removal of existing fixtures as needed','Pipe repair, replacement, or rerouting','Installation of new fixtures and trim','Pressure testing and leak check','Drywall / access panel patching (if applicable)','Cleanup and debris removal'],
        labor: [
            { desc: 'Fixture Removal & Disposal', basis: 'per fixture', price: 75 },
            { desc: 'Pipe Repair / Replacement', basis: 'per hour', price: 85 },
            { desc: 'New Fixture Installation', basis: 'per fixture', price: 120 },
            { desc: 'Pressure Test & Leak Check', basis: '1 lot', price: 50 },
            { desc: 'Access Panel / Drywall Patch', basis: '1 lot', price: 60 },
            { desc: 'Cleanup & Debris Removal', basis: '1 lot', price: 40 }
        ],
        materials: [
            { desc: 'PEX / Copper Pipe & Fittings', qty: '1 lot', price: 65 },
            { desc: 'Shut-Off Valves', qty: '2 ea', price: 24 },
            { desc: 'Supply Lines (braided)', qty: '2 ea', price: 16 },
            { desc: 'Wax Ring / Gaskets / Seals', qty: '1 lot', price: 12 },
            { desc: 'Pipe Sealant / Teflon Tape', qty: '1 lot', price: 8 },
            { desc: 'Drywall Patch Kit', qty: '1 ea', price: 15 },
            { desc: 'Contractor Trash Bags', qty: '1 box', price: 8 }
        ],
        supplierNote: '',
        disclaimer: 'Plumbing systems concealed within walls, floors, and ceilings cannot be fully assessed until access is gained. Conditions including corroded pipes, non-code-compliant connections, galvanic corrosion, root intrusion, or deteriorated drain lines may be discovered during work. Contractor shall provide immediate written notice. Work shall cease until a written Change Order is executed by both parties.',
        notes: ['Fixtures to be selected and approved by client prior to purchase unless specified.','Markup covers procurement time, vehicle/fuel, handling, and warranty administration.','Permits pulled if required by local jurisdiction.']
    },
    electrical: {
        label: 'Electrical',
        areaDesc: 'Unit Interior',
        scope: ['Circuit identification and testing','Removal of existing fixtures / devices as needed','Wire repair, replacement, or new runs','Installation of new fixtures, outlets, and switches','Panel inspection and breaker work (if applicable)','Testing and verification of all circuits','Patching of access points and cleanup'],
        labor: [
            { desc: 'Circuit Testing & Identification', basis: '1 lot', price: 60 },
            { desc: 'Fixture / Device Removal', basis: 'per unit', price: 25 },
            { desc: 'Wire Run ‚Äî New or Replacement', basis: 'per run', price: 120 },
            { desc: 'Fixture / Outlet / Switch Install', basis: 'per unit', price: 45 },
            { desc: 'Panel / Breaker Work', basis: 'per hour', price: 95 },
            { desc: 'Final Testing & Verification', basis: '1 lot', price: 50 },
            { desc: 'Patching & Cleanup', basis: '1 lot', price: 40 }
        ],
        materials: [
            { desc: 'Romex / Wire (various gauge)', qty: '1 lot', price: 55 },
            { desc: 'Outlets / Switches / Cover Plates', qty: '1 lot', price: 30 },
            { desc: 'Junction Boxes / Connectors', qty: '1 lot', price: 20 },
            { desc: 'Wire Nuts / Electrical Tape', qty: '1 lot', price: 10 },
            { desc: 'Breakers (if needed)', qty: '1 lot', price: 25 },
            { desc: 'Drywall Patch Kit', qty: '1 ea', price: 15 },
            { desc: 'Contractor Trash Bags', qty: '1 box', price: 8 }
        ],
        supplierNote: '',
        disclaimer: 'Electrical systems concealed within walls, ceilings, and floors cannot be fully assessed until access is gained. Conditions including aluminum wiring, knob-and-tube wiring, non-code-compliant connections, overloaded circuits, or deteriorated insulation may be discovered. Contractor shall provide immediate written notice. Work shall cease until a written Change Order is executed by both parties. All electrical work performed per NEC and local code.',
        notes: ['Light fixtures and specialty devices to be selected by client unless specified.','Markup covers procurement time, vehicle/fuel, handling, and warranty administration.','Permits pulled if required by local jurisdiction.']
    },
    custom: {
        label: 'Custom',
        areaDesc: '',
        scope: ['[Describe scope item]'],
        labor: [
            { desc: '[Labor description]', basis: '1 lot', price: 0 },
            { desc: '[Labor description]', basis: '1 lot', price: 0 },
            { desc: '[Labor description]', basis: '1 lot', price: 0 }
        ],
        materials: [
            { desc: '[Material description]', qty: '1 lot', price: 0 },
            { desc: '[Material description]', qty: '1 lot', price: 0 },
            { desc: '[Material description]', qty: '1 lot', price: 0 }
        ],
        supplierNote: '',
        disclaimer: 'Concealed conditions not visible prior to commencement of work may require additional scope. Contractor shall provide immediate written notice upon discovery. Work shall cease until a written Change Order is executed by both parties.',
        notes: ['Markup covers procurement time, vehicle/fuel, handling, and warranty administration.','All work performed per applicable building codes.']
    }
};

// =====================================================================
// APP INIT ‚Äî load from Firebase
// =====================================================================
function initApp() {
    if (!document.getElementById('estimateDate').value) {
        document.getElementById('estimateDate').value = new Date().toISOString().split('T')[0];
    }

    // Load company info from Firebase
    companyRef.once('value').then(snap => {
        const data = snap.val();
        if (data) {
            _suppressSync = true;
            companyFields.forEach(id => {
                if (data[id]) document.getElementById(id).value = data[id];
            });
            _suppressSync = false;
        }
    });

    // Load saved jobs from Firebase and listen for changes
    jobsRef.on('value', snap => {
        const data = snap.val() || {};
        _cloudJobs = data;
        loadSavedJobsList();
        updateCatalogBar();
    });

    // Load price catalog and settings from Firebase
    loadCatalog();

    // Price lookup is now fully client-side ‚Äî no proxy needed

    // Set up company field auto-save to Firebase
    companyFields.forEach(id => {
        document.getElementById(id).addEventListener('input', () => {
            if (_suppressSync) return;
            const obj = {};
            companyFields.forEach(fid => { obj[fid] = document.getElementById(fid).value; });
            companyRef.set(obj);
            flashSync();
            const ind = document.getElementById('companySaved');
            ind.classList.add('show');
            setTimeout(() => ind.classList.remove('show'), 2000);
        });
    });

    // Default trade
    onTradeChange();

    // Monitor connection
    db.ref('.info/connected').on('value', snap => {
        if (snap.val() === true) {
            setSyncStatus('online', 'Connected to cloud');
        } else {
            setSyncStatus('offline', 'Offline ‚Äî changes will sync when reconnected');
        }
    });
}

const companyFields = ['companyName', 'licenseNum', 'phone', 'email', 'companyAddress', 'brandSelect'];
let _cloudJobs = {};

// ========== PRICE CATALOG SYSTEM ==========
function sanitizeKey(s) { return String(s||'').toLowerCase().trim().replace(/[.#$\[\]\/]/g,'_').replace(/\s+/g,'_').substring(0,80) || '_empty'; }

function loadCatalog() {
    if (!catalogRef) return;
    catalogRef.on('value', snap => {
        const d = snap.val() || {};
        _catalog.labor = d.labor || {};
        _catalog.materials = d.materials || {};
        updateCatalogBar();
        if (document.getElementById('catList')) catRenderList();
    });
    if (settingsRef) {
        settingsRef.once('value').then(snap => {
            const s = snap.val() || {};
            if (s.inflationRate !== undefined) {
                _inflationRate = s.inflationRate;
                const el = document.getElementById('inflationRate');
                if (el) el.value = _inflationRate;
            }
        });
    }
}

function updateCatalogBar() {
    const lc = Object.keys(_catalog.labor).length;
    const mc = Object.keys(_catalog.materials).length;
    const jc = Object.keys(_cloudJobs).length;
    const elL = document.getElementById('cbLaborCount');
    const elM = document.getElementById('cbMatCount');
    const elJ = document.getElementById('cbJobCount');
    if (elL) elL.textContent = lc;
    if (elM) elM.textContent = mc;
    if (elJ) elJ.textContent = jc;
    const bar = document.getElementById('catalogBar');
    if (bar) bar.style.display = 'flex';
}

function saveInflationRate() {
    _inflationRate = parseFloat(document.getElementById('inflationRate').value) || 3.2;
    if (settingsRef) settingsRef.update({ inflationRate: _inflationRate });
}

function saveToCatalog(type, items, jobName) {
    if (!catalogRef) return;
    const now = Date.now();
    const updates = {};
    items.forEach(item => {
        const key = sanitizeKey(item.desc);
        if (key === '_empty') return;
        const existing = (_catalog[type] && _catalog[type][key]) || {};
        const history = existing.history || {};
        const pushKey = 't' + now + '_' + Math.random().toString(36).substr(2, 4);
        const entry = { price: item.price, date: now, jobName: jobName || '' };
        if (type === 'labor') entry.basis = item.basis || '';
        if (type === 'materials') entry.qty = item.qty || '';
        history[pushKey] = entry;
        updates[type + '/' + key] = {
            desc: item.desc,
            price: item.price,
            basis: item.basis || '',
            qty: item.qty || '',
            lastUsed: now,
            firstSeen: existing.firstSeen || now,
            useCount: (existing.useCount || 0) + 1,
            history: history
        };
    });
    catalogRef.update(updates);
}

function inflationAdjust(price, dateMs) {
    if (!dateMs || !price) return price;
    const years = (Date.now() - dateMs) / (365.25 * 24 * 60 * 60 * 1000);
    if (years < 0.05) return price; // less than ~18 days, no adjustment
    return price * Math.pow(1 + (_inflationRate / 100), years);
}

function relativeDate(ms) {
    if (!ms) return '';
    const days = Math.floor((Date.now() - ms) / 86400000);
    if (days === 0) return 'today';
    if (days === 1) return 'yesterday';
    if (days < 30) return days + 'd ago';
    if (days < 365) return Math.floor(days / 30) + 'mo ago';
    return (days / 365).toFixed(1) + 'yr ago';
}

// ========== AUTOCOMPLETE ENGINE ==========
let _acActiveInput = null;
let _acActiveDrop = null;
let _acActiveIdx = -1;

function acSearch(query, type) {
    const catalog = _catalog[type] || {};
    const q = query.toLowerCase().trim();
    if (!q) return Object.values(catalog).sort((a, b) => (b.useCount || 0) - (a.useCount || 0)).slice(0, 12);
    return Object.values(catalog).filter(item => {
        return item.desc && item.desc.toLowerCase().includes(q);
    }).sort((a, b) => {
        const aStarts = a.desc.toLowerCase().startsWith(q) ? 1 : 0;
        const bStarts = b.desc.toLowerCase().startsWith(q) ? 1 : 0;
        if (aStarts !== bStarts) return bStarts - aStarts;
        return (b.useCount || 0) - (a.useCount || 0);
    }).slice(0, 10);
}

function acRender(results, dropEl, type) {
    dropEl.innerHTML = '';
    if (results.length === 0) { dropEl.classList.remove('show'); return; }
    results.forEach((item, idx) => {
        const div = document.createElement('div');
        div.className = 'ac-item';
        const adj = inflationAdjust(item.price, item.lastUsed);
        const showAdj = Math.abs(adj - item.price) > 0.005;
        let metaHtml = '<span class="ac-price">$' + item.price.toFixed(2) + '</span>';
        if (showAdj) metaHtml += '<span class="ac-adj">&rarr; $' + adj.toFixed(2) + ' adj.</span>';
        if (type === 'labor' && item.basis) metaHtml += '<span>' + item.basis + '</span>';
        if (type === 'materials' && item.qty) metaHtml += '<span>' + item.qty + '</span>';
        metaHtml += '<span class="ac-date">' + relativeDate(item.lastUsed) + '</span>';
        metaHtml += '<span class="ac-count">&times;' + (item.useCount || 1) + '</span>';
        div.innerHTML = '<div class="ac-desc">' + item.desc + '</div><div class="ac-meta">' + metaHtml + '</div>';
        div.addEventListener('mousedown', function(e) {
            e.preventDefault();
            acSelect(item, type);
        });
        dropEl.appendChild(div);
    });
    dropEl.classList.add('show');
    _acActiveIdx = -1;
}

function acSelect(item, type) {
    if (!_acActiveInput) return;
    const row = _acActiveInput.closest('.li-row, .mi-row');
    if (!row) return;
    const inputs = row.querySelectorAll('input');
    const adj = inflationAdjust(item.price, item.lastUsed);
    const useAdj = Math.abs(adj - item.price) > 0.005;
    inputs[0].value = item.desc;
    if (type === 'labor') {
        inputs[1].value = item.basis || '';
        inputs[2].value = (useAdj ? adj : item.price).toFixed(2);
    } else {
        inputs[1].value = item.qty || '';
        inputs[2].value = (useAdj ? adj : item.price).toFixed(2);
    }
    acClose();
}

function acClose() {
    if (_acActiveDrop) _acActiveDrop.classList.remove('show');
    _acActiveInput = null;
    _acActiveDrop = null;
    _acActiveIdx = -1;
}

function acKeydown(e, dropEl) {
    const items = dropEl.querySelectorAll('.ac-item');
    if (!items.length || !dropEl.classList.contains('show')) return;
    if (e.key === 'ArrowDown') {
        e.preventDefault();
        _acActiveIdx = Math.min(_acActiveIdx + 1, items.length - 1);
        items.forEach((it, i) => it.classList.toggle('ac-active', i === _acActiveIdx));
        items[_acActiveIdx].scrollIntoView({ block: 'nearest' });
    } else if (e.key === 'ArrowUp') {
        e.preventDefault();
        _acActiveIdx = Math.max(_acActiveIdx - 1, 0);
        items.forEach((it, i) => it.classList.toggle('ac-active', i === _acActiveIdx));
        items[_acActiveIdx].scrollIntoView({ block: 'nearest' });
    } else if (e.key === 'Enter' && _acActiveIdx >= 0) {
        e.preventDefault();
        items[_acActiveIdx].dispatchEvent(new MouseEvent('mousedown'));
    } else if (e.key === 'Escape') {
        acClose();
    }
}

function attachAutocomplete(input, type) {
    const wrap = document.createElement('div');
    wrap.className = 'ac-wrap';
    input.parentNode.insertBefore(wrap, input);
    wrap.appendChild(input);
    const drop = document.createElement('div');
    drop.className = 'ac-drop';
    wrap.appendChild(drop);

    input.addEventListener('focus', function() {
        _acActiveInput = input;
        _acActiveDrop = drop;
        const results = acSearch(input.value, type);
        if (results.length) acRender(results, drop, type);
    });
    input.addEventListener('input', function() {
        _acActiveInput = input;
        _acActiveDrop = drop;
        acRender(acSearch(input.value, type), drop, type);
    });
    input.addEventListener('blur', function() {
        setTimeout(acClose, 150);
    });
    input.addEventListener('keydown', function(e) {
        acKeydown(e, drop);
    });
}

// ========== PREDICTIVE FILL ==========
function predictiveFill() {
    const trade = document.getElementById('tradeType').value;
    const jobs = Object.values(_cloudJobs).filter(j => j.tradeType === trade);
    if (jobs.length === 0) { alert('No past jobs found for this trade type. Save some jobs first to build your history.'); return; }

    // Tally frequency of each labor item across past jobs of same trade
    const laborFreq = {}, matFreq = {};
    jobs.forEach(j => {
        (j.laborItems || []).forEach(li => {
            const k = sanitizeKey(li.desc);
            if (!laborFreq[k]) laborFreq[k] = { desc: li.desc, basis: li.basis, prices: [], count: 0 };
            laborFreq[k].prices.push({ price: li.price, date: j.savedAt || Date.now() });
            laborFreq[k].count++;
        });
        (j.matItems || []).forEach(mi => {
            const k = sanitizeKey(mi.desc);
            if (!matFreq[k]) matFreq[k] = { desc: mi.desc, qty: mi.qty, prices: [], count: 0 };
            matFreq[k].prices.push({ price: mi.price, date: j.savedAt || Date.now() });
            matFreq[k].count++;
        });
    });

    // Sort by frequency, take top items
    const topLabor = Object.values(laborFreq).sort((a, b) => b.count - a.count).slice(0, 10);
    const topMat = Object.values(matFreq).sort((a, b) => b.count - a.count).slice(0, 15);

    if (topLabor.length === 0 && topMat.length === 0) { alert('Not enough history to predict items.'); return; }

    const msg = 'Smart Fill found ' + topLabor.length + ' labor items and ' + topMat.length + ' materials from ' + jobs.length + ' past ' + trade + ' jobs.\n\nPrices will be inflation-adjusted (' + _inflationRate + '%/yr).\n\nReplace current line items?';
    if (!confirm(msg)) return;

    // Fill labor
    document.getElementById('laborItemsContainer').innerHTML = '';
    topLabor.forEach(item => {
        const latest = item.prices.sort((a, b) => b.date - a.date)[0];
        const adjPrice = inflationAdjust(latest.price, latest.date);
        addLaborRow(item.desc, item.basis, adjPrice.toFixed(2));
    });

    // Fill materials
    document.getElementById('matItemsContainer').innerHTML = '';
    topMat.forEach(item => {
        const latest = item.prices.sort((a, b) => b.date - a.date)[0];
        const adjPrice = inflationAdjust(latest.price, latest.date);
        addMatRow(item.desc, item.qty, adjPrice.toFixed(2));
    });
}

// ========== MATERIAL CATALOG MANAGER ==========
// A clean, reliable inventory catalog. No flaky web scraping.
// Add items manually, paste from store websites, browse & manage your catalog.

function catSwitchTab(tab) {
    const tabs = document.querySelectorAll('.cat-tab');
    const panels = document.querySelectorAll('.cat-panel');
    const tabMap = { browse: 0, add: 1, import: 2 };
    const panelMap = { browse: 'catBrowse', add: 'catAdd', import: 'catImport' };
    tabs.forEach(t => t.classList.remove('active'));
    panels.forEach(p => p.style.display = 'none');
    if (tabs[tabMap[tab]]) tabs[tabMap[tab]].classList.add('active');
    document.getElementById(panelMap[tab]).style.display = '';
    if (tab === 'browse') catRenderList();
}

function catGetMaterials() {
    if (!_catalog || !_catalog.materials) return [];
    const items = [];
    Object.keys(_catalog.materials).forEach(k => {
        const v = _catalog.materials[k];
        if (!v || !v.desc) return;
        items.push({ key: 'materials/' + k, ...v });
    });
    return items;
}

function catRenderList() {
    const listEl = document.getElementById('catList');
    const statusEl = document.getElementById('catStatus');
    const filter = (document.getElementById('catFilter').value || '').toLowerCase().trim();
    const sort = document.getElementById('catSort').value;

    let items = catGetMaterials();

    // Filter
    if (filter) {
        items = items.filter(i => (i.desc || '').toLowerCase().includes(filter) || (i.source || '').toLowerCase().includes(filter));
    }

    // Sort
    if (sort === 'alpha') items.sort((a, b) => (a.desc || '').localeCompare(b.desc || ''));
    else if (sort === 'price-low') items.sort((a, b) => (a.price || 0) - (b.price || 0));
    else if (sort === 'price-high') items.sort((a, b) => (b.price || 0) - (a.price || 0));
    else if (sort === 'most-used') items.sort((a, b) => (b.useCount || 0) - (a.useCount || 0));
    else items.sort((a, b) => (b.lastUsed || 0) - (a.lastUsed || 0));

    statusEl.innerHTML = '<strong>' + items.length + '</strong> items' + (filter ? ' matching "' + escHtml(filter) + '"' : '') + ' &mdash; synced to Firebase';

    if (items.length === 0) {
        listEl.innerHTML = '<div class="pl-empty">' + (filter ? 'No items match your filter.' : 'No items in catalog yet. Use the "+ Add Item" or "Paste Import" tabs above.') + '</div>';
        return;
    }

    listEl.innerHTML = '';
    items.slice(0, 50).forEach(item => {
        const div = document.createElement('div');
        div.className = 'pl-item';
        const priceStr = '$' + (item.price || 0).toFixed(2);
        const ago = item.lastUsed ? catTimeAgo(item.lastUsed) : '';
        const histLen = (item.history || []).length;
        div.innerHTML = '<div style="flex:1;min-width:0">'
            + '<span class="pl-name">' + escHtml(item.desc) + '</span>'
            + (ago ? '<div class="pl-hist">' + escHtml(ago) + (histLen > 1 ? ' &middot; ' + histLen + ' price updates' : '') + '</div>' : '')
            + '</div>'
            + '<span class="pl-price">' + priceStr + '</span>'
            + (item.source ? '<span class="pl-src">' + escHtml(item.source) + '</span>' : '')
            + '<div class="pl-actions">'
            + '<button class="pl-add" title="Add to current bid">+ Bid</button>'
            + '<button class="pl-edit" title="Edit price">Edit</button>'
            + '<button class="pl-del" title="Delete item">X</button>'
            + '</div>';
        div.querySelector('.pl-add').addEventListener('click', function() {
            addMatRow(item.desc, item.qty || '1', (item.price || 0).toFixed(2));
            this.textContent = 'Added!';
            this.style.background = '#2a3a5c';
            setTimeout(() => { this.textContent = '+ Bid'; this.style.background = ''; }, 1500);
        });
        div.querySelector('.pl-edit').addEventListener('click', function() {
            const newPrice = prompt('New price for "' + item.desc + '":', (item.price || 0).toFixed(2));
            if (!newPrice) return;
            const p = parseFloat(newPrice.replace(/[^0-9.]/g, ''));
            if (isNaN(p) || p <= 0) { alert('Invalid price'); return; }
            catSaveItem({ desc: item.desc, price: p, source: item.source || 'Manual', qty: item.qty || '1' });
            catRenderList();
        });
        div.querySelector('.pl-del').addEventListener('click', function() {
            if (!confirm('Delete "' + item.desc + '" from catalog?')) return;
            if (catalogRef) catalogRef.child(item.key).remove();
            catRenderList();
        });
        listEl.appendChild(div);
    });
    if (items.length > 50) {
        listEl.innerHTML += '<div class="pl-empty">Showing first 50 of ' + items.length + ' items. Use the filter to narrow down.</div>';
    }
}

function catTimeAgo(ts) {
    const diff = Date.now() - ts;
    const mins = Math.floor(diff / 60000);
    if (mins < 1) return 'just now';
    if (mins < 60) return mins + 'm ago';
    const hrs = Math.floor(mins / 60);
    if (hrs < 24) return hrs + 'h ago';
    const days = Math.floor(hrs / 24);
    if (days < 30) return days + 'd ago';
    const months = Math.floor(days / 30);
    return months + 'mo ago';
}

function catAddItem() {
    const desc = document.getElementById('catNewDesc').value.trim();
    const priceStr = document.getElementById('catNewPrice').value.trim();
    const qty = document.getElementById('catNewQty').value.trim() || '1';
    const store = document.getElementById('catNewStore').value;

    if (!desc) { document.getElementById('catNewDesc').focus(); return; }
    if (!priceStr) { document.getElementById('catNewPrice').focus(); return; }
    const price = parseFloat(priceStr.replace(/[^0-9.]/g, ''));
    if (isNaN(price) || price <= 0) { alert('Enter a valid price'); document.getElementById('catNewPrice').focus(); return; }

    catSaveItem({ desc, price, source: store, qty });

    document.getElementById('catAddStatus').innerHTML = 'Added <strong>' + escHtml(desc) + '</strong> at $' + price.toFixed(2) + ' to catalog!';
    document.getElementById('catNewDesc').value = '';
    document.getElementById('catNewPrice').value = '';
    document.getElementById('catNewDesc').focus();
    updateCatalogBar();
}

function catImportPaste() {
    const raw = document.getElementById('catPasteArea').value.trim();
    if (!raw) { document.getElementById('catPasteArea').focus(); return; }
    const store = document.getElementById('catImportStore').value || 'Import';
    const statusEl = document.getElementById('catImportStatus');

    const lines = raw.split('\n').map(l => l.trim()).filter(l => l.length > 2);
    let imported = 0;

    lines.forEach(line => {
        // Try to parse: "description  $price" or "description | price | store" or "description, price, store"
        let desc = '', price = 0, lineStore = store;

        // Pattern 1: pipe-separated (desc | price | store)
        if (line.includes('|')) {
            const parts = line.split('|').map(p => p.trim());
            desc = parts[0] || '';
            const priceMatch = (parts[1] || '').match(/([\d,]+\.?\d{0,2})/);
            if (priceMatch) price = parseFloat(priceMatch[1].replace(/,/g, ''));
            if (parts[2]) lineStore = parts[2];
        }
        // Pattern 2: comma-separated (desc, price, store)
        else if ((line.match(/,/g) || []).length >= 1) {
            const parts = line.split(',').map(p => p.trim());
            // Find which part has the price
            let priceIdx = -1;
            parts.forEach((p, i) => {
                if (i > 0 && /^\$?[\d,]+\.?\d{0,2}$/.test(p.replace(/\$/g, ''))) priceIdx = i;
            });
            if (priceIdx > 0) {
                desc = parts.slice(0, priceIdx).join(', ');
                price = parseFloat(parts[priceIdx].replace(/[^0-9.]/g, ''));
                if (parts[priceIdx + 1]) lineStore = parts[priceIdx + 1];
            }
        }
        // Pattern 3: description followed by $price somewhere in the line
        if (!desc || !price) {
            const m = line.match(/^(.+?)\s+\$?([\d,]+\.\d{2})\s*(.*)$/);
            if (m) {
                desc = m[1].replace(/[\|,\-]+$/, '').trim();
                price = parseFloat(m[2].replace(/,/g, ''));
                if (m[3] && m[3].length > 1) lineStore = m[3].trim();
            }
        }
        // Pattern 4: just a dollar amount anywhere
        if (!desc || !price) {
            const pm = line.match(/\$([\d,]+\.?\d{0,2})/);
            if (pm) {
                price = parseFloat(pm[1].replace(/,/g, ''));
                desc = line.replace(/\$[\d,]+\.?\d{0,2}/, '').replace(/[\|,]+/g, ' ').trim();
            }
        }

        if (desc && price > 0 && desc.length >= 2) {
            catSaveItem({ desc, price, source: lineStore, qty: '1' });
            imported++;
        }
    });

    if (imported > 0) {
        statusEl.innerHTML = 'Imported <strong>' + imported + '</strong> items to catalog!';
        document.getElementById('catPasteArea').value = '';
        updateCatalogBar();
    } else {
        statusEl.innerHTML = 'Could not parse any items. Make sure each line has a description and a price (e.g. "Wax Ring $4.99").';
    }
}

function catImportCSV(input) {
    const file = input.files && input.files[0];
    if (!file) return;
    const statusEl = document.getElementById('catImportStatus');
    statusEl.innerHTML = '<span class="pl-spinner"></span> Reading ' + escHtml(file.name) + '...';
    const reader = new FileReader();
    reader.onload = function(e) {
        const text = e.target.result || '';
        // Put CSV content into the paste area and trigger import
        document.getElementById('catPasteArea').value = text;
        catImportPaste();
        input.value = ''; // reset file input
    };
    reader.onerror = function() {
        statusEl.innerHTML = 'Error reading file. Try again.';
    };
    reader.readAsText(file);
}

function catUpdatePrompt() {
    const trade = document.getElementById('catPromptTrade').value;
    const focus = document.getElementById('catPromptFocus').value || 'common repairs and installs';
    const template = 'I need a list of common materials and current retail prices for a ' + trade + ' project. Format each item on its own line like this:\n\nItem Description | $Price | Store Name\n\nFor example:\n1/2 in. x 10 ft. PEX-A Pipe | $3.98 | Home Depot\nWax Ring for Toilet | $4.27 | Menards\n12/2 NM-B Romex Wire 250ft | $89.97 | Lowes\n\nPlease give me 20-30 items commonly used in ' + trade + ' work, with realistic current US retail prices. Include items from Menards, Home Depot, Lowes, and Amazon. Focus on: ' + focus;
    document.getElementById('catAiPrompt').textContent = template;
}

function catImportFromScan() {
    showNotification('üîÑ Checking for scan results from Google Integration...', 'info');
    
    // Check Firebase shared storage for scan results
    db.ref('shared/scanResults').once('value').then(snapshot => {
        const scanData = snapshot.val();
        if (scanData && scanData.results) {
            // Import Google Drive/Gmail scan results
            const items = [];
            
            // Process Drive files
            if (scanData.results.drive) {
                scanData.results.drive.forEach(file => {
                    if (file.isRelevant) {
                        items.push({
                            desc: file.name,
                            price: 'N/A',
                            source: 'Google Drive',
                            model: file.id
                        });
                    }
                });
            }
            
            // Process Gmail messages
            if (scanData.results.gmail) {
                scanData.results.gmail.forEach(email => {
                    if (email.isRelevant) {
                        items.push({
                            desc: email.subject,
                            price: 'N/A',
                            source: 'Gmail',
                            model: email.id
                        });
                    }
                });
            }
            
            if (items.length > 0) {
                // Add items to catalog
                items.forEach(item => catAddItemDirect(item));
                showNotification(`‚úÖ Imported ${items.length} items from scan results`, 'success');
                catSwitchTab('browse');
                catRenderList();
            } else {
                showNotification('üìÑ No relevant items found in scan results', 'info');
            }
        } else {
            // Check local scan results
            db.ref('shared/localScanResults').once('value').then(snapshot => {
                const localData = snapshot.val();
                if (localData && localData.results && localData.results.files) {
                    const items = localData.results.files.map(file => ({
                        desc: file.name,
                        price: file.parsedData.price || 'N/A',
                        source: 'Local Scan',
                        model: file.parsedData.client || 'N/A'
                    }));
                    
                    items.forEach(item => catAddItemDirect(item));
                    showNotification(`‚úÖ Imported ${items.length} items from local scan`, 'success');
                    catSwitchTab('browse');
                    catRenderList();
                } else {
                    showNotification('üìÑ No scan results found. Run a scan first in Google Integration.', 'info');
                }
            }).catch(error => {
                console.error('Error checking local scan results:', error);
                showNotification('‚ùå Failed to load scan results', 'error');
            });
        }
    }).catch(error => {
        console.error('Error checking scan results:', error);
        showNotification('‚ùå Failed to load scan results', 'error');
    });
}

function catAddItemDirect(item) {
    const key = item.desc.toLowerCase().replace(/[^a-z0-9]/g, '_');
    const itemData = {
        desc: item.desc,
        price: item.price,
        qty: 1,
        source: item.source,
        model: item.model,
        useCount: 0,
        lastUsed: null
    };
    
    dbRef.child('materials/' + key).set(itemData);
}

function catCopyPrompt() {
    const text = document.getElementById('catAiPrompt').textContent;
    navigator.clipboard.writeText(text).then(() => {
        const btn = event.target;
        btn.textContent = 'Copied!';
        btn.style.background = '#27ae60';
        setTimeout(() => { btn.textContent = 'Copy Prompt'; btn.style.background = '#2a3a5c'; }, 2000);
    }).catch(() => {
        // Fallback for older browsers
        const ta = document.createElement('textarea');
        ta.value = text;
        ta.style.position = 'fixed';
        ta.style.opacity = '0';
        document.body.appendChild(ta);
        ta.select();
        document.execCommand('copy');
        document.body.removeChild(ta);
        const btn = event.target;
        btn.textContent = 'Copied!';
        btn.style.background = '#27ae60';
        setTimeout(() => { btn.textContent = 'Copy Prompt'; btn.style.background = '#2a3a5c'; }, 2000);
    });
}

function catSaveItem(item) {
    if (!catalogRef || !item.desc || !item.price) return;
    const sKey = sanitizeKey(item.desc);
    const fbPath = 'materials/' + sKey;
    const now = Date.now();
    const existing = (_catalog && _catalog.materials && _catalog.materials[sKey]) || {};
    const history = existing.history || [];
    history.push({ price: parseFloat(item.price), date: now, job: (item.source || 'manual') });
    if (history.length > 20) history.splice(0, history.length - 20);
    catalogRef.child(fbPath).set({
        desc: item.desc,
        price: parseFloat(item.price),
        qty: item.qty || '1',
        lastUsed: now,
        firstSeen: existing.firstSeen || now,
        useCount: (existing.useCount || 0) + 1,
        history: history,
        source: item.source || 'Manual',
        model: item.model || ''
    });
    updateCatalogBar();
}

function escHtml(s) { return String(s || '').replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;'); }

// ========== BRAND PRESETS ==========
const BRANDS = {
    wsi: {
        name: 'Watts Safety Installs',
        accent: '#C0392B',
        dark: '#1A1A1A',
        headerBg: '#1A1A1A',
        headerText: '#C0392B',
        badgeText: '#FFF5E6',
        scopeCheck: '#C0392B',
        combinedBg: '#FFF5E6',
        combinedBorder: '#1A1A1A',
        combinedGrand: '#1A1A1A',
        combinedRule: '#e8c9a0',
        toolbarBg: '#1A1A1A',
        authBg: '#FFF5E6'
    },
    atp: {
        name: 'Watts ATP Contractor',
        accent: '#00C4B4',
        dark: '#0A1D37',
        headerBg: '#0A1D37',
        headerText: '#00C4B4',
        badgeText: 'white',
        scopeCheck: '#00C4B4',
        combinedBg: '#e6faf8',
        combinedBorder: '#0A1D37',
        combinedGrand: '#0A1D37',
        combinedRule: '#8dd8cf',
        toolbarBg: '#0A1D37',
        authBg: '#e6faf8'
    }
};

function getBrand() { return BRANDS[document.getElementById('brandSelect').value] || BRANDS.wsi; }

function onBrandChange() {
    // Trigger auto-save of company fields
    const evt = new Event('input', { bubbles: true });
    document.getElementById('brandSelect').dispatchEvent(evt);
}

// ========== TRADE CHANGE ==========
function onTradeChange() {
    const t = document.getElementById('tradeType').value;
    const preset = TRADES[t];
    const badge = document.getElementById('tradeBadge');
    badge.textContent = preset.label;
    badge.className = 'trade-badge ' + t;
    const adEl = document.getElementById('areaDesc');
    const knownDefaults = Object.values(TRADES).map(p => p.areaDesc);
    if (!adEl.value || knownDefaults.includes(adEl.value)) adEl.value = preset.areaDesc;
    document.getElementById('laborItemsContainer').innerHTML = '';
    preset.labor.forEach(li => addLaborRow(li.desc, li.basis, li.price));
    document.getElementById('matItemsContainer').innerHTML = '';
    preset.materials.forEach(mi => addMatRow(mi.desc, mi.qty, mi.price));
    document.getElementById('supplierNote').value = preset.supplierNote;
    document.getElementById('disclaimer').value = preset.disclaimer;
}

function addLaborRow(desc, basis, price) {
    const c = document.getElementById('laborItemsContainer');
    const row = document.createElement('div');
    row.className = 'li-row';
    row.innerHTML = '<input type="text" placeholder="Description" value="'+esc(desc)+'">'
        + '<input type="text" placeholder="Basis" value="'+esc(basis)+'">'
        + '<div style="display:flex;gap:4px;align-items:center;"><input type="number" step="0.25" placeholder="$" value="'+(price||'')+'" style="flex:1;"><button class="remove-row" onclick="this.closest(\'.li-row\').remove()">&times;</button></div>';
    c.appendChild(row);
    attachAutocomplete(row.querySelector('input'), 'labor');
}
function addMatRow(desc, qty, price) {
    const c = document.getElementById('matItemsContainer');
    const row = document.createElement('div');
    row.className = 'mi-row';
    row.innerHTML = '<input type="text" placeholder="Material" value="'+esc(desc)+'">'
        + '<input type="text" placeholder="Qty" value="'+esc(qty)+'">'
        + '<div style="display:flex;gap:4px;align-items:center;"><input type="number" step="0.01" placeholder="$" value="'+(price||'')+'" style="flex:1;"><button class="remove-row" onclick="this.closest(\'.mi-row\').remove()">&times;</button></div>';
    c.appendChild(row);
    attachAutocomplete(row.querySelector('input'), 'materials');
}
function esc(s) { return String(s||'').replace(/"/g, '&quot;'); }

// ========== GATHER DATA ==========
function getLaborItems() {
    const rows = document.querySelectorAll('#laborItemsContainer .li-row');
    return Array.from(rows).map(r => {
        const inputs = r.querySelectorAll('input');
        return { desc: inputs[0].value, basis: inputs[1].value, price: parseFloat(inputs[2].value) || 0 };
    }).filter(i => i.desc);
}
function getMatItems() {
    const rows = document.querySelectorAll('#matItemsContainer .mi-row');
    return Array.from(rows).map(r => {
        const inputs = r.querySelectorAll('input');
        return { desc: inputs[0].value, qty: inputs[1].value, price: parseFloat(inputs[2].value) || 0 };
    }).filter(i => i.desc);
}
function getScope() { return TRADES[document.getElementById('tradeType').value].scope; }
function getNotes() { return TRADES[document.getElementById('tradeType').value].notes; }

// ========== SAVED JOBS (FIREBASE) ==========
function loadSavedJobsList() {
    const sel = document.getElementById('savedJobsSelect');
    sel.innerHTML = '<option value="">-- Select a saved job --</option>';
    Object.keys(_cloudJobs).sort().forEach(n => {
        const o = document.createElement('option');
        o.value = n; o.textContent = n; sel.appendChild(o);
    });
}
function saveJob() {
    const c = gv('clientName'), x = gv('complexName'), u = gv('unitNum');
    const name = prompt('Save job as:', (c+' - '+x+' '+u).trim() || 'New Job');
    if (!name) return;
    const jobData = {
        tradeType: gv('tradeType'), clientName: c, complexName: x, unitNum: u,
        jobCity: gv('jobCity'), sqft: gv('sqft'), areaDesc: gv('areaDesc'),
        estimateDate: gv('estimateDate'), materialsMarkup: gv('materialsMarkup'),
        supplierNote: gv('supplierNote'), disclaimer: gv('disclaimer'),
        laborItems: getLaborItems(), matItems: getMatItems(),
        savedAt: Date.now()
    };
    jobsRef.child(name).set(jobData).then(() => {
        saveToCatalog('labor', jobData.laborItems, name);
        saveToCatalog('materials', jobData.matItems, name);
        flashSync();
        updateCatalogBar();
        document.getElementById('savedJobsSelect').value = name;
        alert('Job saved & synced: ' + name);
    });
}
function loadJob() {
    const n = document.getElementById('savedJobsSelect').value;
    if (!n) { alert('Select a job first.'); return; }
    const j = _cloudJobs[n]; if (!j) return;
    ['tradeType','clientName','complexName','unitNum','jobCity','sqft','areaDesc','estimateDate','materialsMarkup','supplierNote','disclaimer'].forEach(k => {
        const e = document.getElementById(k); if (e && j[k] !== undefined) e.value = j[k];
    });
    const badge = document.getElementById('tradeBadge');
    const preset = TRADES[j.tradeType] || TRADES.custom;
    badge.textContent = preset.label; badge.className = 'trade-badge ' + (j.tradeType || 'custom');
    if (j.laborItems) {
        document.getElementById('laborItemsContainer').innerHTML = '';
        j.laborItems.forEach(li => addLaborRow(li.desc, li.basis, li.price));
    }
    if (j.matItems) {
        document.getElementById('matItemsContainer').innerHTML = '';
        j.matItems.forEach(mi => addMatRow(mi.desc, mi.qty, mi.price));
    }
}
function deleteJob() {
    const n = document.getElementById('savedJobsSelect').value;
    if (!n) { alert('Select a job first.'); return; }
    if (!confirm('Delete "'+n+'"?')) return;
    jobsRef.child(n).remove().then(() => { flashSync(); });
}
function clearForm() {
    ['clientName','complexName','unitNum','jobCity','areaDesc','supplierNote'].forEach(id => { document.getElementById(id).value = ''; });
    document.getElementById('sqft').value = 48;
    document.getElementById('estimateDate').value = new Date().toISOString().split('T')[0];
    onTradeChange();
}

// ========== HELPERS ==========
function gv(id) { return document.getElementById(id).value; }
function gn(id) { return parseFloat(document.getElementById(id).value) || 0; }
function f(n) { return n.toFixed(2); }
function fd(s) { if (!s) return '[Date]'; const d = new Date(s+'T12:00:00'); return d.toLocaleDateString('en-US',{year:'numeric',month:'long',day:'numeric'}); }
function loc() { return [gv('complexName'),gv('unitNum'),gv('jobCity')].filter(Boolean).join(', ') || '[Location]'; }
function co(brand) { var b = brand || getBrand(); return '<div class="company-info"><h1>'+(gv('companyName')||b.name)+'</h1><p>Licensed General Contractor &mdash; State of Nebraska</p><p>License #: '+(gv('licenseNum')||'[LICENSE #]')+' &nbsp;|&nbsp; Phone: '+(gv('phone')||'[PHONE]')+' &nbsp;|&nbsp; Email: '+(gv('email')||'[EMAIL]')+'</p></div>'; }
function E(v, extra) { return '<span data-editable '+(extra||'')+'>'+v+'</span>'; }
function P(v, extra) { return '<span data-editable class="editable-price" '+(extra||'')+'>'+v+'</span>'; }

// ========== SHARED DOC CSS ==========
function docCSS(brand) {
    var a = brand.accent, d = brand.dark;
    return '@media print { body { margin:0; padding:0.3in; } .no-print { display:none !important; } .sig-canvas { border:none !important; } }'
    +'* { margin:0; padding:0; box-sizing:border-box; }'
    +'body { font-family:"Segoe UI",Tahoma,Geneva,Verdana,sans-serif; color:#1a1a1a; line-height:1.5; padding:0.5in; padding-top:60px; max-width:8.5in; margin:0 auto; font-size:11pt; }'
    +'.toolbar { position:fixed; top:0; left:0; right:0; background:'+brand.toolbarBg+'; color:#eee; padding:8px 20px; display:flex; align-items:center; gap:12px; z-index:9999; box-shadow:0 2px 12px rgba(0,0,0,0.3); font-size:13px; }'
    +'.toolbar .tbt { font-weight:700; font-size:14px; margin-right:auto; } .toolbar button { padding:8px 18px; border:none; border-radius:5px; font-size:13px; font-weight:600; cursor:pointer; }'
    +'.toolbar .tbp { background:'+a+'; color:'+brand.badgeText+'; } .toolbar .tbe { background:#2a3a5c; color:#bbb; border:1px solid #3a4a6c; } .toolbar .tbe.active { background:#f39c12; color:#1a1a1a; border-color:#f39c12; } .toolbar .tbs { font-size:11px; color:#7f8c8d; }'
    +'.header { display:flex; justify-content:space-between; align-items:flex-start; border-bottom:3px solid '+d+'; padding-bottom:15px; margin-bottom:20px; }'
    +'.company-info h1 { font-size:22pt; color:'+d+'; margin-bottom:2px; } .company-info p { font-size:9pt; color:#555; }'
    +'.badge { background:'+a+'; color:'+brand.badgeText+'; padding:8px 20px; font-size:12pt; font-weight:bold; text-align:center; border-radius:4px; } .badge small { display:block; font-size:8pt; font-weight:normal; opacity:0.8; }'
    +'.info-grid { display:grid; grid-template-columns:1fr 1fr; gap:15px; margin-bottom:20px; } .info-grid-3 { display:grid; grid-template-columns:1fr 1fr 1fr; gap:12px; margin-bottom:20px; }'
    +'.info-box { background:#f8f9fa; border:1px solid #dee2e6; border-radius:4px; padding:10px 14px; } .info-box label { font-size:8pt; text-transform:uppercase; color:#6c757d; letter-spacing:0.5px; display:block; margin-bottom:2px; } .info-box .value { font-size:11pt; font-weight:600; color:'+d+'; } .info-box.hl { background:#fff3cd; border-color:#ffc107; }'
    +'.scope { background:#eef2f7; border-left:4px solid '+a+'; padding:12px 16px; margin-bottom:20px; font-size:10pt; } .scope h3 { font-size:10pt; color:'+d+'; margin-bottom:6px; text-transform:uppercase; letter-spacing:0.5px; } .scope ul { list-style:none; padding:0; } .scope ul li { padding:2px 0 2px 16px; position:relative; } .scope ul li::before { content:"\\2713"; position:absolute; left:0; color:'+brand.scopeCheck+'; font-weight:bold; }'
    +'table { width:100%; border-collapse:collapse; margin-bottom:20px; } table thead th { background:'+d+'; color:'+a+'; padding:8px 10px; text-align:left; font-size:9pt; text-transform:uppercase; letter-spacing:0.5px; }'
    +'table thead th:last-child, table thead th:nth-child(3), table thead th:nth-child(4), table thead th:nth-child(5) { text-align:right; }'
    +'table tbody td { padding:8px 10px; border-bottom:1px solid #e9ecef; font-size:10pt; vertical-align:top; } table tbody td:last-child, table tbody td:nth-child(3), table tbody td:nth-child(4), table tbody td:nth-child(5) { text-align:right; white-space:nowrap; } table tbody tr:nth-child(even) { background:#f8f9fa; }'
    +'.item-num { font-weight:700; color:'+a+'; width:30px; } .item-desc strong { display:block; font-size:10pt; } .item-desc small { color:#6c757d; font-size:8.5pt; }'
    +'.subtotal-row td { border-top:2px solid '+a+'; font-weight:700; font-size:11pt; padding-top:10px; background:transparent !important; }'
    +'.total-row td { border-top:3px double '+d+'; font-weight:700; font-size:13pt; color:'+d+'; padding-top:12px; padding-bottom:12px; background:#f5f5f5 !important; }'
    +'.markup-row td { font-weight:600; color:#6c757d; font-size:10pt; }'
    +'.combined { background:'+brand.combinedBg+'; border:2px solid '+brand.combinedBorder+'; border-radius:6px; padding:16px 20px; margin-top:24px; } .combined h3 { font-size:12pt; color:'+brand.combinedGrand+'; margin-bottom:10px; text-transform:uppercase; letter-spacing:0.5px; } .combined table { width:100%; border-collapse:collapse; } .combined table td { padding:6px 10px; font-size:11pt; border-bottom:1px solid '+brand.combinedRule+'; } .combined table td:last-child { text-align:right; font-weight:600; } .combined .grand td { border-top:3px double '+brand.combinedGrand+'; font-size:14pt; font-weight:700; color:'+brand.combinedGrand+'; padding-top:10px; } .combined .psf td { font-size:10pt; color:#6c757d; border-bottom:none; }'
    +'.supplier-note { background:#d4edda; border:1px solid #28a745; border-radius:4px; padding:12px 16px; margin-bottom:20px; font-size:9.5pt; } .supplier-note h4 { color:#155724; font-size:10pt; margin-bottom:4px; } .supplier-note p { color:#155724; }'
    +'.notes-section { margin-top:20px; } .notes-section h3 { font-size:11pt; color:'+a+'; border-bottom:2px solid '+a+'; padding-bottom:4px; margin-bottom:10px; text-transform:uppercase; letter-spacing:0.5px; } .notes-section .note { font-size:9pt; color:#495057; margin-bottom:8px; padding-left:14px; position:relative; } .notes-section .note::before { content:"\\25CF"; position:absolute; left:0; color:'+a+'; font-size:7pt; top:2px; }'
    +'.unforeseen-box { background:#fff3cd; border:1px solid #ffc107; border-radius:4px; padding:12px 16px; margin-top:20px; font-size:9pt; } .unforeseen-box h4 { color:#856404; font-size:10pt; margin-bottom:6px; } .unforeseen-box p { color:#664d03; line-height:1.5; }'
    +'.ref { background:#f0f0f0; border:1px solid #ccc; border-radius:4px; padding:12px 16px; margin-bottom:20px; font-size:9.5pt; } .ref h4 { font-size:10pt; color:'+d+'; margin-bottom:6px; text-transform:uppercase; } .ref p { color:#495057; margin-bottom:4px; }'
    +'.stitle { font-size:11pt; color:'+a+'; border-bottom:2px solid '+a+'; padding-bottom:4px; margin-bottom:12px; margin-top:24px; text-transform:uppercase; letter-spacing:0.5px; }'
    +'.dbox { border:1px solid #dee2e6; border-radius:4px; padding:16px; margin-bottom:20px; } .dbox label { font-size:9pt; color:#6c757d; text-transform:uppercase; display:block; margin-bottom:8px; } .dbox .wl { border-bottom:1px solid #dee2e6; min-height:22px; margin-bottom:6px; }'
    +'.pbox { background:#f8f9fa; border:2px dashed #adb5bd; border-radius:4px; padding:20px; text-align:center; margin-bottom:20px; } .pbox p { color:#6c757d; font-size:9pt; }'
    +'.impact { display:grid; grid-template-columns:1fr 1fr 1fr; gap:12px; margin-bottom:20px; } .impact-box { border:1px solid #dee2e6; border-radius:4px; padding:12px; text-align:center; } .impact-box label { font-size:8pt; text-transform:uppercase; color:#6c757d; display:block; margin-bottom:4px; } .impact-box .val { font-size:14pt; font-weight:700; color:'+a+'; } .impact-box .val.grn { color:#27ae60; }'
    +'.legal { background:#f8f9fa; border:1px solid #dee2e6; border-radius:4px; padding:16px; margin-top:20px; font-size:9pt; color:#495057; line-height:1.6; } .legal h4 { font-size:10pt; color:'+d+'; margin-bottom:8px; } .legal p { margin-bottom:8px; }'
    +'.auth { margin-top:30px; border:2px solid '+a+'; border-radius:6px; padding:20px; background:'+brand.authBg+'; } .auth h3 { font-size:12pt; color:'+a+'; margin-bottom:12px; text-transform:uppercase; }'
    +'.auth-opt { display:flex; align-items:flex-start; margin-bottom:12px; padding:10px; background:white; border:1px solid #dee2e6; border-radius:4px; cursor:pointer; } .auth-opt.selected { border-color:'+a+'; background:'+brand.authBg+'; }'
    +'.auth-cb { width:18px; height:18px; border:2px solid '+d+'; border-radius:3px; margin-right:12px; flex-shrink:0; margin-top:2px; display:flex; align-items:center; justify-content:center; font-size:14px; } .auth-cb.checked { background:'+a+'; border-color:'+a+'; color:'+brand.badgeText+'; }'
    +'.auth-txt { font-size:10pt; } .auth-txt strong { display:block; margin-bottom:2px; } .auth-txt small { color:#6c757d; font-size:8.5pt; }'
    +'[contenteditable="true"] { outline:none; } body.edit-mode [data-editable] { background:#fffde7; border-bottom:2px dashed #f39c12; cursor:text; padding:1px 4px; border-radius:2px; } body.edit-mode [data-editable]:focus { background:#fff9c4; border-bottom-color:#e67e22; } body.edit-mode .editable-price { background:#e3f2fd !important; border-bottom:2px dashed #2196f3 !important; } body.edit-mode .editable-price:focus { background:#bbdefb !important; }'
    +'.sig-section { margin-top:30px; } .sig-section h3 { font-size:11pt; color:'+d+'; border-bottom:2px solid '+d+'; padding-bottom:4px; margin-bottom:16px; text-transform:uppercase; letter-spacing:0.5px; } .sig-grid { display:grid; grid-template-columns:1fr 1fr; gap:30px; } .sig-pad { text-align:center; } .sig-pad label { font-size:9pt; color:#6c757d; display:block; margin-bottom:4px; text-transform:uppercase; letter-spacing:0.5px; } .sig-canvas { border:1px solid #ccc; border-radius:4px; background:white; cursor:crosshair; width:100%; height:100px; display:block; touch-action:none; } .sig-pad .sig-date { font-size:9pt; color:#495057; margin-top:4px; min-height:18px; } .sig-pad .sig-clear { font-size:11px; color:#c0392b; cursor:pointer; background:none; border:none; text-decoration:underline; margin-top:2px; }'
    +'@media print { .sig-pad .sig-clear { display:none; } .toolbar { display:none !important; } body { padding-top:0 !important; } }'
    +'.footer { margin-top:30px; text-align:center; font-size:8pt; color:#adb5bd; border-top:1px solid #dee2e6; padding-top:10px; }';
}

// ========== SHARED DOC JS ==========
function docJS() {
    var js = '';
    js += 'var editMode=false;';
    js += 'function toggleEdit(){editMode=!editMode;document.body.classList.toggle("edit-mode",editMode);var b=document.getElementById("editBtn");b.textContent=editMode?"EDITING (click to lock)":"Edit Values";b.classList.toggle("active",editMode);document.getElementById("editStatus").textContent=editMode?"Click any highlighted value to change it":"Document locked";document.querySelectorAll("[data-editable]").forEach(function(el){el.contentEditable=editMode?"true":"false";});}';
    js += 'function recalc(){var sqEl=document.querySelector("[data-sqft]"),sq=sqEl?(parseFloat(sqEl.textContent)||1):1;document.querySelectorAll("tbody tr").forEach(function(row){var lt=row.querySelector("[data-line-total]");if(!lt)return;var rateEl=row.querySelector("[data-rate]");var basisEl=row.querySelector("[data-basis]");var qtyEl=row.querySelector("[data-qty]");var upEl=row.querySelector("[data-unit-price]");if(rateEl&&basisEl){var rate=parseFloat(rateEl.textContent.replace(/[^0-9.\\-]/g,""))||0;if(basisEl.textContent.toLowerCase().indexOf("sq ft")!==-1){lt.textContent="$"+(rate*sq).toFixed(2);}else{lt.textContent="$"+rate.toFixed(2);}}if(qtyEl&&upEl){var q=parseFloat(qtyEl.textContent)||1;var up=parseFloat(upEl.textContent.replace(/[^0-9.\\-]/g,""))||0;lt.textContent="$"+(q*up).toFixed(2);}});var sub=0;document.querySelectorAll("[data-line-total]").forEach(function(el){sub+=parseFloat(el.textContent.replace(/[^0-9.\\-]/g,""))||0;});document.querySelectorAll("[data-subtotal]").forEach(function(el){el.textContent="$"+sub.toFixed(2);});document.querySelectorAll("[data-total]").forEach(function(el){el.textContent="$"+sub.toFixed(2);});var me=document.querySelector("[data-markup-pct]");if(me){var p=parseFloat(me.textContent)||0,ma=sub*(p/100),mt=sub+ma;document.querySelectorAll("[data-markup-amt]").forEach(function(e){e.textContent="$"+ma.toFixed(2);});document.querySelectorAll("[data-mat-total]").forEach(function(e){e.textContent="$"+mt.toFixed(2);});var le=document.querySelector("[data-combined-labor]");if(le){var la=parseFloat(le.textContent.replace(/[^0-9.\\-]/g,""))||0,g=la+mt;document.querySelectorAll("[data-combined-mat]").forEach(function(e){e.textContent="$"+mt.toFixed(2);});document.querySelectorAll("[data-grand-total]").forEach(function(e){e.textContent="$"+g.toFixed(2);});document.querySelectorAll("[data-per-sqft]").forEach(function(e){e.textContent="$"+(g/sq).toFixed(2)+" /sq ft";});}}}';
    js += 'document.addEventListener("input",function(e){if(e.target.hasAttribute("data-line-total")||e.target.hasAttribute("data-markup-pct")||e.target.hasAttribute("data-rate")||e.target.hasAttribute("data-basis")||e.target.hasAttribute("data-qty")||e.target.hasAttribute("data-unit-price")||e.target.hasAttribute("data-sqft")||e.target.hasAttribute("data-combined-labor"))recalc();});';
    js += 'function initSig(cid,did){var c=document.getElementById(cid);if(!c)return;var x=c.getContext("2d");var d=false,h=false;function rs(){var r=c.getBoundingClientRect();c.width=r.width*2;c.height=r.height*2;x.scale(2,2);x.strokeStyle="#1a1a1a";x.lineWidth=2;x.lineCap="round";x.lineJoin="round";}rs();function gp(e){var r=c.getBoundingClientRect(),t=e.touches?e.touches[0]:e;return{x:t.clientX-r.left,y:t.clientY-r.top};}c.addEventListener("mousedown",function(e){d=true;x.beginPath();var p=gp(e);x.moveTo(p.x,p.y);});c.addEventListener("mousemove",function(e){if(!d)return;var p=gp(e);x.lineTo(p.x,p.y);x.stroke();});c.addEventListener("mouseup",function(){d=false;if(!h){h=true;sd(did);}});c.addEventListener("mouseleave",function(){d=false;});c.addEventListener("touchstart",function(e){e.preventDefault();d=true;x.beginPath();var p=gp(e);x.moveTo(p.x,p.y);},{passive:false});c.addEventListener("touchmove",function(e){e.preventDefault();if(!d)return;var p=gp(e);x.lineTo(p.x,p.y);x.stroke();},{passive:false});c.addEventListener("touchend",function(e){e.preventDefault();d=false;if(!h){h=true;sd(did);}},{passive:false});window["clear_"+cid]=function(){x.clearRect(0,0,c.width,c.height);h=false;document.getElementById(did).textContent=""};}';
    js += 'function sd(did){var e=document.getElementById(did);if(e){var n=new Date();e.textContent="Signed: "+n.toLocaleDateString("en-US",{year:"numeric",month:"long",day:"numeric"})+" at "+n.toLocaleTimeString("en-US",{hour:"2-digit",minute:"2-digit"});}}';
    js += 'function exportPDF(){var el=document.body;var tb=document.querySelector(".toolbar");if(tb)tb.style.display="none";document.querySelectorAll(".sig-clear").forEach(function(b){b.style.display="none"});var client=document.querySelector(".info-box .value")?document.querySelector(".info-box .value").textContent.trim():"Quote";var title=document.title||"Estimate";var fn=title.replace(/[^a-zA-Z0-9]/g,"_")+"_"+new Date().toISOString().slice(0,10)+".pdf";var opt={margin:0.3,filename:fn,image:{type:"jpeg",quality:0.98},html2canvas:{scale:2,useCORS:true},jsPDF:{unit:"in",format:"letter",orientation:"portrait"}};if(typeof html2pdf!=="undefined"){html2pdf().set(opt).from(el).save().then(function(){if(tb)tb.style.display="flex";document.querySelectorAll(".sig-clear").forEach(function(b){b.style.display=""})});}else{var s=document.createElement("script");s.src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js";s.onload=function(){html2pdf().set(opt).from(el).save().then(function(){if(tb)tb.style.display="flex";document.querySelectorAll(".sig-clear").forEach(function(b){b.style.display=""})});};document.head.appendChild(s);}}';
    js += 'function emailQuote(){var client=document.querySelector(".info-box .value")?document.querySelector(".info-box .value").textContent.trim():"";var total="";document.querySelectorAll("[data-total],[data-grand-total]").forEach(function(e){total=e.textContent;});var title=document.title||"Estimate";var subj=encodeURIComponent(title+" - "+(client||"Quote"));var body=encodeURIComponent("Hi "+client+",\\n\\nPlease find attached the "+title+".\\n\\nTotal: "+total+"\\n\\nPlease review and let us know if you have any questions.\\n\\nBest regards");window.location.href="mailto:?subject="+subj+"&body="+body;}';
    js += 'function copySummary(){var lines=[];var title=document.title||"Estimate";lines.push(title);lines.push("=".repeat(title.length));var boxes=document.querySelectorAll(".info-box");boxes.forEach(function(b){var lbl=b.querySelector("label");var val=b.querySelector(".value");if(lbl&&val)lines.push(lbl.textContent.trim()+": "+val.textContent.trim());});lines.push("");var rows=document.querySelectorAll("tbody tr");rows.forEach(function(r){var cells=r.querySelectorAll("td");if(cells.length>=3){var desc=cells[1]?cells[1].textContent.trim():"";var amt=cells[cells.length-1]?cells[cells.length-1].textContent.trim():"";if(desc&&amt)lines.push(desc+" - "+amt);}});var total="";document.querySelectorAll("[data-total],[data-grand-total]").forEach(function(e){total=e.textContent;});if(total)lines.push("\\nTOTAL: "+total);var txt=lines.join("\\n");navigator.clipboard.writeText(txt).then(function(){alert("Summary copied to clipboard!");}).catch(function(){prompt("Copy this summary:",txt);});}';
    js += 'function generateQR(){var qrEl=document.getElementById("docQR");if(!qrEl)return;var title=document.title||"Quote";var client=document.querySelector(".info-box .value")?document.querySelector(".info-box .value").textContent.trim():"";var date=new Date().toISOString().slice(0,10);var ref=title.replace(/[^a-zA-Z0-9]/g,"-")+"-"+date;var data="REF:"+ref+" CLIENT:"+client+" DATE:"+date;var size=120;var canvas=document.createElement("canvas");canvas.width=size;canvas.height=size;var ctx=canvas.getContext("2d");ctx.fillStyle="#fff";ctx.fillRect(0,0,size,size);ctx.fillStyle="#1a1a1a";var s=4;for(var y=0;y<size/s;y++){for(var x=0;x<size/s;x++){if(simpleHash(data+x+","+y)%3===0){ctx.fillRect(x*s,y*s,s,s);}}}drawFinderPattern(ctx,0,0,s);drawFinderPattern(ctx,size-7*s,0,s);drawFinderPattern(ctx,0,size-7*s,s);qrEl.src=canvas.toDataURL();qrEl.title="Quote Ref: "+ref;}';
    js += 'function simpleHash(str){var h=0;for(var i=0;i<str.length;i++){h=((h<<5)-h)+str.charCodeAt(i);h|=0;}return Math.abs(h);}';
    js += 'function drawFinderPattern(ctx,x,y,s){ctx.fillStyle="#1a1a1a";ctx.fillRect(x,y,7*s,7*s);ctx.fillStyle="#fff";ctx.fillRect(x+s,y+s,5*s,5*s);ctx.fillStyle="#1a1a1a";ctx.fillRect(x+2*s,y+2*s,3*s,3*s);}';
    js += 'setTimeout(function(){initSig("sigContractor","sigDateContractor");initSig("sigClient","sigDateClient");generateQR();document.querySelectorAll(".auth-opt").forEach(function(opt){opt.addEventListener("click",function(){document.querySelectorAll(".auth-opt").forEach(function(o){o.classList.remove("selected");o.querySelector(".auth-cb").classList.remove("checked");o.querySelector(".auth-cb").textContent="";});this.classList.add("selected");var cb=this.querySelector(".auth-cb");cb.classList.add("checked");cb.textContent="\\u2713";});});},200);';
    return '<'+'script>' + js + '</'+'script>';
}
function toolbar(title) { return '<div class="toolbar no-print"><span class="tbt">'+title+'</span><span class="tbs" id="editStatus">Document locked</span><button class="tbe" id="editBtn" onclick="toggleEdit()">Edit Values</button><button class="tbp" onclick="exportPDF()">üìÑ Download PDF</button><button class="tbe" onclick="emailQuote()">üìß Email</button><button class="tbe" onclick="copySummary()">üìã Copy Summary</button><button class="tbe" onclick="window.print()">üñ®Ô∏è Print</button></div>'; }
function sigHTML() { return '<div class="sig-section"><h3>Signatures</h3><div class="sig-grid"><div class="sig-pad"><label>Contractor Signature</label><canvas id="sigContractor" class="sig-canvas"></canvas><div class="sig-date" id="sigDateContractor"></div><button class="sig-clear no-print" onclick="clear_sigContractor()">Clear</button></div><div class="sig-pad"><label>Client / Property Manager Signature</label><canvas id="sigClient" class="sig-canvas"></canvas><div class="sig-date" id="sigDateClient"></div><button class="sig-clear no-print" onclick="clear_sigClient()">Clear</button></div></div></div>'; }
function openDoc(html) { var w = window.open('','_blank'); w.document.write(html); w.document.close(); }

// ========== LABOR ESTIMATE ==========
function generateLabor() {
    var brand = getBrand();
    var sq = gn('sqft'), items = getLaborItems(), scope = getScope(), notes = getNotes();
    var tot = 0; items.forEach(function(i){ tot += (i.basis.toLowerCase().indexOf('sq ft') !== -1) ? i.price * sq : i.price; });
    var ad = gv('areaDesc') || '[Area]';
    var disc = gv('disclaimer');
    var h = '<!DOCTYPE html><html><head><meta charset="UTF-8"><title>Labor Estimate - '+(gv('clientName')||'Client')+'</title><style>'+docCSS(brand)+'</style></head><body>';
    h += toolbar('ESTIMATE A &mdash; LABOR');
    h += '<div class="header">'+co(brand)+'<div class="badge">ESTIMATE A<br><small>LABOR COSTS</small></div></div>';
    h += '<div class="info-grid"><div class="info-box"><label>Prepared For</label><div class="value">'+E(gv('clientName')||'[Client]')+'</div></div><div class="info-box"><label>Estimate Date</label><div class="value">'+E(fd(gv('estimateDate')))+'</div></div><div class="info-box"><label>Project Location</label><div class="value">'+E(loc())+'</div></div><div class="info-box"><label>Estimate Valid For</label><div class="value">'+E('30 Days from Date Above')+'</div></div></div>';
    h += '<div class="scope"><h3>Scope of Work &mdash; <span data-editable data-sqft>'+sq+'</span> sq ft '+E(ad)+'</h3><ul>';
    scope.forEach(function(s){ h += '<li>'+E(s)+'</li>'; });
    h += '</ul></div>';
    h += '<table><thead><tr><th style="width:30px">#</th><th>Description of Work</th><th>Basis</th><th>Rate</th><th>Total</th></tr></thead><tbody>';
    items.forEach(function(item, i){
        var isSqFt = item.basis.toLowerCase().indexOf('sq ft') !== -1;
        var lineTotal = isSqFt ? item.price * sq : item.price;
        h += '<tr><td class="item-num">'+(i+1)+'</td><td class="item-desc"><strong>'+E(item.desc)+'</strong></td><td>'+E(item.basis,'data-basis')+'</td><td>'+P('$'+f(item.price),'data-rate')+'</td><td><strong>'+P('$'+f(lineTotal),'data-line-total')+'</strong></td></tr>';
    });
    h += '<tr class="subtotal-row"><td></td><td colspan="3">LABOR SUBTOTAL</td><td><span data-subtotal>$'+f(tot)+'</span></td></tr>';
    h += '<tr class="total-row"><td></td><td colspan="3">TOTAL LABOR &mdash; ESTIMATE A</td><td><span data-total>$'+f(tot)+'</span></td></tr>';
    h += '</tbody></table>';
    h += '<div class="notes-section"><h3>Labor Estimate Notes</h3>';
    notes.forEach(function(n){ h += '<div class="note">'+E(n)+'</div>'; });
    h += '</div>';
    if (disc) { h += '<div class="unforeseen-box"><h4>UNFORESEEN CONDITIONS CLAUSE</h4><p>'+E(disc)+'</p></div>'; }
    h += sigHTML();
    h += '<div class="footer" style="display:flex;align-items:center;justify-content:center;gap:12px"><img id="docQR" style="width:60px;height:60px;opacity:0.6" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7"><p>'+brand.name+' &nbsp;|&nbsp; Valid for 30 days. &nbsp;|&nbsp; Licensed General Contractor &mdash; State of Nebraska</p></div>';
    h += docJS() + '</body></html>';
    openDoc(h);
    saveClientToDB(gv('clientName'), { complexName: gv('complexName'), jobCity: gv('jobCity'), unitNum: gv('unitNum') });
}

// ========== MATERIALS ESTIMATE ==========
function generateMaterials() {
    var brand = getBrand();
    var sq = gn('sqft'), mk = gn('materialsMarkup'), items = getMatItems(), notes = getNotes();
    var sub = 0; items.forEach(function(i){ sub += (parseFloat(i.qty) || 1) * i.price; });
    var ma = sub * (mk/100), mt = sub + ma;
    var litems = getLaborItems(), labTot = 0; litems.forEach(function(i){ labTot += (i.basis.toLowerCase().indexOf('sq ft') !== -1) ? i.price * sq : i.price; });
    var grand = labTot + mt;
    var ad = gv('areaDesc') || '[Area]';
    var sn = gv('supplierNote');
    var h = '<!DOCTYPE html><html><head><meta charset="UTF-8"><title>Materials Estimate - '+(gv('clientName')||'Client')+'</title><style>'+docCSS(brand)+'</style></head><body>';
    h += toolbar('ESTIMATE B &mdash; MATERIALS');
    h += '<div class="header">'+co(brand)+'<div class="badge">ESTIMATE B<br><small>MATERIAL COSTS</small></div></div>';
    h += '<div class="info-grid"><div class="info-box"><label>Prepared For</label><div class="value">'+E(gv('clientName')||'[Client]')+'</div></div><div class="info-box"><label>Estimate Date</label><div class="value">'+E(fd(gv('estimateDate')))+'</div></div><div class="info-box"><label>Project Location</label><div class="value">'+E(loc())+'</div></div><div class="info-box"><label>Estimate Valid For</label><div class="value">'+E('30 Days from Date Above')+'</div></div></div>';
    if (sn) { h += '<div class="supplier-note"><h4>MATERIAL SUPPLIER NOTE</h4><p>'+E(sn)+'</p></div>'; }
    h += '<table><thead><tr><th style="width:30px">#</th><th>Material</th><th>Qty</th><th>Unit Price</th><th>Total</th></tr></thead><tbody>';
    items.forEach(function(item, i){
        var qtyNum = parseFloat(item.qty) || 1;
        var lineTotal = qtyNum * item.price;
        h += '<tr><td class="item-num">'+(i+1)+'</td><td class="item-desc"><strong>'+E(item.desc)+'</strong></td><td>'+E(item.qty,'data-qty')+'</td><td>'+P('$'+f(item.price),'data-unit-price')+'</td><td><strong>'+P('$'+f(lineTotal),'data-line-total')+'</strong></td></tr>';
    });
    h += '<tr class="subtotal-row"><td></td><td colspan="3">MATERIALS SUBTOTAL</td><td><span data-subtotal>$'+f(sub)+'</span></td></tr>';
    h += '<tr class="markup-row"><td></td><td colspan="3"><strong>Contractor Markup (<span data-editable data-markup-pct>'+mk+'</span>%)</strong></td><td><span data-markup-amt>$'+f(ma)+'</span></td></tr>';
    h += '<tr class="total-row"><td></td><td colspan="3">TOTAL MATERIALS &mdash; ESTIMATE B</td><td><span data-mat-total>$'+f(mt)+'</span></td></tr>';
    h += '</tbody></table>';
    h += '<div class="combined"><h3>Combined Project Total</h3><table>';
    h += '<tr><td>Estimate A &mdash; Labor</td><td><span data-combined-labor>$'+f(labTot)+'</span></td></tr>';
    h += '<tr><td>Estimate B &mdash; Materials</td><td><span data-combined-mat>$'+f(mt)+'</span></td></tr>';
    if (sn) h += '<tr><td style="color:#6c757d;font-style:italic;">Third-Party Supplied Materials (paid separately)</td><td style="color:#6c757d;font-style:italic;">Not Included</td></tr>';
    h += '<tr class="grand"><td>TOTAL PROJECT PRICE</td><td><span data-grand-total>$'+f(grand)+'</span></td></tr>';
    h += '<tr class="psf"><td>Per Square Foot (<span data-sqft>'+sq+'</span> sq ft)</td><td><span data-per-sqft>$'+f(grand/sq)+' /sq ft</span></td></tr>';
    h += '</table></div>';
    h += '<div class="notes-section"><h3>Materials Notes</h3>';
    notes.forEach(function(n){ h += '<div class="note">'+E(n)+'</div>'; });
    h += '</div>';
    h += sigHTML();
    h += '<div class="footer" style="display:flex;align-items:center;justify-content:center;gap:12px"><img id="docQR" style="width:60px;height:60px;opacity:0.6" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7"><p>'+brand.name+' &nbsp;|&nbsp; Valid for 30 days. &nbsp;|&nbsp; Licensed General Contractor &mdash; State of Nebraska</p></div>';
    h += docJS() + '</body></html>';
    openDoc(h);
    saveClientToDB(gv('clientName'), { complexName: gv('complexName'), jobCity: gv('jobCity'), unitNum: gv('unitNum') });
}

// ========== CHANGE ORDER ==========
function generateChangeOrder() {
    var sq = gn('sqft'), mk = gn('materialsMarkup')/100;
    var litems = getLaborItems(), labTot = 0; litems.forEach(function(i){ labTot += (i.basis.toLowerCase().indexOf('sq ft') !== -1) ? i.price * sq : i.price; });
    var mitems = getMatItems(), matSub = 0; mitems.forEach(function(i){ matSub += (parseFloat(i.qty) || 1) * i.price; });
    var matTot = matSub + (matSub * mk), orig = labTot + matTot;
    var disc = gv('disclaimer');
    var brand = getBrand();
    var h = '<!DOCTYPE html><html><head><meta charset="UTF-8"><title>Change Order - '+(gv('clientName')||'Client')+'</title><style>'+docCSS(brand)+'</style></head><body>';
    h += toolbar('CHANGE ORDER');
    h += '<div class="header">'+co(brand)+'<div class="badge">CHANGE ORDER<br><small>SCOPE AMENDMENT</small></div></div>';
    h += '<div class="info-grid-3"><div class="info-box hl"><label>Change Order #</label><div class="value">'+E('CO-001')+'</div></div><div class="info-box"><label>Date Issued</label><div class="value">'+E(fd(new Date().toISOString().split('T')[0]))+'</div></div><div class="info-box"><label>Response Required By</label><div class="value">'+E('3 Business Days')+'</div></div></div>';
    h += '<div class="info-grid"><div class="info-box"><label>Prepared For</label><div class="value">'+E(gv('clientName')||'[Client]')+'</div></div><div class="info-box"><label>Project Location</label><div class="value">'+E(loc())+'</div></div></div>';
    h += '<div class="ref"><h4>Reference &mdash; Original Estimate</h4><p><strong>Original Date:</strong> '+fd(gv('estimateDate'))+'</p><p><strong>Original Amount:</strong> Labor $'+f(labTot)+' + Materials $'+f(matTot)+' = <strong>$'+f(orig)+'</strong></p><p><strong>Clause:</strong> '+E(disc || 'Unforeseen Conditions')+'</p></div>';
    h += '<h3 class="stitle">Section 1 &mdash; Discovered Conditions</h3>';
    h += '<div class="dbox"><label>Describe the concealed condition(s):</label><div class="wl" data-editable contenteditable="false">&nbsp;</div><div class="wl" data-editable contenteditable="false">&nbsp;</div><div class="wl" data-editable contenteditable="false">&nbsp;</div><div class="wl" data-editable contenteditable="false">&nbsp;</div></div>';
    h += '<div class="dbox"><label>Location within the unit:</label><div class="wl" data-editable contenteditable="false">&nbsp;</div><div class="wl" data-editable contenteditable="false">&nbsp;</div></div>';
    h += '<div class="pbox"><p><strong>PHOTO DOCUMENTATION</strong> &mdash; Attach dated photos. Count: '+E('______')+'</p></div>';
    h += '<h3 class="stitle">Section 2 &mdash; Additional Work</h3>';
    h += '<table><thead><tr><th style="width:30px">#</th><th>Description</th><th>Qty</th><th>Rate</th><th>Total</th></tr></thead><tbody>';
    var letters = 'ABCDEFGHIJ';
    for (var i = 0; i < 5; i++) {
        h += '<tr><td class="item-num">'+letters[i]+'</td><td class="item-desc"><strong>'+E('[Description]')+'</strong></td><td>'+E('______')+'</td><td>'+P('$______')+'</td><td><strong>'+P('$______','data-line-total')+'</strong></td></tr>';
    }
    h += '<tr class="subtotal-row"><td></td><td colspan="3">CHANGE ORDER SUBTOTAL</td><td><span data-subtotal>$0.00</span></td></tr>';
    h += '<tr class="total-row"><td></td><td colspan="3">CHANGE ORDER TOTAL</td><td><span data-total>$0.00</span></td></tr>';
    h += '</tbody></table>';
    h += '<h3 class="stitle">Section 3 &mdash; Project Impact</h3>';
    h += '<div class="impact"><div class="impact-box"><label>Original Contract</label><div class="val grn">$'+f(orig)+'</div></div><div class="impact-box"><label>This Change Order</label><div class="val">'+E('$______')+'</div></div><div class="impact-box"><label>Revised Total</label><div class="val">'+E('$______')+'</div></div></div>';
    h += '<div class="info-grid"><div class="info-box"><label>Schedule Impact</label><div class="value">'+E('Additional ___ day(s)')+'</div></div><div class="info-box"><label>Revised Completion</label><div class="value">'+E('______')+'</div></div></div>';
    h += '<div class="legal"><h4>Terms &amp; Conditions</h4><p>1. This Change Order amends the original estimate upon execution by both parties.</p><p>2. Work shall not commence until written authorization is received.</p><p>3. Additional compensation reflects actual cost plus applicable overhead.</p><p>4. If declined, Contractor restores area to safe condition. Not responsible for unaddressed damage.</p><p>5. Payment due upon completion of additional scope.</p><p>6. Consistent with Nebraska Revised Statute &sect;73-1117.</p></div>';
    h += '<div class="auth"><h3>Client Authorization</h3>';
    h += '<div class="auth-opt"><div class="auth-cb"></div><div class="auth-txt"><strong>APPROVED</strong><small>I authorize the Contractor to proceed at the stated price.</small></div></div>';
    h += '<div class="auth-opt"><div class="auth-cb"></div><div class="auth-txt"><strong>APPROVED WITH MODIFICATIONS</strong><small>Proceed with modifications: '+E('______________________________')+'</small></div></div>';
    h += '<div class="auth-opt"><div class="auth-cb"></div><div class="auth-txt"><strong>DECLINED</strong><small>I decline. Contractor will restore area to safe condition.</small></div></div></div>';
    h += sigHTML();
    h += '<div class="footer" style="display:flex;align-items:center;justify-content:center;gap:12px"><img id="docQR" style="width:60px;height:60px;opacity:0.6" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7"><p>Change Order &mdash; '+brand.name+' &nbsp;|&nbsp; Licensed GC &mdash; Nebraska &nbsp;|&nbsp; Retain copies for all parties.</p></div>';
    h += docJS() + '</body></html>';
    openDoc(h);
    saveClientToDB(gv('clientName'), { complexName: gv('complexName'), jobCity: gv('jobCity'), unitNum: gv('unitNum') });
}

// =====================================================================
// CLIENT AUTO-COMPLETE DATABASE
// =====================================================================
let _clientDB = {};

function initClientDB() {
    if (!db || !userPIN) return;
    const hashedPIN = hashPIN(userPIN);
    db.ref('clients/' + hashedPIN).on('value', snap => {
        _clientDB = snap.val() || {};
    });
}

function clientAcSearch() {
    const input = document.getElementById('clientName');
    const drop = document.getElementById('clientAcDrop');
    if (!input || !drop) return;
    const q = input.value.toLowerCase().trim();
    if (q.length < 1) { drop.classList.remove('show'); return; }
    
    const matches = Object.values(_clientDB).filter(c => 
        c.name && c.name.toLowerCase().includes(q)
    ).slice(0, 8);
    
    if (matches.length === 0) { drop.classList.remove('show'); return; }
    
    drop.innerHTML = matches.map(c => {
        const meta = [c.property, c.city].filter(Boolean).join(' ‚Äî ');
        return '<div class="client-ac-item" onmousedown="clientAcSelect(\'' + escHtml(c.name).replace(/'/g, "\\'") + '\')">' +
            '<div class="ca-name">' + escHtml(c.name) + '</div>' +
            (meta ? '<div class="ca-meta">' + escHtml(meta) + (c.email ? ' | ' + escHtml(c.email) : '') + '</div>' : '') +
            '</div>';
    }).join('');
    drop.classList.add('show');
}

function clientAcSelect(name) {
    const client = Object.values(_clientDB).find(c => c.name === name);
    if (!client) return;
    document.getElementById('clientName').value = client.name;
    if (client.property) document.getElementById('complexName').value = client.property;
    if (client.city) document.getElementById('jobCity').value = client.city;
    if (client.unit) document.getElementById('unitNum').value = client.unit;
    document.getElementById('clientAcDrop').classList.remove('show');
}

function saveClientToDB(clientName, jobData) {
    if (!db || !userPIN || !clientName || clientName === 'Unknown Client') return;
    const hashedPIN = hashPIN(userPIN);
    const key = sanitizeKey(clientName);
    const existing = _clientDB[key] || {};
    const updated = {
        name: clientName,
        property: jobData.complexName || existing.property || '',
        city: jobData.jobCity || existing.city || '',
        unit: jobData.unitNum || existing.unit || '',
        email: existing.email || '',
        phone: existing.phone || '',
        bidCount: (existing.bidCount || 0) + 1,
        lastBid: Date.now(),
        firstSeen: existing.firstSeen || Date.now()
    };
    _clientDB[key] = updated;
    db.ref('clients/' + hashedPIN + '/' + key).set(updated);
}

document.addEventListener('click', function(e) {
    const drop = document.getElementById('clientAcDrop');
    if (drop && !e.target.closest('.client-ac-wrap')) drop.classList.remove('show');
});

// =====================================================================
// QUICK TEMPLATES
// =====================================================================
const JOB_TEMPLATES = {
    grab_bar_install: {
        trade: 'general', areaDesc: 'Bathroom', sqft: 48,
        labor: [
            { desc: 'Wall stud location & blocking', basis: '1 lot', price: 45 },
            { desc: 'Grab bar mounting (per bar)', basis: 'per unit', price: 35 },
            { desc: 'Drywall patching (if needed)', basis: '1 lot', price: 30 },
            { desc: 'Cleanup & inspection', basis: '1 lot', price: 20 }
        ],
        materials: [
            { desc: 'Stainless Steel Grab Bar 18"', qty: '2', price: 28 },
            { desc: 'Stainless Steel Grab Bar 36"', qty: '1', price: 42 },
            { desc: 'Wood Blocking / Backing Board', qty: '1 lot', price: 12 },
            { desc: 'Stainless Mounting Hardware', qty: '1 lot', price: 15 },
            { desc: 'Drywall Patch Kit', qty: '1', price: 12 }
        ],
        disclaimer: 'Wall conditions behind tile or drywall cannot be assessed until access is gained. If studs are not present at required locations, additional blocking or reinforcement may be needed. Contractor shall provide written notice and a Change Order before proceeding.'
    },
    ada_ramp: {
        trade: 'general', areaDesc: 'Exterior Entry', sqft: 120,
        labor: [
            { desc: 'Site prep & layout', basis: '1 lot', price: 150 },
            { desc: 'Foundation / post setting', basis: '1 lot', price: 200 },
            { desc: 'Ramp framing & decking', basis: 'per sq ft', price: 8 },
            { desc: 'Handrail installation', basis: '1 lot', price: 175 },
            { desc: 'Landing platform', basis: '1 lot', price: 125 },
            { desc: 'Final inspection & cleanup', basis: '1 lot', price: 50 }
        ],
        materials: [
            { desc: 'Pressure-Treated Lumber (framing)', qty: '1 lot', price: 280 },
            { desc: 'Composite Decking Boards', qty: '1 lot', price: 350 },
            { desc: 'Aluminum Handrails', qty: '2', price: 120 },
            { desc: 'Concrete / Post Anchors', qty: '1 lot', price: 65 },
            { desc: 'Hardware / Fasteners', qty: '1 lot', price: 45 },
            { desc: 'Non-Slip Surface Strips', qty: '1 lot', price: 30 }
        ],
        disclaimer: 'Ground conditions, slope grade, and soil composition cannot be fully assessed until excavation begins. Frost depth, drainage issues, or underground utilities may require design modifications. Contractor shall provide written notice and a Change Order before proceeding. All work performed per ADA guidelines and local building code.'
    },
    walk_in_shower: {
        trade: 'plumbing', areaDesc: 'Bathroom', sqft: 48,
        labor: [
            { desc: 'Demolition of existing tub/shower', basis: '1 lot', price: 250 },
            { desc: 'Plumbing rough-in / reroute', basis: '1 lot', price: 300 },
            { desc: 'Shower pan installation', basis: '1 lot', price: 200 },
            { desc: 'Tile / surround installation', basis: '1 lot', price: 400 },
            { desc: 'Fixture installation', basis: '1 lot', price: 150 },
            { desc: 'Grab bar installation', basis: '1 lot', price: 75 },
            { desc: 'Cleanup & haul-away', basis: '1 lot', price: 100 }
        ],
        materials: [
            { desc: 'Walk-In Shower Pan (barrier-free)', qty: '1', price: 350 },
            { desc: 'Shower Surround / Tile', qty: '1 lot', price: 280 },
            { desc: 'Shower Valve & Trim Kit', qty: '1', price: 120 },
            { desc: 'Handheld Shower Head w/ Slide Bar', qty: '1', price: 65 },
            { desc: 'ADA Grab Bars', qty: '2', price: 35 },
            { desc: 'Waterproofing Membrane', qty: '1 lot', price: 45 },
            { desc: 'PEX / Fittings', qty: '1 lot', price: 40 },
            { desc: 'Drain Assembly', qty: '1', price: 30 }
        ],
        disclaimer: 'Plumbing and structural conditions behind walls and under floors cannot be assessed until demolition. Corroded pipes, non-code-compliant connections, water damage, or inadequate subfloor may be discovered. Contractor shall provide written notice. Work shall cease until a written Change Order is executed.'
    },
    stair_rail: {
        trade: 'general', areaDesc: 'Stairway', sqft: 30,
        labor: [
            { desc: 'Measurement & layout', basis: '1 lot', price: 40 },
            { desc: 'Bracket / post mounting', basis: '1 lot', price: 75 },
            { desc: 'Rail installation & leveling', basis: '1 lot', price: 60 },
            { desc: 'Cleanup', basis: '1 lot', price: 20 }
        ],
        materials: [
            { desc: 'Handrail (wood or metal)', qty: '1', price: 55 },
            { desc: 'Wall Brackets', qty: '4', price: 8 },
            { desc: 'End Caps / Returns', qty: '2', price: 12 },
            { desc: 'Mounting Hardware', qty: '1 lot', price: 10 }
        ],
        disclaimer: 'Wall composition and stud placement cannot be confirmed until installation begins. If walls lack adequate backing, additional blocking will be required. Contractor shall provide written notice before proceeding.'
    },
    toilet_replace: {
        trade: 'plumbing', areaDesc: 'Bathroom', sqft: 48,
        labor: [
            { desc: 'Remove existing toilet', basis: '1 lot', price: 45 },
            { desc: 'Inspect flange & drain', basis: '1 lot', price: 30 },
            { desc: 'Install new toilet', basis: '1 lot', price: 75 },
            { desc: 'Connect supply & test', basis: '1 lot', price: 25 },
            { desc: 'Cleanup & haul-away', basis: '1 lot', price: 25 }
        ],
        materials: [
            { desc: 'Toilet (elongated, ADA height)', qty: '1', price: 189 },
            { desc: 'Wax Ring / Gasket', qty: '1', price: 5 },
            { desc: 'Supply Line (braided)', qty: '1', price: 8 },
            { desc: 'Shut-Off Valve', qty: '1', price: 12 },
            { desc: 'Toilet Seat', qty: '1', price: 25 },
            { desc: 'Caulk', qty: '1', price: 6 }
        ],
        disclaimer: 'Plumbing conditions beneath the toilet cannot be assessed until removal. Corroded flanges, damaged subfloor, or non-standard drain connections may require additional work. Contractor shall provide written notice and a Change Order before proceeding.'
    },
    faucet_replace: {
        trade: 'plumbing', areaDesc: 'Kitchen / Bathroom', sqft: 48,
        labor: [
            { desc: 'Remove existing faucet', basis: '1 lot', price: 35 },
            { desc: 'Install new faucet', basis: '1 lot', price: 55 },
            { desc: 'Connect supply lines & test', basis: '1 lot', price: 25 },
            { desc: 'Cleanup', basis: '1 lot', price: 15 }
        ],
        materials: [
            { desc: 'Faucet (single-handle)', qty: '1', price: 85 },
            { desc: 'Supply Lines (braided)', qty: '2', price: 8 },
            { desc: 'Plumber\'s Putty / Teflon', qty: '1 lot', price: 6 }
        ],
        disclaimer: 'Supply line connections and valve conditions cannot be assessed until the existing faucet is removed. Corroded valves or non-standard connections may require additional work.'
    },
    water_heater: {
        trade: 'plumbing', areaDesc: 'Utility / Basement', sqft: 48,
        labor: [
            { desc: 'Disconnect & drain existing unit', basis: '1 lot', price: 75 },
            { desc: 'Remove & haul away old unit', basis: '1 lot', price: 60 },
            { desc: 'Install new water heater', basis: '1 lot', price: 200 },
            { desc: 'Connect plumbing & gas/electric', basis: '1 lot', price: 100 },
            { desc: 'Test & verify operation', basis: '1 lot', price: 40 }
        ],
        materials: [
            { desc: 'Water Heater (50 gal)', qty: '1', price: 450 },
            { desc: 'Expansion Tank', qty: '1', price: 35 },
            { desc: 'Flex Connectors', qty: '2', price: 15 },
            { desc: 'T&P Valve / Discharge Pipe', qty: '1 lot', price: 20 },
            { desc: 'Gas Flex / Fittings (if gas)', qty: '1 lot', price: 25 }
        ],
        disclaimer: 'Existing plumbing, gas, and electrical connections may not meet current code. Venting, gas line sizing, or electrical circuit upgrades may be required. Permits pulled if required by local jurisdiction.'
    },
    drain_repair: {
        trade: 'plumbing', areaDesc: 'Bathroom / Kitchen', sqft: 48,
        labor: [
            { desc: 'Diagnose drain issue', basis: '1 lot', price: 60 },
            { desc: 'Access / open drain line', basis: '1 lot', price: 45 },
            { desc: 'Snake / clear blockage', basis: '1 lot', price: 75 },
            { desc: 'Repair / replace damaged section', basis: '1 lot', price: 100 },
            { desc: 'Test & verify flow', basis: '1 lot', price: 25 }
        ],
        materials: [
            { desc: 'PVC / ABS Pipe & Fittings', qty: '1 lot', price: 25 },
            { desc: 'Drain Cleaner / Treatment', qty: '1', price: 12 },
            { desc: 'Pipe Cement / Primer', qty: '1 lot', price: 10 }
        ],
        disclaimer: 'Drain conditions within walls, floors, and underground cannot be assessed until access is gained. Root intrusion, collapsed pipe, or non-code-compliant connections may be discovered.'
    },
    outlet_install: {
        trade: 'electrical', areaDesc: 'Room Interior', sqft: 120,
        labor: [
            { desc: 'Circuit identification', basis: '1 lot', price: 40 },
            { desc: 'Cut-in box installation', basis: 'per unit', price: 35 },
            { desc: 'Wire run (new or extension)', basis: 'per run', price: 85 },
            { desc: 'Device installation & wiring', basis: 'per unit', price: 30 },
            { desc: 'Testing & verification', basis: '1 lot', price: 25 }
        ],
        materials: [
            { desc: 'Outlet / Receptacle', qty: '2', price: 4 },
            { desc: 'Old-Work Electrical Box', qty: '2', price: 5 },
            { desc: 'Romex Wire (12/2 or 14/2)', qty: '1 lot', price: 25 },
            { desc: 'Cover Plates', qty: '2', price: 3 },
            { desc: 'Wire Nuts / Connectors', qty: '1 lot', price: 5 }
        ],
        disclaimer: 'Electrical systems concealed within walls cannot be fully assessed until access is gained. Aluminum wiring, overloaded circuits, or non-code-compliant connections may be discovered. All work per NEC and local code.'
    },
    light_fixture: {
        trade: 'electrical', areaDesc: 'Room Interior', sqft: 120,
        labor: [
            { desc: 'Remove existing fixture', basis: 'per unit', price: 25 },
            { desc: 'Install new fixture', basis: 'per unit', price: 45 },
            { desc: 'Wiring connection & testing', basis: 'per unit', price: 20 },
            { desc: 'Cleanup', basis: '1 lot', price: 15 }
        ],
        materials: [
            { desc: 'Light Fixture', qty: '1', price: 65 },
            { desc: 'Wire Nuts / Electrical Tape', qty: '1 lot', price: 5 },
            { desc: 'Mounting Hardware', qty: '1 lot', price: 8 }
        ],
        disclaimer: 'Electrical box condition and wiring cannot be assessed until the existing fixture is removed. Inadequate boxes, damaged wiring, or missing grounds may require additional work.'
    },
    ceiling_fan: {
        trade: 'electrical', areaDesc: 'Bedroom / Living Room', sqft: 150,
        labor: [
            { desc: 'Remove existing fixture', basis: '1 lot', price: 30 },
            { desc: 'Install fan-rated box (if needed)', basis: '1 lot', price: 55 },
            { desc: 'Assemble & mount ceiling fan', basis: '1 lot', price: 75 },
            { desc: 'Wiring & testing', basis: '1 lot', price: 30 }
        ],
        materials: [
            { desc: 'Ceiling Fan w/ Light Kit', qty: '1', price: 120 },
            { desc: 'Fan-Rated Ceiling Box', qty: '1', price: 15 },
            { desc: 'Mounting Hardware', qty: '1 lot', price: 8 }
        ],
        disclaimer: 'Ceiling structure and existing electrical box rating cannot be confirmed until the old fixture is removed. A fan-rated box is required by code. Additional framing support may be needed.'
    },
    gfci_upgrade: {
        trade: 'electrical', areaDesc: 'Kitchen / Bathroom / Garage', sqft: 48,
        labor: [
            { desc: 'Circuit identification & testing', basis: '1 lot', price: 40 },
            { desc: 'Remove existing outlet', basis: 'per unit', price: 10 },
            { desc: 'Install GFCI outlet', basis: 'per unit', price: 30 },
            { desc: 'Test trip/reset function', basis: '1 lot', price: 15 }
        ],
        materials: [
            { desc: 'GFCI Outlet (20A)', qty: '3', price: 18 },
            { desc: 'GFCI Cover Plates', qty: '3', price: 4 },
            { desc: 'Wire Nuts / Tape', qty: '1 lot', price: 5 }
        ],
        disclaimer: 'Wiring behind existing outlets cannot be assessed until removal. Aluminum wiring, backstab connections, or missing grounds may require additional work per NEC code.'
    },
    drywall_patch: {
        trade: 'general', areaDesc: 'Room Interior', sqft: 120,
        labor: [
            { desc: 'Cut out damaged area', basis: '1 lot', price: 30 },
            { desc: 'Install backing & patch', basis: 'per patch', price: 35 },
            { desc: 'Tape, mud & sand (3 coats)', basis: 'per patch', price: 55 },
            { desc: 'Prime & paint to match', basis: '1 lot', price: 45 },
            { desc: 'Cleanup', basis: '1 lot', price: 15 }
        ],
        materials: [
            { desc: 'Drywall Patch / Sheet', qty: '1', price: 12 },
            { desc: 'Joint Compound', qty: '1', price: 10 },
            { desc: 'Mesh Tape', qty: '1', price: 6 },
            { desc: 'Sandpaper (various grit)', qty: '1 lot', price: 8 },
            { desc: 'Primer', qty: '1 qt', price: 12 },
            { desc: 'Paint (matched)', qty: '1 qt', price: 18 }
        ],
        disclaimer: 'Conditions behind drywall cannot be assessed until the damaged area is opened. Water damage, mold, or structural issues may be discovered.'
    },
    door_install: {
        trade: 'general', areaDesc: 'Room Interior', sqft: 120,
        labor: [
            { desc: 'Remove existing door & hardware', basis: '1 lot', price: 30 },
            { desc: 'Prep opening / shim frame', basis: '1 lot', price: 45 },
            { desc: 'Hang new door', basis: '1 lot', price: 65 },
            { desc: 'Install hardware (knob, hinges)', basis: '1 lot', price: 30 },
            { desc: 'Trim & casing adjustment', basis: '1 lot', price: 40 }
        ],
        materials: [
            { desc: 'Pre-Hung Interior Door', qty: '1', price: 95 },
            { desc: 'Door Knob / Lever Set', qty: '1', price: 25 },
            { desc: 'Hinges (3-pack)', qty: '1', price: 10 },
            { desc: 'Shims / Screws', qty: '1 lot', price: 8 },
            { desc: 'Caulk / Wood Filler', qty: '1', price: 6 }
        ],
        disclaimer: 'Door frame and wall conditions cannot be assessed until the existing door is removed. Out-of-square frames, damaged headers, or non-standard sizing may require additional work.'
    },
    flooring_vinyl: {
        trade: 'flooring', areaDesc: 'Room Interior', sqft: 120,
        labor: [
            { desc: 'Remove existing flooring', basis: 'per sq ft', price: 1.50 },
            { desc: 'Subfloor prep & leveling', basis: 'per sq ft', price: 0.75 },
            { desc: 'Vinyl plank installation', basis: 'per sq ft', price: 2.50 },
            { desc: 'Transition strips & trim', basis: '1 lot', price: 45 },
            { desc: 'Cleanup & haul-away', basis: '1 lot', price: 40 }
        ],
        materials: [
            { desc: 'Luxury Vinyl Plank (LVP)', qty: '1 lot', price: 2.50 },
            { desc: 'Underlayment', qty: '1 lot', price: 0.50 },
            { desc: 'Transition Strips', qty: '3', price: 12 },
            { desc: 'Quarter Round / Shoe Molding', qty: '1 lot', price: 25 },
            { desc: 'Adhesive / Spacers', qty: '1 lot', price: 15 }
        ],
        disclaimer: 'Subfloor conditions cannot be assessed until existing flooring is removed. Water damage, uneven surfaces, or asbestos-containing materials may be discovered.'
    },
    paint_room: {
        trade: 'painting', areaDesc: 'Room Interior', sqft: 150,
        labor: [
            { desc: 'Surface prep (fill, sand, tape)', basis: 'per sq ft', price: 0.50 },
            { desc: 'Prime walls & ceiling', basis: 'per sq ft', price: 0.40 },
            { desc: 'Paint ‚Äî 2 coats walls', basis: 'per sq ft', price: 0.80 },
            { desc: 'Paint ‚Äî ceiling', basis: 'per sq ft', price: 0.50 },
            { desc: 'Trim & detail work', basis: '1 lot', price: 75 },
            { desc: 'Cleanup & touch-up', basis: '1 lot', price: 30 }
        ],
        materials: [
            { desc: 'Interior Paint (walls)', qty: '2 gal', price: 35 },
            { desc: 'Ceiling Paint', qty: '1 gal', price: 28 },
            { desc: 'Primer', qty: '1 gal', price: 22 },
            { desc: 'Painter\'s Tape', qty: '2 rolls', price: 7 },
            { desc: 'Drop Cloths', qty: '2', price: 8 },
            { desc: 'Rollers / Brushes / Tray', qty: '1 lot', price: 18 },
            { desc: 'Spackle / Caulk', qty: '1 lot', price: 10 }
        ],
        disclaimer: 'Wall and ceiling conditions may reveal water stains, mold, lead paint (pre-1978), or structural cracks once preparation begins. Contractor shall provide written notice before proceeding with remediation.'
    }
};

function applyTemplate() {
    const sel = document.getElementById('templateSelect');
    const key = sel.value;
    if (!key) { alert('Select a template first.'); return; }
    const t = JOB_TEMPLATES[key];
    if (!t) return;
    
    if (document.getElementById('clientName').value && !confirm('This will replace current labor & material items. Continue?')) return;
    
    document.getElementById('tradeType').value = t.trade;
    onTradeChange();
    document.getElementById('areaDesc').value = t.areaDesc;
    document.getElementById('sqft').value = t.sqft;
    
    document.getElementById('laborItemsContainer').innerHTML = '';
    t.labor.forEach(li => addLaborRow(li.desc, li.basis, li.price));
    
    document.getElementById('matItemsContainer').innerHTML = '';
    t.materials.forEach(mi => addMatRow(mi.desc, mi.qty, mi.price));
    
    document.getElementById('disclaimer').value = t.disclaimer;
    sel.value = '';
    showNotification('‚ö° Template applied! Fill in client & job details.', 'success');
}

// =====================================================================
// PUSH NOTIFICATIONS FOR EXPIRING QUOTES
// =====================================================================
function initPushNotifications() {
    if (!('Notification' in window)) return;
    if (Notification.permission === 'default') {
        Notification.requestPermission();
    }
}

function checkAndNotifyExpiring() {
    if (!('Notification' in window) || Notification.permission !== 'granted') return;
    const now = new Date();
    Object.values(invoiceData.temporary || {}).forEach(inv => {
        const daysLeft = Math.ceil((new Date(inv.expiresDate) - now) / 86400000);
        const notifKey = 'notif_' + inv.id + '_' + daysLeft;
        if (sessionStorage.getItem(notifKey)) return;
        
        if (daysLeft === 5 || daysLeft === 2 || daysLeft === 0) {
            let title, body;
            if (daysLeft === 0) {
                title = 'üî¥ Quote EXPIRED';
                body = inv.clientName + ' ‚Äî Quote has expired today!';
            } else if (daysLeft === 2) {
                title = 'üü† Quote expiring in 2 days';
                body = inv.clientName + ' ‚Äî Follow up ASAP!';
            } else {
                title = 'üü° Quote expiring in 5 days';
                body = inv.clientName + ' ‚Äî $' + inv.amount.toFixed(0) + ' pending';
            }
            new Notification(title, { body: body, icon: '/favicon-96x96.png', tag: notifKey });
            sessionStorage.setItem(notifKey, '1');
        }
    });
}

// =====================================================================
// WIN/LOSS ANALYTICS DASHBOARD
// =====================================================================
function openAnalytics() {
    const panel = document.getElementById('quoteDetailPanel');
    const list = document.getElementById('invoiceList');
    if (panel) { panel.style.display = 'block'; }
    if (list) { list.style.display = 'none'; }
    
    const temp = Object.values(invoiceData.temporary);
    const perm = Object.values(invoiceData.permanent);
    const lost = Object.values(invoiceData.lost);
    const all = [...temp, ...perm, ...lost];
    
    const totalBids = all.length;
    const wonCount = perm.length;
    const lostCount = lost.length;
    const pendingCount = temp.length;
    const winRate = totalBids > 0 ? Math.round((wonCount / (wonCount + lostCount || 1)) * 100) : 0;
    const avgBid = all.length > 0 ? all.reduce((s, i) => s + i.amount, 0) / all.length : 0;
    const totalRevenue = perm.reduce((s, i) => s + i.amount, 0);
    
    // Revenue by trade type
    const byTrade = {};
    perm.forEach(inv => {
        const t = (inv.jobDetails && inv.jobDetails.tradeType) || 'general';
        byTrade[t] = (byTrade[t] || 0) + inv.amount;
    });
    const maxTrade = Math.max(...Object.values(byTrade), 1);
    const tradeColors = { flooring: '#27ae60', painting: '#8e44ad', general: '#e67e22', plumbing: '#2980b9', electrical: '#f39c12', custom: '#7f8c8d' };
    
    // Top clients
    const byClient = {};
    perm.forEach(inv => {
        byClient[inv.clientName] = (byClient[inv.clientName] || 0) + inv.amount;
    });
    const topClients = Object.entries(byClient).sort((a, b) => b[1] - a[1]).slice(0, 5);
    const maxClient = topClients.length > 0 ? topClients[0][1] : 1;
    
    // Monthly trend (last 6 months)
    const months = [];
    for (let i = 5; i >= 0; i--) {
        const d = new Date();
        d.setMonth(d.getMonth() - i);
        const key = d.getFullYear() + '-' + String(d.getMonth() + 1).padStart(2, '0');
        const label = d.toLocaleDateString('en-US', { month: 'short', year: '2-digit' });
        const won = perm.filter(inv => inv.awardedDate && inv.awardedDate.startsWith(key)).length;
        const total = all.filter(inv => inv.createdDate && inv.createdDate.startsWith(key)).length;
        months.push({ label, won, total });
    }
    const maxMonth = Math.max(...months.map(m => m.total), 1);
    
    if (!panel) return;
    panel.innerHTML = `
        <div style="margin-bottom:16px">
            <button onclick="invCloseDetail()" style="background:#2a3a5c;color:#bdc3c7;border:none;padding:6px 14px;border-radius:6px;cursor:pointer;font-size:12px;font-weight:600">‚Üê Back to Quote Library</button>
        </div>
        <div class="analytics-grid">
            <div class="analytics-card"><div class="a-value" style="color:#3498db">${winRate}%</div><div class="a-label">Win Rate</div></div>
            <div class="analytics-card"><div class="a-value" style="color:#27ae60">$${totalRevenue.toFixed(0)}</div><div class="a-label">Total Revenue</div></div>
            <div class="analytics-card"><div class="a-value" style="color:#f39c12">$${avgBid.toFixed(0)}</div><div class="a-label">Avg Bid Size</div></div>
            <div class="analytics-card"><div class="a-value" style="color:#27ae60">${wonCount}</div><div class="a-label">Won</div></div>
            <div class="analytics-card"><div class="a-value" style="color:#e74c3c">${lostCount}</div><div class="a-label">Lost</div></div>
            <div class="analytics-card"><div class="a-value" style="color:#f39c12">${pendingCount}</div><div class="a-label">Pending</div></div>
        </div>
        <div class="analytics-chart">
            <h4>Revenue by Trade Type</h4>
            ${Object.entries(byTrade).sort((a,b) => b[1]-a[1]).map(([trade, amt]) => `
                <div class="analytics-bar-row">
                    <div class="analytics-bar-label">${trade.charAt(0).toUpperCase()+trade.slice(1)}</div>
                    <div class="analytics-bar"><div class="analytics-bar-fill" style="width:${(amt/maxTrade*100).toFixed(0)}%;background:${tradeColors[trade]||'#3498db'}"></div></div>
                    <div class="analytics-bar-val">$${amt.toFixed(0)}</div>
                </div>
            `).join('') || '<div style="color:#7f8c8d;font-size:12px;text-align:center;padding:10px">No awarded quotes yet</div>'}
        </div>
        <div class="analytics-chart">
            <h4>Top Clients (by Revenue)</h4>
            ${topClients.map(([name, amt]) => `
                <div class="analytics-bar-row">
                    <div class="analytics-bar-label">${name}</div>
                    <div class="analytics-bar"><div class="analytics-bar-fill" style="width:${(amt/maxClient*100).toFixed(0)}%;background:#3498db"></div></div>
                    <div class="analytics-bar-val">$${amt.toFixed(0)}</div>
                </div>
            `).join('') || '<div style="color:#7f8c8d;font-size:12px;text-align:center;padding:10px">No awarded quotes yet</div>'}
        </div>
        <div class="analytics-chart">
            <h4>Monthly Activity (Last 6 Months)</h4>
            ${months.map(m => `
                <div class="analytics-bar-row">
                    <div class="analytics-bar-label">${m.label}</div>
                    <div class="analytics-bar">
                        <div class="analytics-bar-fill" style="width:${(m.total/maxMonth*100).toFixed(0)}%;background:#2a3a5c"></div>
                    </div>
                    <div class="analytics-bar-val">${m.won}W / ${m.total}T</div>
                </div>
            `).join('')}
        </div>
    `;
}

// =====================================================================
// VERSION HISTORY / REVISION TRACKING
// =====================================================================
function saveQuoteRevision(invoiceId) {
    if (!db || !userPIN) return;
    const hashedPIN = hashPIN(userPIN);
    let invoice = null;
    for (const status in invoiceData) {
        if (invoiceData[status][invoiceId]) {
            invoice = invoiceData[status][invoiceId];
            break;
        }
    }
    if (!invoice) return;
    
    const revKey = 'rev_' + Date.now();
    const revision = {
        ...invoice,
        revisionDate: new Date().toISOString(),
        revisionId: revKey
    };
    
    db.ref('revisions/' + hashedPIN + '/' + invoiceId + '/' + revKey).set(revision);
}

function viewRevisionHistory(invoiceId) {
    if (!db || !userPIN) return;
    const hashedPIN = hashPIN(userPIN);
    
    db.ref('revisions/' + hashedPIN + '/' + invoiceId).once('value').then(snap => {
        const revisions = snap.val() || {};
        const revList = Object.values(revisions).sort((a, b) => new Date(b.revisionDate) - new Date(a.revisionDate));
        
        if (revList.length === 0) {
            alert('No revision history for this quote.');
            return;
        }
        
        let html = '<div style="margin-bottom:16px"><button onclick="invCloseDetail()" style="background:#2a3a5c;color:#bdc3c7;border:none;padding:6px 14px;border-radius:6px;cursor:pointer;font-size:12px;font-weight:600">‚Üê Back</button></div>';
        html += '<h3 style="color:#3498db;font-size:14px;margin-bottom:12px">üìù Revision History (' + revList.length + ' versions)</h3>';
        
        revList.forEach((rev, i) => {
            const date = new Date(rev.revisionDate).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric', hour: '2-digit', minute: '2-digit' });
            html += '<div style="background:#0f1a33;border:1px solid #2a3a5c;border-radius:8px;padding:12px;margin-bottom:8px">';
            html += '<div style="display:flex;justify-content:space-between;align-items:center">';
            html += '<div><span style="color:#3498db;font-weight:700">v' + (revList.length - i) + '</span> <span style="color:#7f8c8d;font-size:12px">' + date + '</span></div>';
            html += '<span style="color:#f39c12;font-size:13px;font-weight:600">$' + rev.amount.toFixed(2) + '</span>';
            html += '</div>';
            html += '<div style="font-size:11px;color:#95a5a6;margin-top:4px">Labor: $' + rev.laborTotal.toFixed(0) + ' | Materials: $' + rev.materialsTotal.toFixed(0) + '</div>';
            html += '</div>';
        });
        
        const panel = document.getElementById('quoteDetailPanel');
        const list = document.getElementById('invoiceList');
        if (panel) { panel.style.display = 'block'; panel.innerHTML = html; }
        if (list) list.style.display = 'none';
    });
}

// =====================================================================
// PDF TEMPLATE UPLOAD SYSTEM
// =====================================================================
let _pdfTemplates = {};
let _tplSelected = null;
let _tplActiveField = null;
let _tplPdfBytes = null;
let _tplPdfDoc = null; // pdf.js doc for rendering
let _tplFieldMappings = {}; // { fieldKey: { x, y, page, width, height } }
const TPL_FIELDS = [
    { key: 'clientName', label: 'Client Name' },
    { key: 'companyName', label: 'Company Name' },
    { key: 'companyPhone', label: 'Company Phone' },
    { key: 'companyEmail', label: 'Company Email' },
    { key: 'companyLicense', label: 'License #' },
    { key: 'complexName', label: 'Property/Complex' },
    { key: 'jobCity', label: 'City' },
    { key: 'unitNum', label: 'Unit #' },
    { key: 'areaDesc', label: 'Area Description' },
    { key: 'sqft', label: 'Sq Ft' },
    { key: 'tradeType', label: 'Trade Type' },
    { key: 'estimateDate', label: 'Estimate Date' },
    { key: 'scopeOfWork', label: 'Scope of Work' },
    { key: 'laborTotal', label: 'Labor Total' },
    { key: 'materialsTotal', label: 'Materials Total' },
    { key: 'grandTotal', label: 'Grand Total' },
    { key: 'lineItems', label: 'Line Items' },
    { key: 'notes', label: 'Notes' },
    { key: 'disclaimer', label: 'Disclaimer' }
];

function openTemplateManager() {
    document.getElementById('tplOverlay').classList.add('show');
    tplRenderList();
}
function closeTplManager() {
    document.getElementById('tplOverlay').classList.remove('show');
}

function tplSwitchTab(tab, el) {
    document.querySelectorAll('.tpl-tab').forEach(t => t.classList.remove('active'));
    el.classList.add('active');
    document.getElementById('tplTabLibrary').style.display = tab === 'library' ? 'block' : 'none';
    document.getElementById('tplTabMapper').style.display = tab === 'mapper' ? 'block' : 'none';
}

// Upload handling
(function initTplUpload() {
    document.addEventListener('DOMContentLoaded', function() {
        var zone = document.getElementById('tplDropZone');
        var inp = document.getElementById('tplFileInput');
        if (!zone || !inp) return;
        zone.addEventListener('click', function() { inp.click(); });
        zone.addEventListener('dragover', function(e) { e.preventDefault(); zone.classList.add('dragover'); });
        zone.addEventListener('dragleave', function() { zone.classList.remove('dragover'); });
        zone.addEventListener('drop', function(e) { e.preventDefault(); zone.classList.remove('dragover'); if (e.dataTransfer.files.length) tplProcessFile(e.dataTransfer.files[0]); });
        inp.addEventListener('change', function() { if (inp.files.length) tplProcessFile(inp.files[0]); inp.value = ''; });
    });
})();

function tplProcessFile(file) {
    if (file.type !== 'application/pdf') { alert('Please upload a PDF file.'); return; }
    if (file.size > 10 * 1024 * 1024) { alert('File too large. Max 10MB.'); return; }
    var reader = new FileReader();
    reader.onload = function(e) {
        var bytes = new Uint8Array(e.target.result);
        var b64 = btoa(String.fromCharCode.apply(null, bytes.length > 65536 ? Array.from(bytes) : bytes));
        // For large files, use chunked btoa
        if (bytes.length > 65536) {
            var binary = '';
            for (var i = 0; i < bytes.length; i++) binary += String.fromCharCode(bytes[i]);
            b64 = btoa(binary);
        }
        var id = 'tpl_' + Date.now();
        var tpl = {
            id: id,
            name: file.name.replace('.pdf', ''),
            fileName: file.name,
            size: file.size,
            uploadDate: new Date().toISOString(),
            pdfBase64: b64,
            type: 'unknown', // will detect fillable vs static
            formFields: [],
            fieldMappings: {}
        };
        // Detect if fillable using pdf-lib
        tplDetectType(tpl, bytes);
    };
    reader.readAsArrayBuffer(file);
}

async function tplDetectType(tpl, bytes) {
    try {
        await tplLoadPdfLib();
        var pdfDoc = await PDFLib.PDFDocument.load(bytes, { ignoreEncryption: true });
        var form = pdfDoc.getForm();
        var fields = form.getFields();
        if (fields.length > 0) {
            tpl.type = 'fillable';
            tpl.formFields = fields.map(function(f) {
                return { name: f.getName(), type: f.constructor.name };
            });
        } else {
            tpl.type = 'static';
        }
    } catch (e) {
        tpl.type = 'static';
    }
    _pdfTemplates[tpl.id] = tpl;
    tplSaveToFirebase();
    tplRenderList();
    showNotification('Template "' + tpl.name + '" uploaded (' + tpl.type + ')');
}

function tplLoadPdfLib() {
    if (typeof PDFLib !== 'undefined') return Promise.resolve();
    return new Promise(function(resolve) {
        var s = document.createElement('script');
        s.src = 'https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js';
        s.onload = resolve;
        document.head.appendChild(s);
    });
}

function tplLoadPdfJs() {
    if (typeof pdfjsLib !== 'undefined') return Promise.resolve();
    return new Promise(function(resolve) {
        var s = document.createElement('script');
        s.src = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js';
        s.onload = function() {
            pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
            resolve();
        };
        document.head.appendChild(s);
    });
}

function tplRenderList() {
    var list = document.getElementById('tplList');
    var keys = Object.keys(_pdfTemplates);
    if (keys.length === 0) {
        list.innerHTML = '<div style="text-align:center;color:#7f8c8d;padding:20px;font-size:13px">No templates uploaded yet. Upload a PDF to get started.</div>';
        return;
    }
    var html = '';
    keys.forEach(function(id) {
        var t = _pdfTemplates[id];
        var sel = _tplSelected === id ? ' selected' : '';
        var typeLabel = t.type === 'fillable' ? 'üìù Fillable (' + (t.formFields||[]).length + ' fields)' : 'üìÑ Static';
        var sizeKB = (t.size / 1024).toFixed(0) + ' KB';
        var mappedCount = Object.keys(t.fieldMappings || {}).length;
        html += '<div class="tpl-card' + sel + '" onclick="tplSelectTemplate(\'' + id + '\')">';
        html += '<div class="tpl-card-icon">' + (t.type === 'fillable' ? 'üìù' : 'üìÑ') + '</div>';
        html += '<div class="tpl-card-info"><div class="tpl-name">' + escHtml(t.name) + '</div>';
        html += '<div class="tpl-meta">' + typeLabel + ' | ' + sizeKB + ' | ' + mappedCount + ' fields mapped</div></div>';
        html += '<div class="tpl-card-actions">';
        html += '<button onclick="event.stopPropagation();tplOpenMapper(\'' + id + '\')">Map Fields</button>';
        html += '<button class="del" onclick="event.stopPropagation();tplDelete(\'' + id + '\')">Delete</button>';
        html += '</div></div>';
    });
    list.innerHTML = html;
}

function tplSelectTemplate(id) {
    _tplSelected = id;
    tplRenderList();
}

function tplDelete(id) {
    if (!confirm('Delete this template?')) return;
    delete _pdfTemplates[id];
    if (_tplSelected === id) _tplSelected = null;
    tplSaveToFirebase();
    tplRenderList();
}

async function tplOpenMapper(id) {
    var tpl = _pdfTemplates[id];
    if (!tpl) return;
    _tplSelected = id;
    _tplFieldMappings = JSON.parse(JSON.stringify(tpl.fieldMappings || {}));
    
    // Switch to mapper tab
    document.querySelectorAll('.tpl-tab').forEach(function(t) { t.classList.remove('active'); });
    document.querySelectorAll('.tpl-tab')[1].classList.add('active');
    document.getElementById('tplTabLibrary').style.display = 'none';
    document.getElementById('tplTabMapper').style.display = 'block';
    document.getElementById('tplMapperEmpty').style.display = 'none';
    document.getElementById('tplMapperContent').style.display = 'block';
    
    // Render field buttons
    var bar = document.getElementById('tplFieldBar');
    var html = '';
    if (tpl.type === 'fillable') {
        // For fillable PDFs, show the actual form field names
        (tpl.formFields || []).forEach(function(f) {
            var mapped = _tplFieldMappings[f.name] ? ' placed' : '';
            html += '<button class="tpl-field-btn' + mapped + '" data-field="' + f.name + '" onclick="tplPickFormField(this,\'' + escHtml(f.name) + '\')">' + escHtml(f.name) + '</button>';
        });
        bar.innerHTML = html || '<span style="color:#7f8c8d;font-size:12px">No form fields detected.</span>';
        // Show form field mapping UI
        tplRenderFillableMapper(tpl);
    } else {
        // For static PDFs, show our standard fields for visual placement
        TPL_FIELDS.forEach(function(f) {
            var mapped = _tplFieldMappings[f.key] ? ' placed' : '';
            html += '<button class="tpl-field-btn' + mapped + '" data-field="' + f.key + '" onclick="tplPickField(this,\'' + f.key + '\')">' + f.label + '</button>';
        });
        bar.innerHTML = html;
        // Render PDF preview for click-to-place
        await tplRenderPreview(tpl);
    }
}

function tplPickField(btn, key) {
    document.querySelectorAll('.tpl-field-btn').forEach(function(b) { b.style.outline = ''; });
    btn.style.outline = '2px solid #e74c3c';
    _tplActiveField = key;
}

function tplPickFormField(btn, fieldName) {
    // For fillable PDFs, map form field to a bid data key
    var options = TPL_FIELDS.map(function(f) { return f.key + ' = ' + f.label; }).join('\n');
    var choice = prompt('Map form field "' + fieldName + '" to which bid data?\n\nOptions:\n' + options + '\n\nType the key (e.g. clientName):');
    if (choice && TPL_FIELDS.some(function(f) { return f.key === choice.trim(); })) {
        _tplFieldMappings[fieldName] = { bidKey: choice.trim() };
        btn.classList.add('placed');
        showNotification('Mapped "' + fieldName + '" to ' + choice.trim());
    }
}

async function tplRenderPreview(tpl) {
    await tplLoadPdfJs();
    var binary = atob(tpl.pdfBase64);
    var bytes = new Uint8Array(binary.length);
    for (var i = 0; i < binary.length; i++) bytes[i] = binary.charCodeAt(i);
    
    var pdf = await pdfjsLib.getDocument({ data: bytes }).promise;
    var page = await pdf.getPage(1);
    var viewport = page.getViewport({ scale: 1.5 });
    var canvas = document.getElementById('tplCanvas');
    var ctx = canvas.getContext('2d');
    canvas.width = viewport.width;
    canvas.height = viewport.height;
    
    await page.render({ canvasContext: ctx, viewport: viewport }).promise;
    _tplPdfDoc = pdf;
    
    // Remove old markers
    var wrap = document.getElementById('tplPreviewWrap');
    wrap.querySelectorAll('.tpl-field-marker').forEach(function(m) { m.remove(); });
    
    // Restore existing mappings as markers
    Object.keys(_tplFieldMappings).forEach(function(key) {
        var m = _tplFieldMappings[key];
        if (m.x !== undefined) tplAddMarker(key, m.x, m.y, wrap);
    });
    
    // Click to place
    canvas.onclick = function(e) {
        if (!_tplActiveField) { alert('Click a field button first, then click on the PDF.'); return; }
        var rect = canvas.getBoundingClientRect();
        var scaleX = canvas.width / rect.width;
        var scaleY = canvas.height / rect.height;
        var x = (e.clientX - rect.left) / rect.width * 100; // percentage
        var y = (e.clientY - rect.top) / rect.height * 100;
        var pxX = (e.clientX - rect.left) * scaleX;
        var pxY = (e.clientY - rect.top) * scaleY;
        
        _tplFieldMappings[_tplActiveField] = { x: x, y: y, pxX: pxX, pxY: pxY, page: 0 };
        tplAddMarker(_tplActiveField, x, y, wrap);
        
        // Mark button as placed
        var btn = document.querySelector('.tpl-field-btn[data-field="' + _tplActiveField + '"]');
        if (btn) btn.classList.add('placed');
        _tplActiveField = null;
        document.querySelectorAll('.tpl-field-btn').forEach(function(b) { b.style.outline = ''; });
    };
}

function tplAddMarker(key, x, y, wrap) {
    // Remove existing marker for this key
    var old = wrap.querySelector('.tpl-field-marker[data-key="' + key + '"]');
    if (old) old.remove();
    
    var label = key;
    TPL_FIELDS.forEach(function(f) { if (f.key === key) label = f.label; });
    
    var marker = document.createElement('div');
    marker.className = 'tpl-field-marker';
    marker.setAttribute('data-key', key);
    marker.style.left = x + '%';
    marker.style.top = y + '%';
    marker.textContent = label;
    marker.ondblclick = function() {
        delete _tplFieldMappings[key];
        marker.remove();
        var btn = document.querySelector('.tpl-field-btn[data-field="' + key + '"]');
        if (btn) btn.classList.remove('placed');
    };
    wrap.appendChild(marker);
}

function tplRenderFillableMapper(tpl) {
    var wrap = document.getElementById('tplPreviewWrap');
    wrap.innerHTML = '<div style="padding:20px;text-align:center;color:#bdc3c7;font-size:13px">' +
        '<p style="font-size:16px;margin-bottom:12px">üìù Fillable PDF Detected</p>' +
        '<p>This PDF has <strong>' + (tpl.formFields||[]).length + '</strong> form fields.</p>' +
        '<p style="margin-top:8px;color:#7f8c8d">Click each field button above and type the bid data key to map it.<br>When you generate, the form fields will be auto-filled.</p>' +
        '<div style="margin-top:16px;text-align:left;background:#0f1a33;border-radius:8px;padding:14px">' +
        '<div style="font-size:11px;color:#7f8c8d;text-transform:uppercase;margin-bottom:8px">Detected Form Fields:</div>' +
        (tpl.formFields||[]).map(function(f) {
            var mapped = _tplFieldMappings[f.name];
            var mapLabel = mapped ? ' ‚Üí <span style="color:#27ae60">' + mapped.bidKey + '</span>' : ' <span style="color:#e74c3c">(unmapped)</span>';
            return '<div style="font-size:12px;color:#bdc3c7;padding:4px 0;border-bottom:1px solid #1a2744">' + escHtml(f.name) + ' <span style="color:#7f8c8d">(' + f.type + ')</span>' + mapLabel + '</div>';
        }).join('') +
        '</div></div>';
}

function tplSaveMappings() {
    if (!_tplSelected || !_pdfTemplates[_tplSelected]) return;
    _pdfTemplates[_tplSelected].fieldMappings = JSON.parse(JSON.stringify(_tplFieldMappings));
    tplSaveToFirebase();
    showNotification('Field mappings saved!');
    tplRenderList();
}

function tplClearMappings() {
    _tplFieldMappings = {};
    if (_tplSelected && _pdfTemplates[_tplSelected]) {
        _pdfTemplates[_tplSelected].fieldMappings = {};
        tplSaveToFirebase();
    }
    var wrap = document.getElementById('tplPreviewWrap');
    wrap.querySelectorAll('.tpl-field-marker').forEach(function(m) { m.remove(); });
    document.querySelectorAll('.tpl-field-btn').forEach(function(b) { b.classList.remove('placed'); });
    showNotification('Mappings cleared');
}

// Gather current bid form data
function tplGetBidData() {
    var gv = function(id) { var el = document.getElementById(id); return el ? el.value.trim() : ''; };
    var items = [];
    document.querySelectorAll('.li-row').forEach(function(row) {
        var inputs = row.querySelectorAll('input');
        if (inputs.length >= 3 && inputs[0].value.trim()) {
            items.push(inputs[0].value.trim() + ' | ' + inputs[1].value.trim() + ' | $' + inputs[2].value.trim());
        }
    });
    document.querySelectorAll('.mi-row').forEach(function(row) {
        var inputs = row.querySelectorAll('input');
        if (inputs.length >= 3 && inputs[0].value.trim()) {
            items.push(inputs[0].value.trim() + ' x' + inputs[1].value.trim() + ' | $' + inputs[2].value.trim());
        }
    });
    var notes = [];
    document.querySelectorAll('.note-row input, .note-row textarea').forEach(function(el) {
        if (el.value.trim()) notes.push(el.value.trim());
    });
    
    // Calculate totals
    var sq = parseFloat(gv('sqft')) || 1;
    var labTot = 0;
    document.querySelectorAll('.li-row').forEach(function(row) {
        var inputs = row.querySelectorAll('input');
        if (inputs.length >= 3) {
            var price = parseFloat(inputs[2].value) || 0;
            var basis = inputs[1].value.toLowerCase();
            labTot += basis.indexOf('sq ft') !== -1 ? price * sq : price;
        }
    });
    var matSub = 0;
    document.querySelectorAll('.mi-row').forEach(function(row) {
        var inputs = row.querySelectorAll('input');
        if (inputs.length >= 3) {
            matSub += (parseFloat(inputs[1].value) || 1) * (parseFloat(inputs[2].value) || 0);
        }
    });
    var markup = parseFloat(gv('materialsMarkup')) || 0;
    var matTotal = matSub * (1 + markup / 100);
    
    return {
        clientName: gv('clientName'),
        companyName: gv('companyName'),
        companyPhone: gv('phone'),
        companyEmail: gv('email'),
        companyLicense: gv('licenseNum'),
        complexName: gv('complexName'),
        jobCity: gv('jobCity'),
        unitNum: gv('unitNum'),
        areaDesc: gv('areaDesc'),
        sqft: gv('sqft'),
        tradeType: gv('tradeType'),
        estimateDate: gv('estimateDate') || new Date().toLocaleDateString(),
        scopeOfWork: (function() { var el = document.getElementById('scopeSelect'); return el ? el.options[el.selectedIndex].text : ''; })(),
        laborTotal: '$' + labTot.toFixed(2),
        materialsTotal: '$' + matTotal.toFixed(2),
        grandTotal: '$' + (labTot + matTotal).toFixed(2),
        lineItems: items.join('\n'),
        notes: notes.join('\n'),
        disclaimer: gv('disclaimer')
    };
}

async function tplGenerateFilled() {
    if (!_tplSelected || !_pdfTemplates[_tplSelected]) {
        alert('Select a template first.');
        return;
    }
    var tpl = _pdfTemplates[_tplSelected];
    var bidData = tplGetBidData();
    
    await tplLoadPdfLib();
    
    var binary = atob(tpl.pdfBase64);
    var bytes = new Uint8Array(binary.length);
    for (var i = 0; i < binary.length; i++) bytes[i] = binary.charCodeAt(i);
    
    try {
        var pdfDoc = await PDFLib.PDFDocument.load(bytes, { ignoreEncryption: true });
        
        if (tpl.type === 'fillable') {
            // Fill form fields
            var form = pdfDoc.getForm();
            Object.keys(tpl.fieldMappings || {}).forEach(function(formFieldName) {
                var mapping = tpl.fieldMappings[formFieldName];
                var value = bidData[mapping.bidKey] || '';
                try {
                    var field = form.getTextField(formFieldName);
                    field.setText(String(value));
                } catch (e) {
                    console.warn('Could not fill field:', formFieldName, e);
                }
            });
            try { form.flatten(); } catch(e) {}
        } else {
            // Static PDF: overlay text at mapped coordinates
            var pages = pdfDoc.getPages();
            var font = await pdfDoc.embedFont(PDFLib.StandardFonts.Helvetica);
            var fontSize = 10;
            
            Object.keys(tpl.fieldMappings || {}).forEach(function(key) {
                var m = tpl.fieldMappings[key];
                if (m.x === undefined) return;
                var value = bidData[key] || '';
                if (!value) return;
                
                var pageIdx = m.page || 0;
                if (pageIdx >= pages.length) return;
                var page = pages[pageIdx];
                var pw = page.getWidth();
                var ph = page.getHeight();
                
                // Convert percentage coords to PDF coords (PDF origin is bottom-left)
                var pdfX = (m.x / 100) * pw;
                var pdfY = ph - ((m.y / 100) * ph);
                
                // Handle multi-line for lineItems
                if (key === 'lineItems' || key === 'notes' || key === 'scopeOfWork') {
                    var lines = value.split('\n');
                    lines.forEach(function(line, li) {
                        page.drawText(line, { x: pdfX, y: pdfY - (li * (fontSize + 2)), size: fontSize, font: font, color: PDFLib.rgb(0, 0, 0) });
                    });
                } else {
                    page.drawText(String(value), { x: pdfX, y: pdfY, size: fontSize, font: font, color: PDFLib.rgb(0, 0, 0) });
                }
            });
        }
        
        var filledBytes = await pdfDoc.save();
        var blob = new Blob([filledBytes], { type: 'application/pdf' });
        var url = URL.createObjectURL(blob);
        var a = document.createElement('a');
        a.href = url;
        a.download = (bidData.clientName || 'Quote') + '_' + tpl.name + '_' + new Date().toISOString().slice(0, 10) + '.pdf';
        a.click();
        URL.revokeObjectURL(url);
        showNotification('Filled PDF downloaded!');
    } catch (e) {
        console.error('PDF fill error:', e);
        alert('Error filling PDF: ' + e.message);
    }
}

// Firebase persistence for templates
function tplSaveToFirebase() {
    if (!db || !userPIN) return;
    var hashedPIN = hashPIN(userPIN);
    // Save without pdfBase64 to Firebase (too large), use localStorage for PDF data
    var meta = {};
    Object.keys(_pdfTemplates).forEach(function(id) {
        var t = _pdfTemplates[id];
        meta[id] = {
            id: t.id, name: t.name, fileName: t.fileName, size: t.size,
            uploadDate: t.uploadDate, type: t.type, formFields: t.formFields || [],
            fieldMappings: t.fieldMappings || {}
        };
        // Store PDF bytes in localStorage
        try { localStorage.setItem('tpl_pdf_' + id, t.pdfBase64); } catch(e) { console.warn('localStorage full for template PDF'); }
    });
    db.ref('templates/' + hashedPIN).set(meta);
}

function tplLoadFromFirebase() {
    if (!db || !userPIN) return;
    var hashedPIN = hashPIN(userPIN);
    db.ref('templates/' + hashedPIN).once('value').then(function(snap) {
        var data = snap.val() || {};
        Object.keys(data).forEach(function(id) {
            var t = data[id];
            t.pdfBase64 = localStorage.getItem('tpl_pdf_' + id) || '';
            _pdfTemplates[id] = t;
        });
        tplRenderList();
    });
}

// =====================================================================
// INVOICE MANAGEMENT SYSTEM
// =====================================================================

let invoiceData = {
    temporary: {},
    permanent: {},
    lost: {}
};
let currentInvoiceTab = 'all';

// Initialize invoice system
function initInvoiceSystem() {
    loadInvoicesFromFirebase();
    invRenderList();
    updateInvoiceStats();
    renderWidgetBanner();
    
    // Check for expired invoices every hour
    setInterval(checkExpiredInvoices, 3600000);
    
    // Update widget banner every minute
    setInterval(renderWidgetBanner, 60000);
    
    // Check for expiring quote notifications every 5 minutes
    setTimeout(checkAndNotifyExpiring, 5000);
    setInterval(checkAndNotifyExpiring, 300000);
}

// Toggle widget collapse/expand
function toggleInvoiceWidget() {
    const body = document.getElementById('widgetBody');
    const toggle = document.getElementById('widgetToggle');
    
    if (body.classList.contains('collapsed')) {
        body.classList.remove('collapsed');
        toggle.textContent = '‚àí';
    } else {
        body.classList.add('collapsed');
        toggle.textContent = '+';
    }
}

// Open invoice modal
function openInvoiceModal() {
    document.getElementById('invoiceModal').classList.add('show');
    invRenderList();
}

// Close invoice modal
function closeInvoiceModal() {
    document.getElementById('invoiceModal').classList.remove('show');
}

// Render widget banner with urgent invoices
function renderWidgetBanner() {
    const widgetBody = document.getElementById('widgetBody');
    const now = new Date();
    
    // Get temporary invoices sorted by urgency
    const tempInvoices = Object.values(invoiceData.temporary).map(inv => {
        const expiresDate = new Date(inv.expiresDate);
        const daysLeft = Math.ceil((expiresDate - now) / (1000 * 60 * 60 * 24));
        return { ...inv, daysLeft };
    }).sort((a, b) => a.daysLeft - b.daysLeft);
    
    if (tempInvoices.length === 0) {
        widgetBody.innerHTML = '<div class="invoice-widget-empty">No pending invoices</div>';
        return;
    }
    
    // Show top 5 most urgent
    const urgentInvoices = tempInvoices.slice(0, 5);
    
    widgetBody.innerHTML = urgentInvoices.map(inv => {
        let urgencyClass = '';
        let timerClass = 'safe';
        
        if (inv.daysLeft <= 0) {
            urgencyClass = 'urgent';
            timerClass = 'urgent';
        } else if (inv.daysLeft <= 5) {
            urgencyClass = 'urgent';
            timerClass = 'urgent';
        } else if (inv.daysLeft <= 10) {
            urgencyClass = 'warning';
            timerClass = 'warning';
        }
        
        const dateEntered = new Date(inv.createdDate).toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
        const timerText = inv.daysLeft <= 0 ? 'EXPIRED' : `${inv.daysLeft}d left`;
        
        return `
            <div class="invoice-banner-item ${urgencyClass}" onclick="invViewDetails('${inv.id}')">
                <div class="invoice-banner-client">${inv.clientName}</div>
                <div class="invoice-banner-meta">
                    <div class="invoice-banner-date">üìÖ ${dateEntered}</div>
                    <div class="invoice-banner-timer ${timerClass}">‚è±Ô∏è ${timerText}</div>
                </div>
            </div>
        `;
    }).join('');
}

// Auto-save invoice when generating documents
function autoSaveInvoice(type) {
    const invoiceId = 'inv_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
    const clientName = gv('clientName') || 'Unknown Client';
    const estimateDate = gv('estimateDate') || new Date().toISOString().split('T')[0];
    
    // Calculate total
    const sq = gn('sqft');
    const litems = getLaborItems();
    let laborTotal = 0;
    litems.forEach(i => {
        laborTotal += (i.basis.toLowerCase().indexOf('sq ft') !== -1) ? i.price * sq : i.price;
    });
    
    const mitems = getMatItems();
    let matSubtotal = 0;
    mitems.forEach(i => {
        matSubtotal += (parseFloat(i.qty) || 1) * i.price;
    });
    
    const markup = gn('materialsMarkup') / 100;
    const matTotal = matSubtotal + (matSubtotal * markup);
    const grandTotal = laborTotal + matTotal;
    
    const invoice = {
        id: invoiceId,
        type: type,
        status: 'temporary',
        clientName: clientName,
        estimateDate: estimateDate,
        createdDate: new Date().toISOString(),
        expiresDate: new Date(Date.now() + 21 * 24 * 60 * 60 * 1000).toISOString(),
        amount: grandTotal,
        laborTotal: laborTotal,
        materialsTotal: matTotal,
        jobDetails: {
            complexName: gv('complexName'),
            unitNum: gv('unitNum'),
            jobCity: gv('jobCity'),
            sqft: sq,
            areaDesc: gv('areaDesc'),
            tradeType: gv('tradeType')
        },
        companyInfo: {
            companyName: gv('companyName'),
            licenseNum: gv('licenseNum'),
            phone: gv('phone'),
            email: gv('email')
        }
    };
    
    // Save to temporary storage
    invoiceData.temporary[invoiceId] = invoice;
    
    // Save to Firebase
    saveInvoiceToFirebase(invoice);
    
    // Update UI
    invRenderList();
    updateInvoiceStats();
    renderWidgetBanner();
    
    // Show notification
    showNotification('üìã Invoice saved as Pending (21-day expiration)', 'success');
    
    return invoiceId;
}

// Save invoice to Firebase
function saveInvoiceToFirebase(invoice) {
    if (!db || !userPIN) return;
    
    const hashedPIN = hashPIN(userPIN);
    const path = `invoices/${hashedPIN}/${invoice.status}/${invoice.id}`;
    
    db.ref(path).set(invoice)
        .then(() => {
            console.log('‚úÖ Invoice synced to Firebase:', invoice.id);
            saveQuoteRevision(invoice.id);
        })
        .catch(error => {
            console.error('‚ùå Firebase sync failed:', error);
            // Fallback to localStorage
            localStorage.setItem('invoices_' + invoice.status, JSON.stringify(invoiceData[invoice.status]));
        });
}

// Load invoices from Firebase
function loadInvoicesFromFirebase() {
    if (!db || !userPIN) {
        // Load from localStorage as fallback
        ['temporary', 'permanent', 'lost'].forEach(status => {
            const stored = localStorage.getItem('invoices_' + status);
            if (stored) {
                try {
                    invoiceData[status] = JSON.parse(stored);
                } catch (e) {
                    invoiceData[status] = {};
                }
            }
        });
        return;
    }
    
    const hashedPIN = hashPIN(userPIN);
    
    ['temporary', 'permanent', 'lost'].forEach(status => {
        db.ref(`invoices/${hashedPIN}/${status}`).once('value')
            .then(snapshot => {
                if (snapshot.exists()) {
                    invoiceData[status] = snapshot.val() || {};
                    invRenderList();
                    updateInvoiceStats();
                    renderWidgetBanner();
                }
            })
            .catch(error => {
                console.error('Error loading invoices:', error);
            });
    });
}

// Switch invoice tab
function invSwitchTab(tab) {
    currentInvoiceTab = tab;
    
    // Update tab buttons
    document.querySelectorAll('.invoice-tab').forEach(btn => {
        btn.classList.remove('active');
    });
    event.target.classList.add('active');
    
    invRenderList();
}

// Render invoice list
function invRenderList() {
    const listEl = document.getElementById('invoiceList');
    if (!listEl) return;
    const searchEl = document.getElementById('invSearchClient');
    const sortEl = document.getElementById('invSortBy');
    const filterEl = document.getElementById('invFilterClient');
    const searchTerm = searchEl ? searchEl.value.toLowerCase() : '';
    const sortBy = sortEl ? sortEl.value : 'expires-asc';
    const filterClient = filterEl ? filterEl.value : '';
    
    // Collect all invoices based on current tab
    let invoices = [];
    
    if (currentInvoiceTab === 'all') {
        invoices = [
            ...Object.values(invoiceData.temporary),
            ...Object.values(invoiceData.permanent),
            ...Object.values(invoiceData.lost)
        ];
    } else {
        invoices = Object.values(invoiceData[currentInvoiceTab] || {});
    }
    
    // Filter by search term
    if (searchTerm) {
        invoices = invoices.filter(inv => 
            inv.clientName.toLowerCase().includes(searchTerm)
        );
    }
    
    // Filter by client
    if (filterClient) {
        invoices = invoices.filter(inv => inv.clientName === filterClient);
    }
    
    // Sort invoices
    invoices.sort((a, b) => {
        switch (sortBy) {
            case 'date-desc':
                return new Date(b.createdDate) - new Date(a.createdDate);
            case 'date-asc':
                return new Date(a.createdDate) - new Date(b.createdDate);
            case 'client-asc':
                return a.clientName.localeCompare(b.clientName);
            case 'client-desc':
                return b.clientName.localeCompare(a.clientName);
            case 'amount-desc':
                return b.amount - a.amount;
            case 'amount-asc':
                return a.amount - b.amount;
            case 'expires-asc':
                if (a.status === 'temporary' && b.status === 'temporary') {
                    return new Date(a.expiresDate) - new Date(b.expiresDate);
                }
                return 0;
            default:
                return 0;
        }
    });
    
    // Update client filter dropdown
    updateClientFilter();
    
    // Render invoices
    if (invoices.length === 0) {
        listEl.innerHTML = '<div class="invoice-empty">No invoices found.</div>';
        return;
    }
    
    listEl.innerHTML = invoices.map(inv => renderInvoiceItem(inv)).join('');
}

// Render single invoice item as a summary index card
function renderInvoiceItem(invoice) {
    const now = new Date();
    const expiresDate = new Date(invoice.expiresDate);
    const daysLeft = Math.ceil((expiresDate - now) / (1000 * 60 * 60 * 24));
    const isExpired = daysLeft <= 0 && invoice.status === 'temporary';
    const isUrgent = daysLeft <= 5 && daysLeft > 0 && invoice.status === 'temporary';
    
    let statusBadge = '';
    if (invoice.status === 'temporary') {
        statusBadge = '<span class="invoice-status temp">PENDING</span>';
    } else if (invoice.status === 'permanent') {
        statusBadge = '<span class="invoice-status perm">AWARDED</span>';
    } else if (invoice.status === 'lost') {
        statusBadge = '<span class="invoice-status lost">LOST</span>';
    }
    
    // Build short summary line
    const trade = (invoice.jobDetails.tradeType || 'general').charAt(0).toUpperCase() + (invoice.jobDetails.tradeType || 'general').slice(1);
    const loc = invoice.jobDetails.jobCity || '';
    const prop = invoice.jobDetails.complexName || '';
    const unit = invoice.jobDetails.unitNum || '';
    const area = invoice.jobDetails.areaDesc || '';
    let summary = trade;
    if (prop) summary += ' ‚Äî ' + prop;
    if (unit) summary += ', ' + unit;
    if (area) summary += ' (' + area + ')';
    if (loc && !summary.includes(loc)) summary += ' ‚Äî ' + loc;
    
    const dateCreated = new Date(invoice.createdDate).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
    const dateEstimate = new Date(invoice.estimateDate).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
    
    let timerHTML = '';
    if (invoice.status === 'temporary') {
        const timerClass = isUrgent || isExpired ? 'urgent' : '';
        timerHTML = `<span class="invoice-timer ${timerClass}" style="margin-left:auto">‚è±Ô∏è ${daysLeft > 0 ? daysLeft + 'd left' : 'EXPIRED'}</span>`;
    }
    if (invoice.status === 'permanent' && invoice.awardedDate) {
        timerHTML = `<span style="color:#27ae60;font-size:11px;margin-left:auto">Awarded ${new Date(invoice.awardedDate).toLocaleDateString('en-US',{month:'short',day:'numeric'})}</span>`;
    }
    
    const itemClass = `invoice-item ${invoice.status} ${isExpired ? 'expired' : ''}`;
    
    return `
        <div class="${itemClass}" style="cursor:pointer" onclick="invViewDetails('${invoice.id}')">
            <div class="invoice-header">
                <div class="invoice-client">${invoice.clientName}</div>
                ${statusBadge}
            </div>
            <div style="font-size:12px;color:#95a5a6;margin-bottom:6px;line-height:1.4">${summary}</div>
            <div class="invoice-details">
                <span>üìÖ ${dateEstimate}</span>
                <span>üí∞ $${invoice.amount.toFixed(2)}</span>
                <span>Labor: $${invoice.laborTotal.toFixed(0)} / Mat: $${invoice.materialsTotal.toFixed(0)}</span>
                ${timerHTML}
            </div>
            <div class="invoice-actions" onclick="event.stopPropagation()">
                ${invoice.status === 'temporary' ? `
                    <button class="invoice-btn award" onclick="invMarkAsAwarded('${invoice.id}')">‚úÖ Award</button>
                    <button class="invoice-btn lost" onclick="invMarkAsLost('${invoice.id}')">‚ùå Lost</button>
                ` : ''}
                <button class="invoice-btn delete" onclick="invDeleteInvoice('${invoice.id}', '${invoice.status}')">üóëÔ∏è</button>
            </div>
        </div>
    `;
}

// Mark invoice as awarded
function invMarkAsAwarded(invoiceId) {
    const invoice = invoiceData.temporary[invoiceId];
    if (!invoice) return;
    
    // Move to permanent storage
    invoice.status = 'permanent';
    invoice.awardedDate = new Date().toISOString();
    delete invoice.expiresDate;
    
    invoiceData.permanent[invoiceId] = invoice;
    delete invoiceData.temporary[invoiceId];
    
    // Delete from temporary Firebase path
    if (db && userPIN) {
        const hashedPIN = hashPIN(userPIN);
        db.ref(`invoices/${hashedPIN}/temporary/${invoiceId}`).remove();
    }
    
    // Save to permanent Firebase path
    saveInvoiceToFirebase(invoice);
    
    // Update UI
    invRenderList();
    updateInvoiceStats();
    renderWidgetBanner();
    
    showNotification('‚úÖ Invoice marked as Awarded and moved to permanent storage!', 'success');
}

// Mark invoice as lost
function invMarkAsLost(invoiceId) {
    const invoice = invoiceData.temporary[invoiceId];
    if (!invoice) return;
    
    if (!confirm('Mark this invoice as Lost? It will be archived.')) return;
    
    // Move to lost storage
    invoice.status = 'lost';
    invoice.lostDate = new Date().toISOString();
    
    invoiceData.lost[invoiceId] = invoice;
    delete invoiceData.temporary[invoiceId];
    
    // Delete from temporary Firebase path
    if (db && userPIN) {
        const hashedPIN = hashPIN(userPIN);
        db.ref(`invoices/${hashedPIN}/temporary/${invoiceId}`).remove();
    }
    
    // Save to lost Firebase path
    saveInvoiceToFirebase(invoice);
    
    // Update UI
    invRenderList();
    updateInvoiceStats();
    renderWidgetBanner();
    
    showNotification('Invoice marked as Lost and archived.', 'info');
}

// Delete invoice
function invDeleteInvoice(invoiceId, status) {
    if (!confirm('Permanently delete this invoice? This cannot be undone.')) return;
    
    delete invoiceData[status][invoiceId];
    
    // Delete from Firebase
    if (db && userPIN) {
        const hashedPIN = hashPIN(userPIN);
        db.ref(`invoices/${hashedPIN}/${status}/${invoiceId}`).remove();
    }
    
    // Update localStorage
    localStorage.setItem('invoices_' + status, JSON.stringify(invoiceData[status]));
    
    // Update UI
    invRenderList();
    updateInvoiceStats();
    renderWidgetBanner();
    
    showNotification('Invoice deleted.', 'info');
}

// View invoice details ‚Äî rich inline panel
function invViewDetails(invoiceId) {
    let invoice = null;
    for (const status in invoiceData) {
        if (invoiceData[status][invoiceId]) {
            invoice = invoiceData[status][invoiceId];
            break;
        }
    }
    if (!invoice) return;
    
    const panel = document.getElementById('quoteDetailPanel');
    const list = document.getElementById('invoiceList');
    if (!panel) return;
    
    // Hide list, show detail
    if (list) list.style.display = 'none';
    panel.style.display = 'block';
    
    const statusLabel = invoice.status === 'temporary' ? 'PENDING' : invoice.status === 'permanent' ? 'AWARDED' : 'LOST';
    const statusColor = invoice.status === 'temporary' ? '#f39c12' : invoice.status === 'permanent' ? '#27ae60' : '#e74c3c';
    
    let statusLine = '';
    if (invoice.status === 'temporary' && invoice.expiresDate) {
        const dl = Math.ceil((new Date(invoice.expiresDate) - new Date()) / 86400000);
        statusLine = `<span style="color:${dl<=5?'#e74c3c':'#f39c12'}">‚è±Ô∏è ${dl > 0 ? dl + ' days until expiration' : 'EXPIRED'}</span>`;
    }
    if (invoice.status === 'permanent' && invoice.awardedDate) {
        statusLine = `<span style="color:#27ae60">Awarded on ${new Date(invoice.awardedDate).toLocaleDateString()}</span>`;
    }
    if (invoice.status === 'lost' && invoice.lostDate) {
        statusLine = `<span style="color:#e74c3c">Lost on ${new Date(invoice.lostDate).toLocaleDateString()}</span>`;
    }
    
    panel.innerHTML = `
        <div style="margin-bottom:16px">
            <button onclick="invCloseDetail()" style="background:#2a3a5c;color:#bdc3c7;border:none;padding:6px 14px;border-radius:6px;cursor:pointer;font-size:12px;font-weight:600">‚Üê Back to Quote Library</button>
        </div>
        <div style="background:#0f1a33;border:1px solid #2a3a5c;border-radius:10px;padding:20px">
            <div style="display:flex;justify-content:space-between;align-items:start;margin-bottom:16px">
                <div>
                    <div style="font-size:20px;font-weight:700;color:#ecf0f1">${invoice.clientName}</div>
                    <div style="font-size:12px;color:#7f8c8d;margin-top:4px">${statusLine}</div>
                </div>
                <span style="background:${statusColor};color:${invoice.status==='temporary'?'#1a1a1a':'white'};padding:4px 12px;border-radius:12px;font-size:11px;font-weight:700">${statusLabel}</span>
            </div>
            
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:16px">
                <div style="background:#16213e;border:1px solid #2a3a5c;border-radius:8px;padding:12px">
                    <div style="font-size:10px;color:#7f8c8d;text-transform:uppercase;margin-bottom:4px">Estimate Date</div>
                    <div style="font-size:14px;color:#ecf0f1">${new Date(invoice.estimateDate).toLocaleDateString()}</div>
                </div>
                <div style="background:#16213e;border:1px solid #2a3a5c;border-radius:8px;padding:12px">
                    <div style="font-size:10px;color:#7f8c8d;text-transform:uppercase;margin-bottom:4px">Created</div>
                    <div style="font-size:14px;color:#ecf0f1">${new Date(invoice.createdDate).toLocaleDateString()}</div>
                </div>
                <div style="background:#16213e;border:1px solid #2a3a5c;border-radius:8px;padding:12px">
                    <div style="font-size:10px;color:#7f8c8d;text-transform:uppercase;margin-bottom:4px">Trade Type</div>
                    <div style="font-size:14px;color:#ecf0f1">${(invoice.jobDetails.tradeType||'N/A').charAt(0).toUpperCase()+(invoice.jobDetails.tradeType||'').slice(1)}</div>
                </div>
                <div style="background:#16213e;border:1px solid #2a3a5c;border-radius:8px;padding:12px">
                    <div style="font-size:10px;color:#7f8c8d;text-transform:uppercase;margin-bottom:4px">Document Type</div>
                    <div style="font-size:14px;color:#ecf0f1">${(invoice.type||'labor').replace('_',' ').charAt(0).toUpperCase()+(invoice.type||'labor').replace('_',' ').slice(1)}</div>
                </div>
            </div>
            
            <div style="background:#16213e;border:1px solid #2a3a5c;border-radius:8px;padding:12px;margin-bottom:16px">
                <div style="font-size:10px;color:#7f8c8d;text-transform:uppercase;margin-bottom:8px">Job Location</div>
                <div style="font-size:14px;color:#ecf0f1">
                    ${invoice.jobDetails.complexName ? '<strong>'+invoice.jobDetails.complexName+'</strong>' : ''}
                    ${invoice.jobDetails.unitNum ? ' ‚Äî '+invoice.jobDetails.unitNum : ''}
                    ${invoice.jobDetails.jobCity ? '<br>'+invoice.jobDetails.jobCity : ''}
                    ${invoice.jobDetails.areaDesc ? '<br><span style="color:#7f8c8d;font-size:12px">'+invoice.jobDetails.areaDesc+'</span>' : ''}
                    ${invoice.jobDetails.sqft ? '<br><span style="color:#7f8c8d;font-size:12px">'+invoice.jobDetails.sqft+' sq ft</span>' : ''}
                </div>
            </div>
            
            <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px;margin-bottom:16px">
                <div style="background:#16213e;border:1px solid #2a3a5c;border-radius:8px;padding:12px;text-align:center">
                    <div style="font-size:10px;color:#7f8c8d;text-transform:uppercase;margin-bottom:4px">Labor</div>
                    <div style="font-size:18px;font-weight:700;color:#3498db">$${invoice.laborTotal.toFixed(2)}</div>
                </div>
                <div style="background:#16213e;border:1px solid #2a3a5c;border-radius:8px;padding:12px;text-align:center">
                    <div style="font-size:10px;color:#7f8c8d;text-transform:uppercase;margin-bottom:4px">Materials</div>
                    <div style="font-size:18px;font-weight:700;color:#27ae60">$${invoice.materialsTotal.toFixed(2)}</div>
                </div>
                <div style="background:#16213e;border:1px solid #2a3a5c;border-radius:8px;padding:12px;text-align:center">
                    <div style="font-size:10px;color:#7f8c8d;text-transform:uppercase;margin-bottom:4px">Total</div>
                    <div style="font-size:18px;font-weight:700;color:#f39c12">$${invoice.amount.toFixed(2)}</div>
                </div>
            </div>
            
            ${invoice.companyInfo ? `
            <div style="background:#16213e;border:1px solid #2a3a5c;border-radius:8px;padding:12px;margin-bottom:16px">
                <div style="font-size:10px;color:#7f8c8d;text-transform:uppercase;margin-bottom:8px">Company Info</div>
                <div style="font-size:13px;color:#ecf0f1">
                    ${invoice.companyInfo.companyName ? '<strong>'+invoice.companyInfo.companyName+'</strong><br>' : ''}
                    ${invoice.companyInfo.phone ? invoice.companyInfo.phone+' | ' : ''}
                    ${invoice.companyInfo.email || ''}
                    ${invoice.companyInfo.licenseNum ? '<br>License: '+invoice.companyInfo.licenseNum : ''}
                </div>
            </div>
            ` : ''}
            
            <div style="display:flex;gap:8px;flex-wrap:wrap">
                ${invoice.status === 'temporary' ? `
                    <button class="invoice-btn award" onclick="invMarkAsAwarded('${invoice.id}');invCloseDetail()">‚úÖ Mark as Awarded</button>
                    <button class="invoice-btn lost" onclick="invMarkAsLost('${invoice.id}');invCloseDetail()">‚ùå Mark as Lost</button>
                ` : ''}
                <button class="invoice-btn view" onclick="viewRevisionHistory('${invoice.id}')">üìù Revisions</button>
                <button class="invoice-btn delete" onclick="invDeleteInvoice('${invoice.id}','${invoice.status}');invCloseDetail()">üóëÔ∏è Delete</button>
            </div>
        </div>
    `;
}

// Close detail panel and return to list
function invCloseDetail() {
    const panel = document.getElementById('quoteDetailPanel');
    const list = document.getElementById('invoiceList');
    if (panel) panel.style.display = 'none';
    if (list) list.style.display = 'block';
    invRenderList();
}

// Update invoice statistics
function updateInvoiceStats() {
    const pending = Object.values(invoiceData.temporary).length;
    const awarded = Object.values(invoiceData.permanent).length;
    
    const totalValue = Object.values(invoiceData.permanent).reduce((sum, inv) => sum + inv.amount, 0);
    
    const now = new Date();
    const expiringSoon = Object.values(invoiceData.temporary).filter(inv => {
        const daysLeft = Math.ceil((new Date(inv.expiresDate) - now) / (1000 * 60 * 60 * 24));
        return daysLeft <= 5 && daysLeft > 0;
    }).length;
    
    const elP = document.getElementById('statPending');
    const elA = document.getElementById('statAwarded');
    const elT = document.getElementById('statTotal');
    const elE = document.getElementById('statExpiring');
    const elPL = document.getElementById('statPendingLib');
    const elEL = document.getElementById('statExpiringLib');
    if (elP) elP.textContent = pending;
    if (elA) elA.textContent = awarded;
    if (elT) elT.textContent = '$' + totalValue.toFixed(0);
    if (elE) elE.textContent = expiringSoon;
    if (elPL) elPL.textContent = pending;
    if (elEL) elEL.textContent = expiringSoon;
}

// Update client filter dropdown
function updateClientFilter() {
    const filterEl = document.getElementById('invFilterClient');
    if (!filterEl) return;
    const currentValue = filterEl.value;
    
    // Get unique client names
    const clients = new Set();
    for (const status in invoiceData) {
        Object.values(invoiceData[status]).forEach(inv => {
            clients.add(inv.clientName);
        });
    }
    
    // Sort alphabetically
    const sortedClients = Array.from(clients).sort();
    
    // Update dropdown
    filterEl.innerHTML = '<option value="">All Clients</option>' + 
        sortedClients.map(client => `<option value="${client}">${client}</option>`).join('');
    
    // Restore previous selection
    filterEl.value = currentValue;
}

// Check for expired invoices
function checkExpiredInvoices() {
    const now = new Date();
    let expiredCount = 0;
    
    Object.entries(invoiceData.temporary).forEach(([id, invoice]) => {
        const expiresDate = new Date(invoice.expiresDate);
        if (expiresDate < now) {
            // Auto-archive expired invoices
            invoice.status = 'lost';
            invoice.lostDate = new Date().toISOString();
            invoice.expiredReason = 'Auto-archived after 21 days';
            
            invoiceData.lost[id] = invoice;
            delete invoiceData.temporary[id];
            
            // Update Firebase
            if (db && userPIN) {
                const hashedPIN = hashPIN(userPIN);
                db.ref(`invoices/${hashedPIN}/temporary/${id}`).remove();
                saveInvoiceToFirebase(invoice);
            }
            
            expiredCount++;
        }
    });
    
    if (expiredCount > 0) {
        invRenderList();
        updateInvoiceStats();
        renderWidgetBanner();
        showNotification(`${expiredCount} expired invoice(s) auto-archived.`, 'info');
    }
}

// Show notification
function showNotification(message, type) {
    const notification = document.createElement('div');
    notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: ${type === 'success' ? '#27ae60' : type === 'error' ? '#e74c3c' : '#3498db'};
        color: white;
        padding: 12px 20px;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 600;
        z-index: 10000;
        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    `;
    notification.textContent = message;
    document.body.appendChild(notification);
    
    setTimeout(() => {
        notification.remove();
    }, 4000);
}

// Hook into existing generate functions to auto-save invoices
const originalGenerateLabor = generateLabor;
generateLabor = function() {
    autoSaveInvoice('labor');
    originalGenerateLabor();
};

const originalGenerateMaterials = generateMaterials;
generateMaterials = function() {
    autoSaveInvoice('materials');
    originalGenerateMaterials();
};

const originalGenerateChangeOrder = generateChangeOrder;
generateChangeOrder = function() {
    autoSaveInvoice('change_order');
    originalGenerateChangeOrder();
};


</script>
</body>
</html>
